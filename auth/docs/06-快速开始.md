# å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ¯ 5åˆ†é’Ÿå¿«é€Ÿä½“éªŒ

### å‰ç½®æ¡ä»¶

ç¡®ä¿ä½ çš„å¼€å‘ç¯å¢ƒå·²å®‰è£…ï¼š
- JDK 17+
- Maven 3.6+
- MySQL 8.0+
- Redis 7.0+

### å¿«é€Ÿå¯åŠ¨æ­¥éª¤

#### 1. å‡†å¤‡æ•°æ®åº“

```bash
# ç™»å½•MySQL
mysql -u root -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE auth_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# é€€å‡º
exit
```

#### 2. å¯¼å…¥åˆå§‹åŒ–æ•°æ®

```bash
# å¯¼å…¥è¡¨ç»“æ„å’Œåˆå§‹æ•°æ®
mysql -u root -p auth_db < scripts/init.sql
```

#### 3. å¯åŠ¨Redis

```bash
# Linux/Mac
redis-server

# Windows
redis-server.exe
```

#### 4. ä¿®æ”¹é…ç½®

ç¼–è¾‘ `src/main/resources/application.yml`:

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/auth_db
    username: root
    password: your_password  # ä¿®æ”¹ä¸ºä½ çš„å¯†ç 
  redis:
    host: localhost
    port: 6379
```

#### 5. å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼ä¸€ï¼šMaven
mvn spring-boot:run

# æ–¹å¼äºŒï¼šæ‰“åŒ…åè¿è¡Œ
mvn clean package
java -jar target/auth-core.jar
```

#### 6. éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:8080/actuator/health

# è·å–éªŒè¯ç 
curl http://localhost:8080/api/v1/auth/captcha

# ç™»å½•ï¼ˆé»˜è®¤è´¦å·ï¼‰
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

âœ… å¦‚æœçœ‹åˆ°è¿”å›çš„Tokenï¼Œè¯´æ˜æœåŠ¡å·²ç»æˆåŠŸå¯åŠ¨ï¼

## ğŸ”Œ é›†æˆåˆ°ä½ çš„é¡¹ç›®

### æ–¹å¼ä¸€ï¼šä½¿ç”¨SDKï¼ˆæ¨èï¼‰

#### 1. æ·»åŠ ä¾èµ–

åœ¨ä½ çš„é¡¹ç›® `pom.xml` ä¸­æ·»åŠ ï¼š

```xml
<dependency>
    <groupId>cn.zhangziming</groupId>
    <artifactId>auth-spring-boot-starter</artifactId>
    <version>1.0.0</version>
</dependency>
```

#### 2. é…ç½®

åœ¨ `application.yml` ä¸­æ·»åŠ é…ç½®ï¼š

```yaml
auth:
  server:
    url: http://localhost:8080  # è®¤è¯æœåŠ¡åœ°å€
  client:
    id: your-client-id          # å®¢æˆ·ç«¯ID
    secret: your-client-secret  # å®¢æˆ·ç«¯å¯†é’¥
  enabled: true
```

#### 3. ä½¿ç”¨æ³¨è§£ä¿æŠ¤æ¥å£

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    // éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®
    @RequireLogin
    @GetMapping("/info")
    public Result getUserInfo() {
        return Result.success(UserContext.getCurrentUser());
    }
    
    // éœ€è¦ç‰¹å®šæƒé™
    @RequirePermission("user:delete")
    @DeleteMapping("/{id}")
    public Result deleteUser(@PathVariable Long id) {
        return Result.success();
    }
    
    // éœ€è¦ç‰¹å®šè§’è‰²
    @RequireRole("ADMIN")
    @PostMapping("/create")
    public Result createUser(@RequestBody UserDTO user) {
        return Result.success();
    }
}
```

#### 4. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

```java
@Service
public class BusinessService {
    
    public void doSomething() {
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·
        UserInfo currentUser = UserContext.getCurrentUser();
        Long userId = currentUser.getUserId();
        String username = currentUser.getUsername();
        List<String> roles = currentUser.getRoles();
        List<String> permissions = currentUser.getPermissions();
        
        // ä¸šåŠ¡é€»è¾‘
        System.out.println("å½“å‰ç”¨æˆ·: " + username);
    }
}
```

### æ–¹å¼äºŒï¼šä½¿ç”¨Feignè°ƒç”¨

#### 1. æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>cn.zhangziming</groupId>
    <artifactId>auth-api</artifactId>
    <version>1.0.0</version>
</dependency>

<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

#### 2. å¯ç”¨Feign

```java
@SpringBootApplication
@EnableFeignClients(basePackages = "cn.zhangziming.auth.api.feign")
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

#### 3. ä½¿ç”¨Feignå®¢æˆ·ç«¯

```java
@Service
public class UserService {
    
    @Autowired
    private AuthFeignClient authFeignClient;
    
    public UserInfoResponse getUserInfo(String token) {
        return authFeignClient.getUserInfo(token);
    }
    
    public boolean validateToken(String token) {
        return authFeignClient.validateToken(token);
    }
}
```

### æ–¹å¼ä¸‰ï¼šç›´æ¥HTTPè°ƒç”¨

#### 1. ç™»å½•è·å–Token

```java
@Service
public class AuthService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    private static final String AUTH_URL = "http://localhost:8080/api/v1";
    
    public LoginResponse login(String username, String password) {
        LoginRequest request = new LoginRequest();
        request.setUsername(username);
        request.setPassword(password);
        
        ResponseEntity<Result<LoginResponse>> response = restTemplate.postForEntity(
            AUTH_URL + "/auth/login",
            request,
            new ParameterizedTypeReference<Result<LoginResponse>>() {}
        );
        
        return response.getBody().getData();
    }
}
```

#### 2. éªŒè¯Token

```java
public boolean validateToken(String token) {
    HttpHeaders headers = new HttpHeaders();
    headers.setBearerAuth(token);
    HttpEntity<?> entity = new HttpEntity<>(headers);
    
    try {
        ResponseEntity<Result<UserInfoResponse>> response = restTemplate.exchange(
            AUTH_URL + "/auth/userinfo",
            HttpMethod.GET,
            entity,
            new ParameterizedTypeReference<Result<UserInfoResponse>>() {}
        );
        return response.getStatusCode() == HttpStatus.OK;
    } catch (Exception e) {
        return false;
    }
}
```

## ğŸŒ å‰ç«¯é›†æˆç¤ºä¾‹

### Vue 3 + Axios

#### 1. å®‰è£…ä¾èµ–

```bash
npm install axios
```

#### 2. åˆ›å»ºAPIå·¥å…·ç±»

```javascript
// src/utils/request.js
import axios from 'axios'

const service = axios.create({
  baseURL: 'http://localhost:8080/api/v1',
  timeout: 5000
})

// è¯·æ±‚æ‹¦æˆªå™¨
service.interceptors.request.use(
  config => {
    const token = localStorage.getItem('access_token')
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`
    }
    return config
  },
  error => {
    return Promise.reject(error)
  }
)

// å“åº”æ‹¦æˆªå™¨
service.interceptors.response.use(
  response => {
    const res = response.data
    if (res.code !== 200) {
      // Tokenè¿‡æœŸï¼Œåˆ·æ–°Token
      if (res.code === 1003) {
        return refreshToken().then(() => {
          return service(response.config)
        })
      }
      return Promise.reject(new Error(res.message || 'Error'))
    }
    return res.data
  },
  error => {
    return Promise.reject(error)
  }
)

export default service
```

#### 3. åˆ›å»ºè®¤è¯API

```javascript
// src/api/auth.js
import request from '@/utils/request'

export function login(username, password) {
  return request({
    url: '/auth/login',
    method: 'post',
    data: {
      username,
      password
    }
  })
}

export function logout() {
  return request({
    url: '/auth/logout',
    method: 'post'
  })
}

export function getUserInfo() {
  return request({
    url: '/auth/userinfo',
    method: 'get'
  })
}

export function refreshToken() {
  const refreshToken = localStorage.getItem('refresh_token')
  return request({
    url: '/auth/refresh',
    method: 'post',
    data: { refreshToken }
  }).then(res => {
    localStorage.setItem('access_token', res.accessToken)
    localStorage.setItem('refresh_token', res.refreshToken)
    return res
  })
}
```

#### 4. ç™»å½•ç»„ä»¶

```vue
<!-- src/views/Login.vue -->
<template>
  <div class="login-container">
    <el-form :model="loginForm" :rules="rules" ref="loginFormRef">
      <el-form-item prop="username">
        <el-input v-model="loginForm.username" placeholder="ç”¨æˆ·å" />
      </el-form-item>
      <el-form-item prop="password">
        <el-input v-model="loginForm.password" type="password" placeholder="å¯†ç " />
      </el-form-item>
      <el-button type="primary" @click="handleLogin">ç™»å½•</el-button>
    </el-form>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { login, getUserInfo } from '@/api/auth'
import { ElMessage } from 'element-plus'

const router = useRouter()
const loginFormRef = ref()
const loginForm = ref({
  username: '',
  password: ''
})

const rules = {
  username: [{ required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' }],
  password: [{ required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' }]
}

const handleLogin = async () => {
  await loginFormRef.value.validate()
  
  try {
    const res = await login(loginForm.value.username, loginForm.value.password)
    
    // ä¿å­˜Token
    localStorage.setItem('access_token', res.accessToken)
    localStorage.setItem('refresh_token', res.refreshToken)
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    const userInfo = await getUserInfo()
    localStorage.setItem('userInfo', JSON.stringify(userInfo))
    
    ElMessage.success('ç™»å½•æˆåŠŸ')
    router.push('/')
  } catch (error) {
    ElMessage.error(error.message || 'ç™»å½•å¤±è´¥')
  }
}
</script>
```

#### 5. è·¯ç”±å®ˆå«

```javascript
// src/router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import { getUserInfo } from '@/api/auth'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/login',
      component: () => import('@/views/Login.vue')
    },
    {
      path: '/',
      component: () => import('@/views/Home.vue'),
      meta: { requireAuth: true }
    }
  ]
})

router.beforeEach(async (to, from, next) => {
  const token = localStorage.getItem('access_token')
  
  if (to.meta.requireAuth) {
    if (!token) {
      next('/login')
      return
    }
    
    // éªŒè¯Token
    try {
      await getUserInfo()
      next()
    } catch (error) {
      localStorage.clear()
      next('/login')
    }
  } else {
    next()
  }
})

export default router
```

### React + Axios

#### 1. åˆ›å»ºè®¤è¯ä¸Šä¸‹æ–‡

```javascript
// src/context/AuthContext.jsx
import { createContext, useState, useContext, useEffect } from 'react'
import { login as loginApi, getUserInfo } from '@/api/auth'

const AuthContext = createContext()

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null)
  const [loading, setLoading] = useState(true)
  
  useEffect(() => {
    // åˆå§‹åŒ–æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkAuth()
  }, [])
  
  const checkAuth = async () => {
    const token = localStorage.getItem('access_token')
    if (token) {
      try {
        const userInfo = await getUserInfo()
        setUser(userInfo)
      } catch (error) {
        localStorage.clear()
      }
    }
    setLoading(false)
  }
  
  const login = async (username, password) => {
    const res = await loginApi(username, password)
    localStorage.setItem('access_token', res.accessToken)
    localStorage.setItem('refresh_token', res.refreshToken)
    setUser(res.userInfo)
    return res
  }
  
  const logout = () => {
    localStorage.clear()
    setUser(null)
  }
  
  const hasPermission = (permission) => {
    return user?.permissions?.includes(permission) || false
  }
  
  const hasRole = (role) => {
    return user?.roles?.includes(role) || false
  }
  
  return (
    <AuthContext.Provider value={{ user, loading, login, logout, hasPermission, hasRole }}>
      {children}
    </AuthContext.Provider>
  )
}

export const useAuth = () => useContext(AuthContext)
```

#### 2. ä½¿ç”¨è®¤è¯

```javascript
// src/pages/Dashboard.jsx
import { useAuth } from '@/context/AuthContext'

export default function Dashboard() {
  const { user, hasPermission } = useAuth()
  
  return (
    <div>
      <h1>æ¬¢è¿, {user?.nickname}</h1>
      
      {hasPermission('user:delete') && (
        <button>åˆ é™¤ç”¨æˆ·</button>
      )}
    </div>
  )
}
```

## ğŸ“± ç§»åŠ¨ç«¯é›†æˆç¤ºä¾‹

### Android (Kotlin)

```kotlin
// AuthService.kt
class AuthService(private val baseUrl: String) {
    private val client = OkHttpClient()
    private val gson = Gson()
    
    fun login(username: String, password: String): LoginResponse {
        val request = LoginRequest(username, password)
        val json = gson.toJson(request)
        
        val body = RequestBody.create(
            "application/json".toMediaType(),
            json
        )
        
        val httpRequest = Request.Builder()
            .url("$baseUrl/api/v1/auth/login")
            .post(body)
            .build()
        
        client.newCall(httpRequest).execute().use { response ->
            val responseBody = response.body?.string()
            val result = gson.fromJson(responseBody, Result::class.java)
            return result.data as LoginResponse
        }
    }
}
```

### iOS (Swift)

```swift
// AuthService.swift
class AuthService {
    let baseURL = "http://localhost:8080/api/v1"
    
    func login(username: String, password: String, completion: @escaping (Result<LoginResponse, Error>) -> Void) {
        let url = URL(string: "\(baseURL)/auth/login")!
        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        
        let body: [String: Any] = [
            "username": username,
            "password": password
        ]
        request.httpBody = try? JSONSerialization.data(withJSONObject: body)
        
        URLSession.shared.dataTask(with: request) { data, response, error in
            if let error = error {
                completion(.failure(error))
                return
            }
            
            guard let data = data else { return }
            
            do {
                let result = try JSONDecoder().decode(ApiResult<LoginResponse>.self, from: data)
                completion(.success(result.data))
            } catch {
                completion(.failure(error))
            }
        }.resume()
    }
}
```

## ğŸ“ ä¸‹ä¸€æ­¥

- ğŸ“– é˜…è¯» [APIæ¥å£æ–‡æ¡£](./04-APIæ¥å£æ–‡æ¡£.md) äº†è§£å®Œæ•´API
- ğŸ—ï¸ æŸ¥çœ‹ [æ¶æ„è®¾è®¡æ–‡æ¡£](./02-æ¶æ„è®¾è®¡.md) äº†è§£ç³»ç»Ÿæ¶æ„
- ğŸš€ å‚è€ƒ [éƒ¨ç½²è¿ç»´æ–‡æ¡£](./05-éƒ¨ç½²è¿ç»´.md) è¿›è¡Œç”Ÿäº§éƒ¨ç½²
- ğŸ”§ æŸ¥çœ‹ [SDKä½¿ç”¨æ–‡æ¡£](./07-SDKä½¿ç”¨æŒ‡å—.md) äº†è§£SDKè¯¦ç»†ç”¨æ³•

## â“ å¸¸è§é—®é¢˜

### Q1: Tokenè¿‡æœŸå¦‚ä½•å¤„ç†ï¼Ÿ
A: SDKä¼šè‡ªåŠ¨ä½¿ç”¨RefreshTokenåˆ·æ–°AccessTokenï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨refreshæ¥å£ã€‚

### Q2: å¦‚ä½•å®ç°å•ç‚¹ç™»å½•ï¼Ÿ
A: é…ç½®OAuth2æˆæƒç æ¨¡å¼ï¼Œæ‰€æœ‰åº”ç”¨å…±äº«è®¤è¯ä¸­å¿ƒçš„Tokenã€‚

### Q3: å¦‚ä½•è‡ªå®šä¹‰æƒé™éªŒè¯é€»è¾‘ï¼Ÿ
A: å®ç°`PermissionEvaluator`æ¥å£å¹¶æ³¨å†Œä¸ºBeanã€‚

### Q4: æ”¯æŒå“ªäº›ç¬¬ä¸‰æ–¹ç™»å½•ï¼Ÿ
A: ç›®å‰æ”¯æŒå¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€GitHubç­‰ï¼Œå¯é€šè¿‡é…ç½®æ‰©å±•ã€‚

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹[å®Œæ•´æ–‡æ¡£](./README.md)æˆ–æäº¤Issue

