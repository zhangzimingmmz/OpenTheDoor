# éƒ¨ç½²è¿ç»´æ–‡æ¡£

## ğŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šæœ¬åœ°å¼€å‘ç¯å¢ƒéƒ¨ç½²

#### ç¯å¢ƒè¦æ±‚

- JDK 17+
- Maven 3.6+
- MySQL 8.0+
- Redis 7.0+
- Nacos 2.0+ (å¯é€‰)

#### æ­¥éª¤

1. **å…‹éš†ä»£ç **
```bash
git clone <repository-url>
cd auth
```

2. **é…ç½®æ•°æ®åº“**
```bash
# åˆ›å»ºæ•°æ®åº“
mysql -u root -p
CREATE DATABASE auth_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# å¯¼å…¥åˆå§‹åŒ–è„šæœ¬
mysql -u root -p auth_db < scripts/schema.sql
mysql -u root -p auth_db < scripts/data.sql
```

3. **é…ç½®Redis**
```bash
# å¯åŠ¨Redis
redis-server
```

4. **ä¿®æ”¹é…ç½®æ–‡ä»¶**
```yaml
# src/main/resources/application.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/auth_db
    username: root
    password: your_password
  redis:
    host: localhost
    port: 6379
```

5. **å¯åŠ¨åº”ç”¨**
```bash
# Mavenæ–¹å¼
mvn clean package
java -jar target/auth-core.jar

# æˆ–è€…ç›´æ¥è¿è¡Œ
mvn spring-boot:run
```

6. **éªŒè¯éƒ¨ç½²**
```bash
curl http://localhost:8080/api/v1/auth/captcha
```

### æ–¹å¼äºŒï¼šDockeréƒ¨ç½²

#### Docker Composeéƒ¨ç½²ï¼ˆæ¨èï¼‰

1. **åˆ›å»ºdocker-compose.yml**
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: auth-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: auth_db
    ports:
      - "3306:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./scripts/schema.sql:/docker-entrypoint-initdb.d/1-schema.sql
      - ./scripts/data.sql:/docker-entrypoint-initdb.d/2-data.sql
    networks:
      - auth-network

  redis:
    image: redis:7-alpine
    container_name: auth-redis
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - auth-network

  auth-service:
    build: .
    container_name: auth-service
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/auth_db?useUnicode=true&characterEncoding=utf8&useSSL=false
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root123
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
    depends_on:
      - mysql
      - redis
    networks:
      - auth-network

networks:
  auth-network:
    driver: bridge
```

2. **åˆ›å»ºDockerfile**
```dockerfile
FROM openjdk:17-slim
LABEL maintainer="zhangziming"

WORKDIR /app

# å¤åˆ¶jaråŒ…
COPY target/auth-core.jar app.jar

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", "-Xms512m", "-Xmx1024m", "-jar", "app.jar"]
```

3. **å¯åŠ¨æœåŠ¡**
```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f auth-service

# åœæ­¢æœåŠ¡
docker-compose down
```

#### å•ç‹¬Dockeréƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t auth-service:1.0.0 .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name auth-service \
  -p 8080:8080 \
  -e SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/auth_db \
  -e SPRING_DATASOURCE_USERNAME=root \
  -e SPRING_DATASOURCE_PASSWORD=root123 \
  -e SPRING_REDIS_HOST=host.docker.internal \
  -e SPRING_REDIS_PORT=6379 \
  auth-service:1.0.0
```

### æ–¹å¼ä¸‰ï¼šKuberneteséƒ¨ç½²

#### åˆ›å»ºKubernetesé…ç½®

1. **ConfigMapé…ç½®**
```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-config
  namespace: auth
data:
  application.yml: |
    spring:
      datasource:
        url: jdbc:mysql://mysql-service:3306/auth_db
        username: root
        password: ${MYSQL_PASSWORD}
      redis:
        host: redis-service
        port: 6379
```

2. **Secreté…ç½®**
```yaml
# k8s/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: auth-secret
  namespace: auth
type: Opaque
data:
  mysql-password: cm9vdDEyMw==  # base64ç¼–ç 
  jwt-secret: eW91ci1qd3Qtc2VjcmV0  # base64ç¼–ç 
```

3. **Deploymenté…ç½®**
```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: auth
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: auth-service:1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: auth-secret
              key: mysql-password
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: auth-secret
              key: jwt-secret
        volumeMounts:
        - name: config
          mountPath: /app/config
        resources:
          limits:
            cpu: "2"
            memory: "2Gi"
          requests:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: auth-config
```

4. **Serviceé…ç½®**
```yaml
# k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: auth
spec:
  type: LoadBalancer
  selector:
    app: auth-service
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
```

5. **éƒ¨ç½²åˆ°K8s**
```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace auth

# åº”ç”¨é…ç½®
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secret.yaml
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n auth
kubectl get svc -n auth

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/auth-service -n auth
```

## ğŸ”§ é…ç½®ç®¡ç†

### ç¯å¢ƒé…ç½®

#### å¼€å‘ç¯å¢ƒï¼ˆapplication-dev.ymlï¼‰
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/auth_db
    username: root
    password: root
  redis:
    host: localhost
    port: 6379
  
logging:
  level:
    cn.zhangziming: DEBUG
```

#### æµ‹è¯•ç¯å¢ƒï¼ˆapplication-test.ymlï¼‰
```yaml
spring:
  datasource:
    url: jdbc:mysql://test-mysql:3306/auth_db
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  redis:
    host: test-redis
    port: 6379

logging:
  level:
    cn.zhangziming: INFO
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆapplication-prod.ymlï¼‰
```yaml
spring:
  datasource:
    url: jdbc:mysql://prod-mysql:3306/auth_db
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
  redis:
    host: prod-redis
    port: 6379
    password: ${REDIS_PASSWORD}
    lettuce:
      pool:
        max-active: 20
        max-idle: 10

logging:
  level:
    cn.zhangziming: WARN
  file:
    name: /var/log/auth/application.log
```

### Nacosé…ç½®ä¸­å¿ƒ

#### é…ç½®Nacos
```yaml
# bootstrap.yml
spring:
  application:
    name: auth-service
  cloud:
    nacos:
      discovery:
        server-addr: nacos-server:8848
        namespace: ${NACOS_NAMESPACE}
      config:
        server-addr: nacos-server:8848
        namespace: ${NACOS_NAMESPACE}
        file-extension: yml
        refresh-enabled: true
```

#### Nacosé…ç½®ç¤ºä¾‹
```yaml
# Data ID: auth-service.yml
# Group: DEFAULT_GROUP

auth:
  jwt:
    secret: ${JWT_SECRET}
    access-token-expire: 7200
    refresh-token-expire: 604800
  
  security:
    login-fail-max-count: 5
    login-fail-lock-time: 900
    
  captcha:
    enabled: true
    expire-time: 300
```

## ğŸ“Š ç›‘æ§å‘Šè­¦

### Spring Boot Actuator

#### é…ç½®Actuator
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

#### å¥åº·æ£€æŸ¥ç«¯ç‚¹
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8080/actuator/health

# æŒ‡æ ‡æ•°æ®
curl http://localhost:8080/actuator/metrics

# Prometheusæ ¼å¼
curl http://localhost:8080/actuator/prometheus
```

### Prometheusç›‘æ§

#### Prometheusé…ç½®
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'auth-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['auth-service:8080']
```

### Grafana Dashboard

#### å¯¼å…¥Dashboard
1. ç™»å½•Grafana
2. å¯¼å…¥Dashboard ID: 4701 (Spring Boot 2.1 Statistics)
3. é…ç½®Prometheusæ•°æ®æº
4. é…ç½®å‘Šè­¦è§„åˆ™

### æ—¥å¿—ç›‘æ§ï¼ˆELKï¼‰

#### Logstashé…ç½®
```conf
input {
  file {
    path => "/var/log/auth/application.log"
    type => "auth-service"
    codec => json
  }
}

filter {
  if [type] == "auth-service" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{JAVACLASS:class} - %{GREEDYDATA:message}" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "auth-service-%{+YYYY.MM.dd}"
  }
}
```

## ğŸ”„ CI/CDæµæ°´çº¿

### GitLab CI/CD

#### .gitlab-ci.yml
```yaml
stages:
  - build
  - test
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository

build:
  stage: build
  image: maven:3.8-openjdk-17
  script:
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day

test:
  stage: test
  image: maven:3.8-openjdk-17
  script:
    - mvn test
  coverage: '/Total.*?([0-9]{1,3})%/'

deploy-dev:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t auth-service:dev .
    - docker push auth-service:dev
    - kubectl set image deployment/auth-service auth-service=auth-service:dev -n dev
  only:
    - develop

deploy-prod:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t auth-service:$CI_COMMIT_TAG .
    - docker push auth-service:$CI_COMMIT_TAG
    - kubectl set image deployment/auth-service auth-service=auth-service:$CI_COMMIT_TAG -n prod
  only:
    - tags
```

### Jenkins Pipeline

#### Jenkinsfile
```groovy
pipeline {
    agent any
    
    tools {
        maven 'Maven 3.8'
        jdk 'JDK 17'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/your/repo.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                sh 'docker build -t auth-service:${BUILD_NUMBER} .'
            }
        }
        
        stage('Deploy to K8s') {
            steps {
                sh '''
                    kubectl set image deployment/auth-service \
                    auth-service=auth-service:${BUILD_NUMBER} \
                    -n production
                '''
            }
        }
    }
    
    post {
        success {
            echo 'Deployment successful!'
        }
        failure {
            echo 'Deployment failed!'
        }
    }
}
```

## ğŸ” å®‰å…¨åŠ å›º

### 1. HTTPSé…ç½®

```yaml
server:
  port: 8443
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: ${SSL_PASSWORD}
    key-store-type: PKCS12
```

### 2. é˜²ç«å¢™è§„åˆ™

```bash
# åªå…è®¸å¿…è¦ç«¯å£
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --permanent --add-port=8443/tcp
firewall-cmd --reload
```

### 3. æ•°æ®åº“å®‰å…¨

```sql
-- åˆ›å»ºä¸“ç”¨ç”¨æˆ·
CREATE USER 'auth_user'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON auth_db.* TO 'auth_user'@'%';
FLUSH PRIVILEGES;
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. JVMå‚æ•°ä¼˜åŒ–

```bash
java -jar \
  -Xms2g \
  -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/auth/heapdump.hprof \
  auth-core.jar
```

### 2. è¿æ¥æ± ä¼˜åŒ–

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

### 3. Redisä¼˜åŒ–

```yaml
spring:
  redis:
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
        max-wait: 3000
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **æœåŠ¡æ— æ³•å¯åŠ¨**
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/auth/application.log

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8080

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
mysql -h localhost -u root -p
```

2. **TokenéªŒè¯å¤±è´¥**
```bash
# æ£€æŸ¥Redisè¿æ¥
redis-cli ping

# æŸ¥çœ‹Token
redis-cli
GET auth:user:1
```

3. **æ€§èƒ½é—®é¢˜**
```bash
# æŸ¥çœ‹JVMçŠ¶æ€
jstat -gcutil <pid> 1000

# æŸ¥çœ‹çº¿ç¨‹dump
jstack <pid> > thread.dump

# æŸ¥çœ‹å †dump
jmap -dump:live,format=b,file=heap.dump <pid>
```

## ğŸ“‹ è¿ç»´æ¸…å•

### æ—¥å¸¸è¿ç»´

- [ ] å®šæœŸæ£€æŸ¥æ—¥å¿—
- [ ] ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
- [ ] æ£€æŸ¥å‘Šè­¦ä¿¡æ¯
- [ ] å¤‡ä»½æ•°æ®åº“
- [ ] æ¸…ç†è¿‡æœŸæ—¥å¿—

### å®šæœŸç»´æŠ¤

- [ ] æ›´æ–°ä¾èµ–åŒ…ï¼ˆæ¯æœˆï¼‰
- [ ] æ•°æ®åº“ä¼˜åŒ–ï¼ˆæ¯å­£åº¦ï¼‰
- [ ] å®‰å…¨å®¡è®¡ï¼ˆæ¯å­£åº¦ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆæ¯å­£åº¦ï¼‰
- [ ] ç¾éš¾æ¢å¤æ¼”ç»ƒï¼ˆæ¯åŠå¹´ï¼‰

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- [æ¶æ„è®¾è®¡æ–‡æ¡£](./02-æ¶æ„è®¾è®¡.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](./06-å¿«é€Ÿå¼€å§‹.md)

