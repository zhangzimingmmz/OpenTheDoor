# å¹¶å‘è®¾è®¡æ¨¡å¼ (Concurrent Design Patterns)

> æŒæ¡ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ã€ThreadLocalã€Futureæ¨¡å¼ç­‰å¹¶å‘è®¾è®¡æ¨¡å¼ï¼Œæå‡å¹¶å‘ç¼–ç¨‹èƒ½åŠ›

## ç›®å½•
- [1. ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼](#1-ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼)
- [2. ThreadLocalæ¨¡å¼](#2-threadlocalæ¨¡å¼)
- [3. Futureæ¨¡å¼](#3-futureæ¨¡å¼)
- [4. ä¸å˜æ¨¡å¼](#4-ä¸å˜æ¨¡å¼)
- [5. å·¥ä½œçªƒå–æ¨¡å¼](#5-å·¥ä½œçªƒå–æ¨¡å¼)
- [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
- [7. é¢è¯•é«˜é¢‘é—®é¢˜](#7-é¢è¯•é«˜é¢‘é—®é¢˜)

---

## 1. ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ (Producer-Consumer Pattern)

### 1.1 æ¨¡å¼æ¦‚è¿°

**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**ï¼šç”Ÿäº§è€…ç”Ÿäº§æ•°æ®æ”¾å…¥é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®æ¶ˆè´¹ã€‚

**æ ¸å¿ƒç»„ä»¶ï¼š**
- **ç”Ÿäº§è€…ï¼ˆProducerï¼‰** - ç”Ÿäº§æ•°æ®
- **æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰** - æ¶ˆè´¹æ•°æ®
- **ç¼“å†²åŒºï¼ˆBufferï¼‰** - ä½¿ç”¨BlockingQueueä½œä¸ºç¼“å†²åŒº

### 1.2 åŸºæœ¬å®ç°

```java
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;

/**
 * ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼åŸºæœ¬å®ç°
 * Basic Producer-Consumer Pattern
 */
public class ProducerConsumerDemo {
    private BlockingQueue<String> queue = new LinkedBlockingQueue<>(10);
    
    // ç”Ÿäº§è€…
    class Producer implements Runnable {
        @Override
        public void run() {
            try {
                for (int i = 0; i < 100; i++) {
                    String item = "item-" + i;
                    queue.put(item); // é˜»å¡ç›´åˆ°æœ‰ç©ºé—´
                    System.out.println("ç”Ÿäº§: " + item);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
    
    // æ¶ˆè´¹è€…
    class Consumer implements Runnable {
        @Override
        public void run() {
            try {
                while (true) {
                    String item = queue.take(); // é˜»å¡ç›´åˆ°æœ‰å…ƒç´ 
                    System.out.println("æ¶ˆè´¹: " + item);
                    processItem(item);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
        
        private void processItem(String item) {
            // å¤„ç†æ•°æ®
        }
    }
    
    public void start() {
        new Thread(new Producer()).start();
        new Thread(new Consumer()).start();
    }
}
```

### 1.3 å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…

```java
/**
 * å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼
 * Multiple Producers and Consumers
 */
public class MultiProducerConsumer {
    private BlockingQueue<Task> taskQueue = new LinkedBlockingQueue<>(100);
    private ExecutorService producerPool = Executors.newFixedThreadPool(5);
    private ExecutorService consumerPool = Executors.newFixedThreadPool(10);
    
    public void start() {
        // å¯åŠ¨å¤šä¸ªç”Ÿäº§è€…
        for (int i = 0; i < 5; i++) {
            producerPool.submit(() -> {
                while (true) {
                    Task task = generateTask();
                    taskQueue.put(task);
                }
            });
        }
        
        // å¯åŠ¨å¤šä¸ªæ¶ˆè´¹è€…
        for (int i = 0; i < 10; i++) {
            consumerPool.submit(() -> {
                while (true) {
                    Task task = taskQueue.take();
                    processTask(task);
                }
            });
        }
    }
}
```

### 1.4 åœ¨ç®—åŠ›å¹³å°ä¸­çš„åº”ç”¨

```java
/**
 * ç®—åŠ›å¹³å°ä¸­çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
 * Producer-Consumer Pattern in Computing Platform
 */
public class PlatformProducerConsumer {
    
    // ä»»åŠ¡çŠ¶æ€é˜Ÿåˆ—ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
    private BlockingQueue<TaskStatus> statusQueue = new LinkedBlockingQueue<>(1000);
    
    // ç”Ÿäº§è€…ï¼šå®šæ—¶ä»»åŠ¡é‡‡é›†Nomadä»»åŠ¡çŠ¶æ€
    @Scheduled(fixedRate = 5000)
    public void produceTaskStatus() {
        List<TaskStatus> statuses = nomadClient.getTaskStatuses();
        for (TaskStatus status : statuses) {
            try {
                statusQueue.put(status); // ç”Ÿäº§æ•°æ®
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
    
    // æ¶ˆè´¹è€…ï¼šæ‰¹é‡æ›´æ–°æ•°æ®åº“
    @PostConstruct
    public void consumeTaskStatus() {
        ExecutorService executor = Executors.newFixedThreadPool(2);
        executor.submit(() -> {
            List<TaskStatus> batch = new ArrayList<>();
            while (true) {
                try {
                    // æ‰¹é‡æ¶ˆè´¹
                    statusQueue.drainTo(batch, 100);
                    if (!batch.isEmpty()) {
                        batchUpdateDatabase(batch);
                        batch.clear();
                    } else {
                        TaskStatus status = statusQueue.take(); // é˜»å¡ç­‰å¾…
                        batch.add(status);
                    }
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        });
    }
}
```

---

## 2. ThreadLocalæ¨¡å¼ (ThreadLocal Pattern)

### 2.1 æ ¸å¿ƒç‰¹ç‚¹

**ThreadLocalï¼ˆçº¿ç¨‹æœ¬åœ°å˜é‡ï¼‰**ï¼šä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œçº¿ç¨‹é—´äº’ä¸å¹²æ‰°ã€‚

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **çº¿ç¨‹éš”ç¦»** | æ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ |
| **é¿å…åŒæ­¥** | ä¸éœ€è¦åŒæ­¥ï¼Œæ€§èƒ½å¥½ |
| **å†…å­˜æ³„æ¼** | éœ€è¦æ³¨æ„å†…å­˜æ³„æ¼é—®é¢˜ |
| **é€‚ç”¨åœºæ™¯** | çº¿ç¨‹ä¸Šä¸‹æ–‡ã€ç”¨æˆ·ä¿¡æ¯ä¼ é€’ |

### 2.2 åŸºæœ¬ä½¿ç”¨

```java
import java.util.concurrent.ThreadLocal;

/**
 * ThreadLocalåŸºæœ¬ä½¿ç”¨
 * Basic Usage of ThreadLocal
 */
public class ThreadLocalDemo {
    // æ–¹å¼1ï¼šä½¿ç”¨ThreadLocalç±»
    private static ThreadLocal<String> threadLocal = new ThreadLocal<>();
    
    // æ–¹å¼2ï¼šä½¿ç”¨ThreadLocalRandomï¼ˆJDK 1.7+ï¼‰
    private ThreadLocalRandom random = ThreadLocalRandom.current();
    
    public void setValue(String value) {
        threadLocal.set(value); // è®¾ç½®å½“å‰çº¿ç¨‹çš„å€¼
    }
    
    public String getValue() {
        return threadLocal.get(); // è·å–å½“å‰çº¿ç¨‹çš„å€¼
    }
    
    public void remove() {
        threadLocal.remove(); // ç§»é™¤å½“å‰çº¿ç¨‹çš„å€¼ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
    }
    
    public static void main(String[] args) {
        ThreadLocalDemo demo = new ThreadLocalDemo();
        
        // çº¿ç¨‹1
        new Thread(() -> {
            demo.setValue("çº¿ç¨‹1çš„å€¼");
            System.out.println("çº¿ç¨‹1: " + demo.getValue()); // çº¿ç¨‹1çš„å€¼
        }).start();
        
        // çº¿ç¨‹2
        new Thread(() -> {
            demo.setValue("çº¿ç¨‹2çš„å€¼");
            System.out.println("çº¿ç¨‹2: " + demo.getValue()); // çº¿ç¨‹2çš„å€¼
        }).start();
    }
}
```

### 2.3 ThreadLocalå®ç°åŸç†

```java
/**
 * ThreadLocalå®ç°åŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
 * ThreadLocal Implementation Principle
 */
public class ThreadLocal<T> {
    // ThreadLocalMapï¼šThreadçš„æˆå‘˜å˜é‡
    // ThreadLocalMap.Entry[] table
    
    public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t); // è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
        if (map != null) {
            map.set(this, value); // ä»¥ThreadLocalä¸ºkeyå­˜å‚¨å€¼
        } else {
            createMap(t, value);
        }
    }
    
    public T get() {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                return (T) e.value;
            }
        }
        return setInitialValue();
    }
}
```

**å…³é”®ç‚¹ï¼š**
- æ¯ä¸ªThreadæœ‰ä¸€ä¸ªThreadLocalMap
- ThreadLocalä½œä¸ºkeyï¼Œå€¼ä½œä¸ºvalue
- çº¿ç¨‹éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°

### 2.4 å†…å­˜æ³„æ¼é—®é¢˜

```java
/**
 * ThreadLocalå†…å­˜æ³„æ¼é—®é¢˜
 * ThreadLocal Memory Leak Problem
 */
public class ThreadLocalMemoryLeak {
    private static ThreadLocal<LargeObject> threadLocal = new ThreadLocal<>();
    
    public void problem() {
        threadLocal.set(new LargeObject()); // è®¾ç½®å¤§å¯¹è±¡
        // å¿˜è®°remove()ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
        // ThreadLocalMap.Entryçš„keyæ˜¯å¼±å¼•ç”¨ï¼Œä½†valueæ˜¯å¼ºå¼•ç”¨
    }
    
    public void solution() {
        try {
            threadLocal.set(new LargeObject());
            // ä½¿ç”¨ThreadLocal
            useThreadLocal();
        } finally {
            threadLocal.remove(); // âœ… å¿…é¡»removeï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        }
    }
}
```

**å†…å­˜æ³„æ¼åŸå› ï¼š**
- ThreadLocalMap.Entryçš„keyæ˜¯å¼±å¼•ç”¨ï¼ˆThreadLocalï¼‰
- ä½†valueæ˜¯å¼ºå¼•ç”¨
- å¦‚æœThreadLocalè¢«å›æ”¶ï¼Œä½†valueè¿˜åœ¨ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨å®ŒThreadLocalåè°ƒç”¨`remove()`
- ä½¿ç”¨çº¿ç¨‹æ± æ—¶ï¼Œçº¿ç¨‹å¤ç”¨ï¼Œå¿…é¡»remove

### 2.5 åœ¨ç®—åŠ›å¹³å°ä¸­çš„åº”ç”¨

```java
/**
 * ç®—åŠ›å¹³å°ä¸­çš„ThreadLocalåº”ç”¨
 * ThreadLocal in Computing Platform
 */
public class PlatformThreadLocal {
    
    // ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼šå­˜å‚¨å½“å‰è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯
    private static ThreadLocal<UserContext> userContext = new ThreadLocal<>();
    
    // è¯·æ±‚IDï¼šè¿½è¸ªè¯·æ±‚é“¾è·¯
    private static ThreadLocal<String> requestId = new ThreadLocal<>();
    
    // æ‹¦æˆªå™¨ï¼šè®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
    @Component
    public class UserContextInterceptor implements HandlerInterceptor {
        @Override
        public boolean preHandle(HttpServletRequest request, 
                                HttpServletResponse response, 
                                Object handler) {
            // ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯
            String userId = request.getHeader("X-User-Id");
            userContext.set(new UserContext(userId));
            
            // ç”Ÿæˆè¯·æ±‚ID
            requestId.set(UUID.randomUUID().toString());
            return true;
        }
        
        @Override
        public void afterCompletion(HttpServletRequest request, 
                                   HttpServletResponse response, 
                                   Object handler, 
                                   Exception ex) {
            // æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            userContext.remove();
            requestId.remove();
        }
    }
    
    // ä¸šåŠ¡ä»£ç ï¼šè·å–å½“å‰ç”¨æˆ·
    public void businessMethod() {
        UserContext context = userContext.get(); // è·å–å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ä¸Šä¸‹æ–‡
        String currentUserId = context.getUserId();
        
        // è®°å½•æ—¥å¿—ï¼šåŒ…å«è¯·æ±‚ID
        logger.info("è¯·æ±‚ID: {}, ç”¨æˆ·ID: {}", requestId.get(), currentUserId);
    }
}
```

---

## 3. Futureæ¨¡å¼ (Future Pattern)

### 3.1 æ ¸å¿ƒç‰¹ç‚¹

**Futureæ¨¡å¼**ï¼šå¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œé€šè¿‡Futureå¯¹è±¡è·å–ç»“æœã€‚

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å¼‚æ­¥æ‰§è¡Œ** | ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ |
| **ç»“æœè·å–** | é€šè¿‡Futureè·å–ç»“æœ |
| **è¶…æ—¶æ§åˆ¶** | å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ |
| **é€‚ç”¨åœºæ™¯** | è€—æ—¶æ“ä½œã€å¹¶è¡Œè®¡ç®— |

### 3.2 åŸºæœ¬ä½¿ç”¨

```java
import java.util.concurrent.Future;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * Futureæ¨¡å¼åŸºæœ¬ä½¿ç”¨
 * Basic Usage of Future Pattern
 */
public class FutureDemo {
    private ExecutorService executor = Executors.newFixedThreadPool(5);
    
    public void basicUsage() throws Exception {
        // æäº¤ä»»åŠ¡ï¼Œè¿”å›Future
        Future<String> future = executor.submit(() -> {
            Thread.sleep(2000);
            return "ä»»åŠ¡å®Œæˆ";
        });
        
        // æ–¹å¼1ï¼šé˜»å¡è·å–ç»“æœ
        String result = future.get();
        
        // æ–¹å¼2ï¼šè¶…æ—¶è·å–ç»“æœ
        String result2 = future.get(5, TimeUnit.SECONDS);
        
        // æ–¹å¼3ï¼šæ£€æŸ¥æ˜¯å¦å®Œæˆ
        if (future.isDone()) {
            String result3 = future.get();
        }
        
        // æ–¹å¼4ï¼šå–æ¶ˆä»»åŠ¡
        boolean cancelled = future.cancel(true);
    }
    
    // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡
    public void parallelExecution() throws Exception {
        List<Future<String>> futures = new ArrayList<>();
        
        // æäº¤å¤šä¸ªä»»åŠ¡
        for (int i = 0; i < 10; i++) {
            final int taskId = i;
            Future<String> future = executor.submit(() -> {
                return "ä»»åŠ¡" + taskId + "å®Œæˆ";
            });
            futures.add(future);
        }
        
        // æ”¶é›†ç»“æœ
        List<String> results = new ArrayList<>();
        for (Future<String> future : futures) {
            results.add(future.get());
        }
    }
}
```

### 3.3 CompletableFutureï¼ˆJDK 1.8+ï¼‰

```java
import java.util.concurrent.CompletableFuture;

/**
 * CompletableFutureä½¿ç”¨ç¤ºä¾‹
 * CompletableFuture Usage Example
 */
public class CompletableFutureDemo {
    
    // å¼‚æ­¥æ‰§è¡Œ
    public void asyncExecution() {
        CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
            return "å¼‚æ­¥ä»»åŠ¡ç»“æœ";
        });
        
        // é“¾å¼è°ƒç”¨
        future.thenApply(s -> s + "å¤„ç†")
              .thenAccept(System.out::println)
              .thenRun(() -> System.out.println("å®Œæˆ"));
    }
    
    // ç»„åˆå¤šä¸ªFuture
    public void combineFutures() {
        CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> "ç»“æœ1");
        CompletableFuture<String> future2 = CompletableFuture.supplyAsync(() -> "ç»“æœ2");
        
        // ç­‰å¾…ä¸¤ä¸ªFutureéƒ½å®Œæˆ
        CompletableFuture<String> combined = future1.thenCombine(future2, (s1, s2) -> {
            return s1 + " + " + s2;
        });
    }
    
    // å¼‚å¸¸å¤„ç†
    public void exceptionHandling() {
        CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
            throw new RuntimeException("å¼‚å¸¸");
        });
        
        future.exceptionally(ex -> {
            System.out.println("å¤„ç†å¼‚å¸¸: " + ex.getMessage());
            return "é»˜è®¤å€¼";
        });
    }
}
```

### 3.4 åœ¨ç®—åŠ›å¹³å°ä¸­çš„åº”ç”¨

```java
/**
 * ç®—åŠ›å¹³å°ä¸­çš„Futureæ¨¡å¼åº”ç”¨
 * Future Pattern in Computing Platform
 */
public class PlatformFuture {
    
    // åœºæ™¯ï¼šå¹¶è¡Œé‡‡é›†å¤šä¸ªèŠ‚ç‚¹ä¿¡æ¯
    public Map<String, NodeInfo> collectNodeInfoParallel(List<String> nodeIds) {
        List<CompletableFuture<NodeInfo>> futures = nodeIds.stream()
            .map(nodeId -> CompletableFuture.supplyAsync(() -> {
                return nomadClient.getNodeInfo(nodeId);
            }, executorService))
            .collect(Collectors.toList());
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .join();
        
        // æ”¶é›†ç»“æœ
        Map<String, NodeInfo> result = new HashMap<>();
        for (int i = 0; i < nodeIds.size(); i++) {
            result.put(nodeIds.get(i), futures.get(i).join());
        }
        return result;
    }
    
    // åœºæ™¯ï¼šå¼‚æ­¥å¤„ç†ä»»åŠ¡çŠ¶æ€æ›´æ–°
    public void updateTaskStatusAsync(String taskId, TaskStatus status) {
        CompletableFuture.runAsync(() -> {
            // æ›´æ–°æ•°æ®åº“
            taskRepository.updateStatus(taskId, status);
            
            // æ›´æ–°ES
            esClient.updateTaskStatus(taskId, status);
        }, executorService).exceptionally(ex -> {
            logger.error("æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥", ex);
            return null;
        });
    }
}
```

---

## 4. ä¸å˜æ¨¡å¼ (Immutable Pattern)

### 4.1 æ ¸å¿ƒç‰¹ç‚¹

**ä¸å˜æ¨¡å¼ï¼ˆImmutable Patternï¼‰**ï¼šå¯¹è±¡åˆ›å»ºåçŠ¶æ€ä¸å¯å˜ï¼Œå¤©ç„¶çº¿ç¨‹å®‰å…¨ã€‚

**å®ç°æ–¹å¼ï¼š**
- æ‰€æœ‰å­—æ®µ`final`
- ä¸æä¾›setteræ–¹æ³•
- ç±»å£°æ˜ä¸º`final`ï¼ˆé˜²æ­¢ç»§æ‰¿ï¼‰
- è¿”å›æ–°å¯¹è±¡è€Œä¸æ˜¯ä¿®æ”¹åŸå¯¹è±¡

### 4.2 åŸºæœ¬å®ç°

```java
/**
 * ä¸å˜æ¨¡å¼ç¤ºä¾‹
 * Immutable Pattern Example
 */
public final class ImmutablePoint {
    private final int x;
    private final int y;
    
    public ImmutablePoint(int x, int y) {
        this.x = x;
        this.y = y;
    }
    
    public int getX() {
        return x;
    }
    
    public int getY() {
        return y;
    }
    
    // è¿”å›æ–°å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¿®æ”¹åŸå¯¹è±¡
    public ImmutablePoint move(int deltaX, int deltaY) {
        return new ImmutablePoint(x + deltaX, y + deltaY);
    }
}
```

### 4.3 Stringçš„ä¸å˜æ€§

```java
/**
 * Stringä¸å˜æ€§ç¤ºä¾‹
 * String Immutability Example
 */
public class StringImmutability {
    public void demonstrate() {
        String str = "Hello";
        str.concat(" World"); // è¿”å›æ–°Stringï¼ŒåŸStringä¸å˜
        System.out.println(str); // ä»ç„¶æ˜¯"Hello"
        
        String newStr = str.concat(" World"); // éœ€è¦æ¥æ”¶æ–°å¯¹è±¡
        System.out.println(newStr); // "Hello World"
    }
}
```

---

## 5. å·¥ä½œçªƒå–æ¨¡å¼ (Work-Stealing Pattern)

### 5.1 æ ¸å¿ƒç‰¹ç‚¹

**å·¥ä½œçªƒå–æ¨¡å¼ï¼ˆWork-Stealingï¼‰**ï¼šForkJoinPoolä½¿ç”¨çš„æ¨¡å¼ï¼Œç©ºé—²çº¿ç¨‹ä»å…¶ä»–çº¿ç¨‹çš„é˜Ÿåˆ—ä¸­çªƒå–ä»»åŠ¡ã€‚

### 5.2 ForkJoinPool

```java
import java.util.concurrent.ForkJoinPool;
import java.util.concurrent.RecursiveTask;

/**
 * ForkJoinPoolå·¥ä½œçªƒå–ç¤ºä¾‹
 * ForkJoinPool Work-Stealing Example
 */
public class ForkJoinDemo {
    public static void main(String[] args) {
        ForkJoinPool pool = new ForkJoinPool();
        
        // æäº¤ä»»åŠ¡
        Long result = pool.invoke(new SumTask(1, 1000000));
        System.out.println("ç»“æœ: " + result);
    }
    
    static class SumTask extends RecursiveTask<Long> {
        private final int start;
        private final int end;
        private static final int THRESHOLD = 10000;
        
        public SumTask(int start, int end) {
            this.start = start;
            this.end = end;
        }
        
        @Override
        protected Long compute() {
            if (end - start <= THRESHOLD) {
                // ç›´æ¥è®¡ç®—
                long sum = 0;
                for (int i = start; i <= end; i++) {
                    sum += i;
                }
                return sum;
            } else {
                // åˆ†å‰²ä»»åŠ¡
                int mid = (start + end) / 2;
                SumTask left = new SumTask(start, mid);
                SumTask right = new SumTask(mid + 1, end);
                
                left.fork(); // å¼‚æ­¥æ‰§è¡Œ
                Long rightResult = right.compute(); // åŒæ­¥æ‰§è¡Œ
                Long leftResult = left.join(); // ç­‰å¾…ç»“æœ
                
                return leftResult + rightResult;
            }
        }
    }
}
```

---

## 6. æœ€ä½³å®è·µ (Best Practices)

### 6.1 ThreadLocalå¿…é¡»remove

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å®Œremove
try {
    threadLocal.set(value);
    // ä½¿ç”¨ThreadLocal
} finally {
    threadLocal.remove(); // å¿…é¡»remove
}

// âŒ é”™è¯¯ï¼šå¿˜è®°removeï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
threadLocal.set(value);
// ä½¿ç”¨ThreadLocal
// å¿˜è®°remove
```

### 6.2 Futureè®¾ç½®è¶…æ—¶

```java
// âœ… æ­£ç¡®ï¼šè®¾ç½®è¶…æ—¶
Future<String> future = executor.submit(task);
try {
    String result = future.get(5, TimeUnit.SECONDS);
} catch (TimeoutException e) {
    future.cancel(true); // å–æ¶ˆä»»åŠ¡
}

// âŒ é”™è¯¯ï¼šæ— é™ç­‰å¾…
String result = future.get(); // å¯èƒ½æ°¸è¿œç­‰å¾…
```

### 6.3 ä½¿ç”¨ä¸å˜å¯¹è±¡

```java
// âœ… æ¨èï¼šä½¿ç”¨ä¸å˜å¯¹è±¡
public final class Config {
    private final String key;
    private final String value;
    // ...
}

// âŒ ä¸æ¨èï¼šå¯å˜å¯¹è±¡éœ€è¦åŒæ­¥
public class Config {
    private String key;
    private String value;
    // éœ€è¦synchronizedä¿æŠ¤
}
```

---

## 7. é¢è¯•é«˜é¢‘é—®é¢˜ (Interview Questions)

### Q1: ThreadLocalçš„å®ç°åŸç†ï¼Ÿ

**ç­”æ¡ˆï¼š** æ¯ä¸ªThreadæœ‰ä¸€ä¸ªThreadLocalMapï¼ŒThreadLocalä½œä¸ºkeyå­˜å‚¨å€¼ï¼Œå®ç°çº¿ç¨‹éš”ç¦»ã€‚

### Q2: ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Ÿ

**ç­”æ¡ˆï¼š** ThreadLocalMap.Entryçš„valueæ˜¯å¼ºå¼•ç”¨ï¼Œå¦‚æœThreadLocalè¢«å›æ”¶ä½†valueè¿˜åœ¨ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚ä½¿ç”¨å®Œå¿…é¡»remove()ã€‚

### Q3: Futureå’ŒCompletableFutureçš„åŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼š** CompletableFutureæ”¯æŒé“¾å¼è°ƒç”¨ã€ç»„åˆå¤šä¸ªFutureã€æ›´å¥½çš„å¼‚å¸¸å¤„ç†ã€‚

### Q4: ä»€ä¹ˆæ˜¯å·¥ä½œçªƒå–æ¨¡å¼ï¼Ÿ

**ç­”æ¡ˆï¼š** ForkJoinPoolä½¿ç”¨çš„æ¨¡å¼ï¼Œç©ºé—²çº¿ç¨‹ä»å…¶ä»–çº¿ç¨‹çš„é˜Ÿåˆ—ä¸­çªƒå–ä»»åŠ¡ï¼Œæé«˜CPUåˆ©ç”¨ç‡ã€‚

### Q5: ä¸å˜æ¨¡å¼çš„ä¼˜åŠ¿ï¼Ÿ

**ç­”æ¡ˆï¼š** å¤©ç„¶çº¿ç¨‹å®‰å…¨ï¼Œä¸éœ€è¦åŒæ­¥ï¼Œæ€§èƒ½å¥½ï¼Œæ˜“äºç†è§£ã€‚

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [ThreadLocal API](https://docs.oracle.com/javase/8/docs/api/java/lang/ThreadLocal.html)
- [CompletableFuture API](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html)
- [ForkJoinPool API](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ForkJoinPool.html)

---

**è¿”å›ï¼š** [07-Javaå¹¶å‘ç¼–ç¨‹](./07-Javaå¹¶å‘ç¼–ç¨‹.md)  
**ä¸Šä¸€ç« ï¼š** [07-07 - åŸå­ç±»ä¸CAS](./07-07-åŸå­ç±»ä¸CAS.md)  
**ä¸‹ä¸€ç« ï¼š** [07-09 - æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ â†’](./07-09-æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ.md)

