# çº¿ç¨‹åŒæ­¥ä¸å†…å­˜æ¨¡å‹ (Thread Synchronization & Memory Model)

> æ·±å…¥ç†è§£synchronizedã€volatileå…³é”®å­—ï¼ŒæŒæ¡Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰å’Œhappens-beforeè§„åˆ™

## ç›®å½•
- [1. ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥](#1-ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥)
- [2. synchronizedå…³é”®å­—](#2-synchronizedå…³é”®å­—)
- [3. volatileå…³é”®å­—](#3-volatileå…³é”®å­—)
- [4. Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰](#4-javaå†…å­˜æ¨¡å‹jmm)
- [5. happens-beforeè§„åˆ™](#5-happens-beforeè§„åˆ™)
- [6. synchronizedå’Œvolatileçš„åŒºåˆ«](#6-synchronizedå’Œvolatileçš„åŒºåˆ«)
- [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
- [8. é¢è¯•é«˜é¢‘é—®é¢˜](#8-é¢è¯•é«˜é¢‘é—®é¢˜)

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥ (Why Synchronization?)

### 1.1 çº¿ç¨‹å®‰å…¨é—®é¢˜

å½“å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå¦‚æœæ²¡æœ‰åŒæ­¥æœºåˆ¶ï¼Œå¯èƒ½å‡ºç°ï¼š

1. **ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰** - å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«å˜é‡
2. **æ•°æ®ä¸ä¸€è‡´** - è¯»å–åˆ°ä¸­é—´çŠ¶æ€çš„æ•°æ®
3. **å¯è§æ€§é—®é¢˜** - ä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹ä¸å¯è§

### 1.2 ç¤ºä¾‹ï¼šçº¿ç¨‹ä¸å®‰å…¨çš„è®¡æ•°å™¨

```java
/**
 * çº¿ç¨‹ä¸å®‰å…¨çš„è®¡æ•°å™¨ç¤ºä¾‹
 * Unsafe Counter Example
 */
public class UnsafeCounter {
    private int count = 0;
    
    public void increment() {
        count++; // ä¸æ˜¯åŸå­æ“ä½œï¼
    }
    
    public int getCount() {
        return count;
    }
    
    public static void main(String[] args) throws InterruptedException {
        UnsafeCounter counter = new UnsafeCounter();
        
        // åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¢åŠ 1000æ¬¡
        Thread[] threads = new Thread[10];
        for (int i = 0; i < 10; i++) {
            threads[i] = new Thread(() -> {
                for (int j = 0; j < 1000; j++) {
                    counter.increment();
                }
            });
            threads[i].start();
        }
        
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        for (Thread thread : threads) {
            thread.join();
        }
        
        // æœŸæœ›ç»“æœï¼š10000ï¼Œå®é™…å¯èƒ½å°äº10000
        System.out.println("æœ€ç»ˆè®¡æ•°: " + counter.getCount());
    }
}
```

**é—®é¢˜åˆ†æï¼š**

`count++` ä¸æ˜¯åŸå­æ“ä½œï¼Œå®é™…åŒ…å«3æ­¥ï¼š
1. è¯»å–countçš„å€¼
2. å°†å€¼åŠ 1
3. å†™å›count

å¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¯»å–åˆ°ç›¸åŒçš„å€¼ï¼Œå¯¼è‡´ä¸¢å¤±æ›´æ–°ã€‚

### 1.3 åœ¨ç®—åŠ›å¹³å°ä¸­çš„åº”ç”¨

åœ¨ç®—åŠ›å¹³å°çš„ç»“ç®—ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶å¤„ç†ç”¨æˆ·é’±åŒ…çš„æ‰£è´¹æ“ä½œï¼Œå¿…é¡»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š

```java
// çº¿ç¨‹ä¸å®‰å…¨çš„é’±åŒ…æ“ä½œ
public class UnsafeWallet {
    private Long balance = 1000L;
    
    public void deduct(Long amount) {
        if (balance >= amount) {
            balance -= amount; // çº¿ç¨‹ä¸å®‰å…¨ï¼
        }
    }
}

// çº¿ç¨‹å®‰å…¨çš„é’±åŒ…æ“ä½œï¼ˆä½¿ç”¨synchronizedï¼‰
public class SafeWallet {
    private Long balance = 1000L;
    
    public synchronized void deduct(Long amount) {
        if (balance >= amount) {
            balance -= amount; // çº¿ç¨‹å®‰å…¨
        }
    }
}
```

---

## 2. synchronizedå…³é”®å­— (synchronized Keyword)

### 2.1 synchronizedçš„ä½œç”¨

`synchronized`å…³é”®å­—æä¾›äº†ä¸€ç§**äº’æ–¥é”ï¼ˆMutex Lockï¼‰**æœºåˆ¶ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œè¢«ä¿æŠ¤çš„ä»£ç å—ã€‚

**ä½œç”¨ï¼š**
1. **åŸå­æ€§ï¼ˆAtomicityï¼‰** - ä¿è¯æ“ä½œçš„åŸå­æ€§
2. **å¯è§æ€§ï¼ˆVisibilityï¼‰** - ä¿è¯å˜é‡çš„å¯è§æ€§
3. **æœ‰åºæ€§ï¼ˆOrderingï¼‰** - ä¿è¯ä¸€å®šçš„æ‰§è¡Œé¡ºåº

### 2.2 synchronizedçš„ç”¨æ³•

#### æ–¹å¼ä¸€ï¼šåŒæ­¥æ–¹æ³•ï¼ˆSynchronized Methodï¼‰

```java
/**
 * åŒæ­¥æ–¹æ³•ç¤ºä¾‹
 * Synchronized Method Example
 */
public class SynchronizedCounter {
    private int count = 0;
    
    // åŒæ­¥å®ä¾‹æ–¹æ³•ï¼šé”å¯¹è±¡æ˜¯this
    public synchronized void increment() {
        count++;
    }
    
    // åŒæ­¥é™æ€æ–¹æ³•ï¼šé”å¯¹è±¡æ˜¯ç±»å¯¹è±¡ï¼ˆSynchronizedCounter.classï¼‰
    public static synchronized void staticMethod() {
        // é™æ€æ–¹æ³•åŒæ­¥
    }
    
    public int getCount() {
        return count;
    }
}
```

**é”å¯¹è±¡ï¼š**
- å®ä¾‹æ–¹æ³•ï¼šé”å¯¹è±¡æ˜¯`this`ï¼ˆå½“å‰å®ä¾‹ï¼‰
- é™æ€æ–¹æ³•ï¼šé”å¯¹è±¡æ˜¯ç±»å¯¹è±¡ï¼ˆ`Class`å¯¹è±¡ï¼‰

#### æ–¹å¼äºŒï¼šåŒæ­¥ä»£ç å—ï¼ˆSynchronized Blockï¼‰

```java
/**
 * åŒæ­¥ä»£ç å—ç¤ºä¾‹
 * Synchronized Block Example
 */
public class SynchronizedBlock {
    private int count = 0;
    private final Object lock = new Object(); // é”å¯¹è±¡
    
    public void increment() {
        // åŒæ­¥ä»£ç å—ï¼šé”å¯¹è±¡æ˜¯lock
        synchronized (lock) {
            count++;
        }
    }
    
    // ä¹Ÿå¯ä»¥ä½¿ç”¨thisä½œä¸ºé”å¯¹è±¡
    public void increment2() {
        synchronized (this) {
            count++;
        }
    }
    
    // ä½¿ç”¨ç±»å¯¹è±¡ä½œä¸ºé”ï¼ˆé™æ€åŒæ­¥ï¼‰
    public void staticSync() {
        synchronized (SynchronizedBlock.class) {
            // é™æ€åŒæ­¥ä»£ç å—
        }
    }
}
```

**ä¼˜åŠ¿ï¼š** å¯ä»¥æ›´ç»†ç²’åº¦åœ°æ§åˆ¶é”çš„èŒƒå›´ï¼Œæé«˜æ€§èƒ½ã€‚

### 2.3 synchronizedçš„å¯é‡å…¥æ€§ï¼ˆReentrantï¼‰

```java
/**
 * synchronizedå¯é‡å…¥æ€§ç¤ºä¾‹
 * Reentrant Synchronization Example
 */
public class ReentrantDemo {
    public synchronized void method1() {
        System.out.println("method1");
        method2(); // è°ƒç”¨å¦ä¸€ä¸ªåŒæ­¥æ–¹æ³•
    }
    
    public synchronized void method2() {
        System.out.println("method2");
    }
    
    public static void main(String[] args) {
        ReentrantDemo demo = new ReentrantDemo();
        demo.method1(); // å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œä¸ä¼šæ­»é”
    }
}
```

**å¯é‡å…¥æ€§ï¼š** åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€ä¸ªé”ï¼Œä¸ä¼šæ­»é”ã€‚

### 2.4 é”çš„é‡Šæ”¾

```java
/**
 * é”çš„é‡Šæ”¾æ—¶æœº
 * Lock Release Timing
 */
public class LockRelease {
    public synchronized void method1() {
        // æ‰§è¡Œä»£ç 
        // æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œè‡ªåŠ¨é‡Šæ”¾é”
    }
    
    public void method2() {
        synchronized (this) {
            // æ‰§è¡Œä»£ç 
            // ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œè‡ªåŠ¨é‡Šæ”¾é”
        }
    }
    
    public void method3() {
        synchronized (this) {
            if (condition) {
                return; // æå‰è¿”å›ï¼Œé”ä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾
            }
            // å…¶ä»–ä»£ç 
        }
    }
    
    public void method4() {
        synchronized (this) {
            try {
                // å¯èƒ½æŠ›å‡ºå¼‚å¸¸
                riskyOperation();
            } catch (Exception e) {
                // å³ä½¿æŠ›å‡ºå¼‚å¸¸ï¼Œé”ä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾
            }
        }
    }
}
```

**é”çš„é‡Šæ”¾æ—¶æœºï¼š**
1. åŒæ­¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•
2. åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•
3. æ–¹æ³•æå‰è¿”å›ï¼ˆreturnï¼‰
4. æŠ›å‡ºå¼‚å¸¸

### 2.5 å¯¹è±¡é” vs ç±»é”

```java
/**
 * å¯¹è±¡é” vs ç±»é”
 * Instance Lock vs Class Lock
 */
public class LockType {
    private int instanceVar = 0;
    private static int staticVar = 0;
    
    // å¯¹è±¡é”ï¼šä¸åŒå®ä¾‹ä¹‹é—´ä¸äº’æ–¥
    public synchronized void instanceMethod() {
        instanceVar++;
    }
    
    // ç±»é”ï¼šæ‰€æœ‰å®ä¾‹å…±äº«ï¼Œäº’æ–¥
    public static synchronized void staticMethod() {
        staticVar++;
    }
    
    public static void main(String[] args) {
        LockType obj1 = new LockType();
        LockType obj2 = new LockType();
        
        // å¯¹è±¡é”ï¼šobj1å’Œobj2ä¸äº’æ–¥ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œ
        new Thread(() -> obj1.instanceMethod()).start();
        new Thread(() -> obj2.instanceMethod()).start();
        
        // ç±»é”ï¼šæ‰€æœ‰å®ä¾‹å…±äº«ï¼Œäº’æ–¥
        new Thread(() -> LockType.staticMethod()).start();
        new Thread(() -> LockType.staticMethod()).start();
    }
}
```

---

## 3. volatileå…³é”®å­— (volatile Keyword)

### 3.1 volatileçš„ä½œç”¨

`volatile`å…³é”®å­—ä¿è¯å˜é‡çš„**å¯è§æ€§**å’Œ**æœ‰åºæ€§**ï¼Œä½†ä¸ä¿è¯**åŸå­æ€§**ã€‚

**ä½œç”¨ï¼š**
1. **å¯è§æ€§** - ä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§
2. **æœ‰åºæ€§** - ç¦æ­¢æŒ‡ä»¤é‡æ’åº
3. **ä¸ä¿è¯åŸå­æ€§** - ä¸èƒ½æ›¿ä»£synchronized

### 3.2 å¯è§æ€§é—®é¢˜ç¤ºä¾‹

```java
/**
 * å¯è§æ€§é—®é¢˜ç¤ºä¾‹
 * Visibility Problem Example
 */
public class VisibilityProblem {
    // ä¸ä½¿ç”¨volatileï¼šå¯èƒ½å‡ºç°å¯è§æ€§é—®é¢˜
    private boolean flag = false;
    
    public void setFlag() {
        flag = true;
    }
    
    public void checkFlag() {
        while (!flag) {
            // å¯èƒ½æ°¸è¿œå¾ªç¯ï¼Œå› ä¸ºçœ‹ä¸åˆ°flagçš„å˜åŒ–
        }
        System.out.println("Flag is true");
    }
    
    public static void main(String[] args) {
        VisibilityProblem demo = new VisibilityProblem();
        
        // çº¿ç¨‹1ï¼šè®¾ç½®flag
        new Thread(() -> {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            demo.setFlag();
        }).start();
        
        // çº¿ç¨‹2ï¼šæ£€æŸ¥flagï¼ˆå¯èƒ½æ°¸è¿œçœ‹ä¸åˆ°å˜åŒ–ï¼‰
        new Thread(() -> {
            demo.checkFlag();
        }).start();
    }
}
```

**ä½¿ç”¨volatileè§£å†³ï¼š**

```java
public class VisibilitySolution {
    // ä½¿ç”¨volatileï¼šä¿è¯å¯è§æ€§
    private volatile boolean flag = false;
    
    public void setFlag() {
        flag = true; // ä¿®æ”¹ç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜
    }
    
    public void checkFlag() {
        while (!flag) {
            // æ¯æ¬¡å¾ªç¯éƒ½ä¼šä»ä¸»å†…å­˜è¯»å–flagçš„æœ€æ–°å€¼
        }
        System.out.println("Flag is true");
    }
}
```

### 3.3 volatileä¸ä¿è¯åŸå­æ€§

```java
/**
 * volatileä¸ä¿è¯åŸå­æ€§ç¤ºä¾‹
 * volatile Does Not Guarantee Atomicity
 */
public class VolatileAtomicity {
    private volatile int count = 0;
    
    public void increment() {
        count++; // ä¸æ˜¯åŸå­æ“ä½œï¼
    }
    
    public static void main(String[] args) throws InterruptedException {
        VolatileAtomicity demo = new VolatileAtomicity();
        
        Thread[] threads = new Thread[10];
        for (int i = 0; i < 10; i++) {
            threads[i] = new Thread(() -> {
                for (int j = 0; j < 1000; j++) {
                    demo.increment();
                }
            });
            threads[i].start();
        }
        
        for (Thread thread : threads) {
            thread.join();
        }
        
        // ç»“æœå¯èƒ½å°äº10000ï¼Œå› ä¸ºvolatileä¸ä¿è¯åŸå­æ€§
        System.out.println("æœ€ç»ˆè®¡æ•°: " + demo.count);
    }
}
```

**volatileé€‚ç”¨åœºæ™¯ï¼š**
- å•å†™å¤šè¯»åœºæ™¯
- çŠ¶æ€æ ‡å¿—ä½
- ä¸ä¾èµ–å½“å‰å€¼çš„æ“ä½œ

### 3.4 volatileç¦æ­¢æŒ‡ä»¤é‡æ’åº

```java
/**
 * volatileç¦æ­¢æŒ‡ä»¤é‡æ’åºç¤ºä¾‹
 * volatile Prevents Instruction Reordering
 */
public class ReorderingExample {
    private int a = 0;
    private int b = 0;
    private volatile boolean flag = false;
    
    // çº¿ç¨‹1
    public void writer() {
        a = 1;      // 1
        b = 2;      // 2
        flag = true; // 3 - volatileå†™ï¼Œä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°ä¹‹å
    }
    
    // çº¿ç¨‹2
    public void reader() {
        if (flag) { // volatileè¯»ï¼Œä¹‹åçš„æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°ä¹‹å‰
            int sum = a + b; // ä¿è¯çœ‹åˆ°a=1, b=2
        }
    }
}
```

---

## 4. Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰(Java Memory Model)

### 4.1 JMMæ¦‚è¿°

**Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰**å®šä¹‰äº†Javaè™šæ‹Ÿæœºå¦‚ä½•ä¸è®¡ç®—æœºå†…å­˜äº¤äº’ï¼Œè§„å®šäº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å˜é‡çš„è¯»å†™è§„åˆ™ã€‚

### 4.2 å†…å­˜åŒºåŸŸåˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰          â”‚
â”‚  å…±äº«å˜é‡ï¼ˆæ‰€æœ‰çº¿ç¨‹å¯è§ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘                    â†“
           â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚  çº¿ç¨‹1      â”‚      â”‚  çº¿ç¨‹2      â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚å·¥ä½œå†…å­˜  â”‚ â”‚      â”‚ â”‚å·¥ä½œå†…å­˜  â”‚ â”‚
    â”‚ â”‚æœ¬åœ°å˜é‡  â”‚ â”‚      â”‚ â”‚æœ¬åœ°å˜é‡  â”‚ â”‚
    â”‚ â”‚å‰¯æœ¬      â”‚ â”‚      â”‚ â”‚å‰¯æœ¬      â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å†…å­˜åŒºåŸŸï¼š**
1. **ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰** - æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå­˜å‚¨å…±äº«å˜é‡
2. **å·¥ä½œå†…å­˜ï¼ˆWorking Memoryï¼‰** - çº¿ç¨‹ç§æœ‰ï¼Œå­˜å‚¨å˜é‡çš„å‰¯æœ¬

### 4.3 å†…å­˜äº¤äº’æ“ä½œ

JMMå®šä¹‰äº†8ç§å†…å­˜æ“ä½œï¼š

1. **lockï¼ˆé”å®šï¼‰** - ä½œç”¨äºä¸»å†…å­˜ï¼Œæ ‡è¯†å˜é‡ä¸ºçº¿ç¨‹ç‹¬å 
2. **unlockï¼ˆè§£é”ï¼‰** - ä½œç”¨äºä¸»å†…å­˜ï¼Œé‡Šæ”¾é”å®šçŠ¶æ€
3. **readï¼ˆè¯»å–ï¼‰** - ä½œç”¨äºä¸»å†…å­˜ï¼Œå°†å˜é‡å€¼ä¼ è¾“åˆ°å·¥ä½œå†…å­˜
4. **loadï¼ˆè½½å…¥ï¼‰** - ä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œå°†readçš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜å˜é‡å‰¯æœ¬
5. **useï¼ˆä½¿ç”¨ï¼‰** - ä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œå°†å˜é‡å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“
6. **assignï¼ˆèµ‹å€¼ï¼‰** - ä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œå°†æ‰§è¡Œå¼•æ“çš„å€¼èµ‹ç»™å˜é‡
7. **storeï¼ˆå­˜å‚¨ï¼‰** - ä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œå°†å˜é‡å€¼ä¼ è¾“åˆ°ä¸»å†…å­˜
8. **writeï¼ˆå†™å…¥ï¼‰** - ä½œç”¨äºä¸»å†…å­˜ï¼Œå°†storeçš„å€¼å†™å…¥ä¸»å†…å­˜å˜é‡

**æ“ä½œé¡ºåºï¼š**
```
read â†’ load â†’ use â†’ assign â†’ store â†’ write
```

### 4.4 å¯è§æ€§é—®é¢˜çš„æ ¹æº

```java
/**
 * å¯è§æ€§é—®é¢˜çš„æ ¹æº
 * Root Cause of Visibility Problem
 */
public class JMMExample {
    private int count = 0; // ä¸»å†…å­˜ä¸­çš„å˜é‡
    
    public void increment() {
        // çº¿ç¨‹1çš„å·¥ä½œå†…å­˜
        int temp = count;  // read + loadï¼šä»ä¸»å†…å­˜è¯»å–åˆ°å·¥ä½œå†…å­˜
        temp = temp + 1;   // use + assignï¼šåœ¨å·¥ä½œå†…å­˜ä¸­è®¡ç®—
        count = temp;      // store + writeï¼šå†™å›ä¸»å†…å­˜ï¼ˆå¯èƒ½å»¶è¿Ÿï¼‰
    }
    
    public int getCount() {
        // çº¿ç¨‹2çš„å·¥ä½œå†…å­˜
        return count;      // read + loadï¼šä»ä¸»å†…å­˜è¯»å–ï¼ˆå¯èƒ½è¯»åˆ°æ—§å€¼ï¼‰
    }
}
```

**é—®é¢˜ï¼š** å·¥ä½œå†…å­˜çš„æ›´æ–°å¯èƒ½ä¸ä¼šç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹çœ‹ä¸åˆ°æœ€æ–°å€¼ã€‚

---

## 5. happens-beforeè§„åˆ™ (happens-before Rules)

### 5.1 ä»€ä¹ˆæ˜¯happens-beforeï¼Ÿ

**happens-before**æ˜¯JMMå®šä¹‰çš„å†…å­˜å¯è§æ€§è§„åˆ™ï¼Œå¦‚æœæ“ä½œA happens-beforeæ“ä½œBï¼Œé‚£ä¹ˆAçš„ç»“æœå¯¹Bå¯è§ã€‚

### 5.2 happens-beforeè§„åˆ™

#### 1. ç¨‹åºé¡ºåºè§„åˆ™ï¼ˆProgram Order Ruleï¼‰

```java
int a = 1;  // 1
int b = 2;  // 2
// 1 happens-before 2
```

**è§„åˆ™ï¼š** åŒä¸€çº¿ç¨‹ä¸­ï¼Œå‰é¢çš„æ“ä½œhappens-beforeåé¢çš„æ“ä½œã€‚

#### 2. ç›‘è§†å™¨é”è§„åˆ™ï¼ˆMonitor Lock Ruleï¼‰

```java
synchronized (lock) {
    // æ“ä½œA
}
// æ“ä½œA happens-before é‡Šæ”¾é”

synchronized (lock) {
    // æ“ä½œB
}
// è·å–é” happens-before æ“ä½œB
```

**è§„åˆ™ï¼š** è§£é”æ“ä½œhappens-beforeåç»­çš„åŠ é”æ“ä½œã€‚

#### 3. volatileå˜é‡è§„åˆ™ï¼ˆVolatile Variable Ruleï¼‰

```java
volatile int flag = 0;

// çº¿ç¨‹1
flag = 1; // volatileå†™

// çº¿ç¨‹2
if (flag == 1) { // volatileè¯»
    // èƒ½çœ‹åˆ°flag=1
}
```

**è§„åˆ™ï¼š** volatileå†™happens-beforeåç»­çš„volatileè¯»ã€‚

#### 4. çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼ˆThread Start Ruleï¼‰

```java
Thread thread = new Thread(() -> {
    // æ“ä½œB
});
// æ“ä½œA
thread.start(); // æ“ä½œA happens-before æ“ä½œB
```

**è§„åˆ™ï¼š** start()è°ƒç”¨happens-beforeçº¿ç¨‹ä¸­çš„ä»»ä½•æ“ä½œã€‚

#### 5. çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼ˆThread Termination Ruleï¼‰

```java
Thread thread = new Thread(() -> {
    // æ“ä½œA
});
thread.start();
thread.join(); // æ“ä½œA happens-before join()è¿”å›
// æ“ä½œB
```

**è§„åˆ™ï¼š** çº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œhappens-beforeå…¶ä»–çº¿ç¨‹çš„join()è¿”å›ã€‚

#### 6. ä¸­æ–­è§„åˆ™ï¼ˆInterruption Ruleï¼‰

```java
thread.interrupt(); // æ“ä½œA
// æ“ä½œA happens-before çº¿ç¨‹æ£€æµ‹åˆ°ä¸­æ–­
```

**è§„åˆ™ï¼š** interrupt()è°ƒç”¨happens-beforeè¢«ä¸­æ–­çº¿ç¨‹æ£€æµ‹åˆ°ä¸­æ–­ã€‚

#### 7. ä¼ é€’æ€§è§„åˆ™ï¼ˆTransitivity Ruleï¼‰

```java
// å¦‚æœ A happens-before B
// ä¸” B happens-before C
// é‚£ä¹ˆ A happens-before C
```

---

## 6. synchronizedå’Œvolatileçš„åŒºåˆ« (synchronized vs volatile)

### 6.1 å¯¹æ¯”è¡¨

| ç‰¹æ€§ | synchronized | volatile |
|------|-------------|----------|
| **åŸå­æ€§** | âœ… ä¿è¯ | âŒ ä¸ä¿è¯ |
| **å¯è§æ€§** | âœ… ä¿è¯ | âœ… ä¿è¯ |
| **æœ‰åºæ€§** | âœ… ä¿è¯ | âœ… ä¿è¯ |
| **æ€§èƒ½** | è¾ƒä½ï¼ˆé‡é‡çº§é”ï¼‰ | è¾ƒé«˜ï¼ˆè½»é‡çº§ï¼‰ |
| **ä½¿ç”¨åœºæ™¯** | å¤šå†™åœºæ™¯ã€å¤æ‚åŒæ­¥ | å•å†™å¤šè¯»ã€çŠ¶æ€æ ‡å¿— |
| **é”æœºåˆ¶** | äº’æ–¥é” | æ— é” |

### 6.2 ä½¿ç”¨å»ºè®®

**ä½¿ç”¨synchronizedï¼š**
- éœ€è¦ä¿è¯åŸå­æ€§
- å¤šçº¿ç¨‹å†™æ“ä½œ
- å¤æ‚çš„åŒæ­¥é€»è¾‘

**ä½¿ç”¨volatileï¼š**
- å•å†™å¤šè¯»åœºæ™¯
- çŠ¶æ€æ ‡å¿—ä½
- ä¸ä¾èµ–å½“å‰å€¼çš„æ“ä½œ

**ç¤ºä¾‹ï¼šå•ä¾‹æ¨¡å¼ï¼ˆåŒé‡æ£€æŸ¥é”å®šï¼‰**

```java
/**
 * åŒé‡æ£€æŸ¥é”å®šå•ä¾‹æ¨¡å¼
 * Double-Checked Locking Singleton
 */
public class Singleton {
    private static volatile Singleton instance; // å¿…é¡»ä½¿ç”¨volatile
    
    private Singleton() {}
    
    public static Singleton getInstance() {
        if (instance == null) { // ç¬¬ä¸€æ¬¡æ£€æŸ¥
            synchronized (Singleton.class) {
                if (instance == null) { // ç¬¬äºŒæ¬¡æ£€æŸ¥
                    instance = new Singleton(); // éœ€è¦volatileä¿è¯å¯è§æ€§
                }
            }
        }
        return instance;
    }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦volatileï¼Ÿ**

`new Singleton()`ä¸æ˜¯åŸå­æ“ä½œï¼ŒåŒ…å«ï¼š
1. åˆ†é…å†…å­˜ç©ºé—´
2. åˆå§‹åŒ–å¯¹è±¡
3. å°†å¼•ç”¨èµ‹å€¼ç»™instance

å¦‚æœæ²¡æœ‰volatileï¼Œæ­¥éª¤2å’Œ3å¯èƒ½é‡æ’åºï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹çœ‹åˆ°æœªåˆå§‹åŒ–çš„å¯¹è±¡ã€‚

---

## 7. æœ€ä½³å®è·µ (Best Practices)

### 7.1 å‡å°‘é”çš„ç²’åº¦

```java
// âŒ ä¸æ¨èï¼šé”èŒƒå›´å¤ªå¤§
public synchronized void process() {
    // ä¸éœ€è¦åŒæ­¥çš„ä»£ç 
    doSomething();
    // éœ€è¦åŒæ­¥çš„ä»£ç 
    synchronized (this) {
        count++;
    }
    // ä¸éœ€è¦åŒæ­¥çš„ä»£ç 
    doSomethingElse();
}

// âœ… æ¨èï¼šåªé”å¿…è¦çš„ä»£ç 
public void process() {
    doSomething();
    synchronized (this) {
        count++;
    }
    doSomethingElse();
}
```

### 7.2 é¿å…æ­»é”

```java
// âŒ ä¸æ¨èï¼šå¯èƒ½æ­»é”
public void method1() {
    synchronized (lockA) {
        synchronized (lockB) {
            // ...
        }
    }
}

public void method2() {
    synchronized (lockB) {
        synchronized (lockA) { // ä¸åŒçš„é”é¡ºåºï¼Œå¯èƒ½æ­»é”
            // ...
        }
    }
}

// âœ… æ¨èï¼šç»Ÿä¸€é”é¡ºåº
public void method1() {
    synchronized (lockA) {
        synchronized (lockB) {
            // ...
        }
    }
}

public void method2() {
    synchronized (lockA) { // ç›¸åŒçš„é”é¡ºåº
        synchronized (lockB) {
            // ...
        }
    }
}
```

### 7.3 ä½¿ç”¨finalå­—æ®µ

```java
// âœ… æ¨èï¼šfinalå­—æ®µå¤©ç„¶çº¿ç¨‹å®‰å…¨
public class SafeObject {
    private final int value; // finalå­—æ®µï¼Œçº¿ç¨‹å®‰å…¨
    
    public SafeObject(int value) {
        this.value = value;
    }
}
```

### 7.4 é¿å…åœ¨å¾ªç¯ä¸­åŠ é”

```java
// âŒ ä¸æ¨èï¼šåœ¨å¾ªç¯ä¸­åŠ é”
public void process(List<String> items) {
    for (String item : items) {
        synchronized (this) {
            processItem(item);
        }
    }
}

// âœ… æ¨èï¼šåœ¨å¾ªç¯å¤–åŠ é”
public void process(List<String> items) {
    synchronized (this) {
        for (String item : items) {
            processItem(item);
        }
    }
}
```

---

## 8. é¢è¯•é«˜é¢‘é—®é¢˜ (Interview Questions)

### Q1: synchronizedå’Œvolatileçš„åŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼š** è§[6. synchronizedå’Œvolatileçš„åŒºåˆ«](#6-synchronizedå’Œvolatileçš„åŒºåˆ«)

### Q2: volatileèƒ½ä¿è¯åŸå­æ€§å—ï¼Ÿ

**ç­”æ¡ˆï¼š** ä¸èƒ½ã€‚volatileåªä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œä¸ä¿è¯åŸå­æ€§ã€‚ä¾‹å¦‚`count++`ä¸æ˜¯åŸå­æ“ä½œã€‚

### Q3: ä»€ä¹ˆæ˜¯Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰ï¼Ÿ

**ç­”æ¡ˆï¼š** JMMå®šä¹‰äº†Javaè™šæ‹Ÿæœºå¦‚ä½•ä¸å†…å­˜äº¤äº’ï¼Œè§„å®šäº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å˜é‡çš„è¯»å†™è§„åˆ™ï¼ŒåŒ…æ‹¬ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„æ¦‚å¿µã€‚

### Q4: happens-beforeè§„åˆ™æœ‰å“ªäº›ï¼Ÿ

**ç­”æ¡ˆï¼š** ç¨‹åºé¡ºåºè§„åˆ™ã€ç›‘è§†å™¨é”è§„åˆ™ã€volatileå˜é‡è§„åˆ™ã€çº¿ç¨‹å¯åŠ¨è§„åˆ™ã€çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ã€ä¸­æ–­è§„åˆ™ã€ä¼ é€’æ€§è§„åˆ™ã€‚

### Q5: åŒé‡æ£€æŸ¥é”å®šä¸ºä»€ä¹ˆéœ€è¦volatileï¼Ÿ

**ç­”æ¡ˆï¼š** é˜²æ­¢æŒ‡ä»¤é‡æ’åºï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹çœ‹åˆ°å®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡ã€‚

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [Java Memory Model](https://docs.oracle.com/javase/specs/jls/se17/html/jls-17.html)
- [The Java Memory Model](http://www.cs.umd.edu/~pugh/java/memoryModel/)

---

**è¿”å›ï¼š** [07-Javaå¹¶å‘ç¼–ç¨‹](./07-Javaå¹¶å‘ç¼–ç¨‹.md)  
**ä¸Šä¸€ç« ï¼š** [07-01 - çº¿ç¨‹åŸºç¡€](./07-01-çº¿ç¨‹åŸºç¡€.md)  
**ä¸‹ä¸€ç« ï¼š** [07-03 - é”æœºåˆ¶ â†’](./07-03-é”æœºåˆ¶.md)

