# å¸¸è§é—®é¢˜ FAQ

## ğŸ” è®¤è¯ç›¸å…³

### Q1: Tokenè¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ

**A:** SDKä¼šè‡ªåŠ¨å¤„ç†Tokenè¿‡æœŸçš„æƒ…å†µï¼š

1. **è‡ªåŠ¨åˆ·æ–°æ¨¡å¼ï¼ˆæ¨èï¼‰**
```yaml
auth:
  token:
    auto-refresh: true
    refresh-threshold: 300  # Tokenè¿‡æœŸå‰5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
```

2. **æ‰‹åŠ¨åˆ·æ–°**
```java
@Service
public class TokenService {
    @Autowired
    private TokenManager tokenManager;
    
    public void refreshToken() {
        TokenResponse newToken = tokenManager.refreshToken();
        // ä¿å­˜æ–°Token
    }
}
```

3. **å‰ç«¯å¤„ç†**
```javascript
// Axiosæ‹¦æˆªå™¨è‡ªåŠ¨åˆ·æ–°
axios.interceptors.response.use(
  response => response,
  async error => {
    if (error.response?.status === 401 && error.response?.data?.code === 1003) {
      // Tokenè¿‡æœŸï¼Œåˆ·æ–°Token
      const newToken = await refreshToken()
      // é‡è¯•åŸè¯·æ±‚
      return axios(error.config)
    }
    return Promise.reject(error)
  }
)
```

### Q2: å¦‚ä½•å®ç°å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰ï¼Ÿ

**A:** ä½¿ç”¨OAuth 2.0æˆæƒç æ¨¡å¼ï¼š

```yaml
# åº”ç”¨Aé…ç½®
auth:
  oauth:
    grant-type: authorization_code
    redirect-uri: http://app-a.com/callback

# åº”ç”¨Bé…ç½®
auth:
  oauth:
    grant-type: authorization_code
    redirect-uri: http://app-b.com/callback
```

æµç¨‹ï¼š
1. ç”¨æˆ·è®¿é—®åº”ç”¨Aï¼Œé‡å®šå‘åˆ°è®¤è¯ä¸­å¿ƒç™»å½•
2. ç™»å½•æˆåŠŸåï¼Œè®¤è¯ä¸­å¿ƒè¿”å›æˆæƒç 
3. åº”ç”¨Aä½¿ç”¨æˆæƒç æ¢å–Token
4. ç”¨æˆ·å†è®¿é—®åº”ç”¨Bæ—¶ï¼Œè®¤è¯ä¸­å¿ƒè¯†åˆ«å·²ç™»å½•ï¼Œç›´æ¥è¿”å›æˆæƒç 
5. å®ç°å•ç‚¹ç™»å½•

### Q3: æ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•å—ï¼Ÿ

**A:** æ”¯æŒï¼Œç›®å‰æ”¯æŒä»¥ä¸‹ç¬¬ä¸‰æ–¹ç™»å½•ï¼š

```java
// å¾®ä¿¡ç™»å½•
@PostMapping("/oauth/wechat")
public Result wechatLogin(@RequestParam String code) {
    return authService.wechatLogin(code);
}

// GitHubç™»å½•
@PostMapping("/oauth/github")
public Result githubLogin(@RequestParam String code) {
    return authService.githubLogin(code);
}
```

é…ç½®ï¼š
```yaml
auth:
  oauth:
    wechat:
      app-id: your-app-id
      app-secret: your-app-secret
    github:
      client-id: your-client-id
      client-secret: your-client-secret
```

### Q4: å¦‚ä½•å®ç°è®°ä½æˆ‘åŠŸèƒ½ï¼Ÿ

**A:** ä½¿ç”¨é•¿æœŸæœ‰æ•ˆçš„RefreshTokenï¼š

```java
@PostMapping("/login")
public Result login(@RequestBody LoginRequest request) {
    LoginResponse response = authService.login(
        request.getUsername(),
        request.getPassword(),
        request.isRememberMe()  // è®°ä½æˆ‘
    );
    
    if (request.isRememberMe()) {
        // RefreshTokenæœ‰æ•ˆæœŸå»¶é•¿åˆ°30å¤©
        response.setRefreshTokenExpire(30 * 24 * 3600);
    }
    
    return Result.success(response);
}
```

### Q5: å¦‚ä½•å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿ï¼Ÿ

**A:** è°ƒç”¨å¼ºåˆ¶ä¸‹çº¿æ¥å£ï¼š

```java
@Service
public class UserService {
    @Autowired
    private AuthClient authClient;
    
    public void forceLogout(Long userId) {
        // æ–¹å¼ä¸€ï¼šé€šè¿‡API
        authClient.forceLogout(userId);
        
        // æ–¹å¼äºŒï¼šç›´æ¥æ“ä½œRedis
        redisTemplate.delete("auth:online:user:" + userId);
        redisTemplate.delete("auth:user:" + userId);
    }
}
```

## ğŸ”‘ æƒé™ç›¸å…³

### Q6: æƒé™ä¸ç”Ÿæ•ˆæ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **ç¡®è®¤å¯ç”¨äº†æƒé™éªŒè¯**
```yaml
auth:
  permission:
    enabled: true
```

2. **æ£€æŸ¥æ³¨è§£ä½ç½®**
```java
// âŒ é”™è¯¯ï¼šæ³¨è§£åœ¨æ¥å£ä¸Š
public interface UserService {
    @RequirePermission("user:read")
    void getUser();
}

// âœ… æ­£ç¡®ï¼šæ³¨è§£åœ¨å®ç°ç±»ä¸Š
@Service
public class UserServiceImpl implements UserService {
    @RequirePermission("user:read")
    public void getUser() {
        // ...
    }
}
```

3. **æ£€æŸ¥æƒé™å­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…**
```java
// æ•°æ®åº“ä¸­çš„æƒé™ç ï¼šuser:read
// æ³¨è§£ä¸­çš„æƒé™ç å¿…é¡»å®Œå…¨ä¸€è‡´
@RequirePermission("user:read")  // âœ… æ­£ç¡®
@RequirePermission("user:view")  // âŒ é”™è¯¯
```

4. **æ¸…é™¤æƒé™ç¼“å­˜**
```java
@Autowired
private PermissionCache permissionCache;

public void refreshPermission(Long userId) {
    permissionCache.evict(userId);
}
```

### Q7: å¦‚ä½•å®ç°åŠ¨æ€æƒé™ï¼Ÿ

**A:** å®ç°è‡ªå®šä¹‰æƒé™éªŒè¯å™¨ï¼š

```java
@Component
public class DynamicPermissionEvaluator implements PermissionEvaluator {
    
    @Autowired
    private PermissionRepository permissionRepository;
    
    @Override
    public boolean hasPermission(UserInfo user, String permission) {
        // ä»æ•°æ®åº“å®æ—¶æŸ¥è¯¢æƒé™
        List<String> permissions = permissionRepository.getUserPermissions(user.getUserId());
        return permissions.contains(permission);
    }
}
```

### Q8: å¦‚ä½•å®ç°æ•°æ®æƒé™ï¼Ÿ

**A:** ä½¿ç”¨æ•°æ®æƒé™æ³¨è§£ï¼š

```java
@Service
public class OrderService {
    
    // åªèƒ½æŸ¥çœ‹è‡ªå·±éƒ¨é—¨çš„è®¢å•
    @DataPermission(type = DataScopeType.DEPT)
    public List<Order> getOrders() {
        // SQLä¼šè‡ªåŠ¨æ·»åŠ ï¼šWHERE dept_id = #{currentUserDeptId}
        return orderMapper.selectList();
    }
    
    // åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•
    @DataPermission(type = DataScopeType.SELF)
    public List<Order> getMyOrders() {
        // SQLä¼šè‡ªåŠ¨æ·»åŠ ï¼šWHERE user_id = #{currentUserId}
        return orderMapper.selectList();
    }
    
    // è‡ªå®šä¹‰SQLè¿‡æ»¤
    @DataPermission(
        type = DataScopeType.CUSTOM,
        sqlFilter = "region_id IN (SELECT region_id FROM user_region WHERE user_id = #{userId})"
    )
    public List<Order> getRegionOrders() {
        return orderMapper.selectList();
    }
}
```

### Q9: å¦‚ä½•å®ç°æŒ‰é’®çº§æƒé™æ§åˆ¶ï¼Ÿ

**A:** å‰ç«¯é…åˆåç«¯æƒé™æ ‡è¯†ï¼š

åç«¯ï¼š
```java
@GetMapping("/user-info")
public Result getUserInfo() {
    UserInfo user = UserContext.getCurrentUser();
    return Result.success(user);  // åŒ…å«permissionsåˆ—è¡¨
}
```

å‰ç«¯ï¼ˆVueï¼‰ï¼š
```vue
<template>
  <div>
    <!-- æ–¹å¼ä¸€ï¼šv-if -->
    <el-button v-if="hasPermission('user:delete')" @click="deleteUser">
      åˆ é™¤
    </el-button>
    
    <!-- æ–¹å¼äºŒï¼šè‡ªå®šä¹‰æŒ‡ä»¤ -->
    <el-button v-permission="'user:delete'" @click="deleteUser">
      åˆ é™¤
    </el-button>
  </div>
</template>

<script setup>
import { useAuth } from '@/hooks/useAuth'

const { hasPermission } = useAuth()

// è‡ªå®šä¹‰æŒ‡ä»¤
app.directive('permission', {
  mounted(el, binding) {
    const permission = binding.value
    const permissions = store.getters.permissions
    
    if (!permissions.includes(permission)) {
      el.parentNode?.removeChild(el)
    }
  }
})
</script>
```

## ğŸ¢ å¤šç§Ÿæˆ·ç›¸å…³

### Q10: å¦‚ä½•å¯ç”¨å¤šç§Ÿæˆ·ï¼Ÿ

**A:** é…ç½®å’Œä½¿ç”¨å¤šç§Ÿæˆ·ï¼š

1. **å¯ç”¨å¤šç§Ÿæˆ·**
```yaml
auth:
  tenant:
    enabled: true
    header-name: X-Tenant-Id
```

2. **è¯·æ±‚æºå¸¦ç§Ÿæˆ·ID**
```java
// æ–¹å¼ä¸€ï¼šä»è¯·æ±‚å¤´è·å–
@GetMapping("/users")
public Result getUsers(@RequestHeader("X-Tenant-Id") String tenantId) {
    // è‡ªåŠ¨æ ¹æ®ç§Ÿæˆ·IDè¿‡æ»¤æ•°æ®
}

// æ–¹å¼äºŒï¼šSDKè‡ªåŠ¨å¤„ç†
@GetMapping("/users")
public Result getUsers() {
    String tenantId = UserContext.getTenantId();
    // æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢è‡ªåŠ¨æ·»åŠ  tenant_id æ¡ä»¶
}
```

3. **MyBatis Plusé…ç½®**
```java
@Configuration
public class MyBatisPlusConfig {
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // æ·»åŠ ç§Ÿæˆ·æ‹¦æˆªå™¨
        TenantLineInnerInterceptor tenantInterceptor = new TenantLineInnerInterceptor();
        tenantInterceptor.setTenantLineHandler(new TenantLineHandler() {
            @Override
            public Expression getTenantId() {
                String tenantId = UserContext.getTenantId();
                return new StringValue(tenantId);
            }
            
            @Override
            public boolean ignoreTable(String tableName) {
                // æ’é™¤ä¸éœ€è¦ç§Ÿæˆ·éš”ç¦»çš„è¡¨
                return "sys_tenant".equals(tableName);
            }
        });
        
        interceptor.addInnerInterceptor(tenantInterceptor);
        return interceptor;
    }
}
```

### Q11: å¦‚ä½•åˆ‡æ¢ç§Ÿæˆ·ï¼Ÿ

**A:** è¶…çº§ç®¡ç†å‘˜å¯ä»¥åˆ‡æ¢ç§Ÿæˆ·ï¼š

```java
@Service
public class TenantService {
    
    @RequireRole("SUPER_ADMIN")
    public void switchTenant(String targetTenantId) {
        // åˆ‡æ¢ç§Ÿæˆ·
        TenantContext.setTenantId(targetTenantId);
        
        // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
        UserContext.refresh();
    }
}
```

## ğŸš€ æ€§èƒ½ç›¸å…³

### Q12: å¦‚ä½•ä¼˜åŒ–æƒé™éªŒè¯æ€§èƒ½ï¼Ÿ

**A:** å¤šç§ä¼˜åŒ–ç­–ç•¥ï¼š

1. **å¯ç”¨æƒé™ç¼“å­˜**
```yaml
auth:
  permission:
    cache-enabled: true
    cache-time: 1800  # ç¼“å­˜30åˆ†é’Ÿ
```

2. **æ‰¹é‡åŠ è½½æƒé™**
```java
@Service
public class PermissionService {
    
    // ç”¨æˆ·ç™»å½•æ—¶ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æƒé™
    @Cacheable(value = "user-permissions", key = "#userId")
    public List<String> loadAllPermissions(Long userId) {
        return permissionRepository.getUserAllPermissions(userId);
    }
}
```

3. **ä½¿ç”¨Redisç¼“å­˜**
```java
@Configuration
public class CacheConfig {
    
    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(factory)
            .cacheDefaults(config)
            .build();
    }
}
```

### Q13: TokenéªŒè¯å¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ

**A:** ä¼˜åŒ–TokenéªŒè¯ï¼š

1. **æœ¬åœ°éªŒè¯JWTï¼ˆæ¨èï¼‰**
```java
// ä¸éœ€è¦æ¯æ¬¡éƒ½è°ƒç”¨è®¤è¯æœåŠ¡å™¨
// ä½¿ç”¨JWTæœ¬åœ°éªŒè¯
@Component
public class JwtValidator {
    
    public boolean validate(String token) {
        try {
            Jws<Claims> claims = Jwts.parserBuilder()
                .setSigningKey(secretKey)
                .build()
                .parseClaimsJws(token);
            return !claims.getBody().getExpiration().before(new Date());
        } catch (Exception e) {
            return false;
        }
    }
}
```

2. **ä½¿ç”¨Redisç¼“å­˜ç”¨æˆ·ä¿¡æ¯**
```java
@Service
public class UserCacheService {
    
    @Cacheable(value = "user-info", key = "#userId")
    public UserInfo getUserInfo(Long userId) {
        return authClient.getUserInfo(userId);
    }
}
```

## ğŸ”§ é›†æˆç›¸å…³

### Q14: å¦‚ä½•ä¸Spring Cloud Gatewayé›†æˆï¼Ÿ

**A:** åœ¨ç½‘å…³å±‚ç»Ÿä¸€è®¤è¯ï¼š

```java
@Configuration
public class GatewayAuthConfig {
    
    @Bean
    public GlobalFilter authFilter() {
        return (exchange, chain) -> {
            ServerHttpRequest request = exchange.getRequest();
            
            // æå–Token
            String token = extractToken(request);
            
            if (token == null) {
                return unauthorized(exchange);
            }
            
            // éªŒè¯Token
            return validateToken(token)
                .flatMap(userInfo -> {
                    // å°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
                    ServerHttpRequest newRequest = request.mutate()
                        .header("X-User-Id", userInfo.getUserId().toString())
                        .header("X-Username", userInfo.getUsername())
                        .header("X-Roles", String.join(",", userInfo.getRoles()))
                        .build();
                    
                    return chain.filter(exchange.mutate().request(newRequest).build());
                })
                .onErrorResume(e -> unauthorized(exchange));
        };
    }
}
```

### Q15: å¦‚ä½•ä¸Feigné›†æˆä¼ é€’Tokenï¼Ÿ

**A:** é…ç½®Feignæ‹¦æˆªå™¨ï¼š

```java
@Configuration
public class FeignConfig {
    
    @Bean
    public RequestInterceptor requestInterceptor() {
        return template -> {
            // è·å–å½“å‰è¯·æ±‚çš„Token
            ServletRequestAttributes attributes = (ServletRequestAttributes) 
                RequestContextHolder.getRequestAttributes();
            
            if (attributes != null) {
                HttpServletRequest request = attributes.getRequest();
                String token = request.getHeader("Authorization");
                
                // ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
                if (token != null) {
                    template.header("Authorization", token);
                }
                
                // ä¼ é€’ç§Ÿæˆ·ID
                String tenantId = request.getHeader("X-Tenant-Id");
                if (tenantId != null) {
                    template.header("X-Tenant-Id", tenantId);
                }
            }
        };
    }
}
```

### Q16: å‰ç«¯å¦‚ä½•å¤„ç†Tokenåˆ·æ–°ï¼Ÿ

**A:** ä½¿ç”¨æ‹¦æˆªå™¨è‡ªåŠ¨åˆ·æ–°ï¼š

```javascript
// axiosé…ç½®
import axios from 'axios'

let isRefreshing = false
let requests = []

axios.interceptors.response.use(
  response => response,
  async error => {
    const { config, response } = error
    
    // Tokenè¿‡æœŸ
    if (response?.status === 401 && response?.data?.code === 1003) {
      if (!isRefreshing) {
        isRefreshing = true
        
        try {
          // åˆ·æ–°Token
          const refreshToken = localStorage.getItem('refresh_token')
          const res = await axios.post('/api/v1/auth/refresh', { refreshToken })
          
          const { accessToken, refreshToken: newRefreshToken } = res.data.data
          localStorage.setItem('access_token', accessToken)
          localStorage.setItem('refresh_token', newRefreshToken)
          
          // é‡è¯•æ‰€æœ‰ç­‰å¾…çš„è¯·æ±‚
          requests.forEach(cb => cb(accessToken))
          requests = []
          
          // é‡è¯•å½“å‰è¯·æ±‚
          config.headers['Authorization'] = `Bearer ${accessToken}`
          return axios(config)
        } catch (e) {
          // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•
          localStorage.clear()
          window.location.href = '/login'
        } finally {
          isRefreshing = false
        }
      } else {
        // æ­£åœ¨åˆ·æ–°Tokenï¼Œå°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
        return new Promise(resolve => {
          requests.push(token => {
            config.headers['Authorization'] = `Bearer ${token}`
            resolve(axios(config))
          })
        })
      }
    }
    
    return Promise.reject(error)
  }
)
```

## ğŸ“± å…¶ä»–é—®é¢˜

### Q17: å¦‚ä½•å®ç°éªŒè¯ç åŠŸèƒ½ï¼Ÿ

**A:** ä½¿ç”¨å†…ç½®éªŒè¯ç APIï¼š

```java
// åç«¯
@GetMapping("/captcha")
public Result getCaptcha() {
    CaptchaResponse captcha = authService.generateCaptcha();
    return Result.success(captcha);
}

@PostMapping("/login")
public Result login(@RequestBody LoginRequest request) {
    // éªŒè¯éªŒè¯ç 
    if (!authService.validateCaptcha(request.getCaptchaKey(), request.getCaptcha())) {
        return Result.error("éªŒè¯ç é”™è¯¯");
    }
    
    // ç™»å½•é€»è¾‘
    return Result.success(authService.login(request.getUsername(), request.getPassword()));
}
```

```javascript
// å‰ç«¯
const getCaptcha = async () => {
  const res = await axios.get('/api/v1/auth/captcha')
  captchaKey.value = res.captchaKey
  captchaImage.value = res.captchaImage
}

const login = async () => {
  await axios.post('/api/v1/auth/login', {
    username: username.value,
    password: password.value,
    captchaKey: captchaKey.value,
    captcha: captcha.value
  })
}
```

### Q18: å¦‚ä½•å®ç°ç™»å½•å¤±è´¥é”å®šï¼Ÿ

**A:** é…ç½®å®‰å…¨ç­–ç•¥ï¼š

```yaml
auth:
  security:
    login-fail-max-count: 5      # æœ€å¤§å¤±è´¥æ¬¡æ•°
    login-fail-lock-time: 900    # é”å®šæ—¶é—´(ç§’)
    login-fail-reset-time: 3600  # å¤±è´¥è®¡æ•°é‡ç½®æ—¶é—´(ç§’)
```

### Q19: æ”¯æŒå“ªäº›æ•°æ®åº“ï¼Ÿ

**A:** ç†è®ºä¸Šæ”¯æŒæ‰€æœ‰å…³ç³»å‹æ•°æ®åº“ï¼š

- MySQL 8.0+ ï¼ˆæ¨èï¼‰
- PostgreSQL 12+
- Oracle 11g+
- SQL Server 2016+
- MariaDB 10.5+

åªéœ€ä¿®æ”¹æ•°æ®åº“è¿æ¥é…ç½®å’ŒSQLæ–¹è¨€ã€‚

### Q20: å¦‚ä½•å¤‡ä»½å’Œæ¢å¤æ•°æ®ï¼Ÿ

**A:** å®šæœŸå¤‡ä»½æ•°æ®åº“ï¼š

```bash
# å¤‡ä»½
mysqldump -u root -p auth_db > backup_$(date +%Y%m%d).sql

# æ¢å¤
mysql -u root -p auth_db < backup_20240101.sql

# å®šæ—¶å¤‡ä»½ï¼ˆcrontabï¼‰
0 2 * * * /usr/bin/mysqldump -u root -ppassword auth_db > /backup/auth_$(date +\%Y\%m\%d).sql
```

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœä»¥ä¸ŠFAQæ²¡æœ‰è§£å†³ä½ çš„é—®é¢˜ï¼š

1. æŸ¥çœ‹[å®Œæ•´æ–‡æ¡£](./README.md)
2. æŸ¥çœ‹[GitHub Issues](https://github.com/your-repo/issues)
3. åŠ å…¥æŠ€æœ¯äº¤æµç¾¤
4. å‘é€é‚®ä»¶åˆ°ï¼šsupport@example.com

---

**æŒç»­æ›´æ–°ä¸­...** å¦‚æœ‰å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿æIssueï¼

