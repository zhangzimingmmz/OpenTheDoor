# æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ›ï¸ æ•´ä½“æ¶æ„

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯åº”ç”¨å±‚                          â”‚
â”‚  (Web/Mobile App/å…¶ä»–å¾®æœåŠ¡)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   APIç½‘å…³å±‚                              â”‚
â”‚  (Spring Cloud Gateway / Nginx)                         â”‚
â”‚  - è·¯ç”±è½¬å‘  - ç»Ÿä¸€è®¤è¯  - é™æµç†”æ–­                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è®¤è¯æˆæƒæœåŠ¡                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Controllerå±‚ (APIæ¥å£)                 â”‚   â”‚
â”‚  â”‚  - ç”¨æˆ·ç®¡ç†  - è®¤è¯  - æˆæƒ  - ç§Ÿæˆ·ç®¡ç†           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Serviceå±‚ (ä¸šåŠ¡é€»è¾‘)                    â”‚   â”‚
â”‚  â”‚  - UserService  - AuthService  - RoleService     â”‚   â”‚
â”‚  â”‚  - PermissionService  - TenantService            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Securityå±‚ (å®‰å…¨æ ¸å¿ƒ)                      â”‚   â”‚
â”‚  â”‚  - JWTå¤„ç†  - OAuth2  - æƒé™éªŒè¯  - åŠ å¯†è§£å¯†      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Repositoryå±‚ (æ•°æ®è®¿é—®)                    â”‚   â”‚
â”‚  â”‚  - UserRepository  - RoleRepository              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MySQL   â”‚          â”‚  Redis   â”‚
    â”‚ æŒä¹…åŒ–å­˜å‚¨â”‚          â”‚   ç¼“å­˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ¨¡å—åˆ’åˆ†

### auth-commonï¼ˆå…¬å…±æ¨¡å—ï¼‰
**èŒè´£**ï¼šæä¾›å…¬å…±å·¥å…·ç±»ã€å¸¸é‡ã€å¼‚å¸¸å®šä¹‰ç­‰

```
auth-common/
â”œâ”€â”€ constant/          # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ AuthConstant.java
â”‚   â”œâ”€â”€ CacheConstant.java
â”‚   â””â”€â”€ ErrorCodeConstant.java
â”œâ”€â”€ enums/            # æšä¸¾ç±»å‹
â”‚   â”œâ”€â”€ UserStatus.java
â”‚   â”œâ”€â”€ LoginType.java
â”‚   â””â”€â”€ PermissionType.java
â”œâ”€â”€ exception/        # è‡ªå®šä¹‰å¼‚å¸¸
â”‚   â”œâ”€â”€ AuthException.java
â”‚   â”œâ”€â”€ TokenException.java
â”‚   â””â”€â”€ PermissionException.java
â”œâ”€â”€ util/            # å·¥å…·ç±»
â”‚   â”œâ”€â”€ PasswordUtil.java
â”‚   â”œâ”€â”€ JwtUtil.java
â”‚   â””â”€â”€ RedisUtil.java
â””â”€â”€ dto/             # æ•°æ®ä¼ è¾“å¯¹è±¡
    â””â”€â”€ Result.java  # ç»Ÿä¸€å“åº”å¯¹è±¡
```

### auth-apiï¼ˆAPIæ¥å£å®šä¹‰ï¼‰
**èŒè´£**ï¼šå®šä¹‰Feignæ¥å£ï¼Œä¾›å…¶ä»–æœåŠ¡è°ƒç”¨

```
auth-api/
â”œâ”€â”€ dto/                    # è¯·æ±‚/å“åº”DTO
â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”œâ”€â”€ LoginRequest.java
â”‚   â”‚   â”œâ”€â”€ RegisterRequest.java
â”‚   â”‚   â””â”€â”€ TokenRefreshRequest.java
â”‚   â””â”€â”€ response/
â”‚       â”œâ”€â”€ LoginResponse.java
â”‚       â”œâ”€â”€ UserInfoResponse.java
â”‚       â””â”€â”€ TokenResponse.java
â”œâ”€â”€ feign/                 # Feignå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ AuthFeignClient.java
â”‚   â””â”€â”€ UserFeignClient.java
â””â”€â”€ vo/                    # è§†å›¾å¯¹è±¡
    â”œâ”€â”€ UserVO.java
    â””â”€â”€ RoleVO.java
```

### auth-coreï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰
**èŒè´£**ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°

```
auth-core/
â”œâ”€â”€ config/               # é…ç½®ç±»
â”‚   â”œâ”€â”€ SecurityConfig.java
â”‚   â”œâ”€â”€ RedisConfig.java
â”‚   â”œâ”€â”€ MyBatisPlusConfig.java
â”‚   â””â”€â”€ Knife4jConfig.java
â”œâ”€â”€ controller/          # æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ AuthController.java      # è®¤è¯æ¥å£
â”‚   â”œâ”€â”€ UserController.java      # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ RoleController.java      # è§’è‰²ç®¡ç†
â”‚   â”œâ”€â”€ PermissionController.java # æƒé™ç®¡ç†
â”‚   â”œâ”€â”€ TenantController.java    # ç§Ÿæˆ·ç®¡ç†
â”‚   â””â”€â”€ OAuthController.java     # OAuthæ¥å£
â”œâ”€â”€ service/             # ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ IAuthService.java
â”‚   â”œâ”€â”€ IUserService.java
â”‚   â”œâ”€â”€ IRoleService.java
â”‚   â”œâ”€â”€ IPermissionService.java
â”‚   â”œâ”€â”€ ITenantService.java
â”‚   â”œâ”€â”€ ITokenService.java
â”‚   â””â”€â”€ impl/
â”‚       â”œâ”€â”€ AuthServiceImpl.java
â”‚       â”œâ”€â”€ UserServiceImpl.java
â”‚       â””â”€â”€ ...
â”œâ”€â”€ security/           # å®‰å…¨ç›¸å…³
â”‚   â”œâ”€â”€ jwt/
â”‚   â”‚   â”œâ”€â”€ JwtTokenProvider.java
â”‚   â”‚   â”œâ”€â”€ JwtAuthenticationFilter.java
â”‚   â”‚   â””â”€â”€ JwtAuthenticationEntryPoint.java
â”‚   â”œâ”€â”€ oauth2/
â”‚   â”‚   â”œâ”€â”€ OAuth2AuthorizationServer.java
â”‚   â”‚   â””â”€â”€ OAuth2ResourceServer.java
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”œâ”€â”€ LoginSuccessHandler.java
â”‚   â”‚   â”œâ”€â”€ LoginFailureHandler.java
â”‚   â”‚   â””â”€â”€ LogoutHandler.java
â”‚   â””â”€â”€ userdetails/
â”‚       â””â”€â”€ CustomUserDetailsService.java
â”œâ”€â”€ repository/         # æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ mapper/
â”‚   â”‚   â”œâ”€â”€ UserMapper.java
â”‚   â”‚   â”œâ”€â”€ RoleMapper.java
â”‚   â”‚   â”œâ”€â”€ PermissionMapper.java
â”‚   â”‚   â””â”€â”€ TenantMapper.java
â”‚   â””â”€â”€ entity/
â”‚       â”œâ”€â”€ User.java
â”‚       â”œâ”€â”€ Role.java
â”‚       â”œâ”€â”€ Permission.java
â”‚       â”œâ”€â”€ UserRole.java
â”‚       â”œâ”€â”€ RolePermission.java
â”‚       â””â”€â”€ Tenant.java
â”œâ”€â”€ interceptor/        # æ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ TenantInterceptor.java
â”‚   â””â”€â”€ LogInterceptor.java
â”œâ”€â”€ aspect/            # åˆ‡é¢
â”‚   â”œâ”€â”€ LogAspect.java
â”‚   â””â”€â”€ PermissionAspect.java
â””â”€â”€ cache/             # ç¼“å­˜ç®¡ç†
    â”œâ”€â”€ UserCacheService.java
    â””â”€â”€ PermissionCacheService.java
```

### auth-clientï¼ˆå®¢æˆ·ç«¯SDKï¼‰
**èŒè´£**ï¼šæä¾›Spring Boot Starterï¼Œæ–¹ä¾¿å…¶ä»–æœåŠ¡é›†æˆ

```
auth-client/
â”œâ”€â”€ autoconfigure/
â”‚   â”œâ”€â”€ AuthAutoConfiguration.java
â”‚   â”œâ”€â”€ AuthProperties.java
â”‚   â””â”€â”€ AuthClientConfiguration.java
â”œâ”€â”€ annotation/
â”‚   â”œâ”€â”€ RequirePermission.java    # æƒé™æ³¨è§£
â”‚   â”œâ”€â”€ RequireRole.java          # è§’è‰²æ³¨è§£
â”‚   â””â”€â”€ RequireLogin.java         # ç™»å½•æ³¨è§£
â”œâ”€â”€ interceptor/
â”‚   â”œâ”€â”€ AuthInterceptor.java      # è®¤è¯æ‹¦æˆªå™¨
â”‚   â””â”€â”€ PermissionInterceptor.java # æƒé™æ‹¦æˆªå™¨
â”œâ”€â”€ filter/
â”‚   â””â”€â”€ TokenFilter.java          # Tokenè¿‡æ»¤å™¨
â”œâ”€â”€ context/
â”‚   â””â”€â”€ UserContext.java          # ç”¨æˆ·ä¸Šä¸‹æ–‡
â””â”€â”€ resources/
    â””â”€â”€ META-INF/
        â””â”€â”€ spring.factories      # è‡ªåŠ¨é…ç½®
```

## ğŸ” è®¤è¯æµç¨‹

### 1. ç”¨æˆ·ç™»å½•æµç¨‹

```
ç”¨æˆ· â†’ å‘é€ç™»å½•è¯·æ±‚(username/password)
  â†“
AuthController.login()
  â†“
AuthService.authenticate()
  â”œâ”€ éªŒè¯ç”¨æˆ·åå¯†ç 
  â”œâ”€ æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
  â”œâ”€ æ£€æŸ¥ç§Ÿæˆ·çŠ¶æ€
  â”œâ”€ è®°å½•ç™»å½•æ—¥å¿—
  â””â”€ ç”ŸæˆToken
      â†“
  è¿”å› AccessToken + RefreshToken
      â†“
  å®¢æˆ·ç«¯å­˜å‚¨Token
```

### 2. TokenéªŒè¯æµç¨‹

```
å®¢æˆ·ç«¯ â†’ æºå¸¦Tokenè®¿é—®èµ„æº
  â†“
JwtAuthenticationFilter
  â”œâ”€ æå–Token
  â”œâ”€ éªŒè¯Tokenæœ‰æ•ˆæ€§
  â”œâ”€ è§£æç”¨æˆ·ä¿¡æ¯
  â”œâ”€ æ£€æŸ¥Redisé»‘åå•
  â””â”€ åŠ è½½ç”¨æˆ·æƒé™
      â†“
  è®¾ç½®SecurityContext
      â†“
  ç»§ç»­è¯·æ±‚å¤„ç†
```

### 3. æƒé™éªŒè¯æµç¨‹

```
è¯·æ±‚æ¥å£
  â†“
PermissionInterceptor/PermissionAspect
  â”œâ”€ è·å–å½“å‰ç”¨æˆ·
  â”œâ”€ è·å–æ‰€éœ€æƒé™
  â”œâ”€ ä»ç¼“å­˜è·å–ç”¨æˆ·æƒé™
  â””â”€ æƒé™åŒ¹é…
      â†“
  é€šè¿‡ï¼šç»§ç»­æ‰§è¡Œ
  å¤±è´¥ï¼šè¿”å›403
```

## ğŸ« Tokenè®¾è®¡

### Tokenç±»å‹

1. **Access Token**
   - æœ‰æ•ˆæœŸï¼š2å°æ—¶
   - ç”¨é€”ï¼šè®¿é—®èµ„æº
   - å­˜å‚¨ä½ç½®ï¼šå®¢æˆ·ç«¯ï¼ˆHeader/LocalStorageï¼‰

2. **Refresh Token**
   - æœ‰æ•ˆæœŸï¼š7å¤©
   - ç”¨é€”ï¼šåˆ·æ–°Access Token
   - å­˜å‚¨ä½ç½®ï¼šå®¢æˆ·ç«¯ï¼ˆHttpOnly Cookieï¼‰

### Tokenç»“æ„

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "userId": "1001",
    "username": "zhangsan",
    "tenantId": "T001",
    "roles": ["admin", "user"],
    "permissions": ["user:read", "user:write"],
    "exp": 1698765432,
    "iat": 1698758232,
    "jti": "token-unique-id"
  },
  "signature": "..."
}
```

## ğŸ—„ï¸ ç¼“å­˜è®¾è®¡

### Redisç¼“å­˜ç­–ç•¥

| ç¼“å­˜Key | æ•°æ® | è¿‡æœŸæ—¶é—´ | è¯´æ˜ |
|---------|------|---------|------|
| `auth:user:{userId}` | ç”¨æˆ·ä¿¡æ¯ | 30åˆ†é’Ÿ | ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ |
| `auth:permissions:{userId}` | ç”¨æˆ·æƒé™åˆ—è¡¨ | 30åˆ†é’Ÿ | ç”¨æˆ·æ‰€æœ‰æƒé™ |
| `auth:roles:{userId}` | ç”¨æˆ·è§’è‰²åˆ—è¡¨ | 30åˆ†é’Ÿ | ç”¨æˆ·æ‰€æœ‰è§’è‰² |
| `auth:token:blacklist:{jti}` | Tokenæ ‡è¯† | Tokenè¿‡æœŸæ—¶é—´ | Tokené»‘åå• |
| `auth:login:fail:{username}` | å¤±è´¥æ¬¡æ•° | 15åˆ†é’Ÿ | ç™»å½•å¤±è´¥è®¡æ•° |
| `auth:online:user:{userId}` | ä¼šè¯ä¿¡æ¯ | 30åˆ†é’Ÿ | åœ¨çº¿ç”¨æˆ· |
| `auth:tenant:{tenantId}` | ç§Ÿæˆ·é…ç½® | 1å°æ—¶ | ç§Ÿæˆ·ä¿¡æ¯ |

### ç¼“å­˜æ›´æ–°ç­–ç•¥

1. **ä¸»åŠ¨æ›´æ–°**ï¼šæ•°æ®ä¿®æ”¹æ—¶ä¸»åŠ¨åˆ é™¤ç¼“å­˜
2. **è¢«åŠ¨æ›´æ–°**ï¼šç¼“å­˜è¿‡æœŸåé‡æ–°åŠ è½½
3. **å¼‚æ­¥åˆ·æ–°**ï¼šåå°å®šæ—¶åˆ·æ–°çƒ­ç‚¹æ•°æ®

## ğŸ”„ OAuth 2.0å®ç°

### æ”¯æŒçš„æˆæƒæ¨¡å¼

1. **æˆæƒç æ¨¡å¼ï¼ˆAuthorization Codeï¼‰**
   - é€‚ç”¨åœºæ™¯ï¼šç¬¬ä¸‰æ–¹Webåº”ç”¨
   - æœ€å®‰å…¨çš„æ–¹å¼

2. **å¯†ç æ¨¡å¼ï¼ˆPasswordï¼‰**
   - é€‚ç”¨åœºæ™¯ï¼šè‡ªå®¶åº”ç”¨
   - ç”¨æˆ·ç›´æ¥æä¾›å¯†ç 

3. **å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentialsï¼‰**
   - é€‚ç”¨åœºæ™¯ï¼šæœåŠ¡é—´è°ƒç”¨
   - æ— éœ€ç”¨æˆ·æˆæƒ

4. **ç®€åŒ–æ¨¡å¼ï¼ˆImplicitï¼‰**
   - é€‚ç”¨åœºæ™¯ï¼šçº¯å‰ç«¯åº”ç”¨ï¼ˆä¸æ¨èï¼‰

### OAuthæµç¨‹ç¤ºä¾‹ï¼ˆæˆæƒç æ¨¡å¼ï¼‰

```
1. å®¢æˆ·ç«¯ â†’ é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨
   GET /oauth/authorize?client_id=xxx&redirect_uri=xxx&response_type=code

2. ç”¨æˆ· â†’ ç™»å½•å¹¶æˆæƒ

3. æˆæƒæœåŠ¡å™¨ â†’ è¿”å›æˆæƒç 
   Redirect: https://client.com/callback?code=AUTH_CODE

4. å®¢æˆ·ç«¯ â†’ ä½¿ç”¨æˆæƒç æ¢å–Token
   POST /oauth/token
   {
     "grant_type": "authorization_code",
     "code": "AUTH_CODE",
     "client_id": "xxx",
     "client_secret": "xxx"
   }

5. æˆæƒæœåŠ¡å™¨ â†’ è¿”å›Token
   {
     "access_token": "...",
     "refresh_token": "...",
     "expires_in": 7200
   }
```

## ğŸ¢ å¤šç§Ÿæˆ·è®¾è®¡

### ç§Ÿæˆ·éš”ç¦»ç­–ç•¥

1. **æ•°æ®åº“éš”ç¦»**
   - æ–¹æ¡ˆï¼šæ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹æ•°æ®åº“
   - ä¼˜ç‚¹ï¼šå®Œå…¨éš”ç¦»ï¼Œå®‰å…¨æ€§é«˜
   - ç¼ºç‚¹ï¼šæˆæœ¬é«˜ï¼Œç»´æŠ¤å¤æ‚

2. **Schemaéš”ç¦»**
   - æ–¹æ¡ˆï¼šå…±äº«æ•°æ®åº“ï¼Œç‹¬ç«‹Schema
   - ä¼˜ç‚¹ï¼šæˆæœ¬é€‚ä¸­ï¼Œéš”ç¦»æ€§å¥½
   - ç¼ºç‚¹ï¼šæ•°æ®åº“æ”¯æŒæœ‰é™

3. **å­—æ®µéš”ç¦»ï¼ˆæ¨èï¼‰**
   - æ–¹æ¡ˆï¼šæ‰€æœ‰è¡¨å¢åŠ tenant_idå­—æ®µ
   - ä¼˜ç‚¹ï¼šæˆæœ¬ä½ï¼Œæ˜“ç»´æŠ¤
   - ç¼ºç‚¹ï¼šéœ€è¦ä¸¥æ ¼çš„ä»£ç æ§åˆ¶

### ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¼ é€’

```java
// é€šè¿‡ThreadLocalå­˜å‚¨ç§Ÿæˆ·ID
public class TenantContext {
    private static ThreadLocal<String> tenantId = new ThreadLocal<>();
    
    public static void setTenantId(String id) {
        tenantId.set(id);
    }
    
    public static String getTenantId() {
        return tenantId.get();
    }
    
    public static void clear() {
        tenantId.remove();
    }
}

// MyBatis Plusæ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶
@Intercepts({@Signature(...)})
public class TenantInterceptor implements Interceptor {
    @Override
    public Object intercept(Invocation invocation) {
        // è‡ªåŠ¨åœ¨SQLä¸­æ·»åŠ  tenant_id = ?
    }
}
```

## ğŸ“¡ APIè®¾è®¡è§„èŒƒ

### ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
  "code": 200,
  "message": "success",
  "data": {...},
  "timestamp": 1698758232000,
  "traceId": "uuid"
}
```

### é”™è¯¯ç è§„èŒƒ

| èŒƒå›´ | è¯´æ˜ |
|------|------|
| 2xx | æˆåŠŸ |
| 4xx | å®¢æˆ·ç«¯é”™è¯¯ |
| 5xx | æœåŠ¡ç«¯é”™è¯¯ |
| 1000-1999 | è®¤è¯ç›¸å…³é”™è¯¯ |
| 2000-2999 | ç”¨æˆ·ç›¸å…³é”™è¯¯ |
| 3000-3999 | æƒé™ç›¸å…³é”™è¯¯ |
| 4000-4999 | ç§Ÿæˆ·ç›¸å…³é”™è¯¯ |

### æ¥å£ç‰ˆæœ¬æ§åˆ¶

```
/api/v1/auth/login    # V1ç‰ˆæœ¬
/api/v2/auth/login    # V2ç‰ˆæœ¬
```

## ğŸ”§ é…ç½®ä¸­å¿ƒè®¾è®¡

### é…ç½®åˆ†å±‚

1. **åº”ç”¨é…ç½®**ï¼šapplication.ymlï¼ˆæœ¬åœ°ï¼‰
2. **ç¯å¢ƒé…ç½®**ï¼šNacosé…ç½®ä¸­å¿ƒï¼ˆè¿œç¨‹ï¼‰
3. **æ•æ„Ÿé…ç½®**ï¼šåŠ å¯†å­˜å‚¨ï¼ˆå¯†é’¥ã€å¯†ç ï¼‰

### é…ç½®çƒ­æ›´æ–°

æ”¯æŒä»¥ä¸‹é…ç½®çš„åŠ¨æ€æ›´æ–°ï¼š
- Tokenè¿‡æœŸæ—¶é—´
- å®‰å…¨ç­–ç•¥ï¼ˆç™»å½•å¤±è´¥æ¬¡æ•°ã€é”å®šæ—¶é—´ï¼‰
- ç¼“å­˜æ—¶é—´
- é™æµé˜ˆå€¼

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### ç›‘æ§æŒ‡æ ‡

1. **ä¸šåŠ¡æŒ‡æ ‡**
   - ç™»å½•æˆåŠŸ/å¤±è´¥ç‡
   - TokenéªŒè¯æ¬¡æ•°
   - åœ¨çº¿ç”¨æˆ·æ•°
   - APIè°ƒç”¨é‡

2. **æ€§èƒ½æŒ‡æ ‡**
   - æ¥å£å“åº”æ—¶é—´
   - æ•°æ®åº“æŸ¥è¯¢æ—¶é—´
   - Rediså‘½ä¸­ç‡
   - CPU/å†…å­˜ä½¿ç”¨ç‡

3. **å®‰å…¨æŒ‡æ ‡**
   - å¼‚å¸¸ç™»å½•æ¬¡æ•°
   - Tokenè¢«ç›—ç”¨æ¬¡æ•°
   - æƒé™æ ¡éªŒå¤±è´¥æ¬¡æ•°

### æ—¥å¿—è§„èŒƒ

```java
// ä½¿ç”¨SLF4Jç»Ÿä¸€æ—¥å¿—
@Slf4j
public class AuthService {
    public void login(String username) {
        log.info("ç”¨æˆ·ç™»å½•ï¼Œusername={}", username);
        log.error("ç™»å½•å¤±è´¥ï¼ŒåŸå› ï¼šå¯†ç é”™è¯¯ï¼Œusername={}", username);
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### ä¼˜åŒ–ç­–ç•¥

1. **ç¼“å­˜ä¼˜åŒ–**
   - æƒé™ä¿¡æ¯ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
   - ä½¿ç”¨Redis Pipelineæ‰¹é‡æ“ä½œ
   - å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€

2. **æ•°æ®åº“ä¼˜åŒ–**
   - åˆç†çš„ç´¢å¼•è®¾è®¡
   - è¯»å†™åˆ†ç¦»
   - åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

3. **ä»£ç ä¼˜åŒ–**
   - å¼‚æ­¥æ—¥å¿—è®°å½•
   - çº¿ç¨‹æ± å¤ç”¨
   - é¿å…N+1æŸ¥è¯¢

4. **ç½‘ç»œä¼˜åŒ–**
   - HTTP/2
   - GZIPå‹ç¼©
   - CDNåŠ é€Ÿ

## ğŸ”’ å®‰å…¨åŠ å›º

### å®‰å…¨æªæ–½

1. **ä¼ è¾“å®‰å…¨**ï¼šå¼ºåˆ¶HTTPS
2. **å­˜å‚¨å®‰å…¨**ï¼šå¯†ç BCryptåŠ å¯†
3. **æ¥å£å®‰å…¨**ï¼šé™æµã€é˜²é‡æ”¾
4. **æ•°æ®å®‰å…¨**ï¼šæ•æ„Ÿæ•°æ®è„±æ•
5. **å®¡è®¡å®‰å…¨**ï¼šå®Œæ•´çš„å®¡è®¡æ—¥å¿—

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./03-æ•°æ®åº“è®¾è®¡.md)
- [APIæ¥å£æ–‡æ¡£](./04-APIæ¥å£æ–‡æ¡£.md)
- [éƒ¨ç½²è¿ç»´æ–‡æ¡£](./05-éƒ¨ç½²è¿ç»´.md)

